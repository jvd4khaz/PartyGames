<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø®ÙˆÙ† Ø¨Ø± Ø¨Ø±Ø¬ Ø³Ø§Ø¹Øª - Ù†Ø³Ø®Ù‡ Ø¢Ù†Ù„Ø§ÛŒÙ†</title>
    <style>
        :root {
            --bg-color: #0a192f;
            --card-bg: #112240;
            --text-primary: #e6f1ff;
            --text-secondary: #8892b0;
            --accent-color: #b71c1c;
            --townsfolk-color: #0277bd;
            --outsider-color: #00bcd4;
            --minion-color: #e65100;
            --demon-color: #d50000;
            --good-color: #4CAF50;
            --evil-color: #F44336;
            --btn-color: #b71c1c;
            --btn-text: #ffffff;
            --border-radius: 8px;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Segoe UI', 'Tahoma', 'Arial', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            width: 95%;
            max-width: 600px;
            padding: 20px;
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            margin: 20px 0;
            text-align: center;
        }

        h1 { font-size: 1.8rem; margin-bottom: 0.5rem; color: var(--accent-color); font-weight: 900; }
        h2 { font-size: 1.2rem; margin: 10px 0; color: var(--text-secondary); }
        p { font-size: 1rem; color: var(--text-secondary); margin-bottom: 1rem; line-height: 1.5; }

        .input-group { margin-bottom: 15px; text-align: left; }
        .input-group label { display: block; margin-bottom: 5px; color: var(--text-secondary); font-size: 0.9rem; }
        
        .player-input, .text-input {
            width: 100%;
            padding: 12px;
            background-color: #233554;
            border: 1px solid #303C55;
            border-radius: 4px;
            color: var(--text-primary);
            font-size: 1rem;
            text-align: center;
        }
        .player-input:focus, .text-input:focus { outline: 1px solid var(--accent-color); }

        .action-btn {
            background-color: var(--btn-color);
            color: var(--btn-text);
            border: none;
            padding: 14px 20px;
            font-size: 1rem;
            font-weight: bold;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            margin-top: 15px;
            transition: transform 0.1s;
        }
        .action-btn:active { transform: scale(0.98); }
        
        .secondary-btn {
            background-color: transparent;
            color: var(--accent-color);
            border: 1px solid var(--accent-color);
            padding: 10px 15px;
            font-size: 0.9rem;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
            width: 100%;
        }

        .player-select-btn {
            background: linear-gradient(135deg, rgba(183, 28, 28, 0.2) 0%, rgba(183, 28, 28, 0.1) 100%);
            color: var(--accent-color);
            border: 3px solid var(--accent-color);
            padding: 18px 24px;
            font-size: 1.2rem;
            font-weight: bold;
            border-radius: 12px;
            cursor: pointer;
            width: 100%;
            margin: 12px 0;
            transition: all 0.3s;
            text-align: center;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .player-select-btn:hover {
            background: linear-gradient(135deg, rgba(183, 28, 28, 0.3) 0%, rgba(183, 28, 28, 0.2) 100%);
            transform: translateY(-2px);
        }
        .player-select-btn.dead {
            opacity: 0.5;
            border-color: #666;
        }

        .hidden { display: none !important; }

        .role-card {
            background: rgba(0,0,0,0.2);
            padding: 20px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.1);
            margin: 20px 0;
        }
        .role-title { 
            font-size: 2rem; 
            font-weight: 900; 
            margin-bottom: 10px; 
        }
        .role-townsfolk { color: var(--townsfolk-color); }
        .role-outsider { color: var(--outsider-color); }
        .role-minion { color: var(--minion-color); }
        .role-demon { color: var(--demon-color); }

        .game-id-display {
            background: rgba(183, 28, 28, 0.2);
            border: 2px solid var(--accent-color);
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            font-size: 1.2rem;
            font-weight: bold;
            word-break: break-all;
        }

        .phase-display {
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            background: rgba(255,255,255,0.05);
        }
        .phase-night { background: rgba(26, 26, 46, 0.5); }
        .phase-day { background: rgba(22, 33, 62, 0.5); }

        .player-list {
            text-align: right;
            margin: 15px 0;
        }
        .player-item {
            padding: 10px;
            margin: 5px 0;
            background: rgba(255,255,255,0.05);
            border-radius: 4px;
        }
        .player-item.dead {
            opacity: 0.5;
            text-decoration: line-through;
        }

        .info-box {
            background: rgba(2, 119, 189, 0.2);
            border: 2px solid var(--townsfolk-color);
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }

        .waiting-message {
            padding: 20px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            margin: 20px 0;
            font-size: 1.1rem;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .pulsing {
            animation: pulse 2s infinite;
        }
    </style>
</head>
<body>
    <!-- 1. Game Room Selection/Creation -->
    <div id="room-screen" class="container">
        <h1>ğŸ•°ï¸ Ø®ÙˆÙ† Ø¨Ø± Ø¨Ø±Ø¬ Ø³Ø§Ø¹Øª - Ù†Ø³Ø®Ù‡ Ø¢Ù†Ù„Ø§ÛŒÙ†</h1>
        <p>Ù‡Ø± Ø¨Ø§Ø²ÛŒÚ©Ù† Ø§Ø² Ø¯Ø³ØªÚ¯Ø§Ù‡ Ø®ÙˆØ¯ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†Ø¯</p>
        <div id="server-status" style="background: rgba(255, 193, 7, 0.2); border: 1px solid #ffc107; border-radius: 8px; padding: 10px; margin: 10px 0; font-size: 0.85rem;">
            <div>ÙˆØ¶Ø¹ÛŒØª Ø³Ø±ÙˆØ±: <span id="server-status-text">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ...</span></div>
            <div>Ø¢Ø¯Ø±Ø³ Ø³Ø±ÙˆØ±: <span id="server-url-text"></span></div>
            <div id="file-protocol-warning" style="margin-top: 10px; padding: 10px; background: rgba(244, 67, 54, 0.2); border: 1px solid #f44336; border-radius: 4px; display: none;">
                <strong>âš ï¸ ØªÙˆØ¬Ù‡:</strong> Ø´Ù…Ø§ ÙØ§ÛŒÙ„ Ø±Ø§ Ù…Ø³ØªÙ‚ÛŒÙ…Ø§Ù‹ Ø¨Ø§Ø² Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯. Ù„Ø·ÙØ§ Ø§Ø² Ø·Ø±ÛŒÙ‚ Ø³Ø±ÙˆØ± Ø¨Ø§Ø² Ú©Ù†ÛŒØ¯:
                <br><code style="background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 3px; margin-top: 5px; display: inline-block;">http://localhost:3000/BloodOnTheClocktowerApp/Blood_On_The_Clocktower_Farsi_Online.html</code>
                <br><br>ÛŒØ§ Ø¢Ø¯Ø±Ø³ Ø³Ø±ÙˆØ± Ø±Ø§ Ø¯Ø± Ø²ÛŒØ± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:
            </div>
            <div id="server-config" style="margin-top: 10px; display: none;">
                <label style="display: block; margin-bottom: 5px; font-size: 0.9rem;">Ø¢Ø¯Ø±Ø³ Ø³Ø±ÙˆØ± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ (Ù…Ø«Ù„Ø§Ù‹: https://your-app.onrender.com):</label>
                <input type="text" id="manual-server-url" class="text-input" placeholder="https://your-app.onrender.com" style="font-size: 0.9rem; padding: 8px;">
                <button class="secondary-btn" onclick="updateServerUrl()" style="margin-top: 5px; padding: 8px; font-size: 0.9rem;">Ø°Ø®ÛŒØ±Ù‡ Ùˆ ØªØ³Øª Ø§ØªØµØ§Ù„</button>
                <p style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 5px;">
                    Ø¨Ø¹Ø¯ Ø§Ø² deploy Ø³Ø±ÙˆØ± Ø±ÙˆÛŒ RenderØŒ Ø¢Ø¯Ø±Ø³ Ø¢Ù† Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯
                </p>
            </div>
        </div>
        
        <div id="create-game-section">
            <h2>Ø§ÛŒØ¬Ø§Ø¯ Ø¨Ø§Ø²ÛŒ</h2>
            <div class="input-group">
                <label>Ù†Ø§Ù… Ø´Ù…Ø§:</label>
                <input type="text" id="storyteller-name" class="text-input" placeholder="Ù†Ø§Ù… Ø´Ù…Ø§">
            </div>
            <button class="action-btn" onclick="createGame()">Ø§ÛŒØ¬Ø§Ø¯ Ø¨Ø§Ø²ÛŒ Ø¬Ø¯ÛŒØ¯</button>
            <p style="font-size: 0.9rem; color: var(--text-secondary); margin-top: 10px;">
                Ø´Ù…Ø§ Ù†ÛŒØ² ÛŒÚ© Ø¨Ø§Ø²ÛŒÚ©Ù† Ø®ÙˆØ§Ù‡ÛŒØ¯ Ø¨ÙˆØ¯ - Ù‡ÛŒÚ† Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§Ø¶Ø§ÙÛŒ Ø¯Ø±ÛŒØ§ÙØª Ù†Ù…ÛŒâ€ŒÚ©Ù†ÛŒØ¯
            </p>
        </div>

        <div style="margin: 30px 0; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 30px;">
            <h2>Ø¨Ø§Ø²ÛŒÚ©Ù†: Ù¾ÛŒÙˆØ³ØªÙ† Ø¨Ù‡ Ø¨Ø§Ø²ÛŒ</h2>
            <div class="input-group">
                <label>Ø´Ù†Ø§Ø³Ù‡ Ø¨Ø§Ø²ÛŒ:</label>
                <input type="text" id="join-game-id" class="text-input" placeholder="Ø´Ù†Ø§Ø³Ù‡ Ø¨Ø§Ø²ÛŒ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯">
            </div>
            <div class="input-group">
                <label>Ù†Ø§Ù… Ø´Ù…Ø§:</label>
                <input type="text" id="join-player-name" class="text-input" placeholder="Ù†Ø§Ù… Ø´Ù…Ø§">
            </div>
            <button class="action-btn" onclick="joinGame()">Ù¾ÛŒÙˆØ³ØªÙ† Ø¨Ù‡ Ø¨Ø§Ø²ÛŒ</button>
        </div>
    </div>

    <!-- 2. Creator Lobby Screen -->
    <div id="creator-lobby" class="container hidden">
        <h1>Ù„Ø§Ø¨ÛŒ Ø¨Ø§Ø²ÛŒ</h1>
        <div class="game-id-display">
            <div>Ø´Ù†Ø§Ø³Ù‡ Ø¨Ø§Ø²ÛŒ:</div>
            <div id="display-game-id" style="font-size: 1.5rem; margin-top: 10px;"></div>
            <p style="font-size: 0.9rem; margin-top: 10px; color: var(--text-secondary);">
                Ø§ÛŒÙ† Ø´Ù†Ø§Ø³Ù‡ Ø±Ø§ Ø¨Ø§ Ø¨Ø§Ø²ÛŒÚ©Ù†Ø§Ù† Ø¨Ù‡ Ø§Ø´ØªØ±Ø§Ú© Ø¨Ú¯Ø°Ø§Ø±ÛŒØ¯
            </p>
        </div>

        <div class="input-group">
            <label>ØªØ¹Ø¯Ø§Ø¯ Ø¨Ø§Ø²ÛŒÚ©Ù†Ø§Ù† Ù…ÙˆØ±Ø¯ Ù†ÛŒØ§Ø²:</label>
            <div style="display: flex; align-items: center; justify-content: center; gap: 20px;">
                <button class="secondary-btn" onclick="updatePlayerCount(-1)" style="width: auto; padding: 10px 20px;">-</button>
                <span id="player-count-display" style="font-size: 1.5rem; font-weight: bold;">7</span>
                <button class="secondary-btn" onclick="updatePlayerCount(1)" style="width: auto; padding: 10px 20px;">+</button>
            </div>
        </div>

        <div style="margin: 20px 0;">
            <h2>Ø¨Ø§Ø²ÛŒÚ©Ù†Ø§Ù† Ù¾ÛŒÙˆØ³ØªÙ‡ (<span id="joined-count">0</span> / <span id="required-count">7</span>)</h2>
            <div id="joined-players-list" class="player-list" style="margin-top: 15px; min-height: 100px;">
                <div style="text-align: center; color: var(--text-secondary); padding: 20px;">
                    Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø§Ø²ÛŒÚ©Ù†Ø§Ù†...
                </div>
            </div>
        </div>

        <button id="start-game-btn" class="action-btn" onclick="confirmStartGame()" disabled>
            Ø´Ø±ÙˆØ¹ Ø¨Ø§Ø²ÛŒ
        </button>
        <p id="start-game-hint" style="font-size: 0.9rem; color: var(--text-secondary); margin-top: 10px;">
            Ù…Ù†ØªØ¸Ø± Ø¨Ù…Ø§Ù†ÛŒØ¯ ØªØ§ Ù‡Ù…Ù‡ Ø¨Ø§Ø²ÛŒÚ©Ù†Ø§Ù† Ø¨Ù¾ÛŒÙˆÙ†Ø¯Ù†Ø¯
        </p>
    </div>

    <!-- 3. Player Waiting Screen -->
    <div id="player-waiting" class="container hidden">
        <h1>Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± Ø´Ø±ÙˆØ¹ Ø¨Ø§Ø²ÛŒ</h1>
        <div class="game-id-display">
            <div>Ø´Ù†Ø§Ø³Ù‡ Ø¨Ø§Ø²ÛŒ:</div>
            <div id="waiting-game-id" style="font-size: 1.5rem; margin-top: 10px;"></div>
        </div>
        <div style="margin: 20px 0;">
            <div class="waiting-message">
                <div class="pulsing">â³ Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± Ø´Ø±ÙˆØ¹ Ø¨Ø§Ø²ÛŒ ØªÙˆØ³Ø· Ø³Ø§Ø²Ù†Ø¯Ù‡...</div>
            </div>
            <div style="margin-top: 20px;">
                <h3>Ø¨Ø§Ø²ÛŒÚ©Ù†Ø§Ù† Ù¾ÛŒÙˆØ³ØªÙ‡:</h3>
                <div id="waiting-players-list" class="player-list" style="margin-top: 15px;"></div>
            </div>
        </div>
    </div>


    <!-- 4. Player View -->
    <div id="player-view" class="container hidden">
        <h1>Ø®ÙˆÙ† Ø¨Ø± Ø¨Ø±Ø¬ Ø³Ø§Ø¹Øª</h1>
        <div id="player-name-display" style="font-size: 1.2rem; color: var(--accent-color); margin: 10px 0;"></div>
        
        <div id="player-role-card" class="role-card hidden">
            <div id="player-role-title" class="role-title"></div>
            <div id="player-role-desc" style="margin-top: 10px;"></div>
            <div id="player-role-extra" style="margin-top: 15px;"></div>
        </div>

        <div id="player-night-action" class="hidden">
            <div class="info-box">
                <h2 id="night-action-title"></h2>
                <div id="night-action-content"></div>
            </div>
        </div>

        <div id="player-day-view" class="hidden">
            <div class="phase-display phase-day">
                <h2 id="day-phase-title">ÙØ§Ø² Ø±ÙˆØ²</h2>
                <div id="day-phase-info" style="margin-top: 15px;">
                    <div style="display: flex; justify-content: space-around; margin: 15px 0;">
                        <div>
                            <div style="font-size: 0.9rem; color: var(--text-secondary);">Ø²Ù†Ø¯Ù‡</div>
                            <div id="day-living-count" style="font-size: 1.5rem; font-weight: bold;">0</div>
                        </div>
                        <div>
                            <div style="font-size: 0.9rem; color: var(--text-secondary);">Ø±ÙˆØ²</div>
                            <div id="day-current-day" style="font-size: 1.5rem; font-weight: bold;">1</div>
                        </div>
                        <div>
                            <div style="font-size: 0.9rem; color: var(--text-secondary);">Ø§Ø¹Ø¯Ø§Ù…â€ŒÙ‡Ø§</div>
                            <div id="day-execution-count" style="font-size: 1.5rem; font-weight: bold;">0</div>
                        </div>
                    </div>
                    <div id="day-players-list" class="player-list" style="margin-top: 20px;"></div>
                </div>
            </div>
        </div>

        <div id="player-info-history" style="margin-top: 20px; text-align: right;"></div>

        <div class="waiting-message hidden" id="waiting-message">
            <div class="pulsing">â³ Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± Ø´Ø±ÙˆØ¹ Ø¨Ø§Ø²ÛŒ...</div>
        </div>
    </div>

    <!-- Night Action Modal (for player) -->
    <div id="night-action-modal" class="modal-overlay hidden">
        <div class="container" style="max-width:500px;">
            <h2 id="modal-night-title"></h2>
            <div id="modal-night-content"></div>
            <button class="action-btn" onclick="closeNightModal()">ØªØ§ÛŒÛŒØ¯</button>
        </div>
    </div>

    <script>
        // Character definitions (same as original)
        var CHARACTER_DISTRIBUTION = {
            5: { townsfolk: 3, outsiders: 0, minions: 1, demon: 1 },
            6: { townsfolk: 3, outsiders: 1, minions: 1, demon: 1 },
            7: { townsfolk: 5, outsiders: 0, minions: 1, demon: 1 },
            8: { townsfolk: 5, outsiders: 1, minions: 1, demon: 1 },
            9: { townsfolk: 5, outsiders: 2, minions: 1, demon: 1 },
            10: { townsfolk: 7, outsiders: 0, minions: 2, demon: 1 },
            11: { townsfolk: 7, outsiders: 1, minions: 2, demon: 1 },
            12: { townsfolk: 7, outsiders: 2, minions: 2, demon: 1 },
            13: { townsfolk: 9, outsiders: 0, minions: 3, demon: 1 },
            14: { townsfolk: 9, outsiders: 1, minions: 3, demon: 1 },
            15: { townsfolk: 9, outsiders: 2, minions: 3, demon: 1 }
        };

        var CHARACTERS = {
            'Washerwoman': { name: 'Ø±Ø®Øªâ€ŒØ´ÙˆÛŒ', type: 'townsfolk', ability: 'Ø¯Ø± Ø´Ø¨ Ø§ÙˆÙ„ØŒ Ù…ØªÙˆØ¬Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÛŒØ¯ Ú©Ù‡ ÛŒÚ©ÛŒ Ø§Ø² Ø¯Ùˆ Ø¨Ø§Ø²ÛŒÚ©Ù† Ù…Ø´Ø®ØµØŒ ÛŒÚ© Ø´Ø®ØµÛŒØª Ø´Ù‡Ø±ÙˆÙ†Ø¯ Ø®Ø§Øµ Ø§Ø³Øª.', nightOrder: 1 },
            'Librarian': { name: 'Ú©ØªØ§Ø¨Ø¯Ø§Ø±', type: 'townsfolk', ability: 'Ø¯Ø± Ø´Ø¨ Ø§ÙˆÙ„ØŒ Ù…ØªÙˆØ¬Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÛŒØ¯ Ú©Ù‡ ÛŒÚ©ÛŒ Ø§Ø² Ø¯Ùˆ Ø¨Ø§Ø²ÛŒÚ©Ù† Ù…Ø´Ø®ØµØŒ ÛŒÚ© Ø´Ø®ØµÛŒØª ØºØ±ÛŒØ¨Ù‡ Ø®Ø§Øµ Ø§Ø³Øª.', nightOrder: 2 },
            'Investigator': { name: 'Ø¨Ø§Ø²Ù¾Ø±Ø³', type: 'townsfolk', ability: 'Ø¯Ø± Ø´Ø¨ Ø§ÙˆÙ„ØŒ Ù…ØªÙˆØ¬Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÛŒØ¯ Ú©Ù‡ ÛŒÚ©ÛŒ Ø§Ø² Ø¯Ùˆ Ø¨Ø§Ø²ÛŒÚ©Ù† Ù…Ø´Ø®ØµØŒ ÛŒÚ© Ø´Ø®ØµÛŒØª Ø®Ø§Ø¯Ù… Ø´ÛŒØ·Ø§Ù† Ø®Ø§Øµ Ø§Ø³Øª.', nightOrder: 3 },
            'Chef': { name: 'Ø¢Ø´Ù¾Ø²', type: 'townsfolk', ability: 'Ø¯Ø± Ø´Ø¨ Ø§ÙˆÙ„ØŒ Ù…ØªÙˆØ¬Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÛŒØ¯ Ú†Ù†Ø¯ Ø¬ÙØª Ø¨Ø§Ø²ÛŒÚ©Ù† Ø´Ø±ÛŒØ± Ú©Ù†Ø§Ø± Ù‡Ù… Ù†Ø´Ø³ØªÙ‡â€ŒØ§Ù†Ø¯.', nightOrder: 4 },
            'Empath': { name: 'Ù‡Ù…â€ŒØ¯Ù„', type: 'townsfolk', ability: 'Ù‡Ø± Ø´Ø¨ØŒ Ù…ØªÙˆØ¬Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÛŒØ¯ Ú†Ù†Ø¯ Ø¨Ø§Ø²ÛŒÚ©Ù† Ø´Ø±ÛŒØ± Ø¯Ø± Ú©Ù†Ø§Ø± Ø´Ù…Ø§ Ù†Ø´Ø³ØªÙ‡â€ŒØ§Ù†Ø¯.', nightOrder: 5 },
            'Fortune Teller': { name: 'ÙØ§Ù„â€ŒÚ¯ÛŒØ±', type: 'townsfolk', ability: 'Ù‡Ø± Ø´Ø¨ØŒ Ø¯Ùˆ Ø¨Ø§Ø²ÛŒÚ©Ù† Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ù…ÛŒâ€ŒÚ©Ù†ÛŒØ¯ Ùˆ Ù…ØªÙˆØ¬Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÛŒØ¯ Ø¢ÛŒØ§ ÛŒÚ©ÛŒ Ø§Ø² Ø¢Ù†Ù‡Ø§ Ø´ÛŒØ·Ø§Ù† Ø§Ø³Øª ÛŒØ§ Ø®ÛŒØ±.', nightOrder: 6 },
            'Undertaker': { name: 'Ù…Ø±Ø¯Ù‡â€ŒØ´ÙˆÛŒ', type: 'townsfolk', ability: 'Ù‡Ø± Ø±ÙˆØ²ØŒ Ø§Ú¯Ø± Ú©Ø³ÛŒ Ø¯Ø± Ø±ÙˆØ² Ù‚Ø¨Ù„ Ø§Ø¹Ø¯Ø§Ù… Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯ØŒ Ø´Ø®ØµÛŒØª Ø§Ùˆ Ø±Ø§ Ù…ÛŒâ€ŒÙÙ‡Ù…ÛŒØ¯.', nightOrder: 7 },
            'Monk': { name: 'Ø±Ø§Ù‡Ø¨', type: 'townsfolk', ability: 'Ù‡Ø± Ø´Ø¨ØŒ ÛŒÚ© Ø¨Ø§Ø²ÛŒÚ©Ù† Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ù…ÛŒâ€ŒÚ©Ù†ÛŒØ¯ Ùˆ Ø¢Ù†Ù‡Ø§ Ø¯Ø± Ø¢Ù† Ø´Ø¨ Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ù†Ø¯ Ø¨Ù…ÛŒØ±Ù†Ø¯.', nightOrder: 8 },
            'Ravenkeeper': { name: 'Ù†Ú¯Ù‡Ø¨Ø§Ù† Ø²Ø§Øº', type: 'townsfolk', ability: 'Ø§Ú¯Ø± Ø¯Ø± Ø´Ø¨ Ø¨Ù…ÛŒØ±ÛŒØ¯ØŒ ÛŒÚ© Ø¨Ø§Ø²ÛŒÚ©Ù† Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ù…ÛŒâ€ŒÚ©Ù†ÛŒØ¯ Ùˆ Ø´Ø®ØµÛŒØª Ø§Ùˆ Ø±Ø§ Ù…ÛŒâ€ŒÙÙ‡Ù…ÛŒØ¯.', nightOrder: 9 },
            'Virgin': { name: 'Ø¨Ø§Ú©Ø±Ù‡', type: 'townsfolk', ability: 'Ø§ÙˆÙ„ÛŒÙ† Ø¨Ø§Ø±ÛŒ Ú©Ù‡ Ù†Ø§Ù…Ø²Ø¯ Ø§Ø¹Ø¯Ø§Ù… Ù…ÛŒâ€ŒØ´ÙˆÛŒØ¯ØŒ Ø§Ú¯Ø± Ù†Ø§Ù…Ø²Ø¯Ú©Ù†Ù†Ø¯Ù‡ Ø´Ù…Ø§ ÛŒÚ© Ø´Ù‡Ø±ÙˆÙ†Ø¯ Ø¨Ø§Ø´Ø¯ØŒ Ø¨Ù‡ Ø¬Ø§ÛŒ Ø´Ù…Ø§ Ø§Ø¹Ø¯Ø§Ù… Ù…ÛŒâ€ŒØ´ÙˆØ¯.', nightOrder: 10 },
            'Slayer': { name: 'Ø³Ù„Ø§Ø®', type: 'townsfolk', ability: 'ÛŒÚ© Ø¨Ø§Ø± Ø¯Ø± Ø·ÙˆÙ„ Ø¨Ø§Ø²ÛŒØŒ Ø¯Ø± Ø·ÙˆÙ„ Ø±ÙˆØ² Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ ÛŒÚ© Ø¨Ø§Ø²ÛŒÚ©Ù† Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯. Ø§Ú¯Ø± Ø¢Ù†Ù‡Ø§ Ø´ÛŒØ·Ø§Ù† Ø¨Ø§Ø´Ù†Ø¯ØŒ ÙÙˆØ±Ø§Ù‹ Ù…ÛŒâ€ŒÙ…ÛŒØ±Ù†Ø¯.', nightOrder: 11 },
            'Soldier': { name: 'Ø³Ø±Ø¨Ø§Ø²', type: 'townsfolk', ability: 'Ø´Ù…Ø§ Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø¯Ø± Ø´Ø¨ Ø¨Ù…ÛŒØ±ÛŒØ¯.', nightOrder: 12 },
            'Mayor': { name: 'Ø´Ù‡Ø±Ø¯Ø§Ø±', type: 'townsfolk', ability: 'Ø§Ú¯Ø± ÙÙ‚Ø· Û³ Ø¨Ø§Ø²ÛŒÚ©Ù† Ø²Ù†Ø¯Ù‡ Ø¨Ø§Ù‚ÛŒ Ø¨Ù…Ø§Ù†Ø¯ Ùˆ Ø´Ù…Ø§ Ø¨Ù…ÛŒØ±ÛŒØ¯ØŒ ØªÛŒÙ… Ø®ÙˆØ¨ Ø¨Ø±Ù†Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.', nightOrder: 13 },
            'Butler': { name: 'Ù¾ÛŒØ´Ø®Ø¯Ù…Øª', type: 'outsider', ability: 'Ù‡Ø± Ø´Ø¨ØŒ ÛŒÚ© Ø¨Ø§Ø²ÛŒÚ©Ù† Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ù…ÛŒâ€ŒÚ©Ù†ÛŒØ¯. ÙØ±Ø¯Ø§ØŒ Ø¨Ø§ÛŒØ¯ Ù‡Ù…Ø§Ù†â€ŒØ·ÙˆØ± Ú©Ù‡ Ø¢Ù†Ù‡Ø§ Ø±Ø§ÛŒ Ù…ÛŒâ€ŒØ¯Ù‡Ù†Ø¯ Ø±Ø§ÛŒ Ø¯Ù‡ÛŒØ¯.', nightOrder: 14 },
            'Drunk': { name: 'Ù…Ø³Øª', type: 'outsider', ability: 'Ø´Ù…Ø§ ÙÚ©Ø± Ù…ÛŒâ€ŒÚ©Ù†ÛŒØ¯ ÛŒÚ© Ø´Ù‡Ø±ÙˆÙ†Ø¯ Ù‡Ø³ØªÛŒØ¯ØŒ Ø§Ù…Ø§ Ø¯Ø± ÙˆØ§Ù‚Ø¹ ÛŒÚ© ØºØ±ÛŒØ¨Ù‡ Ù‡Ø³ØªÛŒØ¯.', nightOrder: 15 },
            'Recluse': { name: 'Ú¯ÙˆØ´Ù‡â€ŒÙ†Ø´ÛŒÙ†', type: 'outsider', ability: 'Ø´Ù…Ø§ Ù…Ù…Ú©Ù† Ø§Ø³Øª Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ø´Ø±ÛŒØ± Ø¨Ø±Ø§ÛŒ Ø³Ø§ÛŒØ± ØªÙˆØ§Ù†Ø§ÛŒÛŒâ€ŒÙ‡Ø§ Ø¸Ø§Ù‡Ø± Ø´ÙˆÛŒØ¯.', nightOrder: 16 },
            'Saint': { name: 'Ù‚Ø¯ÛŒØ³', type: 'outsider', ability: 'Ø§Ú¯Ø± Ø´Ù…Ø§ Ø§Ø¹Ø¯Ø§Ù… Ø´ÙˆÛŒØ¯ØŒ ØªÛŒÙ… Ø´Ø±ÛŒØ± ÙÙˆØ±Ø§Ù‹ Ø¨Ø±Ù†Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.', nightOrder: 17 },
            'Poisoner': { name: 'Ø²Ù‡Ø±Ø¢Ú¯ÛŒÙ†', type: 'minion', ability: 'Ù‡Ø± Ø´Ø¨ØŒ ÛŒÚ© Ø¨Ø§Ø²ÛŒÚ©Ù† Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ù…ÛŒâ€ŒÚ©Ù†ÛŒØ¯ Ùˆ ØªÙˆØ§Ù†Ø§ÛŒÛŒ Ø¢Ù†Ù‡Ø§ Ø®Ø±Ø§Ø¨ Ù…ÛŒâ€ŒØ´ÙˆØ¯.', nightOrder: 18 },
            'Spy': { name: 'Ø¬Ø§Ø³ÙˆØ³', type: 'minion', ability: 'Ø´Ù…Ø§ Ø¨Ø±Ø§ÛŒ Ù‡Ù…Ù‡ ØªÙˆØ§Ù†Ø§ÛŒÛŒâ€ŒÙ‡Ø§ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ø¨Ø§Ø²ÛŒÚ©Ù† Ø®ÙˆØ¨ Ø¸Ø§Ù‡Ø± Ù…ÛŒâ€ŒØ´ÙˆÛŒØ¯.', nightOrder: 19 },
            'Scarlet Woman': { name: 'Ø²Ù† Ø³Ø±Ø®', type: 'minion', ability: 'Ø§Ú¯Ø± Ø´ÛŒØ·Ø§Ù† Ø¨Ù…ÛŒØ±Ø¯ Ùˆ Ûµ ÛŒØ§ Ø¨ÛŒØ´ØªØ± Ø¨Ø§Ø²ÛŒÚ©Ù† Ø²Ù†Ø¯Ù‡ Ø¨Ø§Ø´Ù†Ø¯ØŒ Ø´Ù…Ø§ ØªØ¨Ø¯ÛŒÙ„ Ø¨Ù‡ Ø´ÛŒØ·Ø§Ù† Ù…ÛŒâ€ŒØ´ÙˆÛŒØ¯.', nightOrder: 20 },
            'Baron': { name: 'Ø¨Ø§Ø±ÙˆÙ†', type: 'minion', ability: 'Û² ØºØ±ÛŒØ¨Ù‡ Ø§Ø¶Ø§ÙÛŒ Ø¯Ø± Ø¨Ø§Ø²ÛŒ Ù‡Ø³ØªÙ†Ø¯.', nightOrder: null },
            'Imp': { name: 'Ø´ÛŒØ·Ø§Ù†', type: 'demon', ability: 'Ù‡Ø± Ø´Ø¨ØŒ ÛŒÚ© Ø¨Ø§Ø²ÛŒÚ©Ù† Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ù…ÛŒâ€ŒÚ©Ù†ÛŒØ¯ Ùˆ Ø¢Ù†Ù‡Ø§ Ù…ÛŒâ€ŒÙ…ÛŒØ±Ù†Ø¯.', nightOrder: 21 }
        };

        var ROLE_ICONS = {
            'Washerwoman': 'ğŸ§º', 'Librarian': 'ğŸ“š', 'Investigator': 'ğŸ”', 'Chef': 'ğŸ‘¨â€ğŸ³',
            'Empath': 'ğŸ‘ï¸', 'Fortune Teller': 'ğŸ”®', 'Undertaker': 'âš°ï¸', 'Monk': 'ğŸ›¡ï¸',
            'Ravenkeeper': 'ğŸ¦â€â¬›', 'Virgin': 'ğŸ‘—', 'Slayer': 'âš”ï¸', 'Soldier': 'ğŸ’‚',
            'Mayor': 'ğŸ—³ï¸', 'Butler': 'ğŸ›ï¸', 'Drunk': 'ğŸº', 'Recluse': 'ğŸšï¸',
            'Saint': 'ğŸ˜‡', 'Poisoner': 'â˜ ï¸', 'Spy': 'ğŸ•µï¸', 'Scarlet Woman': 'ğŸ’ƒ',
            'Baron': 'ğŸ‘‘', 'Imp': 'ğŸ‘¹'
        };

        var ALL_TOWNSFOLK = ['Washerwoman', 'Librarian', 'Investigator', 'Chef', 'Empath', 'Fortune Teller', 'Undertaker', 'Monk', 'Ravenkeeper', 'Virgin', 'Slayer', 'Soldier', 'Mayor'];
        var ALL_OUTSIDERS = ['Butler', 'Drunk', 'Recluse', 'Saint'];
        var ALL_MINIONS = ['Poisoner', 'Spy', 'Scarlet Woman', 'Baron'];
        var ALL_DEMONS = ['Imp'];

        // API Configuration
        // Auto-detect server URL, or use default
        var API_BASE_URL = window.location.origin;
        
        // If on GitHub Pages or file://, try to use saved URL or default
        if (API_BASE_URL === 'file://' || API_BASE_URL === 'null' || !API_BASE_URL || 
            API_BASE_URL.includes('github.io')) {
            // Check for saved server URL first
            var savedUrl = localStorage.getItem('botc_server_url');
            if (savedUrl) {
                API_BASE_URL = savedUrl;
            } else {
                // Default to localhost for local testing, or set your deployed server URL here
                API_BASE_URL = 'http://localhost:3000';
                // For production, uncomment and set your server URL:
                // API_BASE_URL = 'https://your-server.railway.app';
            }
        }
        
        // Game state
        var gameId = null;
        var isGameCreator = false; // Person who creates game (only for setup, then becomes regular player)
        var playerName = null;
        var playerIndex = -1;
        var gameState = null;
        var pollInterval = null;

        // Game state (shared by all)
        var gameStateTemplate = {
            playerCount: 7,
            joinedPlayers: [], // Array of {name: string, joinedAt: timestamp}
            creatorName: '',
            players: [], // Assigned after game starts
            currentDay: 1,
            isNightPhase: true,
            currentNightOrder: [],
            nightIndex: 0,
            gameStarted: false,
            distributionComplete: false,
            executions: 0
        };

        async function updateServerUrl() {
            var manualUrl = document.getElementById('manual-server-url').value.trim();
            if (!manualUrl) {
                alert('Ù„Ø·ÙØ§ Ø¢Ø¯Ø±Ø³ Ø³Ø±ÙˆØ± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
                return;
            }
            
            // Remove trailing slash
            if (manualUrl.endsWith('/')) {
                manualUrl = manualUrl.slice(0, -1);
            }
            
            API_BASE_URL = manualUrl;
            localStorage.setItem('botc_server_url', API_BASE_URL);
            document.getElementById('server-url-text').textContent = API_BASE_URL;
            
            // Test connection
            document.getElementById('server-status-text').textContent = 'Ø¯Ø± Ø­Ø§Ù„ ØªØ³Øª Ø§ØªØµØ§Ù„...';
            await checkServerConnection();
            
            if (document.getElementById('server-status-text').textContent.includes('Ù…ØªØµÙ„')) {
                alert('Ø§ØªØµØ§Ù„ Ù…ÙˆÙÙ‚! Ø­Ø§Ù„Ø§ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø¨Ø§Ø²ÛŒ Ø±Ø§ Ø±ÙˆÛŒ Ú†Ù†Ø¯ Ø¯Ø³ØªÚ¯Ø§Ù‡ ØªØ³Øª Ú©Ù†ÛŒØ¯.');
            }
        }

        async function checkServerConnection() {
            // Display server URL
            document.getElementById('server-url-text').textContent = API_BASE_URL;
            
            // Check if opened from file://
            if (window.location.protocol === 'file:') {
                document.getElementById('file-protocol-warning').style.display = 'block';
                document.getElementById('server-config').style.display = 'block';
                document.getElementById('manual-server-url').value = API_BASE_URL;
                document.getElementById('server-status-text').textContent = 'ÙØ§ÛŒÙ„ Ù…Ø³ØªÙ‚ÛŒÙ…Ø§Ù‹ Ø¨Ø§Ø² Ø´Ø¯Ù‡ Ø§Ø³Øª';
                return;
            }
            
            // If on GitHub Pages, use localStorage (no server needed)
            if (window.location.hostname.includes('github.io')) {
                document.getElementById('server-status-text').textContent = 'Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² localStorage (ÙÙ‚Ø· Ù‡Ù…Ø§Ù† Ø¯Ø³ØªÚ¯Ø§Ù‡)';
                document.getElementById('server-status').style.background = 'rgba(255, 193, 7, 0.2)';
                document.getElementById('server-status').style.borderColor = '#ffc107';
                return;
            }
            
            // Check server connection (only for custom servers)
            try {
                const response = await fetch(API_BASE_URL + '/api/health');
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('server-status-text').textContent = 'Ù…ØªØµÙ„ (' + data.gamesCount + ' Ø¨Ø§Ø²ÛŒ ÙØ¹Ø§Ù„)';
                    document.getElementById('server-status').style.background = 'rgba(76, 175, 80, 0.2)';
                    document.getElementById('server-status').style.borderColor = '#4caf50';
                    document.getElementById('file-protocol-warning').style.display = 'none';
                } else {
                    document.getElementById('server-status-text').textContent = 'Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ - Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² localStorage';
                    document.getElementById('server-status').style.background = 'rgba(255, 193, 7, 0.2)';
                    document.getElementById('server-status').style.borderColor = '#ffc107';
                    document.getElementById('server-config').style.display = 'block';
                }
            } catch (error) {
                document.getElementById('server-status-text').textContent = 'Ø³Ø±ÙˆØ± Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†ÛŒØ³Øª - Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² localStorage';
                document.getElementById('server-status').style.background = 'rgba(255, 193, 7, 0.2)';
                document.getElementById('server-status').style.borderColor = '#ffc107';
                document.getElementById('server-config').style.display = 'block';
                console.log('Server not available, will use localStorage');
            }
        }

        // Initialize
        window.onload = async function() {
            // Load saved server URL if exists (override the initial setting)
            var savedUrl = localStorage.getItem('botc_server_url');
            if (savedUrl) {
                API_BASE_URL = savedUrl;
            }
            
            // If on GitHub Pages, use localStorage (works on same device)
            if (window.location.hostname.includes('github.io')) {
                document.getElementById('server-config').style.display = 'block';
                document.getElementById('file-protocol-warning').innerHTML = 
                    '<strong>â„¹ï¸ Ø§Ø·Ù„Ø§Ø¹Ø§Øª:</strong> Ø´Ù…Ø§ Ø§Ø² GitHub Pages Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒØ¯. Ø¨Ø§Ø²ÛŒ Ø§Ø² localStorage Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†Ø¯ Ú©Ù‡ ÙÙ‚Ø· Ø±ÙˆÛŒ Ù‡Ù…Ø§Ù† Ø¯Ø³ØªÚ¯Ø§Ù‡/Ù…Ø±ÙˆØ±Ú¯Ø± Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ø¯.<br><br>' +
                    '<strong>Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø²ÛŒ Ø±ÙˆÛŒ Ú†Ù†Ø¯ Ø¯Ø³ØªÚ¯Ø§Ù‡:</strong> Ø³Ø±ÙˆØ± Ø±Ø§ Ø±ÙˆÛŒ Render (Ø±Ø§ÛŒÚ¯Ø§Ù†) deploy Ú©Ù†ÛŒØ¯ Ùˆ Ø¢Ø¯Ø±Ø³ Ø¢Ù† Ø±Ø§ Ø¯Ø± Ø²ÛŒØ± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.';
                document.getElementById('file-protocol-warning').style.display = 'block';
                // Disable server check for GitHub Pages (will use localStorage)
                API_BASE_URL = 'https://github.io'; // Dummy to trigger localStorage fallback
            }
            
            await checkServerConnection();
            
            // Check URL parameters
            var urlParams = new URLSearchParams(window.location.search);
            var urlGameId = urlParams.get('gameId');
            var urlPlayerName = urlParams.get('playerName');
            
            if (urlGameId && urlPlayerName) {
                // Auto-join if URL parameters present
                document.getElementById('join-game-id').value = urlGameId;
                document.getElementById('join-player-name').value = urlPlayerName;
                joinGame();
            } else {
                showScreen('room-screen');
            }
        };

        function showScreen(screenId) {
            document.querySelectorAll('.container').forEach(el => el.classList.add('hidden'));
            document.getElementById(screenId).classList.remove('hidden');
        }

        function generateGameId() {
            return Math.floor(100 + Math.random() * 900).toString(); // 3-digit number (100-999)
        }

        async function createGame() {
            var name = document.getElementById('storyteller-name').value.trim();
            if (!name) {
                alert('Ù„Ø·ÙØ§ Ù†Ø§Ù… Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
                return;
            }

            gameId = generateGameId();
            isGameCreator = true;
            playerName = name;

            // Initialize game state
            gameState = JSON.parse(JSON.stringify(gameStateTemplate));
            gameState.playerCount = 7;
            gameState.creatorName = name;
            // Creator joins automatically
            gameState.joinedPlayers = [{ name: name, joinedAt: Date.now() }];

            // Try to create on server, fallback to localStorage
            var created = false;
            if (API_BASE_URL && !API_BASE_URL.includes('github.io') && API_BASE_URL !== 'file://') {
                try {
                    const response = await fetch(API_BASE_URL + '/api/games', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ gameId: gameId, gameState: gameState })
                    });
                    
                    if (response.ok) {
                        created = true;
                        console.log('Game created on server:', gameId);
                    }
                } catch (error) {
                    console.log('Server not available, using localStorage');
                }
            }
            
            if (!created) {
                // Use localStorage fallback
                await saveGameState();
                console.log('Game created in localStorage:', gameId);
            }

            document.getElementById('display-game-id').innerText = gameId;
            showScreen('creator-lobby');
            setupBroadcastListener(gameId);
            startPolling();
            updateCreatorLobby();
        }

        async function joinGame() {
            var id = document.getElementById('join-game-id').value.trim();
            var name = document.getElementById('join-player-name').value.trim();
            
            if (!id || !name) {
                alert('Ù„Ø·ÙØ§ Ø´Ù†Ø§Ø³Ù‡ Ø¨Ø§Ø²ÛŒ Ùˆ Ù†Ø§Ù… Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
                return;
            }

            gameId = id;
            playerName = name;
            isGameCreator = false;

            // Try to load game state
            await loadGameState();
            
            if (!gameState) {
                alert('Ø¨Ø§Ø²ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯. Ù„Ø·ÙØ§ Ù…Ø·Ù…Ø¦Ù† Ø´ÙˆÛŒØ¯:\n1. Ø´Ù†Ø§Ø³Ù‡ Ø¨Ø§Ø²ÛŒ ØµØ­ÛŒØ­ Ø§Ø³Øª\n2. Ø³Ø±ÙˆØ± Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§ Ø§Ø³Øª\n3. Ù‡Ù…Ù‡ Ø¯Ø³ØªÚ¯Ø§Ù‡â€ŒÙ‡Ø§ Ø¨Ù‡ Ù‡Ù…Ø§Ù† Ø³Ø±ÙˆØ± Ù…ØªØµÙ„ Ù‡Ø³ØªÙ†Ø¯');
                console.error('Game not found. GameId:', gameId, 'API URL:', API_BASE_URL);
                return;
            }

            // Check if game has started
            if (gameState.gameStarted) {
                // Game already started, find player and show game view
                playerIndex = -1;
                for (var i = 0; i < gameState.players.length; i++) {
                    if (gameState.players[i].name === name) {
                        playerIndex = i;
                        break;
                    }
                }
                if (playerIndex === -1) {
                    alert('Ù†Ø§Ù… Ø´Ù…Ø§ Ø¯Ø± Ù„ÛŒØ³Øª Ø¨Ø§Ø²ÛŒÚ©Ù†Ø§Ù† Ù†ÛŒØ³Øª.');
                    return;
                }
                showPlayerView();
                startPolling();
                return;
            }

            // Game not started - join lobby
            var alreadyJoined = gameState.joinedPlayers.some(p => p.name === name);
            if (!alreadyJoined) {
                // Add player to joined list
                gameState.joinedPlayers.push({ name: name, joinedAt: Date.now() });
                await saveGameState();
            }

            // Show waiting screen
            document.getElementById('waiting-game-id').innerText = gameId;
            showScreen('player-waiting');
            setupBroadcastListener(gameId);
            startPolling();
            updatePlayerWaiting();
        }

        // Use a free backend service: httpbin.org for testing, or a simple storage service
        // For production, this should be replaced with a proper backend
        var USE_FREE_STORAGE = true; // Use free storage service for GitHub Pages
        
        async function saveGameState() {
            if (!gameId || !gameState) return;
            
            // Try custom server first (if configured and not GitHub Pages)
            var useCustomServer = API_BASE_URL && !API_BASE_URL.includes('github.io') && 
                                 API_BASE_URL !== 'file://' && API_BASE_URL !== 'https://github.io' &&
                                 API_BASE_URL.startsWith('http') && API_BASE_URL.includes('://');
            
            if (useCustomServer) {
                try {
                    const response = await fetch(API_BASE_URL + '/api/games/' + gameId, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ gameState: gameState })
                    });
                    
                    if (response.ok) {
                        return; // Success with custom server
                    }
                    
                    if (response.status === 404) {
                        await fetch(API_BASE_URL + '/api/games', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ gameId: gameId, gameState: gameState })
                        });
                        return;
                    }
                } catch (error) {
                    console.log('Custom server failed, using alternative storage...');
                }
            }
            
            // For GitHub Pages: Use localStorage + share mechanism
            // Store in localStorage (primary storage)
            try {
                var storageKey = 'botc_game_' + gameId;
                var gameData = {
                    gameState: gameState,
                    lastUpdated: Date.now(),
                    gameId: gameId
                };
                localStorage.setItem(storageKey, JSON.stringify(gameData));
                
                // Broadcast to other tabs on same origin
                if (typeof BroadcastChannel !== 'undefined') {
                    try {
                        var channel = new BroadcastChannel('botc_' + gameId);
                        channel.postMessage({ type: 'update', data: gameData });
                        setTimeout(() => channel.close(), 100);
                    } catch (e) {}
                }
            } catch (error) {
                console.error('Error saving to localStorage:', error);
            }
        }

        async function loadGameState() {
            if (!gameId) return;
            
            // Try custom server first
            var useCustomServer = API_BASE_URL && !API_BASE_URL.includes('github.io') && 
                                 API_BASE_URL !== 'file://' && API_BASE_URL !== 'https://github.io' &&
                                 API_BASE_URL.startsWith('http') && API_BASE_URL.includes('://');
            
            if (useCustomServer) {
                try {
                    const response = await fetch(API_BASE_URL + '/api/games/' + gameId);
                    if (response.ok) {
                        gameState = await response.json();
                        return;
                    }
                } catch (error) {
                    console.log('Custom server failed, trying localStorage...');
                }
            }
            
            // Load from localStorage
            try {
                var storageKey = 'botc_game_' + gameId;
                var stored = localStorage.getItem(storageKey);
                if (stored) {
                    var gameData = JSON.parse(stored);
                    gameState = gameData.gameState;
                } else {
                    gameState = null;
                }
            } catch (error) {
                console.error('Error loading from localStorage:', error);
                gameState = null;
            }
        }
        
        // Setup BroadcastChannel listener for cross-tab sync
        var broadcastChannels = {};
        function setupBroadcastListener(gameId) {
            if (typeof BroadcastChannel === 'undefined') return;
            
            if (broadcastChannels[gameId]) {
                broadcastChannels[gameId].close();
            }
            
            var channel = new BroadcastChannel('botc_' + gameId);
            channel.onmessage = function(event) {
                if (event.data.type === 'update') {
                    var newTime = event.data.data.lastUpdated;
                    var currentTime = gameState && gameState._lastUpdated ? gameState._lastUpdated : 0;
                    if (newTime > currentTime) {
                        gameState = event.data.data.gameState;
                        gameState._lastUpdated = newTime;
                        // Update UI
                        if (isGameCreator && !gameState.gameStarted) {
                            updateCreatorLobby();
                        } else if (!isGameCreator && !gameState.gameStarted) {
                            updatePlayerWaiting();
                        } else if (gameState.gameStarted) {
                            updatePlayerView();
                        }
                    }
                }
            };
            broadcastChannels[gameId] = channel;
        }

        function startPolling() {
            if (pollInterval) clearInterval(pollInterval);
            pollInterval = setInterval(async function() {
                await loadGameState();
                if (!gameState) return;
                
                if (isGameCreator && !gameState.gameStarted) {
                    // Game creator in lobby
                    updateCreatorLobby();
                } else if (!isGameCreator && !gameState.gameStarted) {
                    // Player waiting in lobby
                    updatePlayerWaiting();
                } else if (gameState.gameStarted) {
                    // Game has started - show game view
                    if (playerIndex === -1) {
                        // Find player index
                        for (var i = 0; i < gameState.players.length; i++) {
                            if (gameState.players[i].name === playerName) {
                                playerIndex = i;
                                break;
                            }
                        }
                    }
                    if (playerIndex !== -1) {
                        // Switch to game view if still in waiting/lobby screen
                        var currentScreen = document.querySelector('.container:not(.hidden)');
                        if (currentScreen && (currentScreen.id === 'player-waiting' || currentScreen.id === 'creator-lobby')) {
                            showPlayerView();
                        }
                        updatePlayerView();
                    }
                }
            }, 1000); // Poll every second
        }

        function updatePlayerCount(delta) {
            if (!gameState) return;
            var newCount = gameState.playerCount + delta;
            if (newCount >= 5 && newCount <= 15) {
                gameState.playerCount = newCount;
                document.getElementById('player-count-display').innerText = gameState.playerCount;
                document.getElementById('required-count').innerText = gameState.playerCount;
                saveGameState(); // Fire and forget
                updateCreatorLobby();
            }
        }

        function updateCreatorLobby() {
            if (!gameState || !isGameCreator) return;
            
            var joinedCount = gameState.joinedPlayers.length;
            var requiredCount = gameState.playerCount;
            
            document.getElementById('joined-count').innerText = joinedCount;
            document.getElementById('required-count').innerText = requiredCount;
            
            // Update joined players list
            var listContainer = document.getElementById('joined-players-list');
            if (joinedCount === 0) {
                listContainer.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø§Ø²ÛŒÚ©Ù†Ø§Ù†...</div>';
            } else {
                listContainer.innerHTML = '';
                gameState.joinedPlayers.forEach(function(player) {
                    var item = document.createElement('div');
                    item.className = 'player-item';
                    item.innerText = player.name;
                    listContainer.appendChild(item);
                });
            }
            
            // Enable/disable start button
            var startBtn = document.getElementById('start-game-btn');
            var hint = document.getElementById('start-game-hint');
            if (joinedCount >= requiredCount) {
                startBtn.disabled = false;
                hint.textContent = 'Ù‡Ù…Ù‡ Ø¨Ø§Ø²ÛŒÚ©Ù†Ø§Ù† Ù¾ÛŒÙˆØ³ØªÙ‡â€ŒØ§Ù†Ø¯. Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø¨Ø§Ø²ÛŒ Ø±Ø§ Ø´Ø±ÙˆØ¹ Ú©Ù†ÛŒØ¯.';
            } else {
                startBtn.disabled = true;
                hint.textContent = 'Ù…Ù†ØªØ¸Ø± Ø¨Ù…Ø§Ù†ÛŒØ¯ ØªØ§ ' + (requiredCount - joinedCount) + ' Ø¨Ø§Ø²ÛŒÚ©Ù† Ø¯ÛŒÚ¯Ø± Ø¨Ù¾ÛŒÙˆÙ†Ø¯Ø¯.';
            }
        }

        function updatePlayerWaiting() {
            if (!gameState || isGameCreator) return;
            
            // Update waiting players list
            var listContainer = document.getElementById('waiting-players-list');
            if (gameState.joinedPlayers.length === 0) {
                listContainer.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±...</div>';
            } else {
                listContainer.innerHTML = '';
                gameState.joinedPlayers.forEach(function(player) {
                    var item = document.createElement('div');
                    item.className = 'player-item';
                    item.innerText = player.name;
                    listContainer.appendChild(item);
                });
            }
            
            // Show progress
            var joinedCount = gameState.joinedPlayers.length;
            var requiredCount = gameState.playerCount;
            var statusText = 'Ø¨Ø§Ø²ÛŒÚ©Ù†Ø§Ù†: ' + joinedCount + ' / ' + requiredCount;
            if (joinedCount >= requiredCount) {
                statusText += ' - Ø¢Ù…Ø§Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹';
            }
            // Could add this to the waiting message if needed
        }

        async function confirmStartGame() {
            if (!gameState || !isGameCreator) return;
            
            var joinedCount = gameState.joinedPlayers.length;
            var requiredCount = gameState.playerCount;
            
            if (joinedCount < requiredCount) {
                alert('Ù‡Ù†ÙˆØ² ' + (requiredCount - joinedCount) + ' Ø¨Ø§Ø²ÛŒÚ©Ù† Ø¯ÛŒÚ¯Ø± Ø¨Ø§ÛŒØ¯ Ø¨Ù¾ÛŒÙˆÙ†Ø¯Ø¯.');
                return;
            }
            
            if (!confirm('Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø¨Ø§Ø²ÛŒ Ø±Ø§ Ø´Ø±ÙˆØ¹ Ú©Ù†ÛŒØ¯ØŸ')) {
                return;
            }
            
            // Start the game - assign roles
            await startGame();
        }

        async function startGame() {
            if (!gameState) return;
            
            // Use joined players' names
            var names = gameState.joinedPlayers.map(p => p.name);
            var actualPlayerCount = names.length;
            
            // Update player count to match actual joined players
            gameState.playerCount = actualPlayerCount;

            // Assign roles
            var dist = CHARACTER_DISTRIBUTION[actualPlayerCount];
            if (!dist) {
                alert('ØªØ¹Ø¯Ø§Ø¯ Ø¨Ø§Ø²ÛŒÚ©Ù† Ù†Ø§Ù…Ø¹ØªØ¨Ø±: ' + actualPlayerCount);
                return;
            }

            // Select characters (simplified - using all characters)
            var selectedChars = [];
            var townsfolkPool = ALL_TOWNSFOLK.slice();
            var outsiderPool = ALL_OUTSIDERS.slice();
            var minionPool = ALL_MINIONS.slice();
            
            shuffleArray(townsfolkPool);
            shuffleArray(outsiderPool);
            shuffleArray(minionPool);

            // Check for Baron
            var baronInPlay = false;
            for (var i = 0; i < dist.minions; i++) {
                if (minionPool[i] === 'Baron') baronInPlay = true;
            }

            var adjustedOutsiders = dist.outsiders + (baronInPlay ? 2 : 0);
            var adjustedTownsfolk = dist.townsfolk - (baronInPlay ? 2 : 0);

            // Select characters
            for (var i = 0; i < adjustedTownsfolk; i++) {
                selectedChars.push(townsfolkPool[i]);
            }
            for (var i = 0; i < adjustedOutsiders; i++) {
                selectedChars.push(outsiderPool[i] || 'Drunk');
            }
            for (var i = 0; i < dist.minions; i++) {
                selectedChars.push(minionPool[i]);
            }
            selectedChars.push('Imp');

            shuffleArray(selectedChars);

            // Create players
            gameState.players = [];
            for (var i = 0; i < actualPlayerCount; i++) {
                var charName = selectedChars[i];
                var charDef = CHARACTERS[charName];
                var fakeCharDef = null;

                if (charName === 'Drunk') {
                    var availableTownsfolk = ALL_TOWNSFOLK.filter(t => selectedChars.indexOf(t) === -1);
                    if (availableTownsfolk.length === 0) availableTownsfolk = ALL_TOWNSFOLK.slice();
                    shuffleArray(availableTownsfolk);
                    fakeCharDef = CHARACTERS[availableTownsfolk[0]];
                }

                gameState.players.push({
                    name: names[i],
                    character: charName,
                    characterDef: charDef,
                    fakeCharacterDef: fakeCharDef,
                    alive: true,
                    index: i,
                    roleRevealed: false
                });
            }

            // Find creator's player index
            playerIndex = -1;
            for (var i = 0; i < gameState.players.length; i++) {
                if (gameState.players[i].name === playerName) {
                    playerIndex = i;
                    break;
                }
            }

            gameState.gameStarted = true;
            gameState.distributionComplete = false;
            await saveGameState();
            
            // Creator also becomes a regular player
            isGameCreator = false;
            showPlayerView();
            // Polling already running
        }

        function shuffleArray(array) {
            for (var i = array.length - 1; i > 0; i--) {
                var j = Math.floor(Math.random() * (i + 1));
                var temp = array[i];
                array[i] = array[j];
                array[j] = temp;
            }
        }

        function buildNightOrder() {
            if (!gameState) return;
            gameState.currentNightOrder = [];
            gameState.players.forEach(function(player) {
                if (player.alive && player.characterDef.nightOrder) {
                    gameState.currentNightOrder.push({
                        order: player.characterDef.nightOrder,
                        player: player,
                        character: player.fakeCharacterDef || player.characterDef
                    });
                }
            });
            gameState.currentNightOrder.sort(function(a, b) {
                return a.player.index - b.player.index;
            });
            gameState.nightIndex = 0;
        }

        function showPlayerView() {
            showScreen('player-view');
            document.getElementById('player-name-display').innerText = 'Ø¨Ø§Ø²ÛŒÚ©Ù†: ' + playerName;
            updatePlayerView();
        }

        function updatePlayerView() {
            if (!gameState || !gameState.gameStarted) {
                document.getElementById('waiting-message').classList.remove('hidden');
                return;
            }

            document.getElementById('waiting-message').classList.add('hidden');

            var player = gameState.players[playerIndex];
            if (!player) return;

            // Show role if not revealed yet
            if (!player.roleRevealed) {
                if (gameState.distributionComplete) {
                    // Distribution complete, show role
                player.roleRevealed = true;
                showPlayerRole(player);
                saveGameState(); // Fire and forget
                } else {
                    // Still in distribution phase
                    document.getElementById('waiting-message').innerHTML = '<div class="pulsing">â³ Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± Ø´Ø±ÙˆØ¹ Ø¨Ø§Ø²ÛŒ...</div>';
                    document.getElementById('waiting-message').classList.remove('hidden');
                    return;
                }
            } else {
                showPlayerRole(player);
            }
            
            // Check if all players have seen their roles, then auto-start first night
            if (!gameState.distributionComplete && gameState.gameStarted) {
                var allRevealed = gameState.players.every(p => p.roleRevealed);
                if (allRevealed) {
                    gameState.distributionComplete = true;
                    gameState.isNightPhase = true;
                    gameState.currentDay = 1;
                    buildNightOrder();
                    saveGameState(); // Fire and forget
                }
            }

            // Show night action if it's night and this player's turn
            if (gameState.isNightPhase && gameState.currentNightOrder) {
                document.getElementById('player-day-view').classList.add('hidden');
                var currentAction = gameState.currentNightOrder[gameState.nightIndex];
                if (currentAction && currentAction.player.index === playerIndex) {
                    // It's this player's turn
                    showNightAction(player, currentAction);
                } else {
                    // Not this player's turn - show waiting message
                    document.getElementById('player-night-action').classList.add('hidden');
                    document.getElementById('waiting-message').innerHTML = '<div class="pulsing">â³ ÙØ§Ø² Ø´Ø¨ - Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± Ù†ÙˆØ¨Øª Ø´Ù…Ø§...</div>';
                    document.getElementById('waiting-message').classList.remove('hidden');
                }
            } else {
                // Day phase - all players see the same information
                document.getElementById('player-night-action').classList.add('hidden');
                document.getElementById('waiting-message').classList.add('hidden');
                document.getElementById('player-day-view').classList.remove('hidden');
                updateDayView();
            }
        }

        function updateDayView() {
            if (!gameState) return;
            
            // Update day phase info - same for all players
            document.getElementById('day-phase-title').innerText = 'Ø±ÙˆØ² ' + gameState.currentDay;
            
            var livingCount = gameState.players.filter(p => p.alive).length;
            document.getElementById('day-living-count').innerText = livingCount;
            document.getElementById('day-current-day').innerText = gameState.currentDay;
            document.getElementById('day-execution-count').innerText = gameState.executions || 0;
            
            // Show player list - only names and alive/dead status (no roles)
            var playersList = document.getElementById('day-players-list');
            playersList.innerHTML = '';
            gameState.players.forEach(function(p) {
                var item = document.createElement('div');
                item.className = 'player-item' + (p.alive ? '' : ' dead');
                item.innerText = p.name + (p.alive ? ' (Ø²Ù†Ø¯Ù‡)' : ' (Ù…Ø±Ø¯Ù‡)');
                playersList.appendChild(item);
            });
        }

        function showPlayerRole(player) {
            var charDef = player.fakeCharacterDef || player.characterDef;
            var charKey = Object.keys(CHARACTERS).find(k => CHARACTERS[k].name === charDef.name);
            var icon = ROLE_ICONS[charKey] || 'â“';

            document.getElementById('player-role-card').classList.remove('hidden');
            document.getElementById('player-role-title').innerHTML = '<div style="font-size: 4rem; margin-bottom: 10px;">' + icon + '</div>' + charDef.name;
            document.getElementById('player-role-title').className = 'role-title role-' + charDef.type;
            document.getElementById('player-role-desc').innerText = charDef.ability;

            // Show evil teammates
            if (charDef.type === 'minion' || charDef.type === 'demon') {
                var evilPlayers = gameState.players.filter(p => 
                    (p.characterDef.type === 'minion' || p.characterDef.type === 'demon') && 
                    p.index !== playerIndex
                );
                if (evilPlayers.length > 0) {
                    var teamList = evilPlayers.map(p => p.name).join('ØŒ ');
                    document.getElementById('player-role-extra').innerHTML = 
                        '<div style="margin-top: 15px; padding: 10px; background: rgba(244, 67, 54, 0.2); border: 1px solid var(--evil-color); border-radius: 8px;">' +
                        'Ù‡Ù…â€ŒØªÛŒÙ…ÛŒâ€ŒÙ‡Ø§ÛŒ Ø´Ø±ÛŒØ± Ø´Ù…Ø§: ' + teamList + '</div>';
                }
            }
        }

        function showNightAction(player, nightAction) {
            document.getElementById('player-night-action').classList.remove('hidden');
            document.getElementById('night-action-title').innerText = nightAction.character.name;
            
            // This is a simplified version - in full implementation, each character would have specific UI
            var content = '<p>' + nightAction.character.ability + '</p>';
            content += '<p style="margin-top: 15px; color: var(--text-secondary);">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± Ù‚ØµÙ‡â€ŒÚ¯Ùˆ...</p>';
            document.getElementById('night-action-content').innerHTML = content;
        }

        function closeNightModal() {
            document.getElementById('night-action-modal').classList.add('hidden');
        }
    </script>
</body>
</html>

