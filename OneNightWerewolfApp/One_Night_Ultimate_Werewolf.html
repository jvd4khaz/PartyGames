<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>One Night Ultimate Werewolf</title>
    <style>
        :root {
            --bg-color: #0a192f;
            --card-bg: #112240;
            --text-primary: #e6f1ff;
            --text-secondary: #8892b0;
            --accent-color: #64ffda;
            --werewolf-color: #8B4513;
            --villager-color: #4CAF50;
            --special-color: #FF9800;
            --btn-color: #64ffda;
            --btn-text: #0a192f;
            --border-radius: 8px;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            overflow-x: hidden;
            user-select: none;
        }

        .container {
            width: 95%;
            max-width: 600px;
            padding: 20px;
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            margin: 20px 0;
            text-align: center;
            transition: transform 0.3s ease;
        }

        h1 { font-size: 1.8rem; margin-bottom: 0.5rem; color: var(--accent-color); font-weight: 900; }
        h2 { font-size: 1.2rem; margin: 10px 0; color: var(--text-secondary); }
        p { font-size: 1rem; color: var(--text-secondary); margin-bottom: 1rem; line-height: 1.5; }

        .setup-info {
            background: rgba(255,255,255,0.05);
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: left;
            font-size: 0.9rem;
            line-height: 1.6;
        }

        .input-group { margin-bottom: 10px; text-align: left; }
        .input-group label { display: block; margin-bottom: 5px; color: var(--text-secondary); font-size: 0.9rem; }
        
        .player-input {
            width: 100%;
            padding: 12px;
            background-color: #233554;
            border: 1px solid #303C55;
            border-radius: 4px;
            color: var(--text-primary);
            font-size: 1rem;
            text-align: center;
        }
        .player-input:focus { outline: 1px solid var(--accent-color); }

        .action-btn {
            background-color: var(--btn-color);
            color: var(--btn-text);
            border: none;
            padding: 14px 20px;
            font-size: 1rem;
            font-weight: bold;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            margin-top: 15px;
            transition: transform 0.1s;
        }
        .action-btn:active { transform: scale(0.98); }
        
        .secondary-btn {
            background-color: transparent;
            color: var(--accent-color);
            border: 1px solid var(--accent-color);
            padding: 10px 15px;
            font-size: 0.9rem;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
            width: 100%;
        }

        .player-select-btn {
            background: linear-gradient(135deg, rgba(100, 255, 218, 0.2) 0%, rgba(100, 255, 218, 0.1) 100%);
            color: var(--accent-color);
            border: 3px solid var(--accent-color);
            padding: 18px 24px;
            font-size: 1.2rem;
            font-weight: bold;
            border-radius: 12px;
            cursor: pointer;
            width: 100%;
            margin: 12px 0;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(100, 255, 218, 0.2);
            text-align: center;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .player-select-btn:hover {
            background: linear-gradient(135deg, rgba(100, 255, 218, 0.3) 0%, rgba(100, 255, 218, 0.2) 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(100, 255, 218, 0.4);
        }
        .player-select-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 10px rgba(100, 255, 218, 0.3);
        }

        .hidden { display: none !important; }

        /* Role Card */
        .role-card {
            background: rgba(0,0,0,0.2);
            padding: 20px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.1);
            margin: 20px 0;
        }
        .role-title { 
            font-size: 2rem; 
            font-weight: 900; 
            margin-bottom: 10px; 
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .role-werewolf { 
            color: var(--werewolf-color); 
            text-shadow: 0 0 10px rgba(139, 69, 19, 0.5);
        }
        .role-villager { 
            color: var(--villager-color); 
            text-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
        }
        .role-special { 
            color: var(--special-color); 
            text-shadow: 0 0 10px rgba(255, 152, 0, 0.5);
        }

        @keyframes popIn {
            from { opacity: 0; transform: scale(0.5); }
            to { opacity: 1; transform: scale(1); }
        }

        /* Center Cards */
        .center-cards {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        .center-card {
            width: 80px;
            height: 110px;
            border-radius: 8px;
            border: 2px solid #555;
            background: rgba(0,0,0,0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            position: relative;
        }
        .center-card.revealed {
            border-color: var(--accent-color);
            box-shadow: 0 0 15px rgba(100, 255, 218, 0.5);
        }
        .center-card.werewolf {
            background: linear-gradient(135deg, #8B4513 0%, #654321 100%);
            color: white;
        }
        .center-card.villager {
            background: linear-gradient(135deg, #4CAF50 0%, #388E3C 100%);
            color: white;
        }

        /* Action Status */
        .action-status {
            padding: 15px;
            background: rgba(100, 255, 218, 0.1);
            border: 2px solid var(--accent-color);
            border-radius: 8px;
            margin: 15px 0;
        }
        .action-status-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }
        .action-status-value {
            font-size: 1.3rem;
            font-weight: bold;
            color: var(--accent-color);
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 25, 47, 0.98);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            pointer-events: auto;
        }
        .modal-overlay.hidden {
            display: none;
        }

        /* Saved Players */
        .saved-list-container {
            margin-top: 15px;
            padding: 10px;
            background: rgba(255,255,255,0.03);
            border-radius: 8px;
            min-height: 40px;
        }
        .saved-list-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }
        .player-chip {
            background: rgba(255,255,255,0.1);
            border: 1px solid #555;
            border-radius: 20px;
            padding: 6px 14px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
            margin: 3px;
            display: inline-block;
        }
        .player-chip:active {
            background: var(--accent-color);
            border-color: var(--accent-color);
            transform: scale(0.95);
        }

        /* Role Icon */
        .role-icon {
            font-size: 3rem;
            margin: 10px 0;
        }

        /* Animations */
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        .container, .modal-overlay > .container { 
            animation: fadeIn 0.3s ease-out; 
        }

        /* Action Input */
        .action-input-section {
            margin: 20px 0;
            padding: 15px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
        }
    </style>
</head>
<body>

    <!-- 1. Setup Screen -->
    <div id="setup-screen" class="container">
        <h1>One Night Ultimate Werewolf</h1>
        <p>Social Deduction Game</p>

        <div class="setup-info">
            <strong>Game Overview:</strong><br>
            ‚Ä¢ Players are secretly assigned roles (Werewolves, Villagers, Special roles)<br>
            ‚Ä¢ Night Phase: Roles perform actions<br>
            ‚Ä¢ Day Phase: Discuss and vote to eliminate a player<br>
            ‚Ä¢ Werewolves win if no Werewolf is eliminated<br>
            ‚Ä¢ Villagers win if at least one Werewolf is eliminated<br>
            ‚Ä¢ Supports 3-10 players
        </div>

        <div class="input-group">
            <label>Number of Players:</label>
            <div style="display:flex; align-items:center; justify-content:center; gap:15px;">
                <button class="secondary-btn" style="width:40px;" onclick="updatePlayerCount(-1)">-</button>
                <span id="player-count-display" style="font-size:1.5rem; font-weight:bold;">3</span>
                <button class="secondary-btn" style="width:40px;" onclick="updatePlayerCount(1)">+</button>
            </div>
        </div>

        <div id="player-inputs-container" style="margin-top:20px;"></div>
        
        <!-- Saved Players List -->
        <div class="saved-list-container">
            <div class="saved-list-label">Saved Names (tap to fill):</div>
            <div id="saved-list" style="text-align: center;"></div>
        </div>

        <div class="input-group" style="margin-top: 20px;">
            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="show-results-immediately" checked style="width: 20px; height: 20px; cursor: pointer;">
                <span>Show results immediately (skip second pass)</span>
            </label>
            <p style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 5px;">
                When enabled, all players can view their results after actions complete, without passing the device again.
            </p>
        </div>

        <button class="action-btn" onclick="showRoleSelection()">Configure Roles</button>
    </div>

    <!-- Role Selection Screen -->
    <div id="role-selection-screen" class="container hidden">
        <h1>Select Roles</h1>
        <p id="role-selection-info" style="color: var(--text-secondary); margin-bottom: 20px;"></p>
        <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
            <button class="action-btn" onclick="confirmRoleSelection()" style="flex: 1; min-width: 150px;">Confirm Roles</button>
            <button class="secondary-btn" onclick="clearAllRoles()" style="flex: 1; min-width: 150px;">Clear All Roles</button>
            <button class="secondary-btn" onclick="useRecommendedRoles()" style="flex: 1; min-width: 150px;">Use Recommended</button>
        </div>
        <div id="role-selection-list"></div>
        <div style="margin-top: 20px; text-align: center;">
            <button class="action-btn" onclick="confirmRoleSelection()">Confirm Roles</button>
        </div>
    </div>

    <!-- 2. Role Distribution Phase -->
    <div id="distribution-screen" class="container hidden">
        <div id="dist-pass-view">
            <p>Pass device to:</p>
            <h2 id="dist-player-name" style="font-size:2rem; color:var(--accent-color);">Player Name</h2>
            <div style="font-size:4rem; margin:20px;">üì±</div>
            <p>Player <span id="dist-player-num">1</span> of <span id="dist-total-players">5</span></p>
            <button class="action-btn" onclick="revealRole()">Reveal Role</button>
        </div>

        <div id="dist-reveal-view" class="hidden">
            <h2 id="reveal-name-header">Player Name</h2>
            <div class="role-card">
                <div id="role-icon" class="role-icon">üê∫</div>
                <div id="role-title" class="role-title">Role</div>
                <div id="role-desc" style="font-size:0.95rem; margin-bottom:10px; color:#ddd;"></div>
                <div id="role-extra" style="font-size:0.9rem; color:#ffd700;"></div>
            </div>
            <p style="font-size:0.8rem; color:#666;">Memorize your role and hide it.</p>
            <button id="next-dist-btn" class="action-btn" onclick="nextDistribute()">Hide & Next</button>
        </div>
    </div>

    <!-- 3. Round 2: Results Phase -->
    <div id="results-screen" class="container hidden">
        <div id="results-pass-view">
            <p>Pass device to:</p>
            <h2 id="results-player-name" style="font-size:2rem; color:var(--accent-color);">Player Name</h2>
            <div style="font-size:4rem; margin:20px;">üì±</div>
            <p>Player <span id="results-player-num">1</span> of <span id="results-total-players">5</span></p>
            <button class="action-btn" onclick="showResult()">See Your Result</button>
        </div>

        <div id="results-reveal-view" class="hidden">
            <h2 id="results-name-header">Player Name</h2>
            <div class="role-card">
                <div id="results-role-icon" class="role-icon">üê∫</div>
                <div id="results-role-title" class="role-title">Role</div>
                <div id="results-role-desc" style="font-size:0.95rem; margin-bottom:10px; color:#ddd;"></div>
                <div id="results-role-extra" style="font-size:0.9rem; color:#ffd700;"></div>
            </div>
            <div id="result-content" style="margin: 20px 0;"></div>
            <button id="next-result-btn" class="action-btn" onclick="nextResult()">Hide & Next</button>
        </div>
    </div>

    <!-- Immediate Results Screen (all players can view at once) -->
    <div id="immediate-results-screen" class="container hidden">
        <h1>Night Phase Results</h1>
        <p style="color: var(--text-secondary); margin-bottom: 20px;">Tap your name to see your result:</p>
        <div id="immediate-results-list" style="margin: 20px 0;"></div>
        <div id="immediate-result-view" class="hidden" style="margin: 20px 0; padding: 20px; background: rgba(255,255,255,0.05); border-radius: 10px;">
            <h2 id="immediate-result-name" style="color: var(--accent-color);"></h2>
            <div id="immediate-result-content"></div>
            <button class="action-btn" onclick="hideImmediateResult()" style="margin-top: 15px;">Hide Result</button>
        </div>
        <p style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 20px;">When everyone has seen their results, proceed to day phase.</p>
        <button class="action-btn" onclick="proceedToDayPhase()" style="margin-top: 10px;">Proceed to Day Phase</button>
    </div>

    <!-- 4. Day Phase -->
    <div id="day-screen" class="container hidden">
        <h1>Day Phase</h1>

        <!-- Timer Section -->
        <div id="day-timer-section" style="margin: 20px 0; padding: 15px; background: rgba(255,255,255,0.08); border-radius: 8px; border: 2px solid var(--accent-color);">
            <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px;">
                <div style="flex: 1; min-width: 200px;">
                    <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 5px;">Discussion Timer</div>
                    <div id="timer-display" style="font-size: 2.5rem; font-weight: bold; color: var(--accent-color); font-family: 'Courier New', monospace;">05:00</div>
                </div>
                <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                    <div style="display: flex; gap: 5px;">
                        <button onclick="adjustTimer(-60)" style="padding: 8px 12px; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); border-radius: 5px; color: white; cursor: pointer; font-size: 0.9rem;">-1:00</button>
                        <button onclick="adjustTimer(-30)" style="padding: 8px 12px; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); border-radius: 5px; color: white; cursor: pointer; font-size: 0.9rem;">-0:30</button>
                        <button onclick="adjustTimer(30)" style="padding: 8px 12px; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); border-radius: 5px; color: white; cursor: pointer; font-size: 0.9rem;">+0:30</button>
                        <button onclick="adjustTimer(60)" style="padding: 8px 12px; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); border-radius: 5px; color: white; cursor: pointer; font-size: 0.9rem;">+1:00</button>
                    </div>
                    <div style="display: flex; gap: 5px;">
                        <button id="timer-start-btn" onclick="toggleTimer()" style="padding: 10px 20px; background: var(--accent-color); border: none; border-radius: 5px; color: white; cursor: pointer; font-weight: bold; font-size: 1rem;">Start</button>
                        <button onclick="resetTimer()" style="padding: 10px 20px; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); border-radius: 5px; color: white; cursor: pointer; font-size: 1rem;">Reset</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="day-phase-content" style="margin: 20px 0; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px;">
            <!-- Roles in the game -->
            <div id="roles-in-game" style="margin: 20px 0;">
                <h3 style="margin-bottom: 10px; color: var(--accent-color);">Roles in Play:</h3>
                <div id="roles-list" style="display: flex; flex-wrap: wrap; gap: 10px;"></div>
            </div>
            
            <!-- Players with final roles (ordered by resolution order) -->
            <div id="players-final-roles" style="margin: 20px 0; display: none;">
                <h3 style="margin-bottom: 10px; color: var(--accent-color);">Final Roles (Resolution Order):</h3>
                <div id="final-roles-list" style="display: flex; flex-direction: column; gap: 8px;"></div>
            </div>
        </div>

        <!-- Player voting list -->
        <div id="player-voting-list" style="margin-top: 20px;">
            <div id="voting-players" style="display: flex; flex-direction: column; gap: 10px;"></div>
        </div>

        <!-- Voting Modal -->
        <div id="voting-modal" class="modal-overlay hidden">
            <div class="container" style="max-width:500px;">
                <h2>Vote to Eliminate</h2>
                <p style="margin: 15px 0;">Select a player to eliminate:</p>
                <div id="voting-list"></div>
            </div>
        </div>

        <!-- End Game Modal -->
        <div id="end-game-modal" class="modal-overlay hidden">
            <div class="container" style="max-width:500px; border: 2px solid var(--accent-color);">
                <h1 id="end-game-title" style="margin-bottom: 20px;">GAME OVER</h1>
                <p id="end-game-message" style="font-size: 1.2rem; margin-bottom: 30px;"></p>
                <div id="final-roles" style="margin: 20px 0; text-align: left;"></div>
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <button class="action-btn" onclick="restartWithSameSetup()">1. Restart Same Setup</button>
                    <button class="action-btn" onclick="restartWithNewSetup()">2. Restart with New Setup</button>
                    <button class="action-btn" onclick="location.reload()">3. New Game</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Role Definitions ---
        var ROLE_DEFINITIONS = {
            'Doppelg√§nger': {
                name: 'Doppelg√§nger',
                icon: 'üë§',
                team: 'variable',
                description: 'Look at another player\'s card. You become that role and perform its action.',
                hasAction: true,
                actionType: 'doppelganger',
                color: 'special',
                nightOrder: 1
            },
            'Werewolf': {
                name: 'Werewolf',
                icon: 'üê∫',
                team: 'werewolf',
                description: 'See other Werewolves. If alone, look at 1 center card.',
                hasAction: true,
                actionType: 'werewolf',
                color: 'werewolf',
                nightOrder: 2
            },
            'Minion': {
                name: 'Minion',
                icon: 'üëπ',
                team: 'werewolf',
                description: 'See who the Werewolves are (they don\'t see you).',
                hasAction: true,
                actionType: 'minion',
                color: 'werewolf',
                nightOrder: 3
            },
            'Mason': {
                name: 'Mason',
                icon: 'ü§ù',
                team: 'villager',
                description: 'See other Masons (if there are 2+ Masons).',
                hasAction: true,
                actionType: 'mason',
                color: 'special',
                nightOrder: 4
            },
            'Seer': {
                name: 'Seer',
                icon: 'üëÅÔ∏è',
                team: 'villager',
                description: 'Look at 2 center cards OR 1 player\'s card.',
                hasAction: true,
                actionType: 'seer',
                color: 'special',
                nightOrder: 5
            },
            'Robber': {
                name: 'Robber',
                icon: 'üí∞',
                team: 'villager',
                description: 'Exchange your card with another player\'s, then look at your new card.',
                hasAction: true,
                actionType: 'robber',
                color: 'special',
                nightOrder: 6
            },
            'Troublemaker': {
                name: 'Troublemaker',
                icon: 'üîÑ',
                team: 'villager',
                description: 'Swap 2 other players\' cards (not yours).',
                hasAction: true,
                actionType: 'troublemaker',
                color: 'special',
                nightOrder: 7
            },
            'Drunk': {
                name: 'Drunk',
                icon: 'üç∫',
                team: 'villager',
                description: 'Exchange your card with a center card (you don\'t see which one).',
                hasAction: true,
                actionType: 'drunk',
                color: 'special',
                nightOrder: 8
            },
            'Insomniac': {
                name: 'Insomniac',
                icon: 'üåô',
                team: 'villager',
                description: 'Look at your card (after all swaps).',
                hasAction: true,
                actionType: 'insomniac',
                color: 'special',
                nightOrder: 9
            },
            'Villager': {
                name: 'Villager',
                icon: 'üë§',
                team: 'villager',
                description: 'You are a Villager. You win if at least one Werewolf is eliminated.',
                hasAction: false,
                actionType: 'villager',
                color: 'villager',
                nightOrder: 0
            },
            'Hunter': {
                name: 'Hunter',
                icon: 'üèπ',
                team: 'villager',
                description: 'If you are eliminated, eliminate another player.',
                hasAction: false,
                actionType: 'hunter',
                color: 'special',
                nightOrder: 0
            },
            'Tanner': {
                name: 'Tanner',
                icon: 'üòà',
                team: 'tanner',
                description: 'You win if YOU are eliminated (you lose if Werewolves win).',
                hasAction: false,
                actionType: 'tanner',
                color: 'special',
                nightOrder: 0
            },
            'Apprentice Tanner': {
                name: 'Apprentice Tanner',
                icon: 'üòàüë∂',
                team: 'tanner',
                description: 'See who the Tanner is (if there is one). If there\'s a Tanner, you win if the Tanner is eliminated. If there\'s no Tanner, you win if YOU are eliminated.',
                hasAction: true,
                actionType: 'apprenticetanner',
                color: 'special',
                nightOrder: 4
            },
            'Alpha Wolf': {
                name: 'Alpha Wolf',
                icon: 'üëëüê∫',
                team: 'werewolf',
                description: 'See other Werewolves. Then wake up separately to swap the Center Werewolf card with a non-Werewolf player\'s card (you don\'t see either card).',
                hasAction: true,
                actionType: 'alphawolf',
                color: 'werewolf',
                nightOrder: 2
            },
            'Dream Wolf': {
                name: 'Dream Wolf',
                icon: 'üí§üê∫',
                team: 'werewolf',
                description: 'You are a Werewolf but do not wake up. Other Werewolves see your thumb when they wake up.',
                hasAction: false,
                actionType: 'dreamwolf',
                color: 'werewolf',
                nightOrder: 0
            },
            'Mystic Wolf': {
                name: 'Mystic Wolf',
                icon: 'üîÆüê∫',
                team: 'werewolf',
                description: 'See other Werewolves. You also look at 1 player\'s card.',
                hasAction: true,
                actionType: 'mysticwolf',
                color: 'werewolf',
                nightOrder: 2
            },
            'Apprentice Seer': {
                name: 'Apprentice Seer',
                icon: 'üîç',
                team: 'villager',
                description: 'Look at 1 center card.',
                hasAction: true,
                actionType: 'apprenticeseer',
                color: 'special',
                nightOrder: 5
            },
            'Witch': {
                name: 'Witch',
                icon: 'üßô',
                team: 'villager',
                description: 'Look at 1 center card.',
                hasAction: true,
                actionType: 'witch',
                color: 'special',
                nightOrder: 5
            },
            'Paranormal Investigator': {
                name: 'Paranormal Investigator',
                icon: 'üî¨',
                team: 'villager',
                description: 'Look at 1 player\'s card.',
                hasAction: true,
                actionType: 'paranormalinvestigator',
                color: 'special',
                nightOrder: 5
            },
            'Village Idiot': {
                name: 'Village Idiot',
                icon: 'ü§™',
                team: 'villager',
                description: 'Swap 2 center cards (you don\'t see them).',
                hasAction: true,
                actionType: 'villageidiot',
                color: 'special',
                nightOrder: 7
            },
            'Revealer': {
                name: 'Revealer',
                icon: 'üì¢',
                team: 'villager',
                description: 'Reveal 1 center card to all players (everyone sees it).',
                hasAction: true,
                actionType: 'revealer',
                color: 'special',
                nightOrder: 5
            },
            'Curator': {
                name: 'Curator',
                icon: 'üèõÔ∏è',
                team: 'villager',
                description: 'Look at 1 center card, then swap it with another center card.',
                hasAction: true,
                actionType: 'curator',
                color: 'special',
                nightOrder: 7
            },
            'Oracle': {
                name: 'Oracle',
                icon: 'üîÆ',
                team: 'villager',
                description: 'See the roles of both other players (original roles).',
                hasAction: true,
                actionType: 'oracle',
                color: 'special',
                nightOrder: 5
            },
            'Oracle Wolf': {
                name: 'Oracle Wolf',
                icon: 'üîÆüê∫',
                team: 'werewolf',
                description: 'See other Werewolves. Also see the roles of both other players (original roles).',
                hasAction: true,
                actionType: 'oraclewolf',
                color: 'werewolf',
                nightOrder: 2
            }
        };

        // Recommended role scenarios by player count
        // Each player count has multiple scenarios that are randomly selected
        var ROLE_SCENARIOS = {
            3: [
                // Basic Logic Triangle - The classic starter game
                ['Werewolf', 'Werewolf', 'Seer', 'Robber', 'Troublemaker', 'Villager'],
                // Tanner "Bad Bluff" - High risk, Tanner protects the Wolves
                ['Werewolf', 'Werewolf', 'Robber', 'Troublemaker', 'Tanner', 'Drunk'],
                // Advanced 3-Player - Requires Daybreak, Mystic Wolf helps the Wolf team
                ['Werewolf', 'Werewolf', 'Mystic Wolf', 'Seer', 'Robber', 'Troublemaker'],
                // Oracle vs Oracle Wolf - Information overload scenario
                ['Oracle', 'Oracle', 'Oracle', 'Oracle Wolf', 'Oracle Wolf', 'Oracle Wolf']
            ],
            4: [
                // The Standard 4 w/ Tanner
                ['Werewolf', 'Werewolf', 'Seer', 'Robber', 'Troublemaker', 'Tanner', 'Insomniac'],
                // The Standard 4 w/ Tanner (Drunk variant)
                ['Werewolf', 'Werewolf', 'Seer', 'Robber', 'Troublemaker', 'Tanner', 'Drunk'],
                // The "Paranoid" 4
                ['Werewolf', 'Werewolf', 'Minion', 'Robber', 'Troublemaker', 'Tanner', 'Seer'],
                // Standard 4
                ['Werewolf', 'Werewolf', 'Seer', 'Robber', 'Troublemaker', 'Villager', 'Mason'],
                // The Chaos 4
                ['Werewolf', 'Werewolf', 'Seer', 'Robber', 'Troublemaker', 'Tanner', 'Drunk']
            ],
            5: [
                // The "Golden Standard" 5
                ['Werewolf', 'Werewolf', 'Seer', 'Robber', 'Troublemaker', 'Tanner', 'Insomniac', 'Drunk'],
                // The Perfect Beginner Game
                ['Werewolf', 'Werewolf', 'Seer', 'Robber', 'Troublemaker', 'Villager', 'Insomniac', 'Drunk'],
                // The "Trust No One" Setup
                ['Werewolf', 'Werewolf', 'Minion', 'Seer', 'Robber', 'Troublemaker', 'Tanner', 'Drunk']
            ],
            6: [
                // Standard Balanced
                ['Werewolf', 'Werewolf', 'Minion', 'Seer', 'Robber', 'Troublemaker', 'Mason', 'Mason', 'Insomniac']
            ],
            7: [
                // The Classic 7
                ['Werewolf', 'Werewolf', 'Minion', 'Seer', 'Robber', 'Troublemaker', 'Mason', 'Mason', 'Drunk', 'Tanner']
            ],
            8: [
                // The Full House
                ['Werewolf', 'Werewolf', 'Minion', 'Seer', 'Robber', 'Troublemaker', 'Mason', 'Mason', 'Insomniac', 'Drunk', 'Tanner']
            ],
            9: [
                // The "Big Village" (9 Players)
                ['Werewolf', 'Werewolf', 'Minion', 'Seer', 'Robber', 'Troublemaker', 'Mason', 'Mason', 'Insomniac', 'Hunter', 'Tanner', 'Villager']
            ],
            10: [
                // Maximum Chaos (10 Players) - without Doppelg√§nger
                ['Werewolf', 'Werewolf', 'Minion', 'Tanner', 'Seer', 'Robber', 'Troublemaker', 'Drunk', 'Insomniac', 'Hunter', 'Villager', 'Villager', 'Mason']
            ]
        };

        var selectedRoles = [];

        // --- Global State ---
        var playerCount = 3;
        var players = [];
        
        // Timer state
        var dayTimerSeconds = 300; // Default: 5 minutes (300 seconds)
        var dayTimerInterval = null;
        var dayTimerRunning = false;
        
        // Store setup for restart
        var savedSetup = {
            playerCount: null,
            playerNames: null,
            selectedRoles: null
        };
        var savedPlayers = [];
        var currentDistIndex = 0;
        var distributionOrder = []; // Shuffled order for distribution when immediate results is enabled
        var centerCards = [];
        var centerCardsFinal = []; // Center cards after all swaps (for immediate resolution)
        var playerActions = {}; // Store actions from Round 1
        var actionResults = {}; // Store results for Round 2
        var currentResultIndex = 0;
        var finalRoles = []; // Roles after all swaps
        var eliminatedPlayer = null;
        var showResultsImmediately = false; // Option to skip second pass

        // --- Initialization ---
        window.onload = function() {
            loadSavedPlayers();
            renderPlayerInputs();
        };

        function loadSavedPlayers() {
            var stored = localStorage.getItem('onuw_players');
            if (stored) {
                savedPlayers = JSON.parse(stored);
            }
            renderSavedList();
        }

        function renderSavedList() {
            var container = document.getElementById('saved-list');
            container.innerHTML = '';
            
            if (savedPlayers.length === 0) {
                container.innerHTML = '<span style="color:#555; font-size:0.8rem;">No saved names</span>';
                return;
            }

            savedPlayers.forEach(function(name) {
                var chip = document.createElement('div');
                chip.className = 'player-chip';
                chip.innerText = name;
                chip.onclick = function() { fillInput(name); };
                container.appendChild(chip);
            });
        }

        function fillInput(name) {
            var inputs = document.querySelectorAll('.player-input');
            for (var i = 0; i < inputs.length; i++) {
                var val = inputs[i].value;
                if (val === '') {
                    inputs[i].value = name;
                    return;
                }
            }
        }

        function updatePlayerCount(delta) {
            var newCount = playerCount + delta;
            if (newCount >= 3 && newCount <= 10) {
                playerCount = newCount;
                document.getElementById('player-count-display').innerText = playerCount;
                renderPlayerInputs();
            }
        }

        function renderPlayerInputs() {
            var container = document.getElementById('player-inputs-container');
            var currentValues = [];
            var inputs = container.querySelectorAll('.player-input');
            for(var i=0; i<inputs.length; i++) currentValues.push(inputs[i].value);

            // Default names
            var defaultNames = ['Jay', 'Rey', 'Ryan'];
            
            container.innerHTML = '';
            for (var i = 0; i < playerCount; i++) {
                var val = currentValues[i] || (defaultNames[i] || '');
                var placeholder = "Player " + (i + 1);
                var input = document.createElement('input');
                input.type = 'text';
                input.className = 'player-input';
                input.placeholder = placeholder;
                input.value = val;
                container.appendChild(input);
            }
        }

        // --- Role Selection ---
        function showRoleSelection() {
            var setupScreen = document.getElementById('setup-screen');
            var roleScreen = document.getElementById('role-selection-screen');
            if (setupScreen) setupScreen.classList.add('hidden');
            if (roleScreen) {
                roleScreen.classList.remove('hidden');
            }
            
            // Load recommended roles if none selected
            if (selectedRoles.length === 0) {
                useRecommendedRoles();
            } else {
                renderRoleSelection();
            }
        }

        function useRecommendedRoles() {
            var scenarios = ROLE_SCENARIOS[playerCount];
            if (scenarios && scenarios.length > 0) {
                // Randomly select a scenario
                var randomIndex = Math.floor(Math.random() * scenarios.length);
                selectedRoles = scenarios[randomIndex].slice();
            } else {
                // Fallback: create a basic set
                var totalCards = playerCount + 3;
                selectedRoles = [];
                // Add basic roles
                selectedRoles.push('Werewolf', 'Werewolf');
                if (playerCount >= 4) selectedRoles.push('Seer');
                if (playerCount >= 5) selectedRoles.push('Robber');
                if (playerCount >= 6) selectedRoles.push('Troublemaker');
                // Fill remaining with Villagers
                while (selectedRoles.length < totalCards) {
                    selectedRoles.push('Villager');
                }
            }
            renderRoleSelection();
        }

        function renderRoleSelection() {
            var info = document.getElementById('role-selection-info');
            var list = document.getElementById('role-selection-list');
            
            if (!info || !list) return;
            
            info.innerHTML = 'Select ' + (playerCount + 3) + ' roles for this game (' + playerCount + ' players + 3 center cards).';
            list.innerHTML = '';
            
            // Show selected roles at the top
            if (selectedRoles.length > 0) {
                var selectedSection = document.createElement('div');
                selectedSection.style.marginBottom = '30px';
                selectedSection.style.padding = '15px';
                selectedSection.style.background = 'rgba(100, 255, 218, 0.1)';
                selectedSection.style.border = '2px solid var(--accent-color)';
                selectedSection.style.borderRadius = '8px';
                
                var selectedHeader = document.createElement('h3');
                selectedHeader.style.fontSize = '1.1rem';
                selectedHeader.style.color = 'var(--accent-color)';
                selectedHeader.style.marginBottom = '15px';
                selectedHeader.innerText = 'Selected Roles (' + selectedRoles.length + ')';
                selectedSection.appendChild(selectedHeader);
                
                var selectedRolesDiv = document.createElement('div');
                selectedRolesDiv.style.display = 'flex';
                selectedRolesDiv.style.flexWrap = 'wrap';
                selectedRolesDiv.style.gap = '10px';
                
                var selectedCounts = {};
                selectedRoles.forEach(function(role) {
                    selectedCounts[role] = (selectedCounts[role] || 0) + 1;
                });
                
                Object.keys(selectedCounts).sort().forEach(function(roleKey) {
                    var count = selectedCounts[roleKey];
                    var roleDef = ROLE_DEFINITIONS[roleKey];
                    if (!roleDef) return;
                    
                    var roleChip = document.createElement('div');
                    roleChip.style.padding = '10px 15px';
                    roleChip.style.background = 'rgba(255,255,255,0.1)';
                    roleChip.style.border = '2px solid var(--accent-color)';
                    roleChip.style.borderRadius = '6px';
                    roleChip.style.display = 'flex';
                    roleChip.style.alignItems = 'center';
                    roleChip.style.gap = '8px';
                    roleChip.style.fontSize = '0.95rem';
                    roleChip.style.fontWeight = 'bold';
                    
                    // Set border color based on team
                    if (roleDef.team === 'tanner') {
                        roleChip.style.borderColor = '#FF9800';
                    } else if (roleDef.team === 'werewolf') {
                        roleChip.style.borderColor = '#8B4513';
                    } else {
                        roleChip.style.borderColor = '#4CAF50';
                    }
                    
                    roleChip.innerHTML = roleDef.icon + ' ' + roleDef.name + (count > 1 ? ' <span style="opacity: 0.8;">(' + count + ')</span>' : '');
                    
                    // Add remove button
                    var removeBtn = document.createElement('button');
                    removeBtn.innerHTML = '√ó';
                    removeBtn.style.background = 'rgba(255, 0, 0, 0.3)';
                    removeBtn.style.border = '1px solid rgba(255, 0, 0, 0.5)';
                    removeBtn.style.borderRadius = '50%';
                    removeBtn.style.width = '24px';
                    removeBtn.style.height = '24px';
                    removeBtn.style.color = 'white';
                    removeBtn.style.cursor = 'pointer';
                    removeBtn.style.fontSize = '1.2rem';
                    removeBtn.style.fontWeight = 'bold';
                    removeBtn.style.padding = '0';
                    removeBtn.style.marginLeft = '5px';
                    removeBtn.onclick = function(e) {
                        e.stopPropagation();
                        removeRole(roleKey);
                    };
                    roleChip.appendChild(removeBtn);
                    
                    selectedRolesDiv.appendChild(roleChip);
                });
                
                selectedSection.appendChild(selectedRolesDiv);
                list.appendChild(selectedSection);
            }
            
            // Organize roles by faction - dynamically get all roles from ROLE_DEFINITIONS
            var tannerRoles = [];
            var badRoles = [];
            var goodRoles = [];
            
            // Sort roles by popularity/importance within each team
            var roleOrder = {
                'Tanner': 0, 'Apprentice Tanner': 1,
                'Werewolf': 0, 'Alpha Wolf': 1, 'Mystic Wolf': 2, 'Dream Wolf': 3, 'Minion': 4,
                'Seer': 0, 'Apprentice Seer': 1, 'Robber': 2, 'Troublemaker': 3, 'Drunk': 4, 'Insomniac': 5, 
                'Villager': 6, 'Hunter': 7, 'Mason': 8, 'Witch': 9, 'Paranormal Investigator': 10, 
                'Village Idiot': 11, 'Revealer': 12, 'Curator': 13, 'Doppelg√§nger': 14
            };
            
            Object.keys(ROLE_DEFINITIONS).forEach(function(roleKey) {
                var roleDef = ROLE_DEFINITIONS[roleKey];
                if (roleDef.team === 'tanner') {
                    tannerRoles.push(roleKey);
                } else if (roleDef.team === 'werewolf') {
                    badRoles.push(roleKey);
                } else if (roleDef.team === 'villager' || roleDef.team === 'variable' || roleDef.team === 'special') {
                    // Villager team includes variable/special roles like Doppelg√§nger
                    goodRoles.push(roleKey);
                }
            });
            
            // Sort within each faction by popularity
            tannerRoles.sort(function(a, b) { return (roleOrder[a] || 999) - (roleOrder[b] || 999); });
            badRoles.sort(function(a, b) { return (roleOrder[a] || 999) - (roleOrder[b] || 999); });
            goodRoles.sort(function(a, b) { return (roleOrder[a] || 999) - (roleOrder[b] || 999); });
            
            var roleCounts = {};
            selectedRoles.forEach(function(role) {
                roleCounts[role] = (roleCounts[role] || 0) + 1;
            });
            
            // Render roles by faction
            renderRoleFaction(list, 'Tanner (Solo)', tannerRoles, roleCounts, '#FF9800');
            renderRoleFaction(list, 'Werewolf Team', badRoles, roleCounts, '#8B4513');
            renderRoleFaction(list, 'Villager Team', goodRoles, roleCounts, '#4CAF50');
            
            // Total roles display
            var total = selectedRoles.length;
            var totalCards = playerCount + 3; // 3 cards go to center
            var totalDiv = document.createElement('div');
            totalDiv.style.marginTop = '20px';
            totalDiv.style.padding = '15px';
            totalDiv.style.background = total === totalCards ? 'rgba(76, 175, 80, 0.2)' : 'rgba(255, 152, 0, 0.2)';
            totalDiv.style.borderRadius = '8px';
            totalDiv.style.fontWeight = 'bold';
            totalDiv.innerText = 'Total Roles: ' + total + ' / ' + totalCards + ' (' + playerCount + ' players + 3 center)';
            list.appendChild(totalDiv);
        }
        
        function renderRoleFaction(container, factionName, roleKeys, roleCounts, factionColor) {
            // Faction header
            var header = document.createElement('div');
            header.style.marginTop = '20px';
            header.style.marginBottom = '10px';
            header.style.padding = '8px 12px';
            header.style.background = 'rgba(255,255,255,0.05)';
            header.style.borderLeft = '4px solid ' + factionColor;
            header.style.borderRadius = '4px';
            header.style.fontWeight = 'bold';
            header.style.fontSize = '0.9rem';
            header.style.color = factionColor;
            header.style.textTransform = 'uppercase';
            header.style.letterSpacing = '0.5px';
            header.innerText = factionName;
            container.appendChild(header);
            
            // Render roles in this faction
            roleKeys.forEach(function(roleKey) {
                var role = ROLE_DEFINITIONS[roleKey];
                if (!role) return;
                
                var item = document.createElement('div');
                item.style.background = 'rgba(255,255,255,0.05)';
                item.style.border = '3px solid ' + factionColor;
                item.style.borderRadius = '10px';
                item.style.padding = '15px';
                item.style.margin = '8px 0';
                item.style.textAlign = 'left';
                item.style.display = 'flex';
                item.style.justifyContent = 'space-between';
                item.style.alignItems = 'center';
                item.style.transition = 'all 0.3s';
                
                var count = roleCounts[roleKey] || 0;
                if (count > 0) {
                    // Enhanced styling for selected roles - better contrast and brightness
                    item.style.borderColor = '#64FFDA';
                    item.style.borderWidth = '4px';
                    item.style.boxShadow = '0 0 30px rgba(100, 255, 218, 0.6), inset 0 0 20px rgba(100, 255, 218, 0.15)';
                    item.style.background = 'rgba(100, 255, 218, 0.25)';
                    item.style.transform = 'scale(1.02)';
                } else {
                    item.style.borderWidth = '3px';
                }
                
                var left = document.createElement('div');
                // Make selected role text brighter
                var roleNameColor = count > 0 ? '#64FFDA' : factionColor;
                var descriptionColor = count > 0 ? 'rgba(200, 255, 240, 0.9)' : 'var(--text-secondary)';
                left.innerHTML = '<strong style="color: ' + roleNameColor + '; font-size: 1.1rem; text-shadow: ' + (count > 0 ? '0 0 10px rgba(100, 255, 218, 0.5)' : 'none') + ';">' + role.icon + ' ' + role.name + '</strong><br><span style="font-size: 0.85rem; color: ' + descriptionColor + ';">' + role.description + '</span>';
                
                var right = document.createElement('div');
                right.style.display = 'flex';
                right.style.alignItems = 'center';
                right.style.gap = '10px';
                
                var countDisplay = document.createElement('span');
                countDisplay.style.fontSize = '1.4rem';
                countDisplay.style.fontWeight = 'bold';
                countDisplay.style.minWidth = '35px';
                countDisplay.style.textAlign = 'center';
                if (count > 0) {
                    countDisplay.style.color = '#64FFDA';
                    countDisplay.style.textShadow = '0 0 15px rgba(100, 255, 218, 0.8)';
                    countDisplay.style.background = 'rgba(100, 255, 218, 0.2)';
                    countDisplay.style.padding = '5px 10px';
                    countDisplay.style.borderRadius = '8px';
                    countDisplay.style.border = '2px solid #64FFDA';
                } else {
                    countDisplay.style.color = 'var(--text-secondary)';
                }
                countDisplay.innerText = count;
                right.appendChild(countDisplay);
                
                var minusBtn = document.createElement('button');
                minusBtn.innerText = '‚àí';
                minusBtn.style.width = '35px';
                minusBtn.style.height = '35px';
                minusBtn.style.borderRadius = '50%';
                if (count > 0) {
                    minusBtn.style.border = '3px solid #64FFDA';
                    minusBtn.style.color = '#64FFDA';
                    minusBtn.style.background = 'rgba(100, 255, 218, 0.15)';
                    minusBtn.style.boxShadow = '0 0 10px rgba(100, 255, 218, 0.4)';
                } else {
                    minusBtn.style.border = '2px solid ' + factionColor;
                    minusBtn.style.color = factionColor;
                    minusBtn.style.background = 'transparent';
                }
                minusBtn.style.cursor = 'pointer';
                minusBtn.style.transition = 'all 0.2s';
                minusBtn.style.fontSize = '1.2rem';
                minusBtn.style.fontWeight = 'bold';
                minusBtn.onmouseover = function() { 
                    if (count > 0) {
                        this.style.background = 'rgba(100, 255, 218, 0.3)';
                        this.style.transform = 'scale(1.1)';
                    } else {
                        this.style.background = factionColor + '20';
                    }
                };
                minusBtn.onmouseout = function() { 
                    if (count > 0) {
                        this.style.background = 'rgba(100, 255, 218, 0.15)';
                        this.style.transform = 'scale(1)';
                    } else {
                        this.style.background = 'transparent';
                    }
                };
                minusBtn.onclick = function(e) { e.stopPropagation(); removeRole(roleKey); };
                right.appendChild(minusBtn);
                
                var plusBtn = document.createElement('button');
                plusBtn.innerText = '+';
                plusBtn.style.width = '35px';
                plusBtn.style.height = '35px';
                plusBtn.style.borderRadius = '50%';
                plusBtn.style.border = '2px solid ' + factionColor;
                plusBtn.style.background = 'transparent';
                plusBtn.style.color = factionColor;
                plusBtn.style.cursor = 'pointer';
                plusBtn.style.transition = 'all 0.2s';
                plusBtn.style.fontSize = '1.2rem';
                plusBtn.style.fontWeight = 'bold';
                plusBtn.onmouseover = function() { 
                    this.style.background = factionColor + '20';
                    this.style.transform = 'scale(1.1)';
                };
                plusBtn.onmouseout = function() { 
                    this.style.background = 'transparent';
                    this.style.transform = 'scale(1)';
                };
                plusBtn.onclick = function(e) { e.stopPropagation(); addRole(roleKey); };
                right.appendChild(plusBtn);
                
                item.appendChild(left);
                item.appendChild(right);
                container.appendChild(item);
            });
        }

        function addRole(roleKey) {
            // Allow any number of roles - no limit
            selectedRoles.push(roleKey);
            renderRoleSelection();
        }

        function removeRole(roleKey) {
            var index = selectedRoles.lastIndexOf(roleKey);
            if (index !== -1) {
                selectedRoles.splice(index, 1);
                renderRoleSelection();
            }
        }

        function clearAllRoles() {
            selectedRoles = [];
            renderRoleSelection();
        }

        function confirmRoleSelection() {
            var totalCards = playerCount + 3; // Recommended: 3 cards go to center
            if (selectedRoles.length < playerCount) {
                alert('Please select at least ' + playerCount + ' roles (one for each player).');
                return;
            }
            
            // Show warning if not the recommended amount, but allow it
            if (selectedRoles.length !== totalCards) {
                alert('Warning: You have selected ' + selectedRoles.length + ' roles. Recommended is ' + totalCards + ' (' + playerCount + ' players + 3 center cards).\n\nYou can continue with ' + selectedRoles.length + ' roles.');
            }
            
            document.getElementById('role-selection-screen').classList.add('hidden');
            startRoleDistribution();
        }

        // --- Role Distribution ---
        function startRoleDistribution() {
            var inputs = document.querySelectorAll('.player-input');
            var names = [];
            for (var i = 0; i < inputs.length; i++) {
                var val = inputs[i].value.trim() || inputs[i].placeholder;
                names.push(val);
                
                if (inputs[i].value.trim() !== '' && savedPlayers.indexOf(val) === -1) {
                    savedPlayers.push(val);
                }
            }
            localStorage.setItem('onuw_players', JSON.stringify(savedPlayers));
            renderSavedList();
            
            // Save setup for restart
            savedSetup.playerCount = playerCount;
            savedSetup.playerNames = names.slice();
            savedSetup.selectedRoles = selectedRoles.slice();

            // Shuffle selected roles
            var rolesToAssign = selectedRoles.slice();
            shuffleArray(rolesToAssign);
            
            // Deal to players
            players = [];
            playerActions = {};
            for (var i = 0; i < playerCount; i++) {
                players.push({
                    name: names[i],
                    initialRole: rolesToAssign[i],
                    currentRole: rolesToAssign[i], // Will change after swaps
                    actionCompleted: false
                });
            }
            
            // Remaining cards go to center
            centerCards = [];
            for (var i = playerCount; i < rolesToAssign.length; i++) {
                if (rolesToAssign[i]) {
                    centerCards.push(rolesToAssign[i]);
                }
            }
            
            shuffleArray(centerCards);
            
            // If Alpha Wolf is in play, add Center Werewolf card (4th center card)
            var hasAlphaWolf = players.some(p => p.initialRole === 'Alpha Wolf');
            if (hasAlphaWolf) {
                centerCards.push('Werewolf'); // Center Werewolf card
            }

            // Set up special role knowledge (Masons, Minion, Werewolves)
            setupSpecialKnowledge();
            
            // Check if immediate results is enabled - if so, randomize the distribution order
            var immediateResults = document.getElementById('show-results-immediately').checked;
            if (immediateResults) {
                // Create a shuffled order for player distribution
                distributionOrder = [];
                for (var i = 0; i < playerCount; i++) {
                    distributionOrder.push(i);
                }
                shuffleArray(distributionOrder);
            } else {
                // Sequential order
                distributionOrder = [];
                for (var i = 0; i < playerCount; i++) {
                    distributionOrder.push(i);
                }
            }
            
            currentDistIndex = 0;
            document.getElementById('dist-total-players').innerText = playerCount;
            showScreen('distribution-screen');
            updateDistScreen();
        }

        function setupSpecialKnowledge() {
            // Masons know each other (only if 2+ Masons)
            var masons = players.filter(p => p.initialRole === 'Mason');
            if (masons.length >= 2) {
                masons.forEach(function(mason) {
                    var otherMasons = masons.filter(m => m.name !== mason.name).map(m => m.name);
                    mason.extraInfo = 'Other Mason(s): ' + otherMasons.join(', ');
                });
            }

            // Minion knows Werewolves (but Werewolves don't see Minion)
            var minion = players.find(p => p.initialRole === 'Minion');
            if (minion) {
                var werewolves = players.filter(p => p.initialRole === 'Werewolf' || p.initialRole === 'Alpha Wolf' || p.initialRole === 'Mystic Wolf' || p.initialRole === 'Dream Wolf' || p.initialRole === 'Oracle Wolf').map(p => p.name);
                if (werewolves.length > 0) {
                    minion.extraInfo = 'Werewolves: ' + werewolves.join(', ');
                } else {
                    minion.extraInfo = 'No Werewolves in play';
                }
            }

            // Werewolves know each other (includes Alpha Wolf, Mystic Wolf, Dream Wolf, and Oracle Wolf)
            var werewolves = players.filter(p => p.initialRole === 'Werewolf' || p.initialRole === 'Alpha Wolf' || p.initialRole === 'Mystic Wolf' || p.initialRole === 'Dream Wolf' || p.initialRole === 'Oracle Wolf');
            werewolves.forEach(function(werewolf) {
                var otherWerewolves = werewolves.filter(w => w.name !== werewolf.name).map(w => w.name);
                if (otherWerewolves.length > 0) {
                    werewolf.extraInfo = 'Other Werewolf(ves): ' + otherWerewolves.join(', ');
                } else {
                    werewolf.extraInfo = 'You are the only Werewolf';
                }
            });
            
            // Apprentice Tanner knows who the Tanner is (if there is one)
            var apprenticeTanner = players.find(p => p.initialRole === 'Apprentice Tanner');
            if (apprenticeTanner) {
                var tanner = players.find(p => p.initialRole === 'Tanner');
                if (tanner) {
                    apprenticeTanner.extraInfo = 'Tanner: ' + tanner.name;
                } else {
                    apprenticeTanner.extraInfo = 'No Tanner in play - you win if YOU are eliminated';
                }
            }
        }

        function updateDistScreen() {
            var playerIndex = distributionOrder[currentDistIndex];
            document.getElementById('dist-player-num').innerText = currentDistIndex + 1;
            document.getElementById('dist-player-name').innerText = players[playerIndex].name;
        }

        function revealRole() {
            var playerIndex = distributionOrder[currentDistIndex];
            var player = players[playerIndex];
            var roleDef = ROLE_DEFINITIONS[player.initialRole];
            
            // Special handling for Oracle and Oracle Wolf - they don't know their own role
            if (player.initialRole === 'Oracle' || player.initialRole === 'Oracle Wolf') {
                document.getElementById('reveal-name-header').innerText = player.name;
                document.getElementById('role-icon').innerText = '‚ùì';
                document.getElementById('role-title').innerText = 'Unknown Role';
                document.getElementById('role-title').className = 'role-title role-special';
                document.getElementById('role-desc').innerText = 'You don\'t know your own role, but you will see the roles of the other players.';
                
                var extra = document.getElementById('role-extra');
                extra.innerHTML = '';
                
                // Show action input immediately
                var actionContainer = document.createElement('div');
                actionContainer.id = 'role-action-container';
                actionContainer.style.marginTop = '20px';
                extra.appendChild(actionContainer);
                
                showRoleAction(player, actionContainer);
                
                document.getElementById('dist-pass-view').classList.add('hidden');
                document.getElementById('dist-reveal-view').classList.remove('hidden');
                return;
            }
            
            document.getElementById('reveal-name-header').innerText = player.name;
            document.getElementById('role-icon').innerText = roleDef.icon;
            document.getElementById('role-title').innerText = roleDef.name;
            document.getElementById('role-title').className = 'role-title role-' + roleDef.color;
            document.getElementById('role-desc').innerText = roleDef.description;
            
            var extra = document.getElementById('role-extra');
            extra.innerHTML = '';
            if (player.extraInfo) {
                extra.innerHTML = '<div style="margin-top: 15px; padding: 10px; background: rgba(255, 215, 0, 0.2); border: 1px solid #ffd700; border-radius: 8px; color: #ffd700;">' + player.extraInfo + '</div>';
            }
            
            // Show action input immediately if role has action
            var actionContainer = document.createElement('div');
            actionContainer.id = 'role-action-container';
            actionContainer.style.marginTop = '20px';
            extra.appendChild(actionContainer);
            
            if (roleDef.hasAction) {
                showRoleAction(player, actionContainer);
            } else {
                // No action role - give them something to do
                showVillagerAction(player, actionContainer);
            }
            
            document.getElementById('dist-pass-view').classList.add('hidden');
            document.getElementById('dist-reveal-view').classList.remove('hidden');
        }

        function showRoleAction(player, container) {
            var roleDef = ROLE_DEFINITIONS[player.initialRole];
            
            if (roleDef.actionType === 'doppelganger') {
                showDoppelgangerAction(player, container);
            } else             if (roleDef.actionType === 'seer') {
                showSeerAction(player, container, false);
            } else if (roleDef.actionType === 'robber') {
                showRobberAction(player, container, false);
            } else if (roleDef.actionType === 'troublemaker') {
                showTroublemakerAction(player, container, false);
            } else if (roleDef.actionType === 'drunk') {
                showDrunkAction(player, container, false);
            } else if (roleDef.actionType === 'werewolf') {
                showWerewolfAction(player, container, false);
            } else if (roleDef.actionType === 'minion') {
                // Minion sees Werewolves (already shown in extraInfo)
                playerActions[player.name] = { type: 'minion' };
                player.actionCompleted = true;
                container.innerHTML = '<p style="color: var(--text-secondary);">You saw the Werewolves (shown above).</p>';
                var nextBtn = document.getElementById('next-dist-btn');
                nextBtn.disabled = false;
                nextBtn.style.opacity = '1';
            } else if (roleDef.actionType === 'mason') {
                // Mason sees other Masons (already shown in extraInfo if 2+ Masons)
                playerActions[player.name] = { type: 'mason' };
                player.actionCompleted = true;
                if (player.extraInfo) {
                    container.innerHTML = '<p style="color: var(--text-secondary);">You saw other Masons (shown above).</p>';
                } else {
                    container.innerHTML = '<p style="color: var(--text-secondary);">You are the only Mason (no action).</p>';
                }
                var nextBtn = document.getElementById('next-dist-btn');
                nextBtn.disabled = false;
                nextBtn.style.opacity = '1';
            } else if (roleDef.actionType === 'apprenticetanner') {
                // Apprentice Tanner sees the Tanner (already shown in extraInfo)
                playerActions[player.name] = { type: 'apprenticetanner' };
                player.actionCompleted = true;
                if (player.extraInfo) {
                    container.innerHTML = '<p style="color: var(--text-secondary);">You saw the Tanner (shown above).</p>';
                } else {
                    container.innerHTML = '<p style="color: var(--text-secondary);">No Tanner in play - you win if YOU are eliminated.</p>';
                }
                var nextBtn = document.getElementById('next-dist-btn');
                nextBtn.disabled = false;
                nextBtn.style.opacity = '1';
            } else if (roleDef.actionType === 'insomniac') {
                // Insomniac has no input needed, just mark as done
                playerActions[player.name] = { type: 'insomniac' };
                player.actionCompleted = true;
                
                var immediateResults = document.getElementById('show-results-immediately').checked;
                if (immediateResults) {
                    // In immediate mode, the currentRole has already been updated by previous players' actions
                    var currentRoleName = player.currentRole || player.initialRole;
                    var currentRoleDef = ROLE_DEFINITIONS[currentRoleName];
                    
                    container.innerHTML = '<p style="color: var(--accent-color); font-weight: bold; font-size: 1.1rem; margin: 0;">‚úì You checked your card:</p>' +
                        '<div class="role-card" style="margin: 15px auto; width: 120px; height: 140px;"><div class="role-icon" style="font-size: 2.5rem;">' + currentRoleDef.icon + '</div><div class="role-title role-' + currentRoleDef.color + '" style="font-size: 1rem;">' + currentRoleDef.name + '</div></div>' +
                        '<p style="color: var(--text-secondary); font-size: 0.9rem;">(This is your role at the end of the night.)</p>';
                } else {
                    container.innerHTML = '<p style="color: var(--text-secondary);">Your action will be resolved after all swaps.</p>';
                }
                
                var nextBtn = document.getElementById('next-dist-btn');
                nextBtn.disabled = false;
                nextBtn.style.opacity = '1';
            } else if (roleDef.actionType === 'mysticwolf') {
                showMysticWolfAction(player, container, false);
            } else if (roleDef.actionType === 'apprenticeseer') {
                showApprenticeSeerAction(player, container, false);
            } else if (roleDef.actionType === 'witch') {
                showWitchAction(player, container, false);
            } else if (roleDef.actionType === 'paranormalinvestigator') {
                showParanormalInvestigatorAction(player, container, false);
            } else if (roleDef.actionType === 'villageidiot') {
                showVillageIdiotAction(player, container, false);
            } else if (roleDef.actionType === 'revealer') {
                showRevealerAction(player, container, false);
            } else if (roleDef.actionType === 'curator') {
                showCuratorAction(player, container, false);
            } else if (roleDef.actionType === 'oracle') {
                showOracleAction(player, container, false);
            } else if (roleDef.actionType === 'oraclewolf') {
                showOracleWolfAction(player, container, false);
            } else if (roleDef.actionType === 'alphawolf') {
                showAlphaWolfAction(player, container, false);
            }
        }

        function showVillagerAction(player, container) {
            var roleDef = ROLE_DEFINITIONS[player.initialRole];
            var roleName = roleDef ? roleDef.name : 'this role';
            
            container.innerHTML = '<p style="color: var(--text-secondary); margin-bottom: 10px;">You have no night action.</p>';
            container.innerHTML += '<p style="color: var(--text-secondary); font-size: 0.9rem;">Click the button below to maintain secrecy (everyone must interact with the device).</p>';
            
            var fakeBtn = document.createElement('button');
            fakeBtn.className = 'action-btn';
            
            // Clear button text explaining no action is needed
            fakeBtn.innerText = 'I Have No Night Action - Click for Secrecy';
            
            fakeBtn.onclick = function() {
                playerActions[player.name] = { type: 'villager-fake' };
                player.actionCompleted = true;
                var nextBtn = document.getElementById('next-dist-btn');
                nextBtn.disabled = false;
                nextBtn.style.opacity = '1';
            };
            container.appendChild(fakeBtn);
        }

        function nextDistribute() {
            // Check if action is completed
            var playerIndex = distributionOrder[currentDistIndex];
            var player = players[playerIndex];
            if (player.initialRole !== 'Insomniac' && !player.actionCompleted && ROLE_DEFINITIONS[player.initialRole].hasAction) {
                alert('Please complete your action first.');
                return;
            }
            
            // Check if immediate results is enabled
            var immediateResults = document.getElementById('show-results-immediately').checked;
            
            // If immediate results mode, resolve just this player's action immediately
            if (immediateResults && player.actionCompleted) {
                resolveCurrentPlayerAction(player);
            }
            
            currentDistIndex++;
            if (currentDistIndex >= playerCount) {
                // All roles distributed and actions completed
                
                // Check for immediate results option
                if (immediateResults) {
                    // In immediate mode, we've been resolving actions incrementally
                    // Just build finalRoles from current state
                    finalRoles = players.map(p => ({ name: p.name, role: p.currentRole || p.initialRole }));
                    centerCardsFinal = centerCards.slice();
                    // Skip results phase entirely and go to Day Phase
                    startDayPhase();
                } else {
                    // Resolve all actions at once for non-immediate mode
                    resolveActions();
                    // Show results for ALL players in order (sequential pass-and-play)
                    showCriticalResults();
                }
            } else {
                document.getElementById('dist-pass-view').classList.remove('hidden');
                document.getElementById('dist-reveal-view').classList.add('hidden');
                updateDistScreen();
            }
        }


        function showDoppelgangerAction(player, container) {
            container.innerHTML = '';
            
            var div = document.createElement('div');
            div.innerHTML = '<p style="margin: 15px 0;">Select a player to copy their role:</p>';
            
            var playersDiv = document.createElement('div');
            playersDiv.className = 'center-cards';
            playersDiv.style.position = 'relative';
            playersDiv.style.zIndex = '1';
            
            players.forEach(function(p) {
                if (p.name === player.name) return; // Can't select self
                
                var playerBtn = document.createElement('div');
                playerBtn.className = 'center-card';
                playerBtn.style.cursor = 'pointer';
                playerBtn.style.position = 'relative';
                playerBtn.style.zIndex = '10';
                playerBtn.style.pointerEvents = 'auto';
                playerBtn.style.display = 'flex';
                playerBtn.style.flexDirection = 'column';
                playerBtn.style.alignItems = 'center';
                playerBtn.style.justifyContent = 'center';
                playerBtn.style.padding = '10px';
                playerBtn.innerHTML = '<div style="font-size: 1.2rem; font-weight: bold;">' + p.name + '</div>';
                playerBtn.dataset.playerName = p.name;
                
                // Use proper closure with captured player
                (function(btnElement, targetPlayer) {
                    btnElement.onclick = function(e) {
                        e.stopPropagation();
                        
                        // Handle Doppelg√§nger selection
                        handleDoppelgangerSelection(player, container, targetPlayer, btnElement, playersDiv);
                    };
                })(playerBtn, p);
                playersDiv.appendChild(playerBtn);
            });
            
            div.appendChild(playersDiv);
            container.appendChild(div);
        }
        
        function handleDoppelgangerSelection(player, container, selectedPlayer, btnElement, playersDiv) {
            // Store only the selected player - role will be revealed in results phase
            playerActions[player.name] = { 
                type: 'doppelganger', 
                copiedPlayer: selectedPlayer.name
                // Don't store copiedRole yet - will be revealed in results phase
            };
            
            // Show confirmation
            btnElement.style.background = 'rgba(100, 255, 218, 0.3)';
            btnElement.style.border = '3px solid var(--accent-color)';
            btnElement.style.boxShadow = '0 0 20px rgba(100, 255, 218, 0.4)';
            btnElement.innerHTML = '<div style="font-size: 1.5rem;">‚úì</div><div style="font-size: 0.9rem; margin-top: 5px;">' + selectedPlayer.name + '</div>';
            btnElement.style.cursor = 'default';
            btnElement.style.pointerEvents = 'none';
            
            // Disable other buttons
            for (var j = 0; j < playersDiv.children.length; j++) {
                if (playersDiv.children[j] !== btnElement) {
                    playersDiv.children[j].style.opacity = '0.3';
                    playersDiv.children[j].style.pointerEvents = 'none';
                }
            }
            
            // Show confirmation message
            var confirmation = document.createElement('div');
            confirmation.style.marginTop = '15px';
            confirmation.style.padding = '15px';
            confirmation.style.background = 'rgba(100, 255, 218, 0.3)';
            confirmation.style.border = '3px solid var(--accent-color)';
            confirmation.style.borderRadius = '10px';
            confirmation.style.boxShadow = '0 0 20px rgba(100, 255, 218, 0.4)';
            
            var immediateResults = document.getElementById('show-results-immediately').checked;
            if (immediateResults) {
                // In immediate mode, show current role (after previous swaps)
                var currentRoleName = selectedPlayer.currentRole || selectedPlayer.initialRole;
                var copiedRole = ROLE_DEFINITIONS[currentRoleName];
                
                // Store the copied role so we know what role they become
                playerActions[player.name].copiedRole = currentRoleName;
                
                confirmation.innerHTML = '<p style="color: var(--accent-color); font-weight: bold; font-size: 1.1rem; margin: 0;">‚úì You copied: <strong>' + copiedRole.name + '</strong></p>' +
                    '<div class="role-card" style="margin: 15px auto; width: 120px; height: 140px;"><div class="role-icon" style="font-size: 2.5rem;">' + copiedRole.icon + '</div><div class="role-title role-' + copiedRole.color + '" style="font-size: 1rem;">' + copiedRole.name + '</div></div>' +
                    '<p style="color: var(--text-secondary); font-size: 0.9rem;">(You are now this role.)</p>';
            } else {
                confirmation.innerHTML = '<p style="color: var(--accent-color); font-weight: bold; font-size: 1.1rem; margin: 0;">‚úì Selected: <strong>' + selectedPlayer.name + '</strong></p><p style="color: #fff; font-size: 0.95rem; margin-top: 8px; margin-bottom: 0;">You will see their role in the results phase, then perform that role\'s action.</p>';
            }
            
            container.appendChild(confirmation);
            
            // Mark action as completed (selection is done, action happens in results phase)
            player.actionCompleted = true;
            var nextBtn = document.getElementById('next-dist-btn');
            nextBtn.disabled = false;
            nextBtn.style.opacity = '1';
        }

        function showSeerAction(player, container, isDoppelganger) {
            container.innerHTML = '';
            
            var div = document.createElement('div');
            div.innerHTML = '<p style="margin: 15px 0;">Choose what to look at:</p>';
            div.innerHTML += '<p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 15px;">Click 2 center cards OR 1 player card</p>';
            
            // Show center cards
            var centerSection = document.createElement('div');
            centerSection.style.marginBottom = '20px';
            var centerLabel = document.createElement('p');
            centerLabel.style.marginBottom = '10px';
            centerLabel.style.fontWeight = 'bold';
            centerLabel.innerText = 'Center Cards (select 2):';
            centerSection.appendChild(centerLabel);
            
            var centerDiv = document.createElement('div');
            centerDiv.className = 'center-cards';
            centerDiv.style.position = 'relative';
            centerDiv.style.zIndex = '1';
            centerDiv.id = 'seer-center-cards';
            
            var selectedCenterCards = [];
            var selectedCardElements = []; // Store actual card element references
            for (var i = 0; i < centerCards.length; i++) {
                var card = document.createElement('div');
                card.className = 'center-card';
                card.style.cursor = 'pointer';
                card.style.position = 'relative';
                card.style.zIndex = '10';
                card.style.pointerEvents = 'auto';
                card.innerHTML = '<div style="font-size: 1.5rem;">?</div>';
                card.dataset.index = i;
                
                // Use proper closure with captured index and centerDiv reference
                (function(cardElement, cardIndex, centerDivRef, selectedCardsArray, selectedElementsArray) {
                    cardElement.onclick = function(e) {
                        e.stopPropagation();
                        
                        // Clear any player selection first
                        var playerSection = document.getElementById('seer-players');
                        if (playerSection) {
                            var playerCards = playerSection.querySelectorAll('.center-card');
                            for (var k = 0; k < playerCards.length; k++) {
                                playerCards[k].style.background = '';
                                playerCards[k].style.border = '2px solid #555';
                                playerCards[k].style.boxShadow = '';
                                playerCards[k].style.opacity = '1';
                                playerCards[k].style.pointerEvents = 'auto';
                                playerCards[k].style.cursor = 'pointer';
                                var playerName = playerCards[k].dataset.playerName;
                                if (playerName) {
                                    playerCards[k].innerHTML = '<div style="font-size: 1.2rem; font-weight: bold;">' + playerName + '</div>';
                                }
                            }
                        }
                        // Remove any confirmation messages
                        var confirmations = container.querySelectorAll('div[style*="rgba(100, 255, 218, 0.3)"]');
                        for (var c = 0; c < confirmations.length; c++) {
                            if (confirmations[c].parentNode) {
                                confirmations[c].parentNode.removeChild(confirmations[c]);
                            }
                        }
                        
                        var indexPos = selectedCardsArray.indexOf(cardIndex);
                        if (indexPos === -1) {
                            // Select this card
                            if (selectedCardsArray.length < 2) {
                                selectedCardsArray.push(cardIndex);
                                selectedElementsArray.push(cardElement);
                                cardElement.style.background = 'rgba(100, 255, 218, 0.3)';
                                cardElement.style.border = '3px solid var(--accent-color)';
                                cardElement.style.boxShadow = '0 0 20px rgba(100, 255, 218, 0.4)';
                                // Keep the ? visible but add a checkmark
                                cardElement.innerHTML = '<div style="font-size: 1.5rem;">?</div><div style="font-size: 1rem; color: var(--accent-color); margin-top: 5px;">‚úì</div>';
                                
                                // If 2 cards selected, confirm - update both using stored element references
                                if (selectedCardsArray.length === 2) {
                                    // Update both selected cards using their element references
                                    for (var selIdx = 0; selIdx < selectedElementsArray.length; selIdx++) {
                                        var selCard = selectedElementsArray[selIdx];
                                        if (selCard) {
                                            selCard.style.background = 'rgba(100, 255, 218, 0.3)';
                                            selCard.style.border = '3px solid var(--accent-color)';
                                            selCard.style.boxShadow = '0 0 20px rgba(100, 255, 218, 0.4)';
                                            selCard.innerHTML = '<div style="font-size: 1.5rem;">?</div><div style="font-size: 1rem; color: var(--accent-color); margin-top: 5px;">‚úì</div>';
                                        }
                                    }
                                    // Store the action
                                    if (isDoppelganger) {
                                        if (!playerActions[player.name]) {
                                            playerActions[player.name] = { type: 'doppelganger' };
                                        }
                                        playerActions[player.name].action = 'center';
                                        playerActions[player.name].centerCards = selectedCardsArray.slice();
                                    } else {
                                        playerActions[player.name] = { 
                                            type: 'seer', 
                                            action: 'center', 
                                            centerCards: selectedCardsArray.slice() 
                                        };
                                    }
                                    player.actionCompleted = true;
                                    
                                    // Show confirmation
                                    var confirmation = document.createElement('div');
                                    confirmation.style.marginTop = '15px';
                                    confirmation.style.padding = '15px';
                                    confirmation.style.background = 'rgba(100, 255, 218, 0.3)';
                                    confirmation.style.border = '3px solid var(--accent-color)';
                                    confirmation.style.borderRadius = '10px';
                                    confirmation.style.boxShadow = '0 0 20px rgba(100, 255, 218, 0.4)';
                                    var immediateResults = document.getElementById('show-results-immediately').checked;
                                    if (immediateResults) {
                                         var role1 = ROLE_DEFINITIONS[centerCards[selectedCardsArray[0]]];
                                         var role2 = ROLE_DEFINITIONS[centerCards[selectedCardsArray[1]]];
                                         confirmation.innerHTML = '<p style="color: var(--accent-color); font-weight: bold; font-size: 1.1rem; margin: 0;">‚úì Selected 2 center cards:</p>' +
                                             '<div style="display: flex; justify-content: center; gap: 15px; margin-top: 15px;">' +
                                             '<div class="role-card" style="width: 100px; height: 120px;"><div class="role-icon" style="font-size: 2rem;">' + role1.icon + '</div><div class="role-title role-' + role1.color + '" style="font-size: 0.9rem;">' + role1.name + '</div></div>' +
                                             '<div class="role-card" style="width: 100px; height: 120px;"><div class="role-icon" style="font-size: 2rem;">' + role2.icon + '</div><div class="role-title role-' + role2.color + '" style="font-size: 0.9rem;">' + role2.name + '</div></div>' +
                                             '</div>';
                                    } else {
                                         confirmation.innerHTML = '<p style="color: var(--accent-color); font-weight: bold; font-size: 1.1rem; margin: 0;">‚úì Selected 2 center cards</p><p style="color: #fff; font-size: 0.95rem; margin-top: 8px; margin-bottom: 0;">You will see their original roles (before swaps) in the results phase.</p>';
                                    }
                                    container.appendChild(confirmation);
                                    
                                    var nextBtn = document.getElementById('next-dist-btn');
                                    nextBtn.disabled = false;
                                    nextBtn.style.opacity = '1';
                                }
                            }
                        } else {
                            // Deselect this card
                            selectedCardsArray.splice(indexPos, 1);
                            var elemPos = selectedElementsArray.indexOf(cardElement);
                            if (elemPos !== -1) {
                                selectedElementsArray.splice(elemPos, 1);
                            }
                            cardElement.style.background = '';
                            cardElement.style.border = '2px solid #555';
                            cardElement.style.boxShadow = '';
                            // Restore the ? mark
                            cardElement.innerHTML = '<div style="font-size: 1.5rem;">?</div>';
                        }
                    };
                })(card, i, centerDiv, selectedCenterCards, selectedCardElements);
                centerDiv.appendChild(card);
            }
            centerSection.appendChild(centerDiv);
            div.appendChild(centerSection);
            
            // Show players
            var playerSection = document.createElement('div');
            playerSection.id = 'seer-players';
            var playerLabel = document.createElement('p');
            playerLabel.style.marginBottom = '10px';
            playerLabel.style.fontWeight = 'bold';
            playerLabel.innerText = 'Players (select 1):';
            playerSection.appendChild(playerLabel);
            
            var playersDiv = document.createElement('div');
            playersDiv.className = 'center-cards';
            playersDiv.style.position = 'relative';
            playersDiv.style.zIndex = '1';
            
            players.forEach(function(p) {
                if (p.name === player.name) return; // Can't select self
                
                var playerBtn = document.createElement('div');
                playerBtn.className = 'center-card';
                playerBtn.style.cursor = 'pointer';
                playerBtn.style.position = 'relative';
                playerBtn.style.zIndex = '10';
                playerBtn.style.pointerEvents = 'auto';
                playerBtn.style.display = 'flex';
                playerBtn.style.flexDirection = 'column';
                playerBtn.style.alignItems = 'center';
                playerBtn.style.justifyContent = 'center';
                playerBtn.style.padding = '10px';
                playerBtn.innerHTML = '<div style="font-size: 1.2rem; font-weight: bold;">' + p.name + '</div>';
                playerBtn.dataset.playerName = p.name;
                
                // Use proper closure with captured player
                (function(btnElement, targetPlayer) {
                    btnElement.onclick = function(e) {
                        e.stopPropagation();
                        
                        // Only clear center cards if action is not already completed (2 center cards selected)
                        if (selectedCenterCards.length < 2) {
                            var centerCardsDiv = document.getElementById('seer-center-cards');
                            if (centerCardsDiv) {
                                var centerCards = centerCardsDiv.querySelectorAll('.center-card');
                                for (var k = 0; k < centerCards.length; k++) {
                                    centerCards[k].style.background = '';
                                    centerCards[k].style.border = '2px solid #555';
                                    centerCards[k].style.boxShadow = '';
                                    centerCards[k].innerHTML = '<div style="font-size: 1.5rem;">?</div>';
                                }
                            }
                            // Clear the selectedCenterCards array
                            selectedCenterCards.length = 0;
                        } else {
                            // Action already completed with 2 center cards, don't allow player selection
                            return;
                        }
                        
                        // Clear other player selections
                        var playerCards = playersDiv.querySelectorAll('.center-card');
                        for (var k = 0; k < playerCards.length; k++) {
                            if (playerCards[k] !== btnElement) {
                                playerCards[k].style.background = '';
                                playerCards[k].style.border = '2px solid #555';
                                playerCards[k].style.boxShadow = '';
                                playerCards[k].style.opacity = '1';
                                playerCards[k].style.pointerEvents = 'auto';
                                playerCards[k].style.cursor = 'pointer';
                                var otherPlayerName = playerCards[k].dataset.playerName;
                                if (otherPlayerName) {
                                    playerCards[k].innerHTML = '<div style="font-size: 1.2rem; font-weight: bold;">' + otherPlayerName + '</div>';
                                }
                            }
                        }
                        
                        // Remove any confirmation messages
                        var confirmations = container.querySelectorAll('div[style*="rgba(100, 255, 218, 0.3)"]');
                        for (var c = 0; c < confirmations.length; c++) {
                            if (confirmations[c].parentNode) {
                                confirmations[c].parentNode.removeChild(confirmations[c]);
                            }
                        }
                        
                        // Store the action
                        if (isDoppelganger) {
                            if (!playerActions[player.name]) {
                                playerActions[player.name] = { type: 'doppelganger' };
                            }
                            playerActions[player.name].action = 'player';
                            playerActions[player.name].target = targetPlayer.name;
                        } else {
                            playerActions[player.name] = { type: 'seer', action: 'player', target: targetPlayer.name };
                        }
                        
                        // Show confirmation
                        btnElement.style.background = 'rgba(100, 255, 218, 0.3)';
                        btnElement.style.border = '3px solid var(--accent-color)';
                        btnElement.style.boxShadow = '0 0 20px rgba(100, 255, 218, 0.4)';
                        btnElement.innerHTML = '<div style="font-size: 1.5rem;">‚úì</div><div style="font-size: 0.9rem; margin-top: 5px;">' + targetPlayer.name + '</div>';
                        btnElement.style.cursor = 'default';
                        btnElement.style.pointerEvents = 'none';
                        
                        // Update container with confirmation
                        setTimeout(function() {
                            var confirmation = document.createElement('div');
                            confirmation.style.marginTop = '15px';
                            confirmation.style.padding = '15px';
                            confirmation.style.background = 'rgba(100, 255, 218, 0.3)';
                            confirmation.style.border = '3px solid var(--accent-color)';
                            confirmation.style.borderRadius = '10px';
                            confirmation.style.boxShadow = '0 0 20px rgba(100, 255, 218, 0.4)';
                            var immediateResults = document.getElementById('show-results-immediately').checked;
                            if (immediateResults) {
                                // In immediate mode, show current role (after previous swaps)
                                var currentRoleName = targetPlayer.currentRole || targetPlayer.initialRole;
                                var targetRole = ROLE_DEFINITIONS[currentRoleName];
                                confirmation.innerHTML = '<p style="color: var(--accent-color); font-weight: bold; font-size: 1.1rem; margin: 0;">‚úì Selected: <strong>' + targetPlayer.name + '</strong></p>' +
                                    '<div class="role-card" style="margin: 15px auto; width: 120px; height: 140px;"><div class="role-icon" style="font-size: 2.5rem;">' + targetRole.icon + '</div><div class="role-title role-' + targetRole.color + '" style="font-size: 1rem;">' + targetRole.name + '</div></div>';
                            } else {
                                confirmation.innerHTML = '<p style="color: var(--accent-color); font-weight: bold; font-size: 1.1rem; margin: 0;">‚úì Selected: <strong>' + targetPlayer.name + '</strong></p><p style="color: #fff; font-size: 0.95rem; margin-top: 8px; margin-bottom: 0;">You will see their original role (before swaps) in the results phase.</p>';
                            }
                            container.appendChild(confirmation);
                        }, 100);
                        
                        player.actionCompleted = true;
                        var nextBtn = document.getElementById('next-dist-btn');
                        nextBtn.disabled = false;
                        nextBtn.style.opacity = '1';
                    };
                })(playerBtn, p);
                playersDiv.appendChild(playerBtn);
            });
            playerSection.appendChild(playersDiv);
            div.appendChild(playerSection);
            
            container.appendChild(div);
        }
        
        function showSeerCenterSelection(player, container, isDoppelganger) {
            // Clear container and show center card selection inline
            container.innerHTML = '';
            
            var div = document.createElement('div');
            div.innerHTML = '<p style="margin: 15px 0;">Select 2 center cards to look at:</p>';
            
            var centerDiv = document.createElement('div');
            centerDiv.className = 'center-cards';
            centerDiv.style.position = 'relative';
            centerDiv.style.zIndex = '1';
            
            var selectedCards = [];
            
            for (var i = 0; i < centerCards.length; i++) {
                var card = document.createElement('div');
                card.className = 'center-card';
                card.style.cursor = 'pointer';
                card.style.position = 'relative';
                card.style.zIndex = '10';
                card.style.pointerEvents = 'auto';
                card.innerHTML = '<div style="font-size: 1.5rem;">?</div>';
                card.dataset.index = i;
                
                // Use proper closure with captured index
                (function(cardElement, cardIndex) {
                    cardElement.onclick = function(e) {
                        e.stopPropagation();
                        
                        var indexPos = selectedCards.indexOf(cardIndex);
                        if (indexPos === -1) {
                            // Select this card
                            if (selectedCards.length < 2) {
                                selectedCards.push(cardIndex);
                                cardElement.style.background = 'rgba(100, 255, 218, 0.3)';
                                cardElement.style.border = '3px solid var(--accent-color)';
                                cardElement.style.boxShadow = '0 0 20px rgba(100, 255, 218, 0.4)';
                            }
                        } else {
                            // Deselect this card
                            selectedCards.splice(indexPos, 1);
                            cardElement.style.background = '';
                            cardElement.style.border = '2px solid #555';
                            cardElement.style.boxShadow = '';
                        }
                        
                        // Update confirm button state
                        var confirmBtn = document.getElementById('seer-confirm-btn');
                        if (confirmBtn) {
                            if (selectedCards.length === 2) {
                                confirmBtn.disabled = false;
                                confirmBtn.style.opacity = '1';
                            } else {
                                confirmBtn.disabled = true;
                                confirmBtn.style.opacity = '0.5';
                            }
                        }
                    };
                })(card, i);
                centerDiv.appendChild(card);
            }
            
            div.appendChild(centerDiv);
            
            var confirmBtn = document.createElement('button');
            confirmBtn.className = 'action-btn';
            confirmBtn.id = 'seer-confirm-btn';
            confirmBtn.innerText = 'Confirm Selection';
            confirmBtn.disabled = true;
            confirmBtn.style.opacity = '0.5';
            confirmBtn.style.marginTop = '15px';
            confirmBtn.onclick = function() {
                if (selectedCards.length === 2) {
                    // Store the action
                    if (isDoppelganger) {
                        if (!playerActions[player.name]) {
                            playerActions[player.name] = { type: 'doppelganger' };
                        }
                        playerActions[player.name].action = 'center';
                        playerActions[player.name].centerCards = selectedCards.slice();
                    } else {
                        playerActions[player.name] = { 
                            type: 'seer', 
                            action: 'center', 
                            centerCards: selectedCards.slice() 
                        };
                    }
                    player.actionCompleted = true;
                    
                    // Show confirmation
                    var confirmation = document.createElement('div');
                    confirmation.style.marginTop = '15px';
                    confirmation.style.padding = '15px';
                    confirmation.style.background = 'rgba(100, 255, 218, 0.3)';
                    confirmation.style.border = '3px solid var(--accent-color)';
                    confirmation.style.borderRadius = '10px';
                    confirmation.style.boxShadow = '0 0 20px rgba(100, 255, 218, 0.4)';
                    confirmation.innerHTML = '<p style="color: var(--accent-color); font-weight: bold; font-size: 1.1rem; margin: 0;">‚úì Selected 2 center cards</p><p style="color: #fff; font-size: 0.95rem; margin-top: 8px; margin-bottom: 0;">You will see their original roles (before swaps) in the results phase.</p>';
                    container.appendChild(confirmation);
                    
                    var nextBtn = document.getElementById('next-dist-btn');
                    nextBtn.disabled = false;
                    nextBtn.style.opacity = '1';
                } else {
                    alert('Please select exactly 2 center cards.');
                }
            };
            div.appendChild(confirmBtn);
            
            container.appendChild(div);
        }
        
        // Old modal-based function (kept for reference but not used)
        function showSeerCenterSelection_OLD(player, isDoppelganger) {
            var modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.id = 'seer-center-modal';
            var content = document.createElement('div');
            content.className = 'container';
            content.style.maxWidth = '500px';
            
            var title = document.createElement('h2');
            title.innerText = 'Select 2 Center Cards';
            content.appendChild(title);
            
            var instruction = document.createElement('p');
            instruction.innerText = 'Choose which 2 center cards to look at:';
            instruction.style.marginBottom = '15px';
            content.appendChild(instruction);
            
            var centerDiv = document.createElement('div');
            centerDiv.className = 'center-cards';
            centerDiv.style.marginBottom = '15px';
            var selectedCards = [];
            
            for (var i = 0; i < 3; i++) {
                var card = document.createElement('div');
                card.className = 'center-card';
                card.style.cursor = 'pointer';
                card.innerHTML = '<div style="font-size: 1.5rem;">?</div>';
                card.dataset.index = i; // Store index as data attribute
                
                // Use proper closure with captured index and card reference
                (function(cardElement, cardIndex) {
                    cardElement.onclick = function() {
                        if (cardElement.classList.contains('selected')) {
                            // Deselect
                            cardElement.classList.remove('selected');
                            cardElement.style.border = '';
                            cardElement.style.boxShadow = '';
                            var idx = selectedCards.indexOf(cardIndex);
                            if (idx > -1) selectedCards.splice(idx, 1);
                        } else if (selectedCards.length < 2) {
                            // Select
                            cardElement.classList.add('selected');
                            cardElement.style.border = '3px solid var(--accent-color)';
                            cardElement.style.boxShadow = '0 0 20px rgba(100, 255, 218, 0.5)';
                            selectedCards.push(cardIndex);
                        }
                        
                        // Enable confirm button when 2 cards selected
                        if (selectedCards.length === 2) {
                            confirmBtn.disabled = false;
                            confirmBtn.style.opacity = '1';
                        } else {
                            confirmBtn.disabled = true;
                            confirmBtn.style.opacity = '0.5';
                        }
                    };
                })(card, i);
                centerDiv.appendChild(card);
            }
            content.appendChild(centerDiv);
            
            var confirmBtn = document.createElement('button');
            confirmBtn.className = 'action-btn';
            confirmBtn.innerText = 'Confirm Selection';
            confirmBtn.disabled = true;
            confirmBtn.style.opacity = '0.5';
            confirmBtn.onclick = function() {
                if (selectedCards.length === 2) {
                    // Verify the selected card indices are valid (0-2)
                    var validIndices = selectedCards.every(function(idx) {
                        return idx >= 0 && idx < 3;
                    });
                    
                    if (!validIndices) {
                        console.warn('Seer center selection: invalid card indices', selectedCards);
                        alert('Invalid card selection. Please try again.');
                        return;
                    }
                    
                    // Store the action
                    if (isDoppelganger) {
                        if (!playerActions[player.name]) {
                            playerActions[player.name] = { type: 'doppelganger' };
                        }
                        playerActions[player.name].action = 'center';
                        playerActions[player.name].centerCards = selectedCards.slice();
                    } else {
                        playerActions[player.name] = { 
                            type: 'seer', 
                            action: 'center', 
                            centerCards: selectedCards.slice() 
                        };
                    }
                    player.actionCompleted = true;
                    document.body.removeChild(modal);
                    var nextBtn = document.getElementById('next-dist-btn');
                    nextBtn.disabled = false;
                    nextBtn.style.opacity = '1';
                } else {
                    alert('Please select exactly 2 center cards.');
                }
            };
            content.appendChild(confirmBtn);
            
            modal.appendChild(content);
            document.body.appendChild(modal);
        }

        function showRobberAction(player, container, isDoppelganger) {
            container.innerHTML = '';
            
            var div = document.createElement('div');
            div.innerHTML = '<p style="margin: 15px 0;">Select a player to steal from:</p>';
            
            var playersDiv = document.createElement('div');
            playersDiv.className = 'center-cards';
            playersDiv.style.position = 'relative';
            playersDiv.style.zIndex = '1';
            
            players.forEach(function(p) {
                if (p.name === player.name) return; // Can't select self
                
                var playerBtn = document.createElement('div');
                playerBtn.className = 'center-card';
                playerBtn.style.cursor = 'pointer';
                playerBtn.style.position = 'relative';
                playerBtn.style.zIndex = '10';
                playerBtn.style.pointerEvents = 'auto';
                playerBtn.style.display = 'flex';
                playerBtn.style.flexDirection = 'column';
                playerBtn.style.alignItems = 'center';
                playerBtn.style.justifyContent = 'center';
                playerBtn.style.padding = '10px';
                playerBtn.innerHTML = '<div style="font-size: 1.2rem; font-weight: bold;">' + p.name + '</div>';
                playerBtn.dataset.playerName = p.name;
                
                // Use proper closure with captured player
                (function(btnElement, targetPlayer) {
                    btnElement.onclick = function(e) {
                        e.stopPropagation();
                        
                        // Store the action
                        if (isDoppelganger) {
                            if (!playerActions[player.name]) {
                                playerActions[player.name] = { type: 'doppelganger' };
                            }
                            playerActions[player.name].target = targetPlayer.name;
                        } else {
                            playerActions[player.name] = { type: 'robber', target: targetPlayer.name };
                        }
                        
                        // Show confirmation
                        btnElement.style.background = 'rgba(100, 255, 218, 0.3)';
                        btnElement.style.border = '3px solid var(--accent-color)';
                        btnElement.style.boxShadow = '0 0 20px rgba(100, 255, 218, 0.4)';
                        btnElement.innerHTML = '<div style="font-size: 1.5rem;">‚úì</div><div style="font-size: 0.9rem; margin-top: 5px;">' + targetPlayer.name + '</div>';
                        btnElement.style.cursor = 'default';
                        btnElement.style.pointerEvents = 'none';
                        
                        // Disable other buttons
                        for (var j = 0; j < playersDiv.children.length; j++) {
                            if (playersDiv.children[j] !== btnElement) {
                                playersDiv.children[j].style.opacity = '0.3';
                                playersDiv.children[j].style.pointerEvents = 'none';
                            }
                        }
                        
                        // Update container with confirmation
                        setTimeout(function() {
                            var confirmation = document.createElement('div');
                            confirmation.style.marginTop = '15px';
                            confirmation.style.padding = '15px';
                            confirmation.style.background = 'rgba(100, 255, 218, 0.3)';
                            confirmation.style.border = '3px solid var(--accent-color)';
                            confirmation.style.borderRadius = '10px';
                            confirmation.style.boxShadow = '0 0 20px rgba(100, 255, 218, 0.4)';
                            var immediateResults = document.getElementById('show-results-immediately').checked;
                            if (immediateResults) {
                                // In immediate mode, show current role (after previous swaps)
                                var currentRoleName = targetPlayer.currentRole || targetPlayer.initialRole;
                                var stolenRole = ROLE_DEFINITIONS[currentRoleName];
                                confirmation.innerHTML = '<p style="color: var(--accent-color); font-weight: bold; font-size: 1.1rem; margin: 0;">‚úì You stole from: <strong>' + targetPlayer.name + '</strong></p>' +
                                    '<p style="margin-top: 10px; margin-bottom: 5px;">Your new role:</p>' +
                                    '<div class="role-card" style="margin: 15px auto; width: 120px; height: 140px;"><div class="role-icon" style="font-size: 2.5rem;">' + stolenRole.icon + '</div><div class="role-title role-' + stolenRole.color + '" style="font-size: 1rem;">' + stolenRole.name + '</div></div>' +
                                    '<p style="color: var(--text-secondary); font-size: 0.9rem;">(You are now this role. ' + targetPlayer.name + ' is now the Robber.)</p>';
                            } else {
                                confirmation.innerHTML = '<p style="color: var(--accent-color); font-weight: bold; font-size: 1.1rem; margin: 0;">‚úì Selected: <strong>' + targetPlayer.name + '</strong></p><p style="color: #fff; font-size: 0.95rem; margin-top: 8px; margin-bottom: 0;">You will see your new role after all night actions complete.</p>';
                            }
                            container.appendChild(confirmation);
                        }, 100);
                        
                        player.actionCompleted = true;
                        var nextBtn = document.getElementById('next-dist-btn');
                        nextBtn.disabled = false;
                        nextBtn.style.opacity = '1';
                    };
                })(playerBtn, p);
                playersDiv.appendChild(playerBtn);
            });
            
            div.appendChild(playersDiv);
            container.appendChild(div);
        }

        function showTroublemakerAction(player, container, isDoppelganger) {
            container.innerHTML = '';
            
            var div = document.createElement('div');
            div.innerHTML = '<p style="margin: 15px 0;">Select 2 players to swap (click both):</p>';
            
            var playersDiv = document.createElement('div');
            playersDiv.className = 'center-cards';
            playersDiv.style.position = 'relative';
            playersDiv.style.zIndex = '1';
            playersDiv.id = 'troublemaker-players';
            
            var selectedPlayers = [];
            
            players.forEach(function(p) {
                if (p.name === player.name) return; // Can't select self
                
                var playerBtn = document.createElement('div');
                playerBtn.className = 'center-card';
                playerBtn.style.cursor = 'pointer';
                playerBtn.style.position = 'relative';
                playerBtn.style.zIndex = '10';
                playerBtn.style.pointerEvents = 'auto';
                playerBtn.style.display = 'flex';
                playerBtn.style.flexDirection = 'column';
                playerBtn.style.alignItems = 'center';
                playerBtn.style.justifyContent = 'center';
                playerBtn.style.padding = '10px';
                playerBtn.innerHTML = '<div style="font-size: 1.2rem; font-weight: bold;">' + p.name + '</div>';
                playerBtn.dataset.playerName = p.name;
                
                // Use proper closure with captured player
                (function(btnElement, targetPlayer) {
                    btnElement.onclick = function(e) {
                        e.stopPropagation();
                        
                        var playerIndex = selectedPlayers.indexOf(targetPlayer.name);
                        if (playerIndex === -1) {
                            // Select this player
                            if (selectedPlayers.length < 2) {
                                selectedPlayers.push(targetPlayer.name);
                                btnElement.style.background = 'rgba(100, 255, 218, 0.3)';
                                btnElement.style.border = '3px solid var(--accent-color)';
                                btnElement.style.boxShadow = '0 0 20px rgba(100, 255, 218, 0.4)';
                                btnElement.innerHTML = '<div style="font-size: 1.2rem; font-weight: bold;">' + targetPlayer.name + '</div><div style="font-size: 1rem; color: var(--accent-color); margin-top: 5px;">‚úì</div>';
                                
                                // If 2 players selected, confirm
                                if (selectedPlayers.length === 2) {
                                    // Store the action
                                    if (isDoppelganger) {
                                        if (!playerActions[player.name]) {
                                            playerActions[player.name] = { type: 'doppelganger' };
                                        }
                                        playerActions[player.name].player1 = selectedPlayers[0];
                                        playerActions[player.name].player2 = selectedPlayers[1];
                                    } else {
                                        playerActions[player.name] = { 
                                            type: 'troublemaker', 
                                            player1: selectedPlayers[0], 
                                            player2: selectedPlayers[1] 
                                        };
                                    }
                                    player.actionCompleted = true;
                                    
                                    // Show confirmation
                                    var confirmation = document.createElement('div');
                                    confirmation.style.marginTop = '15px';
                                    confirmation.style.padding = '15px';
                                    confirmation.style.background = 'rgba(100, 255, 218, 0.3)';
                                    confirmation.style.border = '3px solid var(--accent-color)';
                                    confirmation.style.borderRadius = '10px';
                                    confirmation.style.boxShadow = '0 0 20px rgba(100, 255, 218, 0.4)';
                                    confirmation.innerHTML = '<p style="color: var(--accent-color); font-weight: bold; font-size: 1.1rem; margin: 0;">‚úì Swapped: <strong>' + selectedPlayers[0] + '</strong> and <strong>' + selectedPlayers[1] + '</strong></p><p style="color: #fff; font-size: 0.95rem; margin-top: 8px; margin-bottom: 0;">You don\'t know what roles they had.</p>';
                                    container.appendChild(confirmation);
                                    
                                    var nextBtn = document.getElementById('next-dist-btn');
                                    nextBtn.disabled = false;
                                    nextBtn.style.opacity = '1';
                                }
                            }
                        } else {
                            // Deselect this player
                            selectedPlayers.splice(playerIndex, 1);
                            btnElement.style.background = '';
                            btnElement.style.border = '2px solid #555';
                            btnElement.style.boxShadow = '';
                            btnElement.innerHTML = '<div style="font-size: 1.2rem; font-weight: bold;">' + targetPlayer.name + '</div>';
                        }
                    };
                })(playerBtn, p);
                playersDiv.appendChild(playerBtn);
            });
            
            div.appendChild(playersDiv);
            container.appendChild(div);
        }

        function showDrunkAction(player, container, isDoppelganger) {
            // Clear container first
            container.innerHTML = '';
            
            var div = document.createElement('div');
            div.innerHTML = '<p style="margin: 15px 0;">Select a center card to swap with (you won\'t see which one):</p>';
            
            var centerDiv = document.createElement('div');
            centerDiv.className = 'center-cards';
            centerDiv.style.position = 'relative';
            centerDiv.style.zIndex = '1';
            
            for (var i = 0; i < centerCards.length; i++) {
                var card = document.createElement('div');
                card.className = 'center-card';
                card.style.cursor = 'pointer';
                card.style.position = 'relative';
                card.style.zIndex = '10';
                card.style.pointerEvents = 'auto';
                card.innerHTML = '<div style="font-size: 1.5rem;">?</div>';
                card.dataset.index = i;
                
                // Use proper closure with captured index
                (function(cardElement, cardIndex) {
                    cardElement.onclick = function(e) {
                        e.stopPropagation(); // Prevent event bubbling
                        
                        // Store the correct index
                        if (isDoppelganger) {
                            if (!playerActions[player.name]) {
                                playerActions[player.name] = { type: 'doppelganger' };
                            }
                            playerActions[player.name].centerIndex = cardIndex;
                        } else {
                            playerActions[player.name] = { type: 'drunk', centerIndex: cardIndex };
                        }
                        
                        // Show confirmation
                        cardElement.style.background = 'rgba(100, 255, 218, 0.2)';
                        cardElement.style.border = '3px solid var(--accent-color)';
                        cardElement.innerHTML = '<div style="font-size: 1.5rem;">‚úì</div><div style="font-size: 0.8rem;">Selected</div>';
                        cardElement.style.cursor = 'default';
                        cardElement.style.pointerEvents = 'none';
                        
                        // Disable other cards
                        for (var j = 0; j < centerDiv.children.length; j++) {
                            if (j !== cardIndex) {
                                centerDiv.children[j].style.opacity = '0.3';
                                centerDiv.children[j].style.pointerEvents = 'none';
                            }
                        }
                        
                        player.actionCompleted = true;
                        var nextBtn = document.getElementById('next-dist-btn');
                        nextBtn.disabled = false;
                        nextBtn.style.opacity = '1';
                    };
                })(card, i);
                centerDiv.appendChild(card);
            }
            div.appendChild(centerDiv);
            container.appendChild(div);
        }

        function showWerewolfAction(player, container, isDoppelganger) {
            // Werewolves see each other (includes Alpha Wolf, Mystic Wolf, and Dream Wolf)
            var werewolves = players.filter(p => (p.initialRole === 'Werewolf' || p.initialRole === 'Alpha Wolf' || p.initialRole === 'Mystic Wolf' || p.initialRole === 'Dream Wolf') && p.name !== player.name);
            var div = document.createElement('div');
            div.innerHTML = '<p style="margin: 15px 0;">You see other Werewolves.</p>';
            if (werewolves.length > 0) {
                div.innerHTML += '<p style="color: var(--werewolf-color); margin-bottom: 15px;">Other Werewolves: ' + werewolves.map(p => p.name).join(', ') + '</p>';
            } else {
                div.innerHTML += '<p style="color: var(--werewolf-color); margin-bottom: 15px;">You are the only Werewolf - look at ONE center card:</p>';
                // If only one werewolf, they see ONE center card
                var centerDiv = document.createElement('div');
                centerDiv.className = 'center-cards';
            for (var i = 0; i < centerCards.length; i++) {
                var card = document.createElement('div');
                card.className = 'center-card';
                card.style.cursor = 'pointer';
                card.innerHTML = '<div style="font-size: 1.5rem;">?</div>';
                card.dataset.index = i; // Store index as data attribute
                
                // Use proper closure with captured index and card reference
                (function(cardElement, cardIndex, centerDivRef) {
                    cardElement.onclick = function() {
                        // Store the correct index
                        if (isDoppelganger) {
                            if (!playerActions[player.name]) {
                                playerActions[player.name] = { type: 'doppelganger' };
                            }
                            playerActions[player.name].centerIndex = cardIndex;
                        } else {
                            playerActions[player.name] = { type: 'werewolf', centerIndex: cardIndex };
                        }
                        
                        // Show the selected card using the correct index
                        cardElement.className = 'center-card revealed';
                        var roleDef = ROLE_DEFINITIONS[centerCards[cardIndex]];
                        if (roleDef) {
                            cardElement.classList.add(roleDef.color);
                            cardElement.innerHTML = '<div style="font-size: 1.5rem;">' + roleDef.icon + '</div><div style="font-size: 0.8rem;">' + roleDef.name + '</div>';
                        }
                        cardElement.style.cursor = 'default';
                        cardElement.style.pointerEvents = 'none';
                        
                        // Disable other cards
                        for (var j = 0; j < centerDivRef.children.length; j++) {
                            if (j !== cardIndex) {
                                centerDivRef.children[j].style.opacity = '0.3';
                                centerDivRef.children[j].style.pointerEvents = 'none';
                            }
                        }
                        
                        player.actionCompleted = true;
                        var nextBtn = document.getElementById('next-dist-btn');
                        nextBtn.disabled = false;
                        nextBtn.style.opacity = '1';
                    };
                })(card, i, centerDiv);
                centerDiv.appendChild(card);
            }
                div.appendChild(centerDiv);
            }
            
            if (werewolves.length > 0) {
                // Multiple werewolves - no center card viewing
                if (isDoppelganger) {
                    // Doppelg√§nger action already stored
                } else {
                    playerActions[player.name] = { type: 'werewolf' };
                }
                player.actionCompleted = true;
                var nextBtn = document.getElementById('next-dist-btn');
                nextBtn.disabled = false;
                nextBtn.style.opacity = '1';
            }
            
            container.appendChild(div);
        }

        // --- New Daybreak Role Actions ---
        function showAlphaWolfAction(player, container, isDoppelganger) {
            // Alpha Wolf: First saw other Werewolves (already shown in extraInfo)
            // Now wake up separately to swap Center Werewolf card with a non-Werewolf player
            container.innerHTML = '';
            
            var div = document.createElement('div');
            
            // Show werewolf knowledge (already set in setupSpecialKnowledge)
            if (player.extraInfo) {
                div.innerHTML = '<p style="color: var(--accent-color); font-weight: bold; margin-bottom: 10px;">Other Werewolves:</p>';
                var werewolfList = document.createElement('p');
                werewolfList.style.color = 'var(--text-secondary)';
                werewolfList.style.marginBottom = '20px';
                werewolfList.textContent = player.extraInfo.replace('Other Werewolf(ves): ', '');
                div.appendChild(werewolfList);
            } else {
                div.innerHTML = '<p style="color: var(--text-secondary); margin-bottom: 20px;">You are the only Werewolf.</p>';
            }
            
            div.innerHTML += '<p style="margin: 15px 0;">Now swap the Center Werewolf card with a non-Werewolf player\'s card (you don\'t see either card):</p>';
            
            // Player selection (only non-Werewolves)
            var playersDiv = document.createElement('div');
            playersDiv.className = 'center-cards';
            playersDiv.style.position = 'relative';
            playersDiv.style.zIndex = '1';
            
            var nonWerewolves = players.filter(p => {
                if (p.name === player.name) return false; // Can't select self
                var role = p.initialRole;
                // Exclude all werewolf types
                return role !== 'Werewolf' && role !== 'Alpha Wolf' && role !== 'Mystic Wolf' && role !== 'Dream Wolf' && role !== 'Oracle Wolf';
            });
            
            if (nonWerewolves.length === 0) {
                div.innerHTML += '<p style="color: var(--text-secondary);">No non-Werewolf players to swap with.</p>';
                playerActions[player.name] = { type: 'alphawolf', targetPlayer: null };
                player.actionCompleted = true;
                var nextBtn = document.getElementById('next-dist-btn');
                nextBtn.disabled = false;
                nextBtn.style.opacity = '1';
                container.appendChild(div);
                return;
            }
            
            nonWerewolves.forEach(function(p) {
                var playerBtn = document.createElement('div');
                playerBtn.className = 'center-card';
                playerBtn.style.cursor = 'pointer';
                playerBtn.style.position = 'relative';
                playerBtn.style.zIndex = '10';
                playerBtn.style.pointerEvents = 'auto';
                playerBtn.style.display = 'flex';
                playerBtn.style.flexDirection = 'column';
                playerBtn.style.alignItems = 'center';
                playerBtn.style.justifyContent = 'center';
                playerBtn.style.padding = '10px';
                playerBtn.innerHTML = '<div style="font-size: 1.2rem; font-weight: bold;">' + p.name + '</div>';
                playerBtn.dataset.playerName = p.name;
                
                (function(btnElement, targetPlayer) {
                    btnElement.onclick = function(e) {
                        e.stopPropagation();
                        
                        // Store the action - Center Werewolf is always at index 3 (4th card)
                        if (isDoppelganger) {
                            if (!playerActions[player.name]) {
                                playerActions[player.name] = { type: 'doppelganger' };
                            }
                            playerActions[player.name].centerWerewolfIndex = 3;
                            playerActions[player.name].targetPlayer = targetPlayer.name;
                        } else {
                            playerActions[player.name] = { 
                                type: 'alphawolf', 
                                centerWerewolfIndex: 3, // Center Werewolf is the 4th center card
                                targetPlayer: targetPlayer.name 
                            };
                        }
                        
                        // Show confirmation
                        btnElement.style.background = 'rgba(100, 255, 218, 0.3)';
                        btnElement.style.border = '3px solid var(--accent-color)';
                        btnElement.style.boxShadow = '0 0 20px rgba(100, 255, 218, 0.4)';
                        btnElement.innerHTML = '<div style="font-size: 1.5rem;">‚úì</div><div style="font-size: 0.9rem; margin-top: 5px;">' + targetPlayer.name + '</div>';
                        btnElement.style.cursor = 'default';
                        btnElement.style.pointerEvents = 'none';
                        
                        // Disable other buttons
                        for (var j = 0; j < playersDiv.children.length; j++) {
                            if (playersDiv.children[j] !== btnElement) {
                                playersDiv.children[j].style.opacity = '0.3';
                                playersDiv.children[j].style.pointerEvents = 'none';
                            }
                        }
                        
                        // Show confirmation message
                        var confirmation = document.createElement('div');
                        confirmation.style.marginTop = '15px';
                        confirmation.style.padding = '15px';
                        confirmation.style.background = 'rgba(100, 255, 218, 0.3)';
                        confirmation.style.border = '3px solid var(--accent-color)';
                        confirmation.style.borderRadius = '10px';
                        confirmation.style.boxShadow = '0 0 20px rgba(100, 255, 218, 0.4)';
                        confirmation.innerHTML = '<p style="color: var(--accent-color); font-weight: bold; font-size: 1.1rem; margin: 0;">‚úì Swapped Center Werewolf with <strong>' + targetPlayer.name + '</strong></p><p style="color: #fff; font-size: 0.95rem; margin-top: 8px; margin-bottom: 0;">You don\'t know what roles they had.</p>';
                        container.appendChild(confirmation);
                        
                        player.actionCompleted = true;
                        var nextBtn = document.getElementById('next-dist-btn');
                        nextBtn.disabled = false;
                        nextBtn.style.opacity = '1';
                    };
                })(playerBtn, p);
                playersDiv.appendChild(playerBtn);
            });
            
            div.appendChild(playersDiv);
            container.appendChild(div);
        }
        
        function showMysticWolfAction(player, container, isDoppelganger) {
            // Mystic Wolf: See other Werewolves (if any), then look at 1 player's card
            var werewolves = players.filter(p => (p.initialRole === 'Werewolf' || p.initialRole === 'Alpha Wolf' || p.initialRole === 'Mystic Wolf' || p.initialRole === 'Dream Wolf' || p.initialRole === 'Oracle Wolf') && p.name !== player.name);
            var div = document.createElement('div');
            
            if (werewolves.length > 0) {
                div.innerHTML = '<p style="margin-bottom: 15px;">You see the other Werewolf(ves): <strong>' + werewolves.map(w => w.name).join(', ') + '</strong></p>';
            } else {
                div.innerHTML = '<p style="margin-bottom: 15px;">You are the only Werewolf.</p>';
            }
            
            div.innerHTML += '<p style="margin-bottom: 15px;">As Mystic Wolf, you also look at 1 player\'s card:</p>';
            
            // Player selection
            var playersDiv = document.createElement('div');
            playersDiv.className = 'center-cards';
            playersDiv.style.marginTop = '10px';
            players.forEach(function(p) {
                if (p.name === player.name) return;
                var playerBtn = document.createElement('div');
                playerBtn.className = 'center-card';
                playerBtn.style.cursor = 'pointer';
                playerBtn.style.pointerEvents = 'auto';
                playerBtn.innerHTML = '<div style="font-size: 1.2rem; font-weight: bold;">' + p.name + '</div>';
                playerBtn.dataset.playerName = p.name;
                
                (function(btnElement, targetPlayer) {
                    btnElement.onclick = function(e) {
                        e.stopPropagation();
                        playerActions[player.name] = { type: 'mysticwolf', targetPlayer: targetPlayer.name };
                        btnElement.style.background = 'rgba(100, 255, 218, 0.2)';
                        btnElement.style.border = '3px solid var(--accent-color)';
                        
                        // Mystic Wolf always sees the player's card immediately (this is their night action)
                        // In immediate mode, show current role (after previous swaps)
                        var currentRoleName = targetPlayer.currentRole || targetPlayer.initialRole;
                        var targetRole = ROLE_DEFINITIONS[currentRoleName];
                        btnElement.innerHTML = '<div style="font-size: 1.2rem; font-weight: bold;">' + targetPlayer.name + '</div><div style="font-size: 1rem; margin-top: 5px;">' + targetRole.icon + '</div><div style="font-size: 0.8rem; margin-top: 3px;">' + targetRole.name + '</div>';
                        
                        btnElement.style.cursor = 'default';
                        btnElement.style.pointerEvents = 'none';
                        for (var j = 0; j < playersDiv.children.length; j++) {
                            if (playersDiv.children[j] !== btnElement) {
                                playersDiv.children[j].style.opacity = '0.3';
                                playersDiv.children[j].style.pointerEvents = 'none';
                            }
                        }
                        
                        // Show confirmation with role card
                        var confirmation = document.createElement('div');
                        confirmation.style.marginTop = '15px';
                        confirmation.style.padding = '15px';
                        confirmation.style.background = 'rgba(100, 255, 218, 0.3)';
                        confirmation.style.border = '3px solid var(--accent-color)';
                        confirmation.style.borderRadius = '10px';
                        confirmation.style.boxShadow = '0 0 20px rgba(100, 255, 218, 0.4)';
                        confirmation.innerHTML = '<p style="color: var(--accent-color); font-weight: bold; font-size: 1.1rem; margin: 0;">‚úì You looked at <strong>' + targetPlayer.name + '</strong>\'s card:</p>' +
                            '<div class="role-card" style="margin: 15px auto; width: 120px; height: 140px;"><div class="role-icon" style="font-size: 2.5rem;">' + targetRole.icon + '</div><div class="role-title role-' + targetRole.color + '" style="font-size: 1rem;">' + targetRole.name + '</div></div>';
                        container.appendChild(confirmation);
                        
                        player.actionCompleted = true;
                        var nextBtn = document.getElementById('next-dist-btn');
                        if (nextBtn) {
                            nextBtn.disabled = false;
                            nextBtn.style.opacity = '1';
                        }
                    };
                })(playerBtn, p);
                playersDiv.appendChild(playerBtn);
            });
            div.appendChild(playersDiv);
            container.appendChild(div);
        }
        
        function showApprenticeSeerAction(player, container, isDoppelganger) {
            // Apprentice Seer: Look at 1 center card
            container.innerHTML = '<p style="margin-bottom: 15px;">Look at 1 center card:</p>';
            var centerDiv = document.createElement('div');
            centerDiv.className = 'center-cards';
            for (var i = 0; i < centerCards.length; i++) {
                var card = document.createElement('div');
                card.className = 'center-card';
                card.style.cursor = 'pointer';
                card.style.pointerEvents = 'auto';
                card.innerHTML = '<div style="font-size: 1.5rem;">?</div>';
                card.dataset.index = i;
                
                (function(cardElement, cardIndex) {
                    cardElement.onclick = function(e) {
                        e.stopPropagation();
                        playerActions[player.name] = { type: 'apprenticeseer', centerIndex: cardIndex };
                        cardElement.style.background = 'rgba(100, 255, 218, 0.2)';
                        cardElement.style.border = '3px solid var(--accent-color)';
                        
                        var immediateResults = document.getElementById('show-results-immediately').checked;
                        if (immediateResults) {
                            var role = ROLE_DEFINITIONS[centerCards[cardIndex]];
                            cardElement.innerHTML = '<div style="font-size: 1.5rem;">' + role.icon + '</div><div style="font-size: 0.8rem;">' + role.name + '</div>';
                            cardElement.classList.add(role.color);
                        } else {
                            cardElement.innerHTML = '<div style="font-size: 1.5rem;">‚úì</div>';
                        }
                        
                        cardElement.style.cursor = 'default';
                        cardElement.style.pointerEvents = 'none';
                        for (var j = 0; j < centerDiv.children.length; j++) {
                            if (j !== cardIndex) {
                                centerDiv.children[j].style.opacity = '0.3';
                                centerDiv.children[j].style.pointerEvents = 'none';
                            }
                        }
                        
                        if (!immediateResults) {
                             var msg = document.createElement('p');
                             msg.style.color = 'var(--text-secondary)';
                             msg.style.marginTop = '15px';
                             msg.style.fontSize = '0.9rem';
                             msg.innerText = 'You will see this card in the results phase.';
                             container.appendChild(msg);
                        }
                        
                        player.actionCompleted = true;
                        var nextBtn = document.getElementById('next-dist-btn');
                        nextBtn.disabled = false;
                        nextBtn.style.opacity = '1';
                    };
                })(card, i);
                centerDiv.appendChild(card);
            }
            container.appendChild(centerDiv);
        }
        
        function showWitchAction(player, container, isDoppelganger) {
            // Witch: Look at 1 center card, then swap it with any player (including self)
            container.innerHTML = '<p style="margin-bottom: 15px;">Look at 1 center card:</p>';
            
            var centerDiv = document.createElement('div');
            centerDiv.className = 'center-cards';
            centerDiv.style.marginBottom = '20px';
            
            var playersDiv = document.createElement('div'); // Created early to be referenced
            playersDiv.className = 'center-cards';
            playersDiv.style.marginTop = '10px';
            playersDiv.style.display = 'none'; // Hidden initially
            
            for (var i = 0; i < centerCards.length; i++) {
                var card = document.createElement('div');
                card.className = 'center-card';
                card.style.cursor = 'pointer';
                card.style.pointerEvents = 'auto';
                card.innerHTML = '<div style="font-size: 1.5rem;">?</div>';
                card.dataset.index = i;
                
                (function(cardElement, cardIndex) {
                    cardElement.onclick = function(e) {
                        e.stopPropagation();
                        
                        // Reveal the card
                        var cardRole = centerCards[cardIndex];
                        var roleDef = ROLE_DEFINITIONS[cardRole];
                        cardElement.innerHTML = '<div style="font-size: 1.5rem;">' + roleDef.icon + '</div><div style="font-size: 0.8rem;">' + roleDef.name + '</div>';
                        cardElement.classList.add(roleDef.color);
                        cardElement.style.background = 'rgba(100, 255, 218, 0.2)';
                        cardElement.style.border = '3px solid var(--accent-color)';
                        cardElement.style.cursor = 'default';
                        cardElement.style.pointerEvents = 'none';
                        
                        // Store preliminary action data
                        if (!playerActions[player.name]) {
                             playerActions[player.name] = { type: 'witch', centerIndex: cardIndex };
                        } else {
                             playerActions[player.name].centerIndex = cardIndex;
                        }
                        
                        // Disable other center cards
                        for (var j = 0; j < centerDiv.children.length; j++) {
                            if (j !== cardIndex) {
                                centerDiv.children[j].style.opacity = '0.3';
                                centerDiv.children[j].style.pointerEvents = 'none';
                            }
                        }
                        
                        // Show player selection
                        container.appendChild(document.createElement('br'));
                        var msg = document.createElement('p');
                        msg.style.margin = '15px 0';
                        msg.innerText = 'Now select a player to swap this card with:';
                        container.appendChild(msg);
                        
                        playersDiv.style.display = 'flex';
                        container.appendChild(playersDiv);
                    };
                })(card, i);
                centerDiv.appendChild(card);
            }
            container.appendChild(centerDiv);
            
            // Setup player selection (hidden initially)
            players.forEach(function(p) {
                var playerBtn = document.createElement('div');
                playerBtn.className = 'center-card';
                playerBtn.style.cursor = 'pointer';
                playerBtn.style.pointerEvents = 'auto';
                playerBtn.innerHTML = '<div style="font-size: 1.2rem; font-weight: bold;">' + p.name + '</div>';
                
                (function(btnElement, targetPlayer) {
                    btnElement.onclick = function(e) {
                        e.stopPropagation();
                        playerActions[player.name].targetPlayer = targetPlayer.name;
                        
                        btnElement.style.background = 'rgba(100, 255, 218, 0.2)';
                        btnElement.style.border = '3px solid var(--accent-color)';
                        btnElement.innerHTML = '<div style="font-size: 1.2rem; font-weight: bold;">' + targetPlayer.name + '</div><div style="font-size: 1rem;">‚úì</div>';
                        btnElement.style.cursor = 'default';
                        btnElement.style.pointerEvents = 'none';
                        
                        // Disable other players
                        for (var j = 0; j < playersDiv.children.length; j++) {
                            if (playersDiv.children[j] !== btnElement) {
                                playersDiv.children[j].style.opacity = '0.3';
                                playersDiv.children[j].style.pointerEvents = 'none';
                            }
                        }
                        
                        player.actionCompleted = true;
                        var nextBtn = document.getElementById('next-dist-btn');
                        if (nextBtn) {
                            nextBtn.disabled = false;
                            nextBtn.style.opacity = '1';
                        }
                    };
                })(playerBtn, p);
                playersDiv.appendChild(playerBtn);
            });
        }
        
        function showParanormalInvestigatorAction(player, container, isDoppelganger) {
            // Paranormal Investigator: Look at 1 player's card
            container.innerHTML = '<p style="margin-bottom: 15px;">Look at 1 player\'s card:</p>';
            var playersDiv = document.createElement('div');
            playersDiv.className = 'center-cards';
            players.forEach(function(p) {
                if (p.name === player.name) return;
                var playerBtn = document.createElement('div');
                playerBtn.className = 'center-card';
                playerBtn.style.cursor = 'pointer';
                playerBtn.style.pointerEvents = 'auto';
                playerBtn.innerHTML = '<div style="font-size: 1.2rem; font-weight: bold;">' + p.name + '</div>';
                playerBtn.dataset.playerName = p.name;
                
                (function(btnElement, targetPlayer) {
                    btnElement.onclick = function(e) {
                        e.stopPropagation();
                        playerActions[player.name] = { type: 'paranormalinvestigator', targetPlayer: targetPlayer.name };
                        btnElement.style.background = 'rgba(100, 255, 218, 0.2)';
                        btnElement.style.border = '3px solid var(--accent-color)';
                        btnElement.innerHTML = '<div style="font-size: 1.2rem; font-weight: bold;">' + targetPlayer.name + '</div><div style="font-size: 1rem;">‚úì</div>';
                        btnElement.style.cursor = 'default';
                        btnElement.style.pointerEvents = 'none';
                        for (var j = 0; j < playersDiv.children.length; j++) {
                            if (playersDiv.children[j] !== btnElement) {
                                playersDiv.children[j].style.opacity = '0.3';
                                playersDiv.children[j].style.pointerEvents = 'none';
                            }
                        }
                        player.actionCompleted = true;
                        var nextBtn = document.getElementById('next-dist-btn');
                        nextBtn.disabled = false;
                        nextBtn.style.opacity = '1';
                    };
                })(playerBtn, p);
                playersDiv.appendChild(playerBtn);
            });
            container.appendChild(playersDiv);
        }
        
        function showVillageIdiotAction(player, container, isDoppelganger) {
            // Village Idiot: Swap 2 center cards (doesn't see them)
            container.innerHTML = '<p style="margin-bottom: 15px;">Select 2 center cards to swap:</p>';
            var centerDiv = document.createElement('div');
            centerDiv.className = 'center-cards';
            var selectedIndices = [];
            for (var i = 0; i < centerCards.length; i++) {
                var card = document.createElement('div');
                card.className = 'center-card';
                card.style.cursor = 'pointer';
                card.style.pointerEvents = 'auto';
                card.innerHTML = '<div style="font-size: 1.5rem;">?</div>';
                card.dataset.index = i;
                
                (function(cardElement, cardIndex) {
                    cardElement.onclick = function(e) {
                        e.stopPropagation();
                        var idx = selectedIndices.indexOf(cardIndex);
                        if (idx === -1) {
                            if (selectedIndices.length < 2) {
                                selectedIndices.push(cardIndex);
                                cardElement.style.background = 'rgba(100, 255, 218, 0.2)';
                                cardElement.style.border = '3px solid var(--accent-color)';
                                cardElement.innerHTML = '<div style="font-size: 1.5rem;">‚úì</div>';
                            }
                        } else {
                            selectedIndices.splice(idx, 1);
                            cardElement.style.background = '';
                            cardElement.style.border = '';
                            cardElement.innerHTML = '<div style="font-size: 1.5rem;">?</div>';
                        }
                        
                        if (selectedIndices.length === 2) {
                            playerActions[player.name] = { type: 'villageidiot', card1: selectedIndices[0], card2: selectedIndices[1] };
                            player.actionCompleted = true;
                            for (var j = 0; j < centerDiv.children.length; j++) {
                                centerDiv.children[j].style.pointerEvents = 'none';
                            }
                            var nextBtn = document.getElementById('next-dist-btn');
                            nextBtn.disabled = false;
                            nextBtn.style.opacity = '1';
                        }
                    };
                })(card, i);
                centerDiv.appendChild(card);
            }
            container.appendChild(centerDiv);
        }
        
        function showRevealerAction(player, container, isDoppelganger) {
            // Revealer: Reveal 1 center card to all players
            container.innerHTML = '<p style="margin-bottom: 15px;">Select 1 center card to reveal to everyone:</p>';
            var centerDiv = document.createElement('div');
            centerDiv.className = 'center-cards';
            for (var i = 0; i < centerCards.length; i++) {
                var card = document.createElement('div');
                card.className = 'center-card';
                card.style.cursor = 'pointer';
                card.style.pointerEvents = 'auto';
                card.innerHTML = '<div style="font-size: 1.5rem;">?</div>';
                card.dataset.index = i;
                
                (function(cardElement, cardIndex) {
                    cardElement.onclick = function(e) {
                        e.stopPropagation();
                        playerActions[player.name] = { type: 'revealer', centerIndex: cardIndex };
                        cardElement.style.background = 'rgba(100, 255, 218, 0.2)';
                        cardElement.style.border = '3px solid var(--accent-color)';
                        cardElement.innerHTML = '<div style="font-size: 1.5rem;">‚úì</div>';
                        cardElement.style.cursor = 'default';
                        cardElement.style.pointerEvents = 'none';
                        for (var j = 0; j < centerDiv.children.length; j++) {
                            if (j !== cardIndex) {
                                centerDiv.children[j].style.opacity = '0.3';
                                centerDiv.children[j].style.pointerEvents = 'none';
                            }
                        }
                        player.actionCompleted = true;
                        var nextBtn = document.getElementById('next-dist-btn');
                        nextBtn.disabled = false;
                        nextBtn.style.opacity = '1';
                    };
                })(card, i);
                centerDiv.appendChild(card);
            }
            container.appendChild(centerDiv);
        }
        
        function showOracleAction(player, container, isDoppelganger) {
            // Oracle: Automatically sees both other players' original roles (no selection needed)
            var otherPlayers = players.filter(p => p.name !== player.name);
            if (otherPlayers.length !== 2) {
                container.innerHTML = '<p style="color: var(--text-secondary);">Oracle action requires exactly 2 other players.</p>';
                var nextBtn = document.getElementById('next-dist-btn');
                nextBtn.disabled = false;
                nextBtn.style.opacity = '1';
                return;
            }
            
            // Store action - Oracle sees both other players automatically
            playerActions[player.name] = {
                type: 'oracle',
                targetPlayer1: otherPlayers[0].name,
                targetPlayer2: otherPlayers[1].name
            };
            
            container.innerHTML = '<p style="color: var(--accent-color); font-weight: bold; margin-bottom: 15px;">You see the roles of both other players:</p>';
            
            otherPlayers.forEach(function(targetPlayer) {
                // In immediate mode, show current role (after previous swaps)
                var currentRoleName = targetPlayer.currentRole || targetPlayer.initialRole;
                var roleDef = ROLE_DEFINITIONS[currentRoleName];
                if (roleDef) {
                    var cardDiv = document.createElement('div');
                    cardDiv.className = 'role-card';
                    cardDiv.classList.add(roleDef.color);
                    cardDiv.style.margin = '10px auto';
                    cardDiv.style.maxWidth = '300px';
                    cardDiv.innerHTML = '<div class="role-icon" style="font-size: 3rem;">' + roleDef.icon + '</div>' +
                        '<div class="role-title role-' + roleDef.color + '" style="font-size: 1.3rem; margin-top: 8px;">' + roleDef.name + '</div>' +
                        '<p style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 5px;">' + targetPlayer.name + '</p>';
                    container.appendChild(cardDiv);
                }
            });
            
            player.actionCompleted = true;
            var nextBtn = document.getElementById('next-dist-btn');
            nextBtn.disabled = false;
            nextBtn.style.opacity = '1';
        }

        function showOracleWolfAction(player, container, isDoppelganger) {
            // Oracle Wolf: Sees other Werewolves, then automatically sees both other players' original roles
            var werewolves = players.filter(p => (p.initialRole === 'Werewolf' || p.initialRole === 'Alpha Wolf' || p.initialRole === 'Mystic Wolf' || p.initialRole === 'Dream Wolf' || p.initialRole === 'Oracle Wolf') && p.name !== player.name);
            var otherPlayers = players.filter(p => p.name !== player.name);
            
            if (otherPlayers.length !== 2) {
                container.innerHTML = '<p style="color: var(--text-secondary);">Oracle Wolf action requires exactly 2 other players.</p>';
                var nextBtn = document.getElementById('next-dist-btn');
                nextBtn.disabled = false;
                nextBtn.style.opacity = '1';
                return;
            }
            
            // Store action - Oracle Wolf sees both other players automatically
            playerActions[player.name] = {
                type: 'oraclewolf',
                targetPlayer1: otherPlayers[0].name,
                targetPlayer2: otherPlayers[1].name,
                werewolves: werewolves.map(w => w.name)
            };
            
            // Show werewolf knowledge
            if (werewolves.length > 0) {
                container.innerHTML = '<p style="color: var(--accent-color); font-weight: bold; margin-bottom: 10px;">Other Werewolves:</p>';
                var werewolfList = document.createElement('p');
                werewolfList.style.color = 'var(--text-secondary)';
                werewolfList.style.marginBottom = '20px';
                werewolfList.textContent = werewolves.map(w => w.name).join(', ');
                container.appendChild(werewolfList);
            } else {
                container.innerHTML = '<p style="color: var(--text-secondary); margin-bottom: 20px;">You are the only Werewolf.</p>';
            }
            
            var header = document.createElement('p');
            header.style.color = 'var(--accent-color)';
            header.style.fontWeight = 'bold';
            header.style.marginBottom = '15px';
            header.textContent = 'You also see the roles of both other players:';
            container.appendChild(header);
            
            otherPlayers.forEach(function(targetPlayer) {
                // In immediate mode, show current role (after previous swaps)
                var currentRoleName = targetPlayer.currentRole || targetPlayer.initialRole;
                var roleDef = ROLE_DEFINITIONS[currentRoleName];
                if (roleDef) {
                    var cardDiv = document.createElement('div');
                    cardDiv.className = 'role-card';
                    cardDiv.classList.add(roleDef.color);
                    cardDiv.style.margin = '10px auto';
                    cardDiv.style.maxWidth = '300px';
                    cardDiv.innerHTML = '<div class="role-icon" style="font-size: 3rem;">' + roleDef.icon + '</div>' +
                        '<div class="role-title role-' + roleDef.color + '" style="font-size: 1.3rem; margin-top: 8px;">' + roleDef.name + '</div>' +
                        '<p style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 5px;">' + targetPlayer.name + '</p>';
                    container.appendChild(cardDiv);
                }
            });
            
            player.actionCompleted = true;
            var nextBtn = document.getElementById('next-dist-btn');
            nextBtn.disabled = false;
            nextBtn.style.opacity = '1';
        }

        function showCuratorAction(player, container, isDoppelganger) {
            // Curator: Look at 1 center card, then swap it with another
            container.innerHTML = '<p style="margin-bottom: 15px;">Look at 1 center card, then select another to swap with it:</p>';
            var centerDiv = document.createElement('div');
            centerDiv.className = 'center-cards';
            var firstSelected = null;
            for (var i = 0; i < centerCards.length; i++) {
                var card = document.createElement('div');
                card.className = 'center-card';
                card.style.cursor = 'pointer';
                card.style.pointerEvents = 'auto';
                card.innerHTML = '<div style="font-size: 1.5rem;">?</div>';
                card.dataset.index = i;
                
                (function(cardElement, cardIndex) {
                    cardElement.onclick = function(e) {
                        e.stopPropagation();
                        if (firstSelected === null) {
                            firstSelected = cardIndex;
                            playerActions[player.name] = { type: 'curator', firstCard: cardIndex };
                            cardElement.style.background = 'rgba(100, 255, 218, 0.2)';
                            cardElement.style.border = '3px solid var(--accent-color)';
                            cardElement.innerHTML = '<div style="font-size: 1.5rem;">üëÅÔ∏è</div>';
                        } else if (firstSelected !== cardIndex) {
                            playerActions[player.name].secondCard = cardIndex;
                            cardElement.style.background = 'rgba(100, 255, 218, 0.2)';
                            cardElement.style.border = '3px solid var(--accent-color)';
                            cardElement.innerHTML = '<div style="font-size: 1.5rem;">‚úì</div>';
                            for (var j = 0; j < centerDiv.children.length; j++) {
                                centerDiv.children[j].style.pointerEvents = 'none';
                            }
                            player.actionCompleted = true;
                            var nextBtn = document.getElementById('next-dist-btn');
                            nextBtn.disabled = false;
                            nextBtn.style.opacity = '1';
                        }
                    };
                })(card, i);
                centerDiv.appendChild(card);
            }
            container.appendChild(centerDiv);
        }

        function showPlayerSelection(player, actionType, isDoppelganger) {
            var modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.id = 'player-select-modal';
            var content = document.createElement('div');
            content.className = 'container';
            content.style.maxWidth = '500px';
            
            var title = document.createElement('h2');
            title.innerText = 'Select Player';
            content.appendChild(title);
            
            var list = document.createElement('div');
            players.forEach(function(p) {
                if (p.name === player.name) return; // Can't select self (except for some roles)
                
                var btn = document.createElement('button');
                btn.className = 'player-select-btn';
                btn.innerText = p.name;
                btn.onclick = (function(selectedPlayer) {
                    return function() {
                        // Close modal first
                        if (modal.parentNode) {
                            document.body.removeChild(modal);
                        }
                        // Then handle the selection
                        handlePlayerSelection(player, selectedPlayer, actionType, isDoppelganger);
                    };
                })(p);
                list.appendChild(btn);
            });
            content.appendChild(list);
            modal.appendChild(content);
            document.body.appendChild(modal);
        }

        function handlePlayerSelection(player, selectedPlayer, actionType, isDoppelganger) {
            if (actionType === 'doppelganger') {
                var copiedRole = players.find(p => p.name === selectedPlayer.name).initialRole;
                playerActions[player.name] = { 
                    type: 'doppelganger', 
                    copiedPlayer: selectedPlayer.name,
                    copiedRole: copiedRole
                };
                // Doppelg√§nger immediately performs the copied role's action if it has one
                var copiedRoleDef = ROLE_DEFINITIONS[copiedRole];
                var actionContainer = document.getElementById('role-action-container');
                if (!actionContainer) {
                    actionContainer = document.getElementById('role-extra');
                }
                
                if (copiedRoleDef && copiedRoleDef.hasAction) {
                    // Show message and perform the copied role's action
                    actionContainer.innerHTML = '<div style="margin-top: 15px; padding: 10px; background: rgba(100, 255, 218, 0.2); border: 1px solid var(--accent-color); border-radius: 8px; color: var(--accent-color); margin-bottom: 15px;"><strong>You copied ' + selectedPlayer.name + '\'s role: ' + copiedRoleDef.name + '</strong><br>Now perform that role\'s action:</div>';
                    // Store the copied action type for later resolution
                    playerActions[player.name].copiedActionType = copiedRoleDef.actionType;
                    // Perform the copied role's action
                    if (copiedRoleDef.actionType === 'seer') {
                        showSeerAction(player, actionContainer, true); // true = isDoppelganger
                    } else if (copiedRoleDef.actionType === 'robber') {
                        showRobberAction(player, actionContainer, true); // true = isDoppelganger
                    } else if (copiedRoleDef.actionType === 'troublemaker') {
                        showTroublemakerAction(player, actionContainer, true); // true = isDoppelganger
                    } else if (copiedRoleDef.actionType === 'drunk') {
                        showDrunkAction(player, actionContainer, true); // true = isDoppelganger
                    } else if (copiedRoleDef.actionType === 'werewolf') {
                        showWerewolfAction(player, actionContainer, true); // true = isDoppelganger
                    } else if (copiedRoleDef.actionType === 'minion') {
                        // Minion action - already knows Werewolves from setup
                        player.actionCompleted = true;
                        actionContainer.innerHTML += '<p style="color: var(--text-secondary);">You saw the Werewolves.</p>';
                        var nextBtn = document.getElementById('next-dist-btn');
                        nextBtn.disabled = false;
                        nextBtn.style.opacity = '1';
                    } else if (copiedRoleDef.actionType === 'mason') {
                        // Mason action - already knows other Masons from setup
                        player.actionCompleted = true;
                        actionContainer.innerHTML += '<p style="color: var(--text-secondary);">You saw other Masons (if any).</p>';
                        var nextBtn = document.getElementById('next-dist-btn');
                        nextBtn.disabled = false;
                        nextBtn.style.opacity = '1';
                    } else if (copiedRoleDef.actionType === 'insomniac') {
                        // Insomniac action - will be resolved later
                        player.actionCompleted = true;
                        actionContainer.innerHTML += '<p style="color: var(--text-secondary);">Your action will be resolved after all swaps.</p>';
                        var nextBtn = document.getElementById('next-dist-btn');
                        nextBtn.disabled = false;
                        nextBtn.style.opacity = '1';
                    }
                } else {
                    // Copied role has no action
                    player.actionCompleted = true;
                    actionContainer.innerHTML += '<p style="color: var(--text-secondary);">That role has no night action.</p>';
                    var nextBtn = document.getElementById('next-dist-btn');
                    nextBtn.disabled = false;
                    nextBtn.style.opacity = '1';
                }
            } else if (actionType === 'seer-player') {
                // Seer looks at one player's card (original role, before swaps)
                // Verify target exists
                if (!selectedPlayer || !selectedPlayer.name) {
                    console.warn('Seer player selection: invalid target');
                    return;
                }
                
                // Verify Seer is not looking at themselves
                if (selectedPlayer.name === player.name) {
                    console.warn('Seer cannot look at their own card:', player.name);
                    alert('You cannot look at your own card. Please select another player.');
                    return;
                }
                
                if (isDoppelganger) {
                    if (!playerActions[player.name]) {
                        playerActions[player.name] = { type: 'doppelganger' };
                    }
                    playerActions[player.name].action = 'player';
                    playerActions[player.name].target = selectedPlayer.name;
                } else {
                    playerActions[player.name] = { type: 'seer', action: 'player', target: selectedPlayer.name };
                }
                player.actionCompleted = true;
                var nextBtn = document.getElementById('next-dist-btn');
                nextBtn.disabled = false;
                nextBtn.style.opacity = '1';
            } else if (actionType === 'robber') {
                // Robber selects a player to steal from
                // Store the action
                if (isDoppelganger) {
                    if (!playerActions[player.name]) {
                        playerActions[player.name] = { type: 'doppelganger' };
                    }
                    playerActions[player.name].target = selectedPlayer.name;
                } else {
                    playerActions[player.name] = { type: 'robber', target: selectedPlayer.name };
                }
                
                // Mark action as completed
                player.actionCompleted = true;
                
                // Update action container with clear, visible confirmation (after modal closes)
                setTimeout(function() {
                    var actionContainer = document.getElementById('role-action-container');
                    if (actionContainer) {
                        actionContainer.innerHTML = '<div style="margin-top: 15px; padding: 15px; background: rgba(100, 255, 218, 0.3); border: 3px solid var(--accent-color); border-radius: 10px; box-shadow: 0 0 20px rgba(100, 255, 218, 0.4);"><p style="color: var(--accent-color); font-weight: bold; font-size: 1.1rem; margin: 0;">‚úì Selected: <strong>' + selectedPlayer.name + '</strong></p><p style="color: #fff; font-size: 0.95rem; margin-top: 8px; margin-bottom: 0;">You will see your new role after all night actions complete.</p></div>';
                    }
                }, 150);
                
                var nextBtn = document.getElementById('next-dist-btn');
                nextBtn.disabled = false;
                nextBtn.style.opacity = '1';
            } else if (actionType === 'troublemaker-1') {
                // Show second selection
                var modal = document.createElement('div');
                modal.className = 'modal-overlay';
                modal.id = 'player-select-modal-2';
                var content = document.createElement('div');
                content.className = 'container';
                content.style.maxWidth = '500px';
                var title = document.createElement('h2');
                title.innerText = 'Select Second Player';
                content.appendChild(title);
                var list = document.createElement('div');
                var instruction = document.createElement('p');
                instruction.innerText = 'Select the second player to swap with ' + selectedPlayer.name + ' (you cannot select yourself):';
                instruction.style.marginBottom = '15px';
                instruction.style.color = 'var(--text-secondary)';
                content.appendChild(instruction);
                
                players.forEach(function(p) {
                    // Exclude: Troublemaker themselves, and the first selected player
                    if (p.name === player.name || p.name === selectedPlayer.name) return;
                    
                    var btn = document.createElement('button');
                    btn.className = 'player-select-btn';
                    btn.innerText = p.name;
                    btn.onclick = (function(selectedPlayer2) {
                        return function() {
                            // Store the action
                            if (isDoppelganger) {
                                if (!playerActions[player.name]) {
                                    playerActions[player.name] = { type: 'doppelganger' };
                                }
                                playerActions[player.name].player1 = selectedPlayer.name;
                                playerActions[player.name].player2 = selectedPlayer2.name;
                            } else {
                                playerActions[player.name] = { 
                                    type: 'troublemaker', 
                                    player1: selectedPlayer.name, 
                                    player2: selectedPlayer2.name 
                                };
                            }
                            player.actionCompleted = true;
                            document.body.removeChild(modal);
                            var nextBtn = document.getElementById('next-dist-btn');
                            nextBtn.disabled = false;
                            nextBtn.style.opacity = '1';
                        };
                    })(p);
                    list.appendChild(btn);
                });
                content.appendChild(list);
                modal.appendChild(content);
                document.body.appendChild(modal);
            }
        }

        // --- Resolve Single Player Action (for immediate mode) ---
        function resolveCurrentPlayerAction(player) {
            var action = playerActions[player.name];
            if (!action) return;
            
            // Handle Doppelganger first - they become the copied role
            if (action.type === 'doppelganger' && action.copiedRole) {
                player.currentRole = action.copiedRole;
            }
            
            // For Doppelganger, check copiedActionType
            var actionType = action.type;
            if (action.type === 'doppelganger' && action.copiedActionType) {
                actionType = action.copiedActionType;
            }
            
            // Apply action based on type
            if (actionType === 'robber') {
                // Robber swaps with target
                if (action.target) {
                    var target = players.find(p => p.name === action.target);
                    if (target && target.name !== player.name) {
                        var temp = player.currentRole || player.initialRole;
                        player.currentRole = target.currentRole || target.initialRole;
                        target.currentRole = temp;
                    }
                }
            } else if (actionType === 'troublemaker') {
                // Troublemaker swaps two other players
                if (action.player1 && action.player2) {
                    var p1 = players.find(p => p.name === action.player1);
                    var p2 = players.find(p => p.name === action.player2);
                    if (p1 && p2) {
                        var temp = p1.currentRole || p1.initialRole;
                        p1.currentRole = p2.currentRole || p2.initialRole;
                        p2.currentRole = temp;
                    }
                }
            } else if (actionType === 'drunk') {
                // Drunk swaps with center card
                if (action.centerIndex !== undefined && action.centerIndex < centerCards.length) {
                    var temp = player.currentRole || player.initialRole;
                    player.currentRole = centerCards[action.centerIndex];
                    centerCards[action.centerIndex] = temp;
                }
            } else if (actionType === 'witch') {
                // Witch swaps center card with a player
                if (action.centerIndex !== undefined && action.targetPlayer) {
                    var target = players.find(p => p.name === action.targetPlayer);
                    if (target && action.centerIndex < centerCards.length) {
                        var temp = centerCards[action.centerIndex];
                        centerCards[action.centerIndex] = target.currentRole || target.initialRole;
                        target.currentRole = temp;
                    }
                }
            } else if (actionType === 'alphawolf') {
                // Alpha Wolf swaps center werewolf with a player
                if (action.centerWerewolfIndex !== undefined && action.targetPlayer) {
                    var target = players.find(p => p.name === action.targetPlayer);
                    if (target && action.centerWerewolfIndex < centerCards.length) {
                        var temp = centerCards[action.centerWerewolfIndex];
                        centerCards[action.centerWerewolfIndex] = target.currentRole || target.initialRole;
                        target.currentRole = temp;
                    }
                }
            } else if (actionType === 'villageidiot') {
                // Village Idiot swaps 2 center cards
                if (action.card1 !== undefined && action.card2 !== undefined && 
                    action.card1 !== action.card2 && 
                    action.card1 < centerCards.length && action.card2 < centerCards.length) {
                    var temp = centerCards[action.card1];
                    centerCards[action.card1] = centerCards[action.card2];
                    centerCards[action.card2] = temp;
                }
            } else if (actionType === 'curator') {
                // Curator looks at 1 center card, then swaps it with another
                if (action.firstCard !== undefined && action.secondCard !== undefined && 
                    action.firstCard !== action.secondCard && 
                    action.firstCard < centerCards.length && action.secondCard < centerCards.length) {
                    var temp = centerCards[action.firstCard];
                    centerCards[action.firstCard] = centerCards[action.secondCard];
                    centerCards[action.secondCard] = temp;
                }
            }
            // Note: Seer, Insomniac, Mystic Wolf, Oracle, Paranormal Investigator, Revealer, etc. don't swap anything, so no action needed
        }
        
        // --- Resolve Actions ---
        function resolveActions() {
            // Create a copy of roles for swapping (always start from initial roles)
            finalRoles = players.map(p => ({ name: p.name, role: p.initialRole }));
            centerCardsFinal = centerCards.slice(); // Use global variable for immediate resolution
            var centerCardsOriginal = centerCards.slice(); // Store original for Seer
            
            // Handle Doppelg√§nger first - they become the copied role
            players.forEach(function(player) {
                var action = playerActions[player.name];
                if (action && action.type === 'doppelganger') {
                    var doppelgangerFinal = finalRoles.find(r => r.name === player.name);
                    if (doppelgangerFinal && action.copiedRole) {
                        doppelgangerFinal.role = action.copiedRole;
                    }
                }
            });
            
            // Resolve in order: Alpha Wolf, Witch, Robber, Troublemaker, Drunk
            // (Seer and Insomniac just look, they don't swap)
            
            // 0. Alpha Wolf swaps Center Werewolf card (index 3) with a non-Werewolf player
            players.forEach(function(player) {
                var action = playerActions[player.name];
                if (action && (action.type === 'alphawolf' || (action.type === 'doppelganger' && action.copiedActionType === 'alphawolf'))) {
                    var alphaWolfFinal = finalRoles.find(r => r.name === player.name);
                    if (alphaWolfFinal && action.centerWerewolfIndex !== undefined && action.targetPlayer) {
                        // Center Werewolf is at index 3 (4th center card)
                        var centerWerewolfIndex = action.centerWerewolfIndex;
                        if (centerWerewolfIndex < centerCardsFinal.length) {
                            var target = finalRoles.find(r => r.name === action.targetPlayer);
                            if (target) {
                                // Verify target is not a Werewolf
                                var targetRole = target.role;
                                var isWerewolf = targetRole === 'Werewolf' || targetRole === 'Alpha Wolf' || targetRole === 'Mystic Wolf' || targetRole === 'Dream Wolf' || targetRole === 'Oracle Wolf';
                                if (!isWerewolf) {
                                    // Perform swap: Center Werewolf <-> Target Player
                                    var temp = centerCardsFinal[centerWerewolfIndex];
                                    centerCardsFinal[centerWerewolfIndex] = target.role;
                                    target.role = temp;
                                }
                            }
                        }
                    }
                }
            });
            
            // 1. Witch swaps a center card with a player (including Doppelg√§nger who copied Witch)
            // Witch looks at a center card, then swaps it with any player (including herself)
            players.forEach(function(player) {
                var action = playerActions[player.name];
                if (action && (action.type === 'witch' || (action.type === 'doppelganger' && action.copiedActionType === 'witch'))) {
                    var witchFinal = finalRoles.find(r => r.name === player.name);
                    if (witchFinal && action.centerIndex !== undefined && action.targetPlayer) {
                        var target = finalRoles.find(r => r.name === action.targetPlayer);
                        if (target) {
                            // Perform swap: Center Card <-> Target Player
                            var temp = centerCardsFinal[action.centerIndex];
                            centerCardsFinal[action.centerIndex] = target.role;
                            target.role = temp;
                            
                            // Store result details (what she saw in center)
                            if (action.type === 'witch') {
                                actionResults[player.name] = {
                                    type: 'witch',
                                    centerCard: centerCardsOriginal[action.centerIndex], // She saw original center card
                                    swappedWith: target.name
                                };
                            } else {
                                // Doppelganger result handled separately or needs to be stored here?
                                // The doppelganger logic usually reads from actionResults later? 
                                // No, doppelganger results are typically set in the main loop or checked later.
                                // But for now, let's just perform the swap.
                            }
                        }
                    }
                }
            });

            
            // 2. Robber steals a card (including Doppelg√§nger who copied Robber)
            // Robber exchanges their card with another player's card, then sees their new card
            players.forEach(function(player) {
                var action = playerActions[player.name];
                if (action && (action.type === 'robber' || (action.type === 'doppelganger' && action.copiedActionType === 'robber'))) {
                    // Verify target exists
                    if (!action.target) {
                        console.warn('Robber action missing target for player:', player.name);
                        return;
                    }
                    
                    var target = finalRoles.find(r => r.name === action.target);
                    var robberFinal = finalRoles.find(r => r.name === player.name);
                    
                    if (target && robberFinal) {
                        // Verify target is not the robber themselves
                        if (target.name === robberFinal.name) {
                            console.warn('Robber cannot steal from themselves:', player.name);
                            return;
                        }
                        
                        // Exchange cards: Robber gets target's role, target gets robber's role
                        var robberOriginalRole = robberFinal.role;
                        var targetCurrentRole = target.role; // This is after Troublemaker swaps
                        
                        // Perform the exchange
                        robberFinal.role = targetCurrentRole;
                        target.role = robberOriginalRole;
                        
                        // Debug log to verify swap
                        console.log('Robber swap:', {
                            robber: player.name,
                            robberOriginal: robberOriginalRole,
                            robberNew: robberFinal.role,
                            target: action.target,
                            targetOriginal: targetCurrentRole,
                            targetNew: target.role
                        });
                    } else {
                        console.warn('Robber action: target or robber not found in finalRoles', {
                            target: action.target,
                            robber: player.name,
                            targetFound: !!target,
                            robberFound: !!robberFinal
                        });
                    }
                }
            });
            
            // 2b. Troublemaker swaps two players (including Doppelg√§nger who copied Troublemaker)
            players.forEach(function(player) {
                var action = playerActions[player.name];
                if (action && (action.type === 'troublemaker' || (action.type === 'doppelganger' && action.copiedActionType === 'troublemaker'))) {
                    if (action.player1 && action.player2) {
                        var p1 = finalRoles.find(r => r.name === action.player1);
                        var p2 = finalRoles.find(r => r.name === action.player2);
                        
                        if (p1 && p2) {
                            var temp = p1.role;
                            p1.role = p2.role;
                            p2.role = temp;
                        }
                    }
                }
            });

            // 3. Village Idiot swaps 2 center cards
            players.forEach(function(player) {
                var action = playerActions[player.name];
                if (action && action.type === 'villageidiot') {
                    if (action.card1 !== undefined && action.card2 !== undefined && action.card1 !== action.card2) {
                        var temp = centerCardsFinal[action.card1];
                        centerCardsFinal[action.card1] = centerCardsFinal[action.card2];
                        centerCardsFinal[action.card2] = temp;
                    }
                }
            });
            
            // 4. Curator looks at 1 center card, then swaps it with another
            players.forEach(function(player) {
                var action = playerActions[player.name];
                if (action && action.type === 'curator') {
                    if (action.firstCard !== undefined && action.secondCard !== undefined && action.firstCard !== action.secondCard) {
                        var temp = centerCardsFinal[action.firstCard];
                        centerCardsFinal[action.firstCard] = centerCardsFinal[action.secondCard];
                        centerCardsFinal[action.secondCard] = temp;
                    }
                }
            });
            
            // 5. Drunk swaps with center (including Doppelg√§nger who copied Drunk)
            players.forEach(function(player) {
                var action = playerActions[player.name];
                if (action && (action.type === 'drunk' || (action.type === 'doppelganger' && action.copiedActionType === 'drunk'))) {
                    var drunkFinal = finalRoles.find(r => r.name === player.name);
                    if (drunkFinal && action.centerIndex !== undefined) {
                        var temp = drunkFinal.role;
                        drunkFinal.role = centerCardsFinal[action.centerIndex];
                        centerCardsFinal[action.centerIndex] = temp;
                    }
                }
            });
            
            // Store results for Round 2
            players.forEach(function(player) {
                var action = playerActions[player.name];
                var finalRole = finalRoles.find(r => r.name === player.name);
                
                if (!action) {
                    actionResults[player.name] = { type: 'none' };
                } else if (action.type === 'doppelganger') {
                    // Doppelg√§nger results depend on what they copied
                    var copiedRoleDef = ROLE_DEFINITIONS[action.copiedRole];
                    if (copiedRoleDef && copiedRoleDef.hasAction && action.copiedActionType) {
                        // Handle the copied role's action result
                        if (action.copiedActionType === 'seer') {
                            if (action.action === 'center') {
                                // Doppelg√§nger Seer sees the 2 center cards they chose
                                var seerCards = [];
                                if (action.centerCards && action.centerCards.length === 2) {
                                    seerCards = [centerCardsOriginal[action.centerCards[0]], centerCardsOriginal[action.centerCards[1]]];
                                } else {
                                    // Fallback: first 2 cards
                                    seerCards = [centerCardsOriginal[0], centerCardsOriginal[1]];
                                }
                                actionResults[player.name] = {
                                    type: 'seer-center',
                                    cards: seerCards
                                };
                            } else if (action.action === 'player') {
                                // Seer sees the original role (before swaps)
                                var targetPlayer = players.find(p => p.name === action.target);
                                actionResults[player.name] = {
                                    type: 'seer-player',
                                    target: action.target,
                                    role: targetPlayer ? targetPlayer.initialRole : 'Unknown'
                                };
                            }
                        } else if (action.copiedActionType === 'robber') {
                            actionResults[player.name] = {
                                type: 'robber',
                                newRole: finalRole ? finalRole.role : 'Unknown'
                            };
                        } else if (action.copiedActionType === 'troublemaker') {
                            // Doppelg√§nger who copied Troublemaker
                            if (action.player1 && action.player2) {
                                actionResults[player.name] = {
                                    type: 'troublemaker',
                                    message: 'You swapped ' + action.player1 + ' and ' + action.player2 + ' (you don\'t know what roles they had)',
                                    player1: action.player1,
                                    player2: action.player2
                                };
                            } else {
                                actionResults[player.name] = {
                                    type: 'troublemaker',
                                    message: 'You attempted to swap players, but the action was incomplete.'
                                };
                            }
                        } else if (action.copiedActionType === 'drunk') {
                            actionResults[player.name] = {
                                type: 'drunk',
                                message: 'You swapped with a center card (you don\'t know which one)'
                            };
                        } else if (action.copiedActionType === 'werewolf') {
                            if (action.centerIndex !== undefined) {
                                actionResults[player.name] = {
                                    type: 'werewolf-center',
                                    card: centerCardsOriginal[action.centerIndex]
                                };
                            } else {
                                actionResults[player.name] = {
                                    type: 'werewolf',
                                    message: 'You saw other Werewolves'
                                };
                            }
                        } else if (action.copiedActionType === 'minion') {
                            actionResults[player.name] = {
                                type: 'minion',
                                message: 'You saw the Werewolves'
                            };
                        } else if (action.copiedActionType === 'mason') {
                            actionResults[player.name] = {
                                type: 'mason',
                                message: 'You saw other Masons (if any)'
                            };
                        } else if (action.copiedActionType === 'insomniac') {
                            actionResults[player.name] = {
                                type: 'insomniac',
                                finalRole: finalRole ? finalRole.role : 'Unknown'
                            };
                        }
                    } else {
                        actionResults[player.name] = {
                            type: 'doppelganger',
                            copiedRole: action.copiedRole,
                            message: 'You copied ' + action.copiedPlayer + '\'s role: ' + action.copiedRole + (copiedRoleDef && !copiedRoleDef.hasAction ? ' (no action)' : '')
                        };
                    }
                } else if (action.type === 'minion') {
                    actionResults[player.name] = {
                        type: 'minion',
                        message: 'You saw the Werewolves'
                    };
                } else if (action.type === 'mason') {
                    actionResults[player.name] = {
                        type: 'mason',
                        message: player.extraInfo ? 'You saw other Masons' : 'You are the only Mason'
                    };
                } else if (action.type === 'seer') {
                    // Seer looks at cards but doesn't swap anything
                    // Seer sees the original state (before any swaps)
                    if (action.action === 'center') {
                        // Seer sees original center cards (before swaps) - the 2 cards they chose
                        if (!action.centerCards || action.centerCards.length !== 2) {
                            console.warn('Seer center action: invalid centerCards array for player:', player.name);
                            // Fallback: first 2 cards (for backwards compatibility)
                            actionResults[player.name] = {
                                type: 'seer-center',
                                cards: [centerCardsOriginal[0], centerCardsOriginal[1]]
                            };
                        } else {
                            // Verify indices are valid
                            var idx1 = action.centerCards[0];
                            var idx2 = action.centerCards[1];
                            if (idx1 >= 0 && idx1 < 3 && idx2 >= 0 && idx2 < 3 && idx1 !== idx2) {
                                var seerCards = [centerCardsOriginal[idx1], centerCardsOriginal[idx2]];
                                actionResults[player.name] = {
                                    type: 'seer-center',
                                    cards: seerCards
                                };
                            } else {
                                console.warn('Seer center action: invalid card indices', action.centerCards);
                                // Fallback: first 2 cards
                                actionResults[player.name] = {
                                    type: 'seer-center',
                                    cards: [centerCardsOriginal[0], centerCardsOriginal[1]]
                                };
                            }
                        }
                    } else if (action.action === 'player') {
                        // Seer sees the original role (before swaps)
                        if (!action.target) {
                            console.warn('Seer player action: missing target for player:', player.name);
                            actionResults[player.name] = {
                                type: 'seer-player',
                                target: 'Unknown',
                                role: 'Unknown'
                            };
                        } else {
                            var targetPlayer = players.find(p => p.name === action.target);
                            if (targetPlayer) {
                                // Verify Seer didn't look at themselves
                                if (targetPlayer.name === player.name) {
                                    console.warn('Seer attempted to look at their own card:', player.name);
                                }
                                actionResults[player.name] = {
                                    type: 'seer-player',
                                    target: action.target,
                                    role: targetPlayer.initialRole
                                };
                            } else {
                                console.warn('Seer player action: target not found', action.target);
                                actionResults[player.name] = {
                                    type: 'seer-player',
                                    target: action.target,
                                    role: 'Unknown'
                                };
                            }
                        }
                    } else {
                        console.warn('Seer action: invalid action type', action.action);
                        actionResults[player.name] = {
                            type: 'seer',
                            message: 'Seer action was incomplete or invalid.'
                        };
                    }
                } else if (action.type === 'robber') {
                    // Robber sees their new role after the swap
                    // Get the robber's final role from finalRoles (after swap)
                    var robberFinalRole = finalRoles.find(r => r.name === player.name);
                    if (!robberFinalRole) {
                        console.warn('Robber result: robberFinalRole not found for player:', player.name);
                        actionResults[player.name] = {
                            type: 'robber',
                            newRole: 'Unknown'
                        };
                    } else if (!action.target) {
                        console.warn('Robber result: target not specified for player:', player.name);
                        actionResults[player.name] = {
                            type: 'robber',
                            newRole: robberFinalRole.role
                        };
                    } else {
                        // The robber's role should have been swapped, so robberFinalRole.role is the stolen role
                        // Verify it's not still "Robber" (which would indicate the swap didn't work)
                        if (robberFinalRole.role === 'Robber') {
                            console.error('Robber result: swap did not occur! Robber still has Robber role. Initial:', player.initialRole, 'Final:', robberFinalRole.role);
                            // Try to get the target's original role as fallback
                            var targetPlayer = players.find(p => p.name === action.target);
                            if (targetPlayer) {
                                robberFinalRole.role = targetPlayer.initialRole;
                            }
                        }
                        actionResults[player.name] = {
                            type: 'robber',
                            newRole: robberFinalRole.role,
                            stolenFrom: action.target // Store who they stole from for reference
                        };
                    }
                } else if (action.type === 'troublemaker') {
                    // Troublemaker swaps two other players but doesn't see what roles they swapped
                    if (action.player1 && action.player2) {
                        actionResults[player.name] = {
                            type: 'troublemaker',
                            message: 'You swapped ' + action.player1 + ' and ' + action.player2 + ' (you don\'t know what roles they had)',
                            player1: action.player1,
                            player2: action.player2
                        };
                    } else {
                        console.warn('Troublemaker result: missing player1 or player2 for player:', player.name);
                        actionResults[player.name] = {
                            type: 'troublemaker',
                            message: 'You attempted to swap players, but the action was incomplete.'
                        };
                    }
                } else if (action.type === 'alphawolf') {
                    // Alpha Wolf swaps Center Werewolf card with a non-Werewolf player (doesn't see either card)
                    if (action.targetPlayer) {
                        actionResults[player.name] = {
                            type: 'alphawolf',
                            message: 'You swapped the Center Werewolf card with ' + action.targetPlayer + ' (you don\'t know what roles they had)',
                            targetPlayer: action.targetPlayer
                        };
                    } else {
                        actionResults[player.name] = {
                            type: 'alphawolf',
                            message: 'You attempted to swap the Center Werewolf card, but the action was incomplete.'
                        };
                    }
                } else if (action.type === 'drunk') {
                    actionResults[player.name] = {
                        type: 'drunk',
                        message: 'You swapped with a center card (you don\'t know which one)'
                    };
                } else if (action.type === 'insomniac') {
                    actionResults[player.name] = {
                        type: 'insomniac',
                        finalRole: finalRole ? finalRole.role : 'Unknown'
                    };
                } else if (action.type === 'mysticwolf') {
                    // Mystic Wolf: sees werewolves + 1 center card + 1 player card (original state)
                    var werewolves = players.filter(p => (p.initialRole === 'Werewolf' || p.initialRole === 'Alpha Wolf' || p.initialRole === 'Mystic Wolf' || p.initialRole === 'Dream Wolf' || p.initialRole === 'Oracle Wolf') && p.name !== player.name).map(p => p.name);
                    var result = {
                        type: 'mysticwolf',
                        werewolves: werewolves
                    };
                    if (action.centerIndex !== undefined) {
                        result.centerCard = centerCardsOriginal[action.centerIndex];
                    }
                    if (action.targetPlayer) {
                        var targetPlayer = players.find(p => p.name === action.targetPlayer);
                        if (targetPlayer) {
                            result.playerCard = targetPlayer.initialRole;
                            result.targetPlayer = action.targetPlayer;
                        }
                    }
                    actionResults[player.name] = result;
                } else if (action.type === 'dreamwolf') {
                    // Dream Wolf: no action, but Werewolves see them
                    actionResults[player.name] = {
                        type: 'dreamwolf',
                        message: 'You are a Dream Wolf. You did not wake up, but other Werewolves saw your thumb.'
                    };
                } else if (action.type === 'apprenticeseer' || action.type === 'witch') {
                    // Apprentice Seer and Witch: look at 1 center card (original state)
                    if (action.centerIndex !== undefined) {
                        actionResults[player.name] = {
                            type: action.type,
                            card: centerCardsOriginal[action.centerIndex]
                        };
                    } else {
                        actionResults[player.name] = {
                            type: action.type,
                            message: 'Action was incomplete'
                        };
                    }
                } else if (action.type === 'paranormalinvestigator') {
                    // Paranormal Investigator: look at 1 player's card (original state)
                    if (action.targetPlayer) {
                        var targetPlayer = players.find(p => p.name === action.targetPlayer);
                        if (targetPlayer) {
                            actionResults[player.name] = {
                                type: 'paranormalinvestigator',
                                target: action.targetPlayer,
                                role: targetPlayer.initialRole
                            };
                        } else {
                            actionResults[player.name] = {
                                type: 'paranormalinvestigator',
                                message: 'Target player not found'
                            };
                        }
                    } else {
                        actionResults[player.name] = {
                            type: 'paranormalinvestigator',
                            message: 'Action was incomplete'
                        };
                    }
                } else if (action.type === 'villageidiot') {
                    // Village Idiot: swaps 2 center cards (doesn't see them)
                    actionResults[player.name] = {
                        type: 'villageidiot',
                        message: 'You swapped 2 center cards (you don\'t know which ones)'
                    };
                } else if (action.type === 'revealer') {
                    // Revealer: reveals 1 center card to all players (original state)
                    if (action.centerIndex !== undefined) {
                        actionResults[player.name] = {
                            type: 'revealer',
                            card: centerCardsOriginal[action.centerIndex],
                            centerIndex: action.centerIndex
                        };
                    } else {
                        actionResults[player.name] = {
                            type: 'revealer',
                            message: 'Action was incomplete'
                        };
                    }
                } else if (action.type === 'curator') {
                    // Curator: looks at 1 center card, then swaps it with another
                    var result = {
                        type: 'curator',
                        message: 'You looked at a center card and swapped it with another'
                    };
                    if (action.firstCard !== undefined) {
                        result.lookedAt = centerCardsOriginal[action.firstCard];
                    }
                    actionResults[player.name] = result;
                } else if (action.type === 'villager-fake') {
                    actionResults[player.name] = {
                        type: 'villager-fake'
                    };
                } else if (action.type === 'werewolf') {
                if (action.centerIndex !== undefined) {
                    // Single werewolf who saw a center card (original, before swaps)
                    actionResults[player.name] = {
                        type: 'werewolf-center',
                        card: centerCardsOriginal[action.centerIndex]
                    };
                } else {
                    // Multiple werewolves
                    actionResults[player.name] = {
                        type: 'werewolf',
                        message: 'You saw other Werewolves'
                    };
                }
            }
            });
            
            // Update current roles
            players.forEach(function(player) {
                var final = finalRoles.find(r => r.name === player.name);
                if (final) {
                    player.currentRole = final.role;
                }
            });
        }

        // --- Round 2: Results ---
        function startResultsPhase() {
            currentResultIndex = 0;
            document.getElementById('results-total-players').innerText = playerCount;
            showScreen('results-screen');
            updateResultsScreen();
        }

        // --- Immediate Results Phase ---
        function startImmediateResultsPhase() {
            showScreen('immediate-results-screen');
            renderImmediateResultsList();
        }

        function renderImmediateResultsList() {
            var list = document.getElementById('immediate-results-list');
            list.innerHTML = '';
            
            players.forEach(function(player) {
                var btn = document.createElement('button');
                btn.className = 'player-select-btn';
                btn.style.width = '100%';
                btn.style.marginBottom = '10px';
                btn.innerText = player.name;
                btn.onclick = function() {
                    showImmediateResult(player.name);
                };
                list.appendChild(btn);
            });
        }

        function showImmediateResult(playerName) {
            var player = players.find(p => p.name === playerName);
            if (!player) return;
            
            var result = actionResults[playerName];
            var container = document.getElementById('immediate-result-content');
            var nameHeader = document.getElementById('immediate-result-name');
            
            nameHeader.innerText = playerName;
            container.innerHTML = '';
            
            // Show original role card at the top
            var roleDef = ROLE_DEFINITIONS[player.initialRole];
            if (roleDef) {
                var roleCardDiv = document.createElement('div');
                roleCardDiv.style.marginBottom = '20px';
                roleCardDiv.style.textAlign = 'center';
                roleCardDiv.innerHTML = '<p style="color: var(--text-secondary); margin-bottom: 10px; font-size: 0.9rem;">Your original role:</p>';
                roleCardDiv.innerHTML += '<div class="role-card" style="margin: 0 auto; max-width: 250px;"><div class="role-icon" style="font-size: 3rem;">' + roleDef.icon + '</div><div class="role-title role-' + roleDef.color + '" style="font-size: 1.3rem; margin-top: 10px;">' + roleDef.name + '</div></div>';
                container.appendChild(roleCardDiv);
            }
            
            // Show result below
            var resultDiv = document.createElement('div');
            resultDiv.style.marginTop = '20px';
            
            if (!result || result.type === 'none') {
                resultDiv.innerHTML = '<p style="color: var(--text-secondary);">You had no action. Nothing happened to you during the night.</p>';
            } else if (result.type === 'seer-center') {
                resultDiv.innerHTML = '<p style="margin-bottom: 15px;">You looked at 2 center cards:</p>';
                var centerDiv = document.createElement('div');
                centerDiv.className = 'center-cards';
                result.cards.forEach(function(roleName) {
                    var card = document.createElement('div');
                    card.className = 'center-card revealed';
                    var roleDef = ROLE_DEFINITIONS[roleName];
                    card.classList.add(roleDef.color);
                    card.innerHTML = '<div style="font-size: 1.5rem;">' + roleDef.icon + '</div><div style="font-size: 0.8rem;">' + roleDef.name + '</div>';
                    centerDiv.appendChild(card);
                });
                resultDiv.appendChild(centerDiv);
            } else if (result.type === 'seer-player') {
                if (result.role && ROLE_DEFINITIONS[result.role]) {
                    var roleDef = ROLE_DEFINITIONS[result.role];
                    resultDiv.innerHTML = '<p style="margin-bottom: 15px;">You looked at <strong>' + result.target + '</strong>\'s card (original role, before swaps):</p>';
                    resultDiv.innerHTML += '<div class="role-card" style="margin: 0 auto; max-width: 250px;"><div class="role-icon" style="font-size: 3rem;">' + roleDef.icon + '</div><div class="role-title role-' + roleDef.color + '" style="font-size: 1.3rem; margin-top: 10px;">' + roleDef.name + '</div></div>';
                } else {
                    resultDiv.innerHTML = '<p style="color: var(--text-secondary);">You looked at <strong>' + result.target + '</strong>\'s card, but the role could not be determined.</p>';
                }
            } else if (result.type === 'witch') {
                if (result.centerCard && ROLE_DEFINITIONS[result.centerCard]) {
                    var roleDef = ROLE_DEFINITIONS[result.centerCard];
                    resultDiv.innerHTML = '<p style="margin-bottom: 15px; color: var(--accent-color); font-weight: bold;">You looked at a center card (original):</p>';
                    resultDiv.innerHTML += '<div class="role-card" style="margin: 0 auto; max-width: 250px;"><div class="role-icon" style="font-size: 4rem;">' + roleDef.icon + '</div><div class="role-title role-' + roleDef.color + '" style="font-size: 1.3rem; margin-top: 10px;">' + roleDef.name + '</div></div>';
                    if (result.swappedWith) {
                        resultDiv.innerHTML += '<p style="color: var(--text-secondary); margin-top: 15px; font-size: 0.9rem;">You swapped it with <strong>' + result.swappedWith + '</strong></p>';
                    }
                } else {
                    resultDiv.innerHTML = '<p style="color: var(--text-secondary);">You looked at a center card, but it could not be determined.</p>';
                }
            } else if (result.type === 'robber') {
                if (result.newRole && ROLE_DEFINITIONS[result.newRole]) {
                    var roleDef = ROLE_DEFINITIONS[result.newRole];
                    resultDiv.innerHTML = '<p style="margin-bottom: 15px;">You stole a card! You are now:</p>';
                    resultDiv.innerHTML += '<div class="role-card" style="margin: 0 auto; max-width: 250px;"><div class="role-icon" style="font-size: 3rem;">' + roleDef.icon + '</div><div class="role-title role-' + roleDef.color + '" style="font-size: 1.3rem; margin-top: 10px;">' + roleDef.name + '</div></div>';
                } else {
                    resultDiv.innerHTML = '<p style="color: var(--text-secondary);">You stole a card, but your new role could not be determined.</p>';
                }
            } else if (result.type === 'troublemaker') {
                resultDiv.innerHTML = '<p style="color: var(--accent-color);">' + result.message + '</p>';
            } else if (result.type === 'alphawolf') {
                resultDiv.innerHTML = '<p style="color: var(--accent-color);">' + result.message + '</p>';
            } else if (result.type === 'drunk') {
                resultDiv.innerHTML = '<p style="color: var(--text-secondary);">' + result.message + '</p>';
            } else if (result.type === 'insomniac') {
                var roleDef = ROLE_DEFINITIONS[result.finalRole];
                resultDiv.innerHTML = '<p style="margin-bottom: 15px;">You looked at your card (after all swaps):</p>';
                resultDiv.innerHTML += '<div class="role-card" style="margin: 0 auto; max-width: 250px;"><div class="role-icon" style="font-size: 3rem;">' + roleDef.icon + '</div><div class="role-title role-' + roleDef.color + '" style="font-size: 1.3rem; margin-top: 10px;">' + roleDef.name + '</div></div>';
            } else if (result.type === 'villager-fake') {
                resultDiv.innerHTML = '<p style="color: var(--text-secondary);">You had no night action. Nothing happened to you during the night.</p>';
            } else if (result.type === 'werewolf') {
                resultDiv.innerHTML = '<p style="color: var(--text-secondary);">' + result.message + '</p>';
            } else if (result.type === 'werewolf-center') {
                if (result.card && ROLE_DEFINITIONS[result.card]) {
                    var roleDef = ROLE_DEFINITIONS[result.card];
                    resultDiv.innerHTML = '<p style="margin-bottom: 15px;">You looked at a center card:</p>';
                    resultDiv.innerHTML += '<div class="role-card" style="margin: 0 auto; max-width: 250px;"><div class="role-icon" style="font-size: 3rem;">' + roleDef.icon + '</div><div class="role-title role-' + roleDef.color + '" style="font-size: 1.3rem; margin-top: 10px;">' + roleDef.name + '</div></div>';
                } else {
                    resultDiv.innerHTML = '<p style="color: var(--text-secondary);">You looked at a center card, but it could not be determined.</p>';
                }
            } else if (result.type === 'doppelganger') {
                resultDiv.innerHTML = '<p style="color: var(--accent-color); margin-bottom: 15px;">' + result.message + '</p>';
                if (result.copiedRole) {
                    var roleDef = ROLE_DEFINITIONS[result.copiedRole];
                    resultDiv.innerHTML += '<p style="color: var(--text-secondary);">You became that role and performed its action (see above).</p>';
                }
            } else if (result.type === 'minion') {
                resultDiv.innerHTML = '<p style="color: var(--text-secondary);">' + result.message + '</p>';
            } else if (result.type === 'mason') {
                resultDiv.innerHTML = '<p style="color: var(--text-secondary);">' + result.message + '</p>';
            } else if (result.type === 'apprenticetanner') {
                resultDiv.innerHTML = '<p style="color: var(--text-secondary);">' + result.message + '</p>';
            }
            
            container.appendChild(resultDiv);
            document.getElementById('immediate-result-view').classList.remove('hidden');
        }

        function hideImmediateResult() {
            document.getElementById('immediate-result-view').classList.add('hidden');
        }

        function proceedToDayPhase() {
            startDayPhase();
        }

        function updateResultsScreen() {
            document.getElementById('results-player-num').innerText = currentResultIndex + 1;
            document.getElementById('results-player-name').innerText = players[currentResultIndex].name;
        }

        function showResult() {
            var player = players[currentResultIndex];
            var result = actionResults[player.name];
            var roleDef = ROLE_DEFINITIONS[player.initialRole];
            
            // Update the role card section to match the role reveal format
            document.getElementById('results-name-header').innerText = player.name;
            if (roleDef) {
                document.getElementById('results-role-icon').innerText = roleDef.icon;
                document.getElementById('results-role-title').innerText = roleDef.name;
                document.getElementById('results-role-title').className = 'role-title role-' + roleDef.color;
                document.getElementById('results-role-desc').innerText = roleDef.description;
                
                // Show extra info if available
                var extra = document.getElementById('results-role-extra');
                extra.innerHTML = '';
                if (player.extraInfo) {
                    extra.innerHTML = '<div style="margin-top: 15px; padding: 10px; background: rgba(255, 215, 0, 0.2); border: 1px solid #ffd700; border-radius: 8px; color: #ffd700;">' + player.extraInfo + '</div>';
                }
            }
            
            // Show result below the role card
            var container = document.getElementById('result-content');
            container.innerHTML = '';
            
            if (!result || result.type === 'none' || result.type === 'villager-fake') {
                container.innerHTML = '<p style="color: var(--text-secondary);">You had no night action. Nothing happened to you during the night.</p>';
            } else if (result.type === 'seer-center') {
                container.innerHTML = '<p style="margin-bottom: 15px; color: var(--accent-color); font-weight: bold;">You looked at 2 center cards:</p>';
                var centerDiv = document.createElement('div');
                centerDiv.className = 'center-cards';
                result.cards.forEach(function(roleName) {
                    var card = document.createElement('div');
                    card.className = 'center-card revealed';
                    var roleDef = ROLE_DEFINITIONS[roleName];
                    if (roleDef) {
                        card.classList.add(roleDef.color);
                        card.innerHTML = '<div style="font-size: 1.5rem;">' + roleDef.icon + '</div><div style="font-size: 0.8rem;">' + roleDef.name + '</div>';
                    }
                    centerDiv.appendChild(card);
                });
                container.appendChild(centerDiv);
            } else if (result.type === 'seer-player') {
                if (result.role && ROLE_DEFINITIONS[result.role]) {
                    var targetRoleDef = ROLE_DEFINITIONS[result.role];
                    container.innerHTML = '<p style="margin-bottom: 15px; color: var(--accent-color); font-weight: bold;">You looked at <strong>' + result.target + '</strong>\'s card (original role, before swaps):</p>';
                    container.innerHTML += '<div class="role-card" style="margin: 0 auto; max-width: 250px;"><div class="role-icon" style="font-size: 3rem;">' + targetRoleDef.icon + '</div><div class="role-title role-' + targetRoleDef.color + '" style="font-size: 1.3rem; margin-top: 10px;">' + targetRoleDef.name + '</div></div>';
                } else {
                    container.innerHTML = '<p style="color: var(--text-secondary);">You looked at <strong>' + result.target + '</strong>\'s card, but the role could not be determined.</p>';
                }
            } else if (result.type === 'robber') {
                if (result.newRole && ROLE_DEFINITIONS[result.newRole]) {
                    var newRoleDef = ROLE_DEFINITIONS[result.newRole];
                    container.innerHTML = '<p style="margin-bottom: 15px; color: var(--accent-color); font-weight: bold;">You stole a card! You are now:</p>';
                    container.innerHTML += '<div class="role-card" style="margin: 0 auto; max-width: 250px;"><div class="role-icon" style="font-size: 3rem;">' + newRoleDef.icon + '</div><div class="role-title role-' + newRoleDef.color + '" style="font-size: 1.3rem; margin-top: 10px;">' + newRoleDef.name + '</div></div>';
                    if (result.stolenFrom) {
                        container.innerHTML += '<p style="color: var(--text-secondary); margin-top: 15px; font-size: 0.9rem;">You stole from ' + result.stolenFrom + '</p>';
                    }
                } else {
                    container.innerHTML = '<p style="color: var(--text-secondary);">You stole a card, but your new role could not be determined.</p>';
                }
            } else if (result.type === 'troublemaker') {
                container.innerHTML = '<p style="color: var(--accent-color); font-weight: bold; margin-bottom: 10px;">Your action:</p><p style="color: var(--text-secondary);">' + result.message + '</p>';
            } else if (result.type === 'alphawolf') {
                container.innerHTML = '<p style="color: var(--accent-color); font-weight: bold; margin-bottom: 10px;">Your action:</p><p style="color: var(--text-secondary);">' + result.message + '</p>';
            } else if (result.type === 'drunk') {
                container.innerHTML = '<p style="color: var(--accent-color); font-weight: bold; margin-bottom: 10px;">Your action:</p><p style="color: var(--text-secondary);">' + result.message + '</p>';
            } else if (result.type === 'insomniac') {
                if (result.finalRole && ROLE_DEFINITIONS[result.finalRole]) {
                    var finalRoleDef = ROLE_DEFINITIONS[result.finalRole];
                    container.innerHTML = '<p style="margin-bottom: 15px; color: var(--accent-color); font-weight: bold;">You looked at your card (after all swaps):</p>';
                    container.innerHTML += '<div class="role-card" style="margin: 0 auto; max-width: 250px;"><div class="role-icon" style="font-size: 3rem;">' + finalRoleDef.icon + '</div><div class="role-title role-' + finalRoleDef.color + '" style="font-size: 1.3rem; margin-top: 10px;">' + finalRoleDef.name + '</div></div>';
                } else {
                    container.innerHTML = '<p style="color: var(--text-secondary);">You looked at your card, but the role could not be determined.</p>';
                }
            } else if (result.type === 'werewolf') {
                container.innerHTML = '<p style="color: var(--accent-color); font-weight: bold; margin-bottom: 10px;">Your action:</p><p style="color: var(--text-secondary);">' + result.message + '</p>';
            } else if (result.type === 'werewolf-center') {
                if (result.card && ROLE_DEFINITIONS[result.card]) {
                    var cardRoleDef = ROLE_DEFINITIONS[result.card];
                    container.innerHTML = '<p style="margin-bottom: 15px; color: var(--accent-color); font-weight: bold;">You looked at a center card (original, before swaps):</p>';
                    container.innerHTML += '<div class="role-card" style="margin: 0 auto; max-width: 250px;"><div class="role-icon" style="font-size: 3rem;">' + cardRoleDef.icon + '</div><div class="role-title role-' + cardRoleDef.color + '" style="font-size: 1.3rem; margin-top: 10px;">' + cardRoleDef.name + '</div></div>';
                } else {
                    container.innerHTML = '<p style="color: var(--text-secondary);">You looked at a center card, but it could not be determined.</p>';
                }
            } else if (result.type === 'doppelganger') {
                container.innerHTML = '<p style="color: var(--accent-color); font-weight: bold; margin-bottom: 10px;">Your action:</p><p style="color: var(--text-secondary); margin-bottom: 15px;">' + result.message + '</p>';
                if (result.copiedRole) {
                    var copiedRoleDef = ROLE_DEFINITIONS[result.copiedRole];
                    if (copiedRoleDef) {
                        container.innerHTML += '<p style="color: var(--text-secondary); font-size: 0.9rem;">You became that role and performed its action (see above).</p>';
                    }
                }
            } else if (result.type === 'minion') {
                container.innerHTML = '<p style="color: var(--accent-color); font-weight: bold; margin-bottom: 10px;">Your action:</p><p style="color: var(--text-secondary);">' + result.message + '</p>';
            } else if (result.type === 'mason') {
                container.innerHTML = '<p style="color: var(--accent-color); font-weight: bold; margin-bottom: 10px;">Your action:</p><p style="color: var(--text-secondary);">' + result.message + '</p>';
            } else if (result.type === 'apprenticetanner') {
                container.innerHTML = '<p style="color: var(--accent-color); font-weight: bold; margin-bottom: 10px;">Your action:</p><p style="color: var(--text-secondary);">' + result.message + '</p>';
            } else if (result.type === 'mysticwolf') {
                container.innerHTML = '<p style="color: var(--accent-color); font-weight: bold; margin-bottom: 10px;">Your action:</p>';
                if (result.werewolves && result.werewolves.length > 0) {
                    container.innerHTML += '<p style="color: var(--text-secondary); margin-bottom: 10px;">You saw other Werewolves: <strong>' + result.werewolves.join(', ') + '</strong></p>';
                }
                if (result.centerCard && ROLE_DEFINITIONS[result.centerCard]) {
                    var centerRoleDef = ROLE_DEFINITIONS[result.centerCard];
                    container.innerHTML += '<p style="color: var(--text-secondary); margin-bottom: 10px;">You looked at a center card:</p>';
                    container.innerHTML += '<div class="role-card" style="margin: 0 auto; max-width: 200px; display: inline-block; margin-right: 15px;"><div class="role-icon" style="font-size: 2rem;">' + centerRoleDef.icon + '</div><div class="role-title role-' + centerRoleDef.color + '" style="font-size: 1rem;">' + centerRoleDef.name + '</div></div>';
                }
                if (result.playerCard && ROLE_DEFINITIONS[result.playerCard]) {
                    var playerRoleDef = ROLE_DEFINITIONS[result.playerCard];
                    container.innerHTML += '<p style="color: var(--text-secondary); margin-top: 15px; margin-bottom: 10px;">You looked at <strong>' + result.targetPlayer + '</strong>\'s card:</p>';
                    container.innerHTML += '<div class="role-card" style="margin: 0 auto; max-width: 200px; display: inline-block;"><div class="role-icon" style="font-size: 2rem;">' + playerRoleDef.icon + '</div><div class="role-title role-' + playerRoleDef.color + '" style="font-size: 1rem;">' + playerRoleDef.name + '</div></div>';
                }
            } else if (result.type === 'apprenticeseer' || result.type === 'witch') {
                if (result.card && ROLE_DEFINITIONS[result.card]) {
                    var cardRoleDef = ROLE_DEFINITIONS[result.card];
                    container.innerHTML = '<p style="margin-bottom: 15px; color: var(--accent-color); font-weight: bold;">You looked at a center card:</p>';
                    container.innerHTML += '<div class="role-card" style="margin: 0 auto; max-width: 250px;"><div class="role-icon" style="font-size: 3rem;">' + cardRoleDef.icon + '</div><div class="role-title role-' + cardRoleDef.color + '" style="font-size: 1.3rem; margin-top: 10px;">' + cardRoleDef.name + '</div></div>';
                }
            } else if (result.type === 'paranormalinvestigator') {
                if (result.role && ROLE_DEFINITIONS[result.role]) {
                    var targetRoleDef = ROLE_DEFINITIONS[result.role];
                    container.innerHTML = '<p style="margin-bottom: 15px; color: var(--accent-color); font-weight: bold;">You looked at <strong>' + result.target + '</strong>\'s card:</p>';
                    container.innerHTML += '<div class="role-card" style="margin: 0 auto; max-width: 250px;"><div class="role-icon" style="font-size: 3rem;">' + targetRoleDef.icon + '</div><div class="role-title role-' + targetRoleDef.color + '" style="font-size: 1.3rem; margin-top: 10px;">' + targetRoleDef.name + '</div></div>';
                }
            } else if (result.type === 'villageidiot') {
                container.innerHTML = '<p style="color: var(--accent-color); font-weight: bold; margin-bottom: 10px;">Your action:</p><p style="color: var(--text-secondary);">' + result.message + '</p>';
            } else if (result.type === 'revealer') {
                if (result.card && ROLE_DEFINITIONS[result.card]) {
                    var revealRoleDef = ROLE_DEFINITIONS[result.card];
                    container.innerHTML = '<p style="margin-bottom: 15px; color: var(--accent-color); font-weight: bold;">You revealed a center card to everyone:</p>';
                    container.innerHTML += '<div class="role-card" style="margin: 0 auto; max-width: 250px;"><div class="role-icon" style="font-size: 3rem;">' + revealRoleDef.icon + '</div><div class="role-title role-' + revealRoleDef.color + '" style="font-size: 1.3rem; margin-top: 10px;">' + revealRoleDef.name + '</div></div>';
                }
            } else if (result.type === 'curator') {
                container.innerHTML = '<p style="color: var(--accent-color); font-weight: bold; margin-bottom: 10px;">Your action:</p><p style="color: var(--text-secondary); margin-bottom: 15px;">' + result.message + '</p>';
                if (result.lookedAt && ROLE_DEFINITIONS[result.lookedAt]) {
                    var lookedRoleDef = ROLE_DEFINITIONS[result.lookedAt];
                    container.innerHTML += '<p style="color: var(--text-secondary); margin-bottom: 10px;">You looked at:</p>';
                    container.innerHTML += '<div class="role-card" style="margin: 0 auto; max-width: 200px; display: inline-block;"><div class="role-icon" style="font-size: 2rem;">' + lookedRoleDef.icon + '</div><div class="role-title role-' + lookedRoleDef.color + '" style="font-size: 1rem;">' + lookedRoleDef.name + '</div></div>';
                }
            }
            
            document.getElementById('results-pass-view').classList.add('hidden');
            document.getElementById('results-reveal-view').classList.remove('hidden');
        }

        function nextResult() {
            currentResultIndex++;
            if (currentResultIndex >= playerCount) {
                startDayPhase();
            } else {
                document.getElementById('results-pass-view').classList.remove('hidden');
                document.getElementById('results-reveal-view').classList.add('hidden');
                updateResultsScreen();
            }
        }

        // --- Critical Results (must be shown before day phase) ---
        var currentCriticalResultIndex = 0;
        var criticalResultsPlayers = [];
        
        function showCriticalResults() {
            // Show results for ALL players in order
            criticalResultsPlayers = [];
            players.forEach(function(player) {
                var action = playerActions[player.name];
                var result = actionResults[player.name];
                
                // Determine result type - use result.type if available, otherwise use action type or 'none'
                var resultType = 'none';
                if (result && result.type) {
                    resultType = result.type;
                } else if (action && action.type) {
                    // If there's an action but no result stored, use action type
                    resultType = action.type;
                } else if (player.initialRole === 'Villager') {
                    resultType = 'villager';
                }
                
                criticalResultsPlayers.push({ 
                    player: player, 
                    type: resultType,
                    result: result || { type: resultType },
                    action: action
                });
            });
            
            if (criticalResultsPlayers.length === 0) {
                startDayPhase();
                return;
            }
            
            currentCriticalResultIndex = 0;
            showNextCriticalResult();
        }
        
        function showNextCriticalResult() {
            if (currentCriticalResultIndex >= criticalResultsPlayers.length) {
                startDayPhase();
                return;
            }
            
            var resultInfo = criticalResultsPlayers[currentCriticalResultIndex];
            var player = resultInfo.player;
            var result = resultInfo.result;
            
            // Create modal to show the result
            var modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.style.zIndex = '10000';
            modal.id = 'critical-result-modal';
            
            var content = document.createElement('div');
            content.className = 'container';
            content.style.maxWidth = '600px';
            content.style.maxHeight = '90vh';
            content.style.overflowY = 'auto';
            
            // First show "pass to player" screen
            var passScreen = document.createElement('div');
            passScreen.id = 'result-pass-screen';
            
            var title = document.createElement('h2');
            title.innerText = 'Pass to ' + player.name;
            title.style.color = 'var(--accent-color)';
            title.style.marginBottom = '30px';
            passScreen.appendChild(title);
            
            var instruction = document.createElement('p');
            instruction.innerText = 'Tap when ' + player.name + ' is ready to see their results';
            instruction.style.color = 'var(--text-secondary)';
            instruction.style.fontSize = '1.1rem';
            instruction.style.marginBottom = '30px';
            passScreen.appendChild(instruction);
            
            var revealBtn = document.createElement('button');
            revealBtn.className = 'action-btn';
            revealBtn.innerText = 'Show Results';
            revealBtn.style.fontSize = '1.2rem';
            revealBtn.style.padding = '15px 40px';
            revealBtn.onclick = function() {
                // Hide pass screen and show results
                passScreen.style.display = 'none';
                resultScreen.style.display = 'block';
            };
            passScreen.appendChild(revealBtn);
            
            // Results screen (hidden initially)
            var resultScreen = document.createElement('div');
            resultScreen.id = 'result-reveal-screen';
            resultScreen.style.display = 'none';
            
            var resultTitle = document.createElement('h2');
            resultTitle.innerText = player.name;
            resultTitle.style.color = 'var(--accent-color)';
            resultScreen.appendChild(resultTitle);
            
            // Show original role card (matching role reveal format)
            var roleDef = ROLE_DEFINITIONS[player.initialRole];
            if (roleDef) {
                var roleCardDiv = document.createElement('div');
                roleCardDiv.className = 'role-card';
                roleCardDiv.style.marginBottom = '20px';
                roleCardDiv.innerHTML = '<div class="role-icon">' + roleDef.icon + '</div><div class="role-title role-' + roleDef.color + '">' + roleDef.name + '</div><div style="font-size:0.95rem; margin-bottom:10px; color:#ddd;">' + roleDef.description + '</div>';
                
                // Add extra info if available
                if (player.extraInfo) {
                    roleCardDiv.innerHTML += '<div style="font-size:0.9rem; color:#ffd700; margin-top: 15px; padding: 10px; background: rgba(255, 215, 0, 0.2); border: 1px solid #ffd700; border-radius: 8px;">' + player.extraInfo + '</div>';
                }
                resultScreen.appendChild(roleCardDiv);
            }
            
            var resultDiv = document.createElement('div');
            resultDiv.style.margin = '20px 0';
            
            if (resultInfo.type === 'robber' && result.type === 'robber') {
                if (result.newRole && ROLE_DEFINITIONS[result.newRole]) {
                    var roleDef = ROLE_DEFINITIONS[result.newRole];
                    resultDiv.innerHTML = '<p style="margin-bottom: 15px; color: var(--accent-color); font-weight: bold;">You stole a card! You are now:</p>';
                    resultDiv.innerHTML += '<div class="role-card" style="margin: 0 auto; max-width: 300px;"><div class="role-icon" style="font-size: 4rem;">' + roleDef.icon + '</div><div class="role-title role-' + roleDef.color + '" style="font-size: 1.5rem; margin-top: 10px;">' + roleDef.name + '</div></div>';
                    if (result.stolenFrom) {
                        resultDiv.innerHTML += '<p style="color: var(--text-secondary); margin-top: 15px; font-size: 0.9rem;">You stole from ' + result.stolenFrom + '</p>';
                    }
                } else {
                    resultDiv.innerHTML = '<p style="color: var(--text-secondary);">Your new role could not be determined.</p>';
                }
            } else if (resultInfo.type === 'witch') {
                if (result.centerCard && ROLE_DEFINITIONS[result.centerCard]) {
                    var roleDef = ROLE_DEFINITIONS[result.centerCard];
                    resultDiv.innerHTML = '<p style="margin-bottom: 15px; color: var(--accent-color); font-weight: bold;">You looked at a center card (original):</p>';
                    resultDiv.innerHTML += '<div class="role-card" style="margin: 0 auto; max-width: 300px;"><div class="role-icon" style="font-size: 4rem;">' + roleDef.icon + '</div><div class="role-title role-' + roleDef.color + '" style="font-size: 1.5rem; margin-top: 10px;">' + roleDef.name + '</div></div>';
                    if (result.swappedWith) {
                        resultDiv.innerHTML += '<p style="color: var(--text-secondary); margin-top: 15px; font-size: 0.9rem;">You swapped it with <strong>' + result.swappedWith + '</strong></p>';
                    }
                } else {
                    resultDiv.innerHTML = '<p style="color: var(--text-secondary);">You looked at a center card, but it could not be determined.</p>';
                }
            } else if (resultInfo.type === 'insomniac' && result.type === 'insomniac') {
                if (result.finalRole && ROLE_DEFINITIONS[result.finalRole]) {
                    var roleDef = ROLE_DEFINITIONS[result.finalRole];
                    resultDiv.innerHTML = '<p style="margin-bottom: 15px; color: var(--accent-color); font-weight: bold;">You looked at your card (after all swaps):</p>';
                    resultDiv.innerHTML += '<div class="role-card" style="margin: 0 auto; max-width: 300px;"><div class="role-icon" style="font-size: 4rem;">' + roleDef.icon + '</div><div class="role-title role-' + roleDef.color + '" style="font-size: 1.5rem; margin-top: 10px;">' + roleDef.name + '</div></div>';
                } else {
                    resultDiv.innerHTML = '<p style="color: var(--text-secondary);">Your final role could not be determined.</p>';
                }
            } else if (resultInfo.type === 'seer-center' || (resultInfo.type === 'seer' && result.type === 'seer-center')) {
                resultDiv.innerHTML = '<p style="margin-bottom: 15px; color: var(--accent-color); font-weight: bold;">You looked at 2 center cards:</p>';
                var centerDiv = document.createElement('div');
                centerDiv.className = 'center-cards';
                centerDiv.style.justifyContent = 'center';
                if (result.cards && result.cards.length === 2) {
                    result.cards.forEach(function(roleName) {
                        var card = document.createElement('div');
                        card.className = 'center-card revealed';
                        var roleDef = ROLE_DEFINITIONS[roleName];
                        if (roleDef) {
                            card.classList.add(roleDef.color);
                            card.innerHTML = '<div style="font-size: 2rem;">' + roleDef.icon + '</div><div style="font-size: 1rem;">' + roleDef.name + '</div>';
                        }
                        centerDiv.appendChild(card);
                    });
                }
                resultDiv.appendChild(centerDiv);
            } else if (resultInfo.type === 'seer-player' || (resultInfo.type === 'seer' && result.type === 'seer-player')) {
                if (result.role && ROLE_DEFINITIONS[result.role]) {
                    var roleDef = ROLE_DEFINITIONS[result.role];
                    resultDiv.innerHTML = '<p style="margin-bottom: 15px; color: var(--accent-color); font-weight: bold;">You looked at <strong>' + result.target + '</strong>\'s card (original role, before swaps):</p>';
                    resultDiv.innerHTML += '<div class="role-card" style="margin: 0 auto; max-width: 300px;"><div class="role-icon" style="font-size: 4rem;">' + roleDef.icon + '</div><div class="role-title role-' + roleDef.color + '" style="font-size: 1.5rem; margin-top: 10px;">' + roleDef.name + '</div></div>';
                } else {
                    resultDiv.innerHTML = '<p style="color: var(--text-secondary);">The role could not be determined.</p>';
                }
            } else if (resultInfo.type === 'werewolf-center' || (resultInfo.type === 'werewolf' && result.type === 'werewolf-center')) {
                if (result.card && ROLE_DEFINITIONS[result.card]) {
                    var roleDef = ROLE_DEFINITIONS[result.card];
                    resultDiv.innerHTML = '<p style="margin-bottom: 15px; color: var(--accent-color); font-weight: bold;">You looked at a center card (original, before swaps):</p>';
                    resultDiv.innerHTML += '<div class="role-card" style="margin: 0 auto; max-width: 300px;"><div class="role-icon" style="font-size: 4rem;">' + roleDef.icon + '</div><div class="role-title role-' + roleDef.color + '" style="font-size: 1.5rem; margin-top: 10px;">' + roleDef.name + '</div></div>';
                } else {
                    resultDiv.innerHTML = '<p style="color: var(--text-secondary);">You looked at a center card, but it could not be determined.</p>';
                }
            } else if (resultInfo.type === 'troublemaker' && result.type === 'troublemaker') {
                resultDiv.innerHTML = '<p style="color: var(--accent-color); font-weight: bold; margin-bottom: 10px;">Your action:</p><p style="color: var(--text-secondary);">' + (result.message || 'You swapped two players\' cards.') + '</p>';
            } else if (resultInfo.type === 'alphawolf' && result.type === 'alphawolf') {
                resultDiv.innerHTML = '<p style="color: var(--accent-color); font-weight: bold; margin-bottom: 10px;">Your action:</p><p style="color: var(--text-secondary);">' + (result.message || 'You swapped the Center Werewolf card with a player.') + '</p>';
            } else if (resultInfo.type === 'drunk') {
                resultDiv.innerHTML = '<p style="color: var(--accent-color); font-weight: bold; margin-bottom: 10px;">Your action:</p><p style="color: var(--text-secondary);">You swapped your card with a center card (you don\'t know which one).</p>';
            } else if (resultInfo.type === 'doppelganger' && result.type === 'doppelganger') {
                // Doppelg√§nger sees the copied role and then performs its action
                var action = resultInfo.action;
                if (action && action.copiedPlayer) {
                    var copiedPlayer = players.find(p => p.name === action.copiedPlayer);
                    if (copiedPlayer) {
                        var copiedRole = copiedPlayer.initialRole;
                        var copiedRoleDef = ROLE_DEFINITIONS[copiedRole];
                        
                        if (copiedRoleDef) {
                            resultDiv.innerHTML = '<p style="color: var(--accent-color); font-weight: bold; margin-bottom: 15px;">You copied ' + action.copiedPlayer + '\'s role:</p>';
                            resultDiv.innerHTML += '<div class="role-card" style="margin: 0 auto; max-width: 300px;"><div class="role-icon" style="font-size: 4rem;">' + copiedRoleDef.icon + '</div><div class="role-title role-' + copiedRoleDef.color + '" style="font-size: 1.5rem; margin-top: 10px;">' + copiedRoleDef.name + '</div></div>';
                            
                            // Store the copied role for action resolution
                            if (!playerActions[player.name]) {
                                playerActions[player.name] = { type: 'doppelganger' };
                            }
                            playerActions[player.name].copiedRole = copiedRole;
                            playerActions[player.name].copiedActionType = copiedRoleDef.actionType;
                            
                            // If the copied role has an action, show button to perform it
                            if (copiedRoleDef.hasAction) {
                                var actionBtn = document.createElement('button');
                                actionBtn.className = 'action-btn';
                                actionBtn.style.marginTop = '20px';
                                actionBtn.innerText = 'Perform ' + copiedRoleDef.name + ' Action';
                                actionBtn.onclick = function() {
                                    // Hide the result screen temporarily
                                    resultScreen.style.display = 'none';
                                    
                                    // Create action container
                                    var actionContainer = document.createElement('div');
                                    actionContainer.style.padding = '20px';
                                    actionContainer.style.background = 'rgba(0,0,0,0.8)';
                                    actionContainer.style.borderRadius = '10px';
                                    actionContainer.style.marginTop = '20px';
                                    
                                    var actionTitle = document.createElement('h3');
                                    actionTitle.innerText = 'Perform ' + copiedRoleDef.name + ' Action';
                                    actionTitle.style.color = 'var(--accent-color)';
                                    actionTitle.style.marginBottom = '15px';
                                    actionContainer.appendChild(actionTitle);
                                    
                                    // Perform the copied role's action
                                    if (copiedRoleDef.actionType === 'seer') {
                                        showSeerAction(player, actionContainer, true); // true = isDoppelganger
                                    } else if (copiedRoleDef.actionType === 'robber') {
                                        showRobberAction(player, actionContainer, true);
                                    } else if (copiedRoleDef.actionType === 'troublemaker') {
                                        showTroublemakerAction(player, actionContainer, true);
                                    } else if (copiedRoleDef.actionType === 'drunk') {
                                        showDrunkAction(player, actionContainer, true);
                                    } else if (copiedRoleDef.actionType === 'werewolf') {
                                        showWerewolfAction(player, actionContainer, true);
                                    }
                                    
                                    // Add back button to return to result
                                    var backBtn = document.createElement('button');
                                    backBtn.className = 'secondary-btn';
                                    backBtn.style.marginTop = '15px';
                                    backBtn.innerText = 'Back to Results';
                                    backBtn.onclick = function() {
                                        content.removeChild(actionContainer);
                                        resultScreen.style.display = 'block';
                                    };
                                    actionContainer.appendChild(backBtn);
                                    
                                    content.appendChild(actionContainer);
                                };
                                resultDiv.appendChild(actionBtn);
                            } else {
                                resultDiv.innerHTML += '<p style="color: var(--text-secondary); margin-top: 15px;">That role has no night action.</p>';
                            }
                        }
                    }
                } else {
                    resultDiv.innerHTML = '<p style="color: var(--text-secondary);">You copied a role, but it could not be determined.</p>';
                }
            } else if (resultInfo.type === 'minion' && result.type === 'minion') {
                resultDiv.innerHTML = '<p style="color: var(--accent-color); font-weight: bold; margin-bottom: 10px;">Your action:</p><p style="color: var(--text-secondary);">' + (result.message || 'You saw the Werewolves.') + '</p>';
            } else if (resultInfo.type === 'mason' && result.type === 'mason') {
                resultDiv.innerHTML = '<p style="color: var(--accent-color); font-weight: bold; margin-bottom: 10px;">Your action:</p><p style="color: var(--text-secondary);">' + (result.message || 'You saw the other Masons.') + '</p>';
            } else if (resultInfo.type === 'apprenticetanner' && result.type === 'apprenticetanner') {
                resultDiv.innerHTML = '<p style="color: var(--accent-color); font-weight: bold; margin-bottom: 10px;">Your action:</p><p style="color: var(--text-secondary);">' + (result.message || 'You saw the Tanner.') + '</p>';
            } else if (resultInfo.type === 'dreamwolf' && result.type === 'dreamwolf') {
                resultDiv.innerHTML = '<p style="color: var(--accent-color); font-weight: bold; margin-bottom: 10px;">Your action:</p><p style="color: var(--text-secondary);">' + (result.message || 'You are a Dream Wolf. You did not wake up, but other Werewolves saw your thumb.') + '</p>';
            } else if (resultInfo.type === 'werewolf' && !result) {
                // Werewolf with no center card viewing (multiple werewolves)
                resultDiv.innerHTML = '<p style="color: var(--accent-color); font-weight: bold; margin-bottom: 10px;">Your action:</p><p style="color: var(--text-secondary);">You saw the other Werewolves.</p>';
            } else if (resultInfo.type === 'villager' || resultInfo.type === 'none' || !result) {
                // Villager or no action
                resultDiv.innerHTML = '<p style="color: var(--accent-color); font-weight: bold; margin-bottom: 10px;">Your action:</p><p style="color: var(--text-secondary);">You had no night action. Nothing happened to you during the night.</p>';
            } else if (resultInfo.type === 'mysticwolf') {
                resultDiv.innerHTML = '<p style="color: var(--accent-color); font-weight: bold; margin-bottom: 10px;">Your action:</p>';
                if (result.werewolves && result.werewolves.length > 0) {
                    resultDiv.innerHTML += '<p style="color: var(--text-secondary); margin-bottom: 10px;">You saw other Werewolves: <strong>' + result.werewolves.join(', ') + '</strong></p>';
                }
                if (result.centerCard && ROLE_DEFINITIONS[result.centerCard]) {
                    var centerRoleDef = ROLE_DEFINITIONS[result.centerCard];
                    resultDiv.innerHTML += '<p style="color: var(--text-secondary); margin-bottom: 10px;">You looked at a center card:</p>';
                    resultDiv.innerHTML += '<div class="role-card" style="margin: 0 auto; max-width: 200px; display: inline-block; margin-right: 15px;"><div class="role-icon" style="font-size: 2rem;">' + centerRoleDef.icon + '</div><div class="role-title role-' + centerRoleDef.color + '" style="font-size: 1rem;">' + centerRoleDef.name + '</div></div>';
                }
                if (result.playerCard && ROLE_DEFINITIONS[result.playerCard]) {
                    var playerRoleDef = ROLE_DEFINITIONS[result.playerCard];
                    resultDiv.innerHTML += '<p style="color: var(--text-secondary); margin-top: 15px; margin-bottom: 10px;">You looked at <strong>' + result.targetPlayer + '</strong>\'s card:</p>';
                    resultDiv.innerHTML += '<div class="role-card" style="margin: 0 auto; max-width: 200px; display: inline-block;"><div class="role-icon" style="font-size: 2rem;">' + playerRoleDef.icon + '</div><div class="role-title role-' + playerRoleDef.color + '" style="font-size: 1rem;">' + playerRoleDef.name + '</div></div>';
                }
            } else if (resultInfo.type === 'apprenticeseer' || resultInfo.type === 'witch') {
                if (result.card && ROLE_DEFINITIONS[result.card]) {
                    var cardRoleDef = ROLE_DEFINITIONS[result.card];
                    resultDiv.innerHTML = '<p style="margin-bottom: 15px; color: var(--accent-color); font-weight: bold;">You looked at a center card:</p>';
                    resultDiv.innerHTML += '<div class="role-card" style="margin: 0 auto; max-width: 300px;"><div class="role-icon" style="font-size: 4rem;">' + cardRoleDef.icon + '</div><div class="role-title role-' + cardRoleDef.color + '" style="font-size: 1.5rem; margin-top: 10px;">' + cardRoleDef.name + '</div></div>';
                }
            } else if (resultInfo.type === 'paranormalinvestigator') {
                if (result.role && ROLE_DEFINITIONS[result.role]) {
                    var targetRoleDef = ROLE_DEFINITIONS[result.role];
                    resultDiv.innerHTML = '<p style="margin-bottom: 15px; color: var(--accent-color); font-weight: bold;">You looked at <strong>' + result.target + '</strong>\'s card:</p>';
                    resultDiv.innerHTML += '<div class="role-card" style="margin: 0 auto; max-width: 300px;"><div class="role-icon" style="font-size: 4rem;">' + targetRoleDef.icon + '</div><div class="role-title role-' + targetRoleDef.color + '" style="font-size: 1.5rem; margin-top: 10px;">' + targetRoleDef.name + '</div></div>';
                }
            } else if (resultInfo.type === 'villageidiot') {
                resultDiv.innerHTML = '<p style="color: var(--accent-color); font-weight: bold; margin-bottom: 10px;">Your action:</p><p style="color: var(--text-secondary);">' + (result.message || 'You swapped 2 center cards (you don\'t know which ones)') + '</p>';
            } else if (resultInfo.type === 'revealer') {
                if (result.card && ROLE_DEFINITIONS[result.card]) {
                    var revealRoleDef = ROLE_DEFINITIONS[result.card];
                    resultDiv.innerHTML = '<p style="margin-bottom: 15px; color: var(--accent-color); font-weight: bold;">You revealed a center card to everyone:</p>';
                    resultDiv.innerHTML += '<div class="role-card" style="margin: 0 auto; max-width: 300px;"><div class="role-icon" style="font-size: 4rem;">' + revealRoleDef.icon + '</div><div class="role-title role-' + revealRoleDef.color + '" style="font-size: 1.5rem; margin-top: 10px;">' + revealRoleDef.name + '</div></div>';
                }
            } else if (resultInfo.type === 'curator') {
                resultDiv.innerHTML = '<p style="color: var(--accent-color); font-weight: bold; margin-bottom: 10px;">Your action:</p><p style="color: var(--text-secondary); margin-bottom: 15px;">' + (result.message || 'You looked at a center card and swapped it with another') + '</p>';
                if (result.lookedAt && ROLE_DEFINITIONS[result.lookedAt]) {
                    var lookedRoleDef = ROLE_DEFINITIONS[result.lookedAt];
                    resultDiv.innerHTML += '<p style="color: var(--text-secondary); margin-bottom: 10px;">You looked at:</p>';
                    resultDiv.innerHTML += '<div class="role-card" style="margin: 0 auto; max-width: 200px; display: inline-block;"><div class="role-icon" style="font-size: 2rem;">' + lookedRoleDef.icon + '</div><div class="role-title role-' + lookedRoleDef.color + '" style="font-size: 1rem;">' + lookedRoleDef.name + '</div></div>';
                }
            } else {
                // Generic result display
                if (result.message) {
                    resultDiv.innerHTML = '<p style="color: var(--accent-color); font-weight: bold; margin-bottom: 10px;">Your action:</p><p style="color: var(--text-secondary);">' + result.message + '</p>';
                } else {
                    resultDiv.innerHTML = '<p style="color: var(--text-secondary);">No results to display.</p>';
                }
            }
            
            resultScreen.appendChild(resultDiv);
            
            var continueBtn = document.createElement('button');
            continueBtn.className = 'action-btn';
            continueBtn.style.marginTop = '20px';
            continueBtn.innerText = currentCriticalResultIndex < criticalResultsPlayers.length - 1 ? 'Next Player' : 'Start Day Phase';
            continueBtn.onclick = function() {
                document.body.removeChild(modal);
                currentCriticalResultIndex++;
                showNextCriticalResult();
            };
            resultScreen.appendChild(continueBtn);
            
            // Add both screens to content
            content.appendChild(passScreen);
            content.appendChild(resultScreen);
            
            modal.appendChild(content);
            document.body.appendChild(modal);
        }

        // --- Day Phase ---
        var startingPlayerIndex = 0; // Store the randomly selected starting player for day phase
        
        function startDayPhase() {
            eliminatedPlayer = null;
            
            // Randomly select starting player for day phase
            startingPlayerIndex = Math.floor(Math.random() * players.length);
            
            showScreen('day-screen');
            renderRolesInGame();
            renderFinalRolesByResolutionOrder();
            renderVotingPlayers();
            renderStartingPlayerNote();
            
            // Initialize timer display and start automatically
            updateTimerDisplay();
            toggleTimer(); // Start timer automatically
        }
        
        // --- Timer Functions ---
        function formatTime(seconds) {
            var mins = Math.floor(seconds / 60);
            var secs = seconds % 60;
            return (mins < 10 ? '0' : '') + mins + ':' + (secs < 10 ? '0' : '') + secs;
        }
        
        function updateTimerDisplay() {
            var display = document.getElementById('timer-display');
            if (display) {
                display.innerText = formatTime(dayTimerSeconds);
                
                // Change color when time is running low
                if (dayTimerSeconds <= 30) {
                    display.style.color = '#ff4444';
                } else if (dayTimerSeconds <= 60) {
                    display.style.color = '#ffaa00';
                } else {
                    display.style.color = 'var(--accent-color)';
                }
            }
        }
        
        function toggleTimer() {
            var startBtn = document.getElementById('timer-start-btn');
            if (!startBtn) return;
            
            if (dayTimerRunning) {
                // Pause timer
                clearInterval(dayTimerInterval);
                dayTimerInterval = null;
                dayTimerRunning = false;
                startBtn.innerText = 'Start';
                startBtn.style.background = 'var(--accent-color)';
            } else {
                // Start timer
                if (dayTimerSeconds <= 0) {
                    dayTimerSeconds = 300; // Reset to 5 minutes if at 0
                }
                dayTimerInterval = setInterval(function() {
                    dayTimerSeconds--;
                    updateTimerDisplay();
                    
                    if (dayTimerSeconds <= 0) {
                        clearInterval(dayTimerInterval);
                        dayTimerInterval = null;
                        dayTimerRunning = false;
                        startBtn.innerText = 'Start';
                        startBtn.style.background = 'var(--accent-color)';
                        
                        // Optional: Play sound or show alert when timer reaches 0
                        // You can add audio notification here if desired
                    }
                }, 1000);
                dayTimerRunning = true;
                startBtn.innerText = 'Pause';
                startBtn.style.background = '#ff4444';
            }
        }
        
        function resetTimer() {
            clearInterval(dayTimerInterval);
            dayTimerInterval = null;
            dayTimerRunning = false;
            dayTimerSeconds = 300; // Reset to default 5 minutes
            updateTimerDisplay();
            
            var startBtn = document.getElementById('timer-start-btn');
            if (startBtn) {
                startBtn.innerText = 'Start';
                startBtn.style.background = 'var(--accent-color)';
            }
        }
        
        function adjustTimer(seconds) {
            // Allow adjustment even when timer is running
            dayTimerSeconds += seconds;
            
            // Clamp between 0 and 30 minutes (1800 seconds)
            if (dayTimerSeconds < 0) {
                dayTimerSeconds = 0;
            } else if (dayTimerSeconds > 1800) {
                dayTimerSeconds = 1800;
            }
            
            updateTimerDisplay();
        }
        
        function renderStartingPlayerNote() {
            var startingPlayer = players[startingPlayerIndex];
            var noteDiv = document.getElementById('starting-player-note');
            if (!noteDiv) {
                noteDiv = document.createElement('div');
                noteDiv.id = 'starting-player-note';
                noteDiv.style.marginBottom = '20px';
                noteDiv.style.padding = '15px';
                noteDiv.style.background = 'rgba(255, 215, 0, 0.2)';
                noteDiv.style.border = '2px solid #ffd700';
                noteDiv.style.borderRadius = '8px';
                noteDiv.style.textAlign = 'center';
                var dayContent = document.getElementById('day-phase-content');
                dayContent.insertBefore(noteDiv, dayContent.firstChild);
            }
            noteDiv.innerHTML = '<p style="color: #ffd700; font-size: 1.1rem; font-weight: bold; margin: 0;"><span style="font-size: 1.3rem;">‚≠ê</span> ' + startingPlayer.name + ' should start the discussion <span style="font-size: 1.3rem;">‚≠ê</span></p>';
        }

        function renderRolesInGame() {
            // Get all unique roles that are in play (from selectedRoles)
            var rolesList = document.getElementById('roles-list');
            rolesList.innerHTML = '';
            
            var uniqueRoles = {};
            selectedRoles.forEach(function(role) {
                uniqueRoles[role] = (uniqueRoles[role] || 0) + 1;
            });
            
            // Create array of role items with their night order
            var roleItems = [];
            
            Object.keys(uniqueRoles).forEach(function(roleKey) {
                var roleDef = ROLE_DEFINITIONS[roleKey];
                if (!roleDef) return;
                
                var count = uniqueRoles[roleKey];
                var roleItem = document.createElement('div');
                roleItem.style.padding = '8px 12px';
                roleItem.style.background = 'rgba(255,255,255,0.1)';
                roleItem.style.borderRadius = '6px';
                roleItem.style.display = 'inline-flex';
                roleItem.style.alignItems = 'center';
                roleItem.style.gap = '8px';
                roleItem.style.fontSize = '0.9rem';
                
                // Set border color based on team
                if (roleDef.team === 'tanner') {
                    roleItem.style.borderLeft = '3px solid #FF9800';
                } else if (roleDef.team === 'werewolf') {
                    roleItem.style.borderLeft = '3px solid #8B4513';
                } else {
                    roleItem.style.borderLeft = '3px solid #4CAF50';
                }
                
                roleItem.innerHTML = roleDef.icon + ' ' + roleDef.name + (count > 1 ? ' (' + count + ')' : '');
                
                roleItems.push({
                    item: roleItem,
                    nightOrder: roleDef.nightOrder || 999 // Roles without night order go to end
                });
            });
            
            // Sort by night order (ascending), but roles with nightOrder 0 go to the end
            roleItems.sort(function(a, b) {
                if (a.nightOrder === 0 && b.nightOrder === 0) return 0;
                if (a.nightOrder === 0) return 1; // a goes after b
                if (b.nightOrder === 0) return -1; // b goes after a
                return a.nightOrder - b.nightOrder;
            });
            
            // Append in night order
            roleItems.forEach(function(roleData) {
                rolesList.appendChild(roleData.item);
            });
        }
        
        function renderFinalRolesByResolutionOrder() {
            var immediateResults = document.getElementById('show-results-immediately').checked;
            var container = document.getElementById('players-final-roles');
            var list = document.getElementById('final-roles-list');
            
            // Only show this when immediate resolution is NOT checked
            if (immediateResults) {
                container.style.display = 'none';
                return;
            }
            
            container.style.display = 'block';
            list.innerHTML = '';
            
            // Check if Doppelg√§nger copied a role with action (for ordering)
            var doppelgangerHasAction = false;
            var originalDoppelganger = players.find(p => p.initialRole === 'Doppelg√§nger');
            if (originalDoppelganger && playerActions[originalDoppelganger.name] && playerActions[originalDoppelganger.name].copiedActionType) {
                doppelgangerHasAction = true;
            }
            
            // Resolution order mapping: lower number = resolves earlier
            // Order matches resolveActions() sequence:
            // 1. Doppelganger (if copied a role with action)
            // 2. Alpha Wolf
            // 3. Witch
            // 4. Robber
            // 5. Troublemaker
            // 6. Village Idiot
            // 7. Curator
            // 8. Drunk
            // 9. Others (no swap actions)
            function getResolutionOrder(roleName) {
                if (roleName === 'Doppelg√§nger') {
                    return doppelgangerHasAction ? 0 : 999;
                }
                var roleDef = ROLE_DEFINITIONS[roleName];
                if (!roleDef) return 999;
                
                // Map to resolution order based on resolveActions() sequence
                if (roleName === 'Alpha Wolf') return 1;
                if (roleName === 'Witch') return 2;
                if (roleName === 'Robber') return 3;
                if (roleName === 'Troublemaker') return 4;
                if (roleName === 'Village Idiot') return 5;
                if (roleName === 'Curator') return 6;
                if (roleName === 'Drunk') return 7;
                
                // All other roles (Seer, Insomniac, Werewolf, Villager, etc.) don't swap, so order doesn't matter
                return 999;
            }
            
            // Create array of players with their final roles and resolution order
            var playerItems = players.map(function(player) {
                var finalRole = player.currentRole || player.initialRole;
                var roleDef = ROLE_DEFINITIONS[finalRole];
                if (!roleDef) return null;
                
                return {
                    player: player,
                    role: finalRole,
                    roleDef: roleDef,
                    resolutionOrder: getResolutionOrder(finalRole)
                };
            }).filter(function(item) { return item !== null; });
            
            // Sort by resolution order
            playerItems.sort(function(a, b) {
                if (a.resolutionOrder !== b.resolutionOrder) {
                    return a.resolutionOrder - b.resolutionOrder;
                }
                // If same resolution order, sort alphabetically by player name
                return a.player.name.localeCompare(b.player.name);
            });
            
            // Render each player
            playerItems.forEach(function(item) {
                var playerDiv = document.createElement('div');
                playerDiv.style.padding = '10px 15px';
                playerDiv.style.background = 'rgba(255,255,255,0.05)';
                playerDiv.style.borderRadius = '6px';
                playerDiv.style.borderLeft = '3px solid';
                
                // Set border color based on team
                if (item.roleDef.team === 'tanner') {
                    playerDiv.style.borderLeftColor = '#FF9800';
                } else if (item.roleDef.team === 'werewolf') {
                    playerDiv.style.borderLeftColor = '#8B4513';
                } else {
                    playerDiv.style.borderLeftColor = '#4CAF50';
                }
                
                playerDiv.innerHTML = '<strong style="color: var(--accent-color);">' + item.player.name + ':</strong> ' + 
                    '<span style="font-size: 1.1rem;">' + item.roleDef.icon + '</span> ' + 
                    '<span>' + item.roleDef.name + '</span>';
                
                list.appendChild(playerDiv);
            });
        }

        function renderVotingPlayers() {
            var votingList = document.getElementById('voting-players');
            votingList.innerHTML = '';
            
            players.forEach(function(player) {
                var playerCard = document.createElement('div');
                playerCard.style.padding = '15px';
                playerCard.style.background = 'rgba(255,255,255,0.05)';
                playerCard.style.border = '2px solid rgba(255,255,255,0.2)';
                playerCard.style.borderRadius = '10px';
                playerCard.style.cursor = 'pointer';
                playerCard.style.transition = 'all 0.3s';
                playerCard.style.textAlign = 'center';
                
                playerCard.onmouseover = function() {
                    this.style.background = 'rgba(255, 152, 0, 0.2)';
                    this.style.borderColor = '#FF9800';
                    this.style.transform = 'scale(1.02)';
                };
                playerCard.onmouseout = function() {
                    this.style.background = 'rgba(255,255,255,0.05)';
                    this.style.borderColor = 'rgba(255,255,255,0.2)';
                    this.style.transform = 'scale(1)';
                };
                
                playerCard.onclick = function() {
                    eliminatePlayer(player);
                };
                
                var playerName = document.createElement('div');
                playerName.style.fontSize = '1.3rem';
                playerName.style.fontWeight = 'bold';
                playerName.style.color = 'var(--accent-color)';
                playerName.style.marginBottom = '5px';
                playerName.innerText = player.name;
                playerCard.appendChild(playerName);
                
                var clickHint = document.createElement('div');
                clickHint.style.fontSize = '0.85rem';
                clickHint.style.color = 'var(--text-secondary)';
                clickHint.innerText = 'Click to eliminate';
                playerCard.appendChild(clickHint);
                
                votingList.appendChild(playerCard);
            });
        }

        function eliminatePlayer(player) {
            eliminatedPlayer = player;
            document.getElementById('voting-modal').classList.add('hidden');
            checkWinConditions();
        }

        function checkWinConditions() {
            var eliminatedRole = eliminatedPlayer.currentRole;
            var roleDef = ROLE_DEFINITIONS[eliminatedRole];
            
            // Check for Hunter
            if (eliminatedRole === 'Hunter') {
                // Hunter eliminates another player
                var hunterModal = document.createElement('div');
                hunterModal.className = 'modal-overlay';
                var content = document.createElement('div');
                content.className = 'container';
                content.style.maxWidth = '500px';
                content.innerHTML = '<h2>Hunter Ability</h2><p>' + eliminatedPlayer.name + ' was eliminated! As the Hunter, eliminate another player:</p>';
                var list = document.createElement('div');
                players.forEach(function(p) {
                    if (p.name === eliminatedPlayer.name) return;
                    var btn = document.createElement('button');
                    btn.className = 'player-select-btn';
                    btn.innerText = p.name;
                    btn.onclick = function() {
                        var secondEliminated = p;
                        // Check if second eliminated is a Werewolf
                        var secondRole = secondEliminated.currentRole;
                        var wasWerewolfEliminated = (eliminatedRole === 'Werewolf' || eliminatedRole === 'Alpha Wolf' || eliminatedRole === 'Mystic Wolf' || eliminatedRole === 'Dream Wolf' || eliminatedRole === 'Oracle Wolf' || secondRole === 'Werewolf' || secondRole === 'Alpha Wolf' || secondRole === 'Mystic Wolf' || secondRole === 'Dream Wolf' || secondRole === 'Oracle Wolf');
                        var tannerEliminated = (eliminatedRole === 'Tanner' || secondRole === 'Tanner');
                        var apprenticeTannerEliminated = (eliminatedRole === 'Apprentice Tanner' || secondRole === 'Apprentice Tanner');
                        
                        document.body.removeChild(hunterModal);
                        
                        // Check for Apprentice Tanner win conditions
                        // Check if Tanner was in the initial setup (before swaps)
                        var hasTanner = players.some(p => p.initialRole === 'Tanner');
                        var hasApprenticeTanner = players.some(p => p.initialRole === 'Apprentice Tanner');
                        var apprenticeTannerWins = false;
                        
                        // Apprentice Tanner wins if:
                        // 1. Tanner (current role after swaps) is eliminated - Apprentice Tanner wins regardless
                        // 2. Apprentice Tanner (current role after swaps) is eliminated AND there's no Tanner in initial setup
                        if (tannerEliminated && hasApprenticeTanner) {
                            // If Tanner is eliminated, Apprentice Tanner wins
                            apprenticeTannerWins = true;
                        } else if (apprenticeTannerEliminated && !hasTanner) {
                            // If Apprentice Tanner is eliminated and there's no Tanner, Apprentice Tanner wins
                            apprenticeTannerWins = true;
                        }
                        
                        var winner = '';
                        var message = '';
                        
                        // Priority: Tanner wins override everything (but Apprentice Tanner also wins if Tanner is eliminated)
                        if (tannerEliminated) {
                            winner = 'Tanner';
                            message = 'Tanner wins! ' + (eliminatedRole === 'Tanner' ? eliminatedPlayer.name : secondEliminated.name) + ' (Tanner) was eliminated.';
                            if (apprenticeTannerWins) {
                                // Find the Apprentice Tanner player (by initial role, as they might have been swapped)
                                var apprenticeTanner = players.find(p => p.initialRole === 'Apprentice Tanner');
                                if (apprenticeTanner) {
                                    message += ' ' + apprenticeTanner.name + ' (Apprentice Tanner) also wins!';
                                }
                            }
                        } else if (apprenticeTannerEliminated && apprenticeTannerWins) {
                            winner = 'Apprentice Tanner';
                            message = 'Apprentice Tanner wins! ' + (eliminatedRole === 'Apprentice Tanner' ? eliminatedPlayer.name : secondEliminated.name) + ' (Apprentice Tanner) was eliminated (no Tanner in play).';
                        } else if (wasWerewolfEliminated) {
                            winner = 'Villagers';
                            message = 'Villagers win! A Werewolf was eliminated.';
                        } else {
                            winner = 'Werewolves';
                            message = 'Werewolves win! No Werewolf was eliminated.';
                        }
                        
                        endGame(winner, message);
                    };
                    list.appendChild(btn);
                });
                content.appendChild(list);
                hunterModal.appendChild(content);
                document.body.appendChild(hunterModal);
                return;
            }
            
            // Check win conditions
            var wasWerewolfEliminated = (eliminatedRole === 'Werewolf' || eliminatedRole === 'Alpha Wolf' || eliminatedRole === 'Mystic Wolf' || eliminatedRole === 'Dream Wolf');
            var tannerEliminated = eliminatedRole === 'Tanner';
            var apprenticeTannerEliminated = eliminatedRole === 'Apprentice Tanner';
            
            // Check if Doppelg√§nger became a Werewolf
            if (eliminatedPlayer.initialRole === 'Doppelg√§nger') {
                var doppelgangerAction = playerActions[eliminatedPlayer.name];
                if (doppelgangerAction && doppelgangerAction.type === 'doppelganger') {
                    var copiedRole = doppelgangerAction.copiedRole;
                    if (copiedRole === 'Werewolf' || copiedRole === 'Alpha Wolf' || copiedRole === 'Mystic Wolf' || copiedRole === 'Dream Wolf' || copiedRole === 'Oracle Wolf') {
                        // Check final role after swaps
                        wasWerewolfEliminated = (eliminatedRole === 'Werewolf' || eliminatedRole === 'Alpha Wolf' || eliminatedRole === 'Mystic Wolf' || eliminatedRole === 'Dream Wolf' || eliminatedRole === 'Oracle Wolf');
                    }
                }
            }
            
            // Check for Apprentice Tanner win conditions
            // Check if Tanner was in the initial setup (before swaps)
            var hasTanner = players.some(p => p.initialRole === 'Tanner');
            var hasApprenticeTanner = players.some(p => p.initialRole === 'Apprentice Tanner');
            var apprenticeTannerWins = false;
            
            // Apprentice Tanner wins if:
            // 1. Tanner (current role after swaps) is eliminated - Apprentice Tanner wins regardless
            // 2. Apprentice Tanner (current role after swaps) is eliminated AND there's no Tanner in initial setup
            if (tannerEliminated && hasApprenticeTanner) {
                // If Tanner is eliminated, Apprentice Tanner wins
                apprenticeTannerWins = true;
            } else if (apprenticeTannerEliminated && !hasTanner) {
                // If Apprentice Tanner is eliminated and there's no Tanner, Apprentice Tanner wins
                apprenticeTannerWins = true;
            }
            
            var winner = '';
            var message = '';
            
            // Priority: Tanner wins override everything (but Apprentice Tanner also wins if Tanner is eliminated)
            if (tannerEliminated) {
                winner = 'Tanner';
                message = 'Tanner wins! ' + eliminatedPlayer.name + ' (Tanner) was eliminated.';
                if (apprenticeTannerWins) {
                    // Find the Apprentice Tanner player (by initial role, as they might have been swapped)
                    var apprenticeTanner = players.find(p => p.initialRole === 'Apprentice Tanner');
                    if (apprenticeTanner) {
                        message += ' ' + apprenticeTanner.name + ' (Apprentice Tanner) also wins!';
                    }
                }
            } else if (apprenticeTannerEliminated && apprenticeTannerWins) {
                winner = 'Apprentice Tanner';
                message = 'Apprentice Tanner wins! ' + eliminatedPlayer.name + ' (Apprentice Tanner) was eliminated (no Tanner in play).';
            } else if (wasWerewolfEliminated) {
                winner = 'Villagers';
                message = 'Villagers win! A Werewolf was eliminated.';
            } else {
                winner = 'Werewolves';
                message = 'Werewolves win! No Werewolf was eliminated.';
            }
            
            endGame(winner, message);
        }

        function endGame(winner, message) {
            var titleEl = document.getElementById('end-game-title');
            titleEl.innerText = winner.toUpperCase() + ' WIN!';
            titleEl.style.color = winner === 'Werewolves' ? 'var(--werewolf-color)' : (winner === 'Tanner' ? 'var(--special-color)' : 'var(--villager-color)');
            document.getElementById('end-game-message').innerText = message;
            
            // Show final roles
            var rolesDiv = document.getElementById('final-roles');
            rolesDiv.innerHTML = '<h3 style="margin-bottom: 10px;">Final Roles (after all swaps):</h3>';
            players.forEach(function(player) {
                var roleDef = ROLE_DEFINITIONS[player.currentRole];
                var colorMap = {
                    'werewolf': '#8B4513',
                    'villager': '#4CAF50',
                    'special': '#FF9800'
                };
                var color = colorMap[roleDef.color] || '#e6f1ff';
                var pDiv = document.createElement('div');
                pDiv.style.padding = '8px';
                pDiv.style.borderBottom = '1px solid rgba(255,255,255,0.1)';
                pDiv.innerHTML = '<strong>' + player.name + ':</strong> <span style="color: ' + color + ';">' + roleDef.icon + ' ' + roleDef.name + '</span>';
                if (player.name === eliminatedPlayer.name) {
                    pDiv.style.textDecoration = 'line-through';
                    pDiv.style.opacity = '0.6';
                }
                rolesDiv.appendChild(pDiv);
            });
            
            document.getElementById('end-game-modal').classList.remove('hidden');
        }
        
        // --- Restart with Same Setup ---
        function restartWithSameSetup() {
            if (!savedSetup.playerCount || !savedSetup.playerNames || !savedSetup.selectedRoles) {
                alert('No saved setup found. Starting a new game instead.');
                location.reload();
                return;
            }
            
            // Close end game modal
            var endGameModal = document.getElementById('end-game-modal');
            if (endGameModal) {
                endGameModal.classList.add('hidden');
            }
            
            // Hide day screen explicitly
            var dayScreen = document.getElementById('day-screen');
            if (dayScreen) {
                dayScreen.classList.add('hidden');
            }
            
            // Restore setup
            playerCount = savedSetup.playerCount;
            selectedRoles = savedSetup.selectedRoles.slice();
            
            // Get player names from saved setup
            var names = savedSetup.playerNames.slice();
            
            // Reset game state
            players = [];
            playerActions = {};
            actionResults = {};
            eliminatedPlayer = null;
            currentDistIndex = 0;
            currentResultIndex = 0;
            currentCriticalResultIndex = 0;
            criticalResultsPlayers = [];
            
            // Shuffle selected roles
            var rolesToAssign = selectedRoles.slice();
            shuffleArray(rolesToAssign);
            
            // Deal to players
            for (var i = 0; i < playerCount; i++) {
                players.push({
                    name: names[i],
                    initialRole: rolesToAssign[i],
                    currentRole: rolesToAssign[i], // Will change after swaps
                    actionCompleted: false
                });
            }
            
            // Remaining cards go to center
            centerCards = [];
            for (var i = playerCount; i < rolesToAssign.length; i++) {
                if (rolesToAssign[i]) {
                    centerCards.push(rolesToAssign[i]);
                }
            }
            
            shuffleArray(centerCards);

            // Set up special role knowledge (Masons, Minion, Werewolves)
            setupSpecialKnowledge();
            
            // Check if immediate results is enabled - if so, randomize the distribution order
            var immediateResults = document.getElementById('show-results-immediately').checked;
            if (immediateResults) {
                // Create a shuffled order for player distribution
                distributionOrder = [];
                for (var i = 0; i < playerCount; i++) {
                    distributionOrder.push(i);
                }
                shuffleArray(distributionOrder);
            } else {
                // Sequential order
                distributionOrder = [];
                for (var i = 0; i < playerCount; i++) {
                    distributionOrder.push(i);
                }
            }
            
            // Go directly to distribution screen
            currentDistIndex = 0;
            document.getElementById('dist-total-players').innerText = playerCount;
            
            // Reset distribution screen views
            var distPassView = document.getElementById('dist-pass-view');
            var distRevealView = document.getElementById('dist-reveal-view');
            if (distPassView) {
                distPassView.classList.remove('hidden');
            }
            if (distRevealView) {
                distRevealView.classList.add('hidden');
            }
            
            showScreen('distribution-screen');
            updateDistScreen();
        }
        
        // --- Restart with New Setup (go to role selection) ---
        function restartWithNewSetup() {
            if (!savedSetup.playerCount || !savedSetup.playerNames) {
                alert('No saved setup found. Starting a new game instead.');
                location.reload();
                return;
            }
            
            // Close end game modal
            document.getElementById('end-game-modal').classList.add('hidden');
            
            // Hide day screen explicitly
            var dayScreen = document.getElementById('day-screen');
            if (dayScreen) {
                dayScreen.classList.add('hidden');
            }
            
            // Restore player count and names
            playerCount = savedSetup.playerCount;
            
            // Update player count display
            document.getElementById('player-count-display').innerText = playerCount;
            renderPlayerInputs();
            
            // Restore player names in inputs
            var inputs = document.querySelectorAll('.player-input');
            for (var i = 0; i < inputs.length && i < savedSetup.playerNames.length; i++) {
                inputs[i].value = savedSetup.playerNames[i];
            }
            
            // Reset game state
            players = [];
            playerActions = {};
            actionResults = {};
            eliminatedPlayer = null;
            currentDistIndex = 0;
            currentResultIndex = 0;
            currentCriticalResultIndex = 0;
            criticalResultsPlayers = [];
            
            // Reset selected roles (user will choose new ones)
            selectedRoles = [];
            
            // Go to role selection screen
            showScreen('role-selection-screen');
            renderRoleSelection();
        }

        function showScreen(id) {
            var screens = ['setup-screen', 'role-selection-screen', 'distribution-screen', 'results-screen', 'immediate-results-screen', 'day-screen'];
            screens.forEach(s => {
                var el = document.getElementById(s);
                if (el) el.classList.add('hidden');
            });
            var target = document.getElementById(id);
            if (target) target.classList.remove('hidden');
        }

        function shuffleArray(array) {
            for (var i = array.length - 1; i > 0; i--) {
                var j = Math.floor(Math.random() * (i + 1));
                var temp = array[i];
                array[i] = array[j];
                array[j] = temp;
            }
        }
    </script>
</body>
</html>

