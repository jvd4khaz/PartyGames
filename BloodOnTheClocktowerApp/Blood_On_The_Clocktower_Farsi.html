<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ุฎูู ุจุฑ ุจุฑุฌ ุณุงุนุช - ุงูพูฺฉุดู ูุตูโฺฏู</title>
    <style>
        :root {
            --bg-color: #0a192f;
            --card-bg: #112240;
            --text-primary: #e6f1ff;
            --text-secondary: #8892b0;
            --accent-color: #b71c1c;
            --townsfolk-color: #0277bd; /* Regular Blue */
            --outsider-color: #00bcd4; /* Cyan/Light Blue - Distinct from Townsfolk */
            --minion-color: #e65100;
            --demon-color: #d50000;
            --good-color: #4CAF50;
            --evil-color: #F44336;
            --btn-color: #b71c1c;
            --btn-text: #ffffff;
            --border-radius: 8px;
            --night-bg: #1a1a2e;
            --day-bg: #16213e;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Segoe UI', 'Tahoma', 'Arial', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            overflow-x: hidden;
            user-select: none;
        }

        .container {
            width: 95%;
            max-width: 600px;
            padding: 20px;
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            margin: 20px 0;
            text-align: center;
            transition: transform 0.3s ease;
        }

        h1 { font-size: 1.8rem; margin-bottom: 0.5rem; color: var(--accent-color); font-weight: 900; }
        h2 { font-size: 1.2rem; margin: 10px 0; color: var(--text-secondary); }
        p { font-size: 1rem; color: var(--text-secondary); margin-bottom: 1rem; line-height: 1.5; }

        .setup-info {
            background: rgba(255,255,255,0.05);
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: left;
            font-size: 0.9rem;
            line-height: 1.6;
        }

        .input-group { margin-bottom: 10px; text-align: left; }
        .input-group label { display: block; margin-bottom: 5px; color: var(--text-secondary); font-size: 0.9rem; }
        
        .player-input {
            width: 100%;
            padding: 12px;
            background-color: #233554;
            border: 1px solid #303C55;
            border-radius: 4px;
            color: var(--text-primary);
            font-size: 1rem;
            text-align: center;
        }
        .player-input:focus { outline: 1px solid var(--accent-color); }

        .action-btn {
            background-color: var(--btn-color);
            color: var(--btn-text);
            border: none;
            padding: 14px 20px;
            font-size: 1rem;
            font-weight: bold;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            margin-top: 15px;
            transition: transform 0.1s;
        }
        .action-btn:active { transform: scale(0.98); }
        
        .secondary-btn {
            background-color: transparent;
            color: var(--accent-color);
            border: 1px solid var(--accent-color);
            padding: 10px 15px;
            font-size: 0.9rem;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
            width: 100%;
        }

        .player-select-btn {
            background: linear-gradient(135deg, rgba(183, 28, 28, 0.2) 0%, rgba(183, 28, 28, 0.1) 100%);
            color: var(--accent-color);
            border: 3px solid var(--accent-color);
            padding: 18px 24px;
            font-size: 1.2rem;
            font-weight: bold;
            border-radius: 12px;
            cursor: pointer;
            width: 100%;
            margin: 12px 0;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(183, 28, 28, 0.2);
            text-align: center;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .player-select-btn:hover {
            background: linear-gradient(135deg, rgba(183, 28, 28, 0.3) 0%, rgba(183, 28, 28, 0.2) 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(183, 28, 28, 0.4);
        }
        .player-select-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 10px rgba(183, 28, 28, 0.3);
        }
        .player-select-btn.dead {
            opacity: 0.5;
            border-color: #666;
        }

        .hidden { display: none !important; }

        /* Role Card */
        .role-card {
            background: rgba(0,0,0,0.2);
            padding: 20px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.1);
            margin: 20px 0;
        }
        .role-title { 
            font-size: 2rem; 
            font-weight: 900; 
            margin-bottom: 10px; 
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .role-townsfolk { 
            color: var(--townsfolk-color); 
            text-shadow: 0 0 10px rgba(2, 119, 189, 0.5);
        }
        .role-outsider { 
            color: var(--outsider-color); 
            text-shadow: 0 0 10px rgba(25, 118, 210, 0.5);
        }
        .role-minion { 
            color: var(--minion-color); 
            text-shadow: 0 0 10px rgba(230, 81, 0, 0.5);
        }
        .role-demon { 
            color: var(--demon-color); 
            text-shadow: 0 0 10px rgba(213, 0, 0, 0.5);
        }

        @keyframes popIn {
            from { opacity: 0; transform: scale(0.5); }
            to { opacity: 1; transform: scale(1); }
        }

        /* Game Status */
        .game-status {
            display: none; /* Hidden - redundant info shown in day phase stat cards */
            justify-content: space-around;
            margin: 20px 0;
            padding: 15px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
        }
        .status-item {
            text-align: center;
        }
        .status-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }
        .status-value {
            font-size: 1.5rem;
            font-weight: bold;
        }

        /* Phase Display */
        .phase-display {
            margin: 20px 0;
            padding: 15px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
        }
        .phase-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--accent-color);
            margin-bottom: 10px;
        }
        .phase-night {
            background: var(--night-bg);
            border: 2px solid #2a2a3e;
        }
        .phase-day {
            background: var(--day-bg);
            border: 2px solid #1e3a5f;
        }

        /* Grimoire View */
        .grimoire-view {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin: 20px 0;
            padding: 15px;
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
        }
        .grimoire-token {
            padding: 10px;
            background: rgba(255,255,255,0.1);
            border: 2px solid #444;
            border-radius: 8px;
            text-align: center;
            font-size: 0.85rem;
        }
        .grimoire-token.dead {
            opacity: 0.5;
            border-color: #666;
        }
        .grimoire-token.townsfolk { border-left: 4px solid var(--townsfolk-color); }
        .grimoire-token.outsider { border-left: 4px solid var(--outsider-color); }
        .grimoire-token.minion { border-left: 4px solid var(--minion-color); }
        .grimoire-token.demon { border-left: 4px solid var(--demon-color); }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 25, 47, 0.98);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            pointer-events: auto;
            overflow-y: auto;
        }
        .modal-overlay.hidden {
            display: none;
        }

        /* Character Ability Info */
        .ability-info {
            background: rgba(255,255,255,0.05);
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: left;
            font-size: 0.9rem;
        }

        /* Log */
        .log-entry {
            font-size: 0.85rem;
            text-align: left;
            border-bottom: 1px solid #233554;
            padding: 5px 0;
            color: #8892b0;
        }

        /* Saved Players */
        .saved-list-container {
            margin-top: 15px;
            padding: 10px;
            background: rgba(255,255,255,0.03);
            border-radius: 8px;
            min-height: 40px;
        }
        .saved-list-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        /* Cheat Sheet Styles */
        .cheat-sheet-container {
            padding: 10px;
            direction: rtl;
        }
        .cheat-sheet-section {
            margin-bottom: 20px;
            border-radius: 8px;
            padding: 10px;
            background: rgba(255,255,255,0.05);
        }
        .cheat-sheet-header {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 10px;
            text-align: center;
            padding-bottom: 5px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .cs-townsfolk-header { color: var(--townsfolk-color); }
        .cs-outsider-header { color: var(--outsider-color); }
        .cs-minion-header { color: var(--minion-color); }
        .cs-demon-header { color: var(--demon-color); }
        
        .cheat-sheet-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 10px;
        }
        .cheat-sheet-card {
            background: rgba(255,255,255,0.1);
            border: 1px solid #444;
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            font-size: 0.8rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100%;
            transition: transform 0.2s;
        }
        .cheat-sheet-card:hover { transform: scale(1.02); }
        .cs-icon { font-size: 2rem; margin-bottom: 5px; }
        .cs-name { font-weight: bold; margin-bottom: 5px; color: var(--text-primary); font-size: 0.9rem; }
        .cs-rebus { font-size: 0.75rem; color: #aaa; line-height: 1.3; direction: rtl; }
        
        .role-townsfolk .cs-name { color: var(--townsfolk-color); }
        .role-outsider .cs-name { color: var(--outsider-color); }
        .role-minion .cs-name { color: var(--minion-color); }
        .role-demon .cs-name { color: var(--demon-color); }
        
        .win-conditions {
            margin-top: 20px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .win-card {
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .win-good { background: rgba(76, 175, 80, 0.2); border: 1px solid var(--good-color); }
        .win-evil { background: rgba(244, 67, 54, 0.2); border: 1px solid var(--evil-color); }

        @media print {
            body { background: white; color: black; }
            .container, .modal-overlay { 
                width: 100%; max-width: 100%; position: static; 
                background: white; color: black; box-shadow: none; border: none;
                display: block !important;
                padding: 0; margin: 0;
            }
            /* Hide everything except the cheat sheet content */
            body > * { display: none; }
            #cheat-sheet-modal { display: block !important; }
            
            /* Hide buttons in cheat sheet */
            .action-btn, .secondary-btn, #cheat-sheet-close-btn, #cheat-sheet-print-btn { display: none !important; }
            
            .cheat-sheet-container { padding: 0; }
            .cheat-sheet-section {
                background: transparent !important;
                border: 1px solid #ccc;
                margin-bottom: 15px;
                page-break-inside: avoid;
            }
            .cheat-sheet-header {
                color: black !important;
                border-bottom: 1px solid #000;
            }
            
            /* Grid adjustments for print */
            .cheat-sheet-grid {
                grid-template-columns: repeat(4, 1fr);
                gap: 8px;
            }
            .cheat-sheet-card {
                border: 1px solid #ccc;
                color: black;
                background: transparent !important;
                break-inside: avoid;
                box-shadow: none;
            }
            .cs-name { color: black !important; }
            .cs-rebus { color: #333 !important; }
            
            /* Use borders or subtle backgrounds to distinguish types in print if color is not available, 
               but we assume color print or grayscale conversion */
            .role-townsfolk { border-top: 3px solid #0277bd; }
            .role-outsider { border-top: 3px solid #00bcd4; }
            .role-minion { border-top: 3px solid #e65100; }
            .role-demon { border-top: 3px solid #d50000; }
            
            .win-conditions {
                grid-template-columns: 1fr 1fr;
                gap: 10px;
                page-break-inside: avoid;
            }
            .win-card {
                border: 2px solid black;
                background: transparent !important;
                color: black !important;
            }
        }

        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        @keyframes pulseGlow {
            0%, 100% { box-shadow: 0 12px 32px rgba(156, 39, 176, 0.6), inset 0 2px 4px rgba(255,255,255,0.1); }
            50% { box-shadow: 0 12px 40px rgba(156, 39, 176, 0.9), inset 0 2px 4px rgba(255,255,255,0.2); }
        }
        .container, .modal-overlay > .container { 
            animation: fadeIn 0.3s ease-out; 
        }
    </style>
</head>
<body>

    <!-- 1. Setup Screen -->
    <div id="setup-screen" class="container">
        <h1>ุฎูู ุจุฑ ุจุฑุฌ ุณุงุนุช</h1>
        <p>ุงูพูฺฉุดู ูุตูโฺฏู</p>

        <div class="setup-info">
            <strong>ุฎูุงุตู ุจุงุฒ:</strong><br>
            โข ุจุงุฒ ุงุณุชูุชุงุฌ ุงุฌุชูุงุน ุจุง ููุดโูุง ูุฎู<br>
            โข ุชู ุฎูุจ ุณุน ูโฺฉูุฏ ุดุทุงู ุฑุง ุงุนุฏุงู ฺฉูุฏ<br>
            โข ุชู ุดุฑุฑ ุณุน ูโฺฉูุฏ ุชุง ููุท ฒ ุจุงุฒฺฉู ุจุงู ุจูุงูุฏ ุฒูุฏู ุจูุงูุฏ<br>
            โข ูุตูโฺฏู ูุงุฒูุง ุดุจ ู ุฑูุฒ ุฑุง ูุฏุฑุช ูโฺฉูุฏ<br>
            โข ูพุดุชุจุงู ุงุฒ ต ุชุง ฑต ุจุงุฒฺฉู (ูุณุฎู Trouble Brewing)
        </div>

        <div class="input-group">
            <label>ุชุนุฏุงุฏ ุจุงุฒฺฉูุงู:</label>
            <div style="display:flex; align-items:center; justify-content:center; gap:15px;">
                <button class="secondary-btn" style="width:40px;" onclick="updatePlayerCount(-1)">-</button>
                <span id="player-count-display" style="font-size:1.5rem; font-weight:bold;">7</span>
                <button class="secondary-btn" style="width:40px;" onclick="updatePlayerCount(1)">+</button>
            </div>
        </div>

        <div class="input-group" style="margin-top: 20px; padding: 15px; background: rgba(255, 255, 255, 0.05); border-radius: 10px;">
            <label style="display: block; margin-bottom: 10px; font-weight: bold; color: var(--accent-color);">ุณูุงุฑู (Script):</label>
            <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                <label style="cursor: pointer; padding: 5px 10px; background: rgba(0,0,0,0.2); border-radius: 5px; display: flex; align-items: center; gap: 5px;">
                    <input type="radio" name="script-select" value="trouble" checked onchange="updateScriptSelection()"> 
                    <span>ุฏุฑุฏุณุฑ ุฏุฑ ุดูุฑ (Trouble Brewing)</span>
                </label>
                <label style="cursor: pointer; padding: 5px 10px; background: rgba(0,0,0,0.2); border-radius: 5px; display: flex; align-items: center; gap: 5px;">
                    <input type="radio" name="script-select" value="teensy" onchange="updateScriptSelection()"> 
                    <span>ุชูุฒโูู (Teensyville)</span>
                </label>
                <label style="cursor: pointer; padding: 5px 10px; background: rgba(0,0,0,0.2); border-radius: 5px; display: flex; align-items: center; gap: 5px;">
                    <input type="radio" name="script-select" value="teensy-no-baron" onchange="updateScriptSelection()"> 
                    <span>ุชูุฒโูู - ุจุฏูู ุจุงุฑูู</span>
                </label>
            </div>
            <div id="script-desc" style="margin-top: 10px; font-size: 0.9rem; color: #ccc; font-style: italic;">
                ุชูุงู ุดุฎุตุชโูุง ูุณุฎู ูพุงู. ููุงุณุจ ุจุฑุง ท+ ุจุงุฒฺฉู.
            </div>
        </div>
        
        <div class="input-group" id="teensy-roles-display" style="margin-top: 10px; padding: 10px; background: rgba(2, 119, 189, 0.1); border: 1px solid rgba(2, 119, 189, 0.3); border-radius: 8px; display:none;">
            <div style="font-weight:bold; color:var(--townsfolk-color); margin-bottom:5px;">ุดุฎุตุชโูุง ุชูุฒโูู:</div>
            <div style="font-size:0.85rem; line-height:1.4; margin-bottom:8px;">
                <span style="color:var(--townsfolk-color);">ุฑุฎุชโุดูุ ุขุดูพุฒุ ูุงูโฺฏุฑุ ูุฑุฏูโุดูุ ุฑุงูุจุ ุณูุงุฎ</span><br>
                <span style="color:var(--outsider-color);">ูุณุชุ ูุฏุณ</span><br>
                <span style="color:var(--minion-color);">ุฒูุฑุขฺฏูุ ุฒู ุณุฑุฎุ ุจุงุฑูู</span><br>
                <span style="color:var(--demon-color);">ุดุทุงู</span>
            </div>
            <div id="teensy-distribution" style="font-size:0.85rem; font-weight:bold; color:var(--accent-color); border-top:1px solid rgba(2, 119, 189, 0.3); padding-top:8px; margin-top:8px;"></div>
        </div>

        <div class="input-group" id="teensy-no-baron-roles-display" style="margin-top: 10px; padding: 10px; background: rgba(2, 119, 189, 0.1); border: 1px solid rgba(2, 119, 189, 0.3); border-radius: 8px; display:none;">
            <div style="font-weight:bold; color:var(--townsfolk-color); margin-bottom:5px;">ุดุฎุตุชโูุง ุชูุฒโูู (ุจุฏูู ุจุงุฑูู):</div>
            <div style="font-size:0.85rem; line-height:1.4; margin-bottom:8px;">
                <span style="color:var(--townsfolk-color);">ุฑุฎุชโุดูุ ุขุดูพุฒุ ูุงูโฺฏุฑุ ูุฑุฏูโุดูุ ุฑุงูุจุ ุณูุงุฎ</span><br>
                <span style="color:var(--outsider-color);">ูุณุชุ ูุฏุณ</span><br>
                <span style="color:var(--minion-color);">ุฒูุฑุขฺฏูุ ุฒู ุณุฑุฎ</span><br>
                <span style="color:var(--demon-color);">ุดุทุงู</span>
            </div>
            <div id="teensy-no-baron-distribution" style="font-size:0.85rem; font-weight:bold; color:var(--accent-color); border-top:1px solid rgba(2, 119, 189, 0.3); padding-top:8px; margin-top:8px;"></div>
        </div>

        <div id="player-inputs-container" style="margin-top:20px;"></div>
        
        <!-- Saved Players List -->
        <div class="saved-list-container">
            <div class="saved-list-label">ูุงูโูุง ุฐุฎุฑู ุดุฏู (ุจุฑุง ูพุฑ ฺฉุฑุฏู ุถุฑุจู ุจุฒูุฏ):</div>
            <div id="saved-list" style="text-align: center;"></div>
        </div>

        <button class="action-btn" onclick="startRoleDistribution()">ุดุฑูุน ุจุงุฒ</button>
        <div style="display:flex; gap:10px; margin-top:10px;">
            <button class="secondary-btn" onclick="showPlayerGuide()" style="background-color: rgba(183, 28, 28, 0.2); font-weight: bold;">๐ ุฑุงูููุง ุจุงุฒฺฉู</button>
            <button class="secondary-btn" onclick="showCheatSheet()" style="background-color: rgba(183, 28, 28, 0.2); font-weight: bold;">๐ ุฎูุงุตู ููุดโูุง</button>
        </div>
    </div>

    <!-- 2. Role Distribution Phase -->
    <div id="distribution-screen" class="container hidden">
        <div id="dist-pass-view">
            <p>ุฏุณุชฺฏุงู ุฑุง ุจู ุงู ุจุงุฒฺฉู ุจุฏูุฏ:</p>
            <h2 id="dist-player-name" style="font-size:2rem; color:var(--accent-color);">ูุงู ุจุงุฒฺฉู</h2>
            <div style="font-size:4rem; margin:20px;">๐ฑ</div>
            <p>ุจุงุฒฺฉู <span id="dist-player-num">1</span> ุงุฒ <span id="dist-total-players">7</span></p>
            <button class="action-btn" onclick="revealRole()">ููุงุด ููุด</button>
        </div>

        <div id="dist-reveal-view" class="hidden">
            <h2 id="reveal-name-header">ูุงู ุจุงุฒฺฉู</h2>
            <div class="role-card">
                <div id="role-title" class="role-title">ููุด</div>
                <div id="role-desc" style="font-size:0.95rem; margin-bottom:10px; color:#ddd;"></div>
                <div id="role-extra" style="font-size:0.9rem; color:#ffd700;"></div>
            </div>
            
            <!-- Night 1 Action/Info Area -->
            <div id="dist-night-action" style="margin: 15px 0; padding: 10px; border: 1px solid #444; border-radius: 8px; background: rgba(0,0,0,0.2); display:none;"></div>
            
            <p style="font-size:0.8rem; color:#666;">ููุด ุฎูุฏ ุฑุง ุจู ุฎุงุทุฑ ุจุณูพุงุฑุฏ ู ูุฎู ฺฉูุฏ.</p>
            <button id="next-dist-btn" class="action-btn" onclick="nextDistribute()">ูุฎู ฺฉุฑุฏู ู ุจุนุฏ</button>
        </div>
    </div>

    <!-- 3. Main Game Screen -->
    <div id="game-screen" class="container hidden">
        <h1>ุฎูู ุจุฑ ุจุฑุฌ ุณุงุนุช</h1>
        
        <!-- Game Status -->
        <div class="game-status">
            <div class="status-item">
                <div class="status-label">ุฒูุฏู</div>
                <div class="status-value" id="living-count">7</div>
            </div>
            <div class="status-item">
                <div class="status-label">ุฑูุฒ</div>
                <div class="status-value" id="current-day">1</div>
            </div>
            <div class="status-item">
                <div class="status-label">ุงุนุฏุงูโูุง</div>
                <div class="status-value" id="execution-count">0</div>
            </div>
        </div>

        <!-- Phase Display -->
        <div id="phase-display" class="phase-display">
            <div id="phase-title" class="phase-title"></div>
            <div id="phase-content"></div>
        </div>

        <!-- Action Buttons -->
        <div id="action-buttons" style="margin-top: 20px;"></div>

        <!-- Grimoire View (Storyteller Only) -->
        <div style="display:flex; gap:10px; margin-top:10px;">
            <button class="secondary-btn" onclick="showPlayerGuide()" style="background-color: rgba(183, 28, 28, 0.2); font-weight: bold;">๐ ุฑุงูููุง ุจุงุฒฺฉู</button>
            <button class="secondary-btn" onclick="showCheatSheet()" style="background-color: rgba(183, 28, 28, 0.2); font-weight: bold;">๐ ุฎูุงุตู ููุดโูุง</button>
        </div>
        <div id="grimoire-view" class="grimoire-view hidden"></div>

        <!-- Game Log -->
        <button class="secondary-btn" onclick="toggleLog()" style="margin-top: 10px;">Toggle Game Log</button>
        <div id="game-log" class="hidden" style="margin-top: 15px; max-height: 200px; overflow-y: auto; text-align: left; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px;">
            <div id="log-content"></div>
        </div>

        <!-- End Game Modal -->
        <div id="end-game-modal" class="modal-overlay hidden">
            <div class="container" style="max-width:500px; border: 2px solid var(--accent-color);">
                <h1 id="end-game-title" style="margin-bottom: 20px;">ูพุงุงู ุจุงุฒ</h1>
                <p id="end-game-message" style="font-size: 1.2rem; margin-bottom: 30px;"></p>
                <button class="action-btn" onclick="location.reload()">ุจุงุฒ ุฌุฏุฏ</button>
            </div>
        </div>
    </div>

    <!-- Night Phase Modal -->
    <div id="night-modal" class="modal-overlay hidden">
        <div class="container" style="max-width:500px;">
            <!-- Confirmation View -->
            <div id="night-confirm-view">
                <p>ุฏุณุชฺฏุงู ุฑุง ุจู ุงู ุจุงุฒฺฉู ุจุฏูุฏ:</p>
                <h2 id="night-player-name" style="font-size:2rem; color:var(--accent-color);">ูุงู ุจุงุฒฺฉู</h2>
                <div style="font-size:4rem; margin:20px;">๐ฑ</div>
                <p id="night-character-hint" style="font-size:0.9rem; color:var(--text-secondary);"></p>
                <button class="action-btn" onclick="confirmNightPlayer()">ูู ุงู ุจุงุฒฺฉู ูุณุชู</button>
            </div>
            
            <!-- Character Action View -->
            <div id="night-action-view" class="hidden">
                <h2 id="night-character-name"></h2>
                <div id="night-character-info" class="ability-info"></div>
                <div id="night-character-actions"></div>
                <button class="secondary-btn" onclick="skipNightAbility()">ุฑุฏ ฺฉุฑุฏู (ุฏุฑ ุจุงุฒ ูุณุช)</button>
            </div>
        </div>
    </div>

    <!-- Player Guide Modal -->
    <div id="guide-modal" class="modal-overlay hidden">
        <div class="container" style="max-width:700px; max-height:90vh; overflow-y:auto;">
            <h1 style="margin-bottom: 20px;">ุฑุงูููุง ุจุงุฒฺฉู</h1>
            <div id="guide-content" style="text-align: right; line-height: 1.8;"></div>
            <button class="action-btn" onclick="closePlayerGuide()" style="margin-top: 20px;">ุจุณุชู</button>
        </div>
    </div>

    <!-- Day Phase - Execution Modal -->
    <div id="nomination-modal" class="modal-overlay hidden">
        <div class="container" style="max-width:500px;">
            <h2>Execution</h2>
            <p id="nomination-text" style="margin: 15px 0;"></p>
            <div id="nomination-votes" style="margin: 20px 0;"></div>
            <button class="secondary-btn" onclick="closeNomination()">Cancel</button>
        </div>
    </div>

    <!-- Information Display Modal -->
    <div id="info-modal" class="modal-overlay hidden">
        <div class="container" style="max-width:500px; border: 2px solid var(--townsfolk-color);">
            <h2 id="info-character-name" style="color: var(--townsfolk-color);"></h2>
            <p style="margin: 15px 0; color: var(--text-secondary);">ุฏุณุชฺฏุงู ุฑุง ุจู ุงู ุจุงุฒฺฉู ุจุฏูุฏ:</p>
            <h3 id="info-player-name" style="font-size: 1.5rem; color: var(--accent-color); margin: 20px 0;"></h3>
            <div style="background: rgba(2, 119, 189, 0.2); border: 2px solid var(--townsfolk-color); border-radius: 8px; padding: 20px; margin: 20px 0;">
                <p style="font-size: 1.1rem; font-weight: bold; margin-bottom: 10px;">ุงุทูุงุนุงุช ุดูุง:</p>
                <p id="info-text" style="font-size: 1.2rem; color: var(--text-primary); line-height: 1.6;"></p>
            </div>
            <p style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 15px;">ุงู ุงุทูุงุนุงุช ุฑุง ุจู ุฎุงุทุฑ ุจุณูพุงุฑุฏ ู ูุฎู ฺฉูุฏ.</p>
            <button class="action-btn" onclick="closeInfoModal()">ูุฎู ฺฉุฑุฏู ู ุงุฏุงูู</button>
        </div>
    </div>

    <!-- Slayer Result Modal -->
    <div id="slayer-result-modal" class="modal-overlay hidden">
        <div class="container" style="max-width:500px;">
            <h2>ูุชุฌู ุณูุงุฎ</h2>
            <div id="slayer-result-content" style="margin: 20px 0; padding: 20px; border-radius: 8px; text-align: center;"></div>
            <button class="action-btn" onclick="closeSlayerResult()">ุงุฏุงูู</button>
        </div>
    </div>

    <!-- Spy Grimoire Modal -->
    <div id="spy-grimoire-modal" class="modal-overlay hidden">
        <div class="container" style="max-width:800px; max-height:90vh; overflow-y:auto;">
            <div id="spy-grimoire-content"></div>
        </div>
    </div>

    <!-- Cheat Sheet Modal -->
    <div id="cheat-sheet-modal" class="modal-overlay hidden">
        <div class="container" style="max-width:900px; max-height:95vh; overflow-y:auto;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h1 style="margin:0; font-size:1.5rem;">ุฎูุงุตู ููุดโูุง</h1>
                <div>
                    <button id="cheat-sheet-print-btn" class="secondary-btn" style="width:auto; padding:5px 15px; margin:0; margin-right:10px;" onclick="window.print()">๐จ๏ธ ฺุงูพ</button>
                    <button id="cheat-sheet-close-btn" class="secondary-btn" style="width:auto; padding:5px 15px; margin:0;" onclick="closeCheatSheet()">โ</button>
                </div>
            </div>
            <div id="cheat-sheet-content" class="cheat-sheet-grid"></div>
        </div>
    </div>

    <script>
        // --- Character Distribution by Player Count ---
        var CHARACTER_DISTRIBUTION = {
            5: { townsfolk: 3, outsiders: 0, minions: 1, demon: 1 },
            6: { townsfolk: 3, outsiders: 1, minions: 1, demon: 1 },
            7: { townsfolk: 5, outsiders: 0, minions: 1, demon: 1 },
            8: { townsfolk: 5, outsiders: 1, minions: 1, demon: 1 },
            9: { townsfolk: 5, outsiders: 2, minions: 1, demon: 1 },
            10: { townsfolk: 7, outsiders: 0, minions: 2, demon: 1 },
            11: { townsfolk: 7, outsiders: 1, minions: 2, demon: 1 },
            12: { townsfolk: 7, outsiders: 2, minions: 2, demon: 1 },
            13: { townsfolk: 9, outsiders: 0, minions: 3, demon: 1 },
            14: { townsfolk: 9, outsiders: 1, minions: 3, demon: 1 },
            15: { townsfolk: 9, outsiders: 2, minions: 3, demon: 1 }
        };

        // --- Character Definitions (Trouble Brewing) ---
        var CHARACTERS = {
            // Townsfolk
            'Washerwoman': { name: 'ุฑุฎุชโุดู', type: 'townsfolk', ability: 'ุฏุฑ ุดุจ ุงููุ ูุชูุฌู ูโุดูุฏ ฺฉู ฺฉ ุงุฒ ุฏู ุจุงุฒฺฉู ูุดุฎุตุ ฺฉ ุดุฎุตุช ุดูุฑููุฏ ุฎุงุต ุงุณุช. ุฏุงุณุชุงูโฺฏู ุงูุชุฎุงุจ ูโฺฉูุฏ ฺฉุฏุงู ุงุทูุงุนุงุช ุฑุง ุจู ุดูุง ุจุฏูุฏ.', nightOrder: 1 },
            'Librarian': { name: 'ฺฉุชุงุจุฏุงุฑ', type: 'townsfolk', ability: 'ุฏุฑ ุดุจ ุงููุ ูุชูุฌู ูโุดูุฏ ฺฉู ฺฉ ุงุฒ ุฏู ุจุงุฒฺฉู ูุดุฎุตุ ฺฉ ุดุฎุตุช ุบุฑุจู ุฎุงุต ุงุณุช. ุฏุงุณุชุงูโฺฏู ุงูุชุฎุงุจ ูโฺฉูุฏ ฺฉุฏุงู ุงุทูุงุนุงุช ุฑุง ุจู ุดูุง ุจุฏูุฏ.', nightOrder: 2 },
            'Investigator': { name: 'ุจุงุฒูพุฑุณ', type: 'townsfolk', ability: 'ุฏุฑ ุดุจ ุงููุ ูุชูุฌู ูโุดูุฏ ฺฉู ฺฉ ุงุฒ ุฏู ุจุงุฒฺฉู ูุดุฎุตุ ฺฉ ุดุฎุตุช ุฎุงุฏู ุดุทุงู ุฎุงุต ุงุณุช. ุฏุงุณุชุงูโฺฏู ุงูุชุฎุงุจ ูโฺฉูุฏ ฺฉุฏุงู ุงุทูุงุนุงุช ุฑุง ุจู ุดูุง ุจุฏูุฏ.', nightOrder: 3 },
            'Chef': { name: 'ุขุดูพุฒ', type: 'townsfolk', ability: 'ุฏุฑ ุดุจ ุงููุ ูุชูุฌู ูโุดูุฏ ฺูุฏ ุฌูุช ุจุงุฒฺฉู ุดุฑุฑ ฺฉูุงุฑ ูู ูุดุณุชูโุงูุฏ. ุงู ุชุนุฏุงุฏ ุฌูุชโูุง ุฑุง ูโุดูุงุฑุฏุ ูู ุงูุฑุงุฏ ุฑุง.', nightOrder: 4 },
            'Empath': { name: 'ููโุฏู', type: 'townsfolk', ability: 'ูุฑ ุดุจุ ูุชูุฌู ูโุดูุฏ ฺูุฏ ุจุงุฒฺฉู ุดุฑุฑ ุฏุฑ ฺฉูุงุฑ ุดูุง ูุดุณุชูโุงูุฏ (ฺฉ ุง ูุฑ ุฏู ููุณุงู). ุงฺฏุฑ ูุฑุฏู ุจุงุดุฏุ ุนุฏุฏ ุตูุฑ ุฑุง ุฏุฑุงูุช ูโฺฉูุฏ.', nightOrder: 5 },
            'Fortune Teller': { name: 'ูุงูโฺฏุฑ', type: 'townsfolk', ability: 'ูุฑ ุดุจุ ุฏู ุจุงุฒฺฉู ุฑุง ุงูุชุฎุงุจ ูโฺฉูุฏ ู ูุชูุฌู ูโุดูุฏ ุขุง ฺฉ ุงุฒ ุขููุง ุดุทุงู ุงุณุช ุง ุฎุฑ (ุจูู/ุฎุฑ). ุฏุฑ ุดุจ ุงููุ ฺฉ ุจุงุฒฺฉู ุฎูุจ ุจู ุนููุงู "ูุดุงูู ฺฉุงุฐุจ" ุชุนู ูโุดูุฏ ฺฉู ููุดู "ุจูู" ุฏุฑุงูุช ูโฺฉูุฏ.', nightOrder: 6 },
            'Undertaker': { name: 'ูุฑุฏูโุดู', type: 'townsfolk', ability: 'ูุฑ ุฑูุฒุ ุงฺฏุฑ ฺฉุณ ุฏุฑ ุฑูุฒ ูุจู ุงุนุฏุงู ุดุฏู ุจุงุดุฏุ ุดุฎุตุช ุงู ุฑุง ูโูููุฏ. ุงู ุชูุงูุง ููุท ุฏุฑ ุตูุฑุช ุงุนุฏุงู ุดุฏู ฺฉุณ ุฏุฑ ุฑูุฒ ูุจู ูุนุงู ูโุดูุฏ.', nightOrder: 7 },
            'Monk': { name: 'ุฑุงูุจ', type: 'townsfolk', ability: 'ูุฑ ุดุจุ ฺฉ ุจุงุฒฺฉู ุฑุง ุงูุชุฎุงุจ ูโฺฉูุฏ ู ุขููุง ุฏุฑ ุขู ุดุจ ููโุชูุงููุฏ ุจูุฑูุฏ. ุงู ูุญุงูุธุช ุชุง ุฑูุฒ ุจุนุฏ ุงุฏุงูู ุฏุงุฑุฏ.', nightOrder: 8 },
            'Ravenkeeper': { name: 'ูฺฏูุจุงู ุฒุงุบ', type: 'townsfolk', ability: 'ุงฺฏุฑ ุฏุฑ ุดุจ ุจูุฑุฏุ ฺฉ ุจุงุฒฺฉู ุฑุง ุงูุชุฎุงุจ ูโฺฉูุฏ ู ุดุฎุตุช ุงู ุฑุง ูโูููุฏ. ุงู ุชูุงูุง ููุท ุฏุฑ ุตูุฑุช ูุฑฺฏ ุฏุฑ ุดุจ ูุนุงู ูโุดูุฏ.', nightOrder: 9 },
            'Virgin': { name: 'ุจุงฺฉุฑู', type: 'townsfolk', ability: 'ุงููู ุจุงุฑ ฺฉู ูุงูุฒุฏ ุงุนุฏุงู ูโุดูุฏุ ุงฺฏุฑ ูุงูุฒุฏฺฉููุฏู ุดูุง ฺฉ ุดูุฑููุฏ ุจุงุดุฏุ ุจู ุฌุง ุดูุง ุงุนุฏุงู ูโุดูุฏ. ุงู ุชูุงูุง ููุท ฺฉ ุจุงุฑ ุฏุฑ ุจุงุฒ ฺฉุงุฑ ูโฺฉูุฏ.', nightOrder: 10 },
            'Slayer': { name: 'ุณูุงุฎ', type: 'townsfolk', ability: 'ฺฉ ุจุงุฑ ุฏุฑ ุทูู ุจุงุฒุ ุฏุฑ ุทูู ุฑูุฒ ูโุชูุงูุฏ ฺฉ ุจุงุฒฺฉู ุฑุง ุงูุชุฎุงุจ ฺฉูุฏ. ุงฺฏุฑ ุขููุง ุดุทุงู ุจุงุดูุฏุ ููุฑุงู ูโูุฑูุฏ. ุงู ุชูุงูุง ุฏุฑ ูุฑ ุฑูุฒ ูุงุจู ุงุณุชูุงุฏู ุงุณุช.', nightOrder: 11 },
            'Soldier': { name: 'ุณุฑุจุงุฒ', type: 'townsfolk', ability: 'ุดูุง ููโุชูุงูุฏ ุฏุฑ ุดุจ ุจูุฑุฏ. ุงูุง ููฺูุงู ุฏุฑ ุจุฑุงุจุฑ ุงุนุฏุงู ุขุณุจโูพุฐุฑ ูุณุชุฏ.', nightOrder: 12 },
            'Mayor': { name: 'ุดูุฑุฏุงุฑ', type: 'townsfolk', ability: 'ุงฺฏุฑ ููุท ณ ุจุงุฒฺฉู ุฒูุฏู ุจุงู ุจูุงูุฏ (ุดุงูู ุดูุง) ู ุดูุง ุจูุฑุฏุ ุจู ุฌุง ุดุฑุฑุ ุชู ุฎูุจ ุจุฑูุฏู ูโุดูุฏ. ุงู ฺฉ ุดุฑุท ุจุฑุฏ ุฎุงุต ุงุณุช.', nightOrder: 13 },
            
            // Outsiders
            'Butler': { name: 'ูพุดุฎุฏูุช', type: 'outsider', ability: 'ูุฑ ุดุจุ ฺฉ ุจุงุฒฺฉู ุฑุง ุงูุชุฎุงุจ ูโฺฉูุฏ. ูุฑุฏุงุ ุจุงุฏ ุฏููุงู ููุงูโุทูุฑ ฺฉู ุขููุง ุฑุง ูโุฏููุฏ ุฑุง ุฏูุฏ. ุดูุง ููโุชูุงูุฏ ูุชูุงูุช ุงุฒ ุจุงุฒฺฉู ุงูุชุฎุงุจโุดุฏู ุฑุง ุฏูุฏ.', nightOrder: 14 },
            'Drunk': { name: 'ูุณุช', type: 'outsider', ability: 'ุดูุง ูฺฉุฑ ูโฺฉูุฏ ฺฉ ุดูุฑููุฏ ูุณุชุฏุ ุงูุง ุฏุฑ ูุงูุน ฺฉ ุบุฑุจู ูุณุชุฏ. ุชูุงูุง ุดูุง ฺฉุงุฑ ููโฺฉูุฏ ู ุงุทูุงุนุงุช ุฏุฑุงูุช ููโฺฉูุฏ.', nightOrder: 15 },
            'Recluse': { name: 'ฺฏูุดูโูุดู', type: 'outsider', ability: 'ุดูุง ููฺฉู ุงุณุช ุจู ุนููุงู ุดุฑุฑ ุง ุญุช ุดุทุงู ุจุฑุง ุณุงุฑ ุชูุงูุงโูุง ุธุงูุฑ ุดูุฏุ ุญุช ุงฺฏุฑ ูุฑุฏู ุจุงุดุฏ. ุฏุงุณุชุงูโฺฏู ูโุชูุงูุฏ ุดูุง ุฑุง ุจู ุนููุงู ุดุฑุฑ ูุดุงู ุฏูุฏ. ุดูุง ููฺูุงู ุฏุฑ ุชู ุฎูุจ ูุณุชุฏ.', nightOrder: 16 },
            'Saint': { name: 'ูุฏุณ', type: 'outsider', ability: 'ุงฺฏุฑ ุดูุง ุงุนุฏุงู ุดูุฏุ ุชู ุดุฑุฑ ููุฑุงู ุจุฑูุฏู ูโุดูุฏ. ุชู ุฎูุจ ุจุงุฏ ุงุฒ ุงุนุฏุงู ุดูุง ุงุฌุชูุงุจ ฺฉูุฏ.', nightOrder: 17 },
            
            // Minions
            'Poisoner': { name: 'ุฒูุฑุขฺฏู', type: 'minion', ability: 'ูุฑ ุดุจุ ฺฉ ุจุงุฒฺฉู ุฑุง ุงูุชุฎุงุจ ูโฺฉูุฏ ู ุชูุงูุง ุขููุง ุฎุฑุงุจ ูโุดูุฏ. ุขููุง ุงุทูุงุนุงุช ูุงุฏุฑุณุช ุฏุฑุงูุช ูโฺฉููุฏ ุง ุชูุงูุงโุดุงู ฺฉุงุฑ ููโฺฉูุฏ. ุงู ุงุซุฑ ุชุง ุดุจ ุจุนุฏ ุงุฏุงูู ุฏุงุฑุฏ.', nightOrder: 18 },
            'Spy': { name: 'ุฌุงุณูุณ', type: 'minion', ability: 'ุดูุง ุจุฑุง ููู ุชูุงูุงโูุง ุจู ุนููุงู ุจุงุฒฺฉู ุฎูุจ ุธุงูุฑ ูโุดูุฏ. ูโุชูุงูุฏ ุฏูุชุฑฺู ุจุงุฒ ุฑุง ุจุจูุฏ ู ูโุฏุงูุฏ ุดุทุงู ฺฉุณุช.', nightOrder: 19 },
            'Scarlet Woman': { name: 'ุฒู ุณุฑุฎ', type: 'minion', ability: 'ุงฺฏุฑ ุดุทุงู ุจูุฑุฏ ู ต ุง ุจุดุชุฑ ุจุงุฒฺฉู ุฒูุฏู ุจุงุดูุฏ (ูุจู ุงุฒ ูุฑฺฏ ุดุทุงู)ุ ุดูุง ููุฑุงู ุชุจุฏู ุจู ุดุทุงู ูโุดูุฏ. ุงู ุชุจุฏู ุจูุงูุงุตูู ุจุนุฏ ุงุฒ ูุฑฺฏ ุดุทุงู ุงุชูุงู ูโุงูุชุฏ ู ุดูุง ููฺูุงู ุชูุงูุง ุฒู ุณุฑุฎ ุฑุง ุญูุธ ูโฺฉูุฏ.', nightOrder: 20 },
            'Baron': { name: 'ุจุงุฑูู', type: 'minion', ability: 'ฒ ุบุฑุจู ุงุถุงู ุฏุฑ ุจุงุฒ ูุณุชูุฏ. ุงู ฺฉ ุชูุงูุง ูููุนู ุงุณุช ฺฉู ุจุงุนุซ ูโุดูุฏ ุฏุฑ ุงุจุชุฏุง ุจุงุฒ ฒ ุบุฑุจู ุจุดุชุฑ ุชูุฒุน ุดูุฏ.', nightOrder: null },
            
            // Demon
            'Imp': { name: 'ุดุทุงู', type: 'demon', ability: 'ูุฑ ุดุจุ ฺฉ ุจุงุฒฺฉู ุฑุง ุงูุชุฎุงุจ ูโฺฉูุฏ ู ุขููุง ูโูุฑูุฏ. ุดูุง ุดุทุงู ูุณุชุฏ. ุงฺฏุฑ ุดูุง ุงุนุฏุงู ุดูุฏุ ุชู ุดุฑุฑ ูโุจุงุฒุฏ.', nightOrder: 21 }
        };

        var ROLE_ICONS = {
            'Washerwoman': '๐งบ', 'Librarian': '๐', 'Investigator': '๐', 'Chef': '๐จโ๐ณ',
            'Empath': '๐๏ธ', 'Fortune Teller': '๐ฎ', 'Undertaker': 'โฐ๏ธ', 'Monk': '๐ก๏ธ',
            'Ravenkeeper': '๐ฆโโฌ', 'Virgin': '๐', 'Slayer': 'โ๏ธ', 'Soldier': '๐',
            'Mayor': '๐ณ๏ธ', 'Butler': '๐๏ธ', 'Drunk': '๐บ', 'Recluse': '๐๏ธ',
            'Saint': '๐', 'Poisoner': 'โ๏ธ', 'Spy': '๐ต๏ธ', 'Scarlet Woman': '๐',
            'Baron': '๐', 'Imp': '๐น'
        };

        var ROLE_REBUS = {
            'Washerwoman': 'ุดุฑูุน: ฑ ุงุฒ ฒ ุจุงุฒฺฉู = [ุดูุฑููุฏ]',
            'Librarian': 'ุดุฑูุน: ฑ ุงุฒ ฒ ุจุงุฒฺฉู = [ุบุฑุจู]',
            'Investigator': 'ุดุฑูุน: ฑ ุงุฒ ฒ ุจุงุฒฺฉู = [ุฎุงุฏู]',
            'Chef': 'ุดุฑูุน: ุชุนุฏุงุฏ ุฌูุชโูุง ุดุฑุฑ',
            'Empath': 'ุดุจ: ุชุนุฏุงุฏ ููุณุงูโูุง ุดุฑุฑ',
            'Fortune Teller': 'ุดุจ: ุงูุชุฎุงุจ ฒ ููุฑ. ฺฉ ุดุทุงู ุงุณุชุ',
            'Undertaker': 'ุดุจ: ฺู ฺฉุณ ุงูุฑูุฒ ูุฑุฏุ = [ููุด]',
            'Monk': 'ุดุจ: ูุญุงูุธุช ุงุฒ ฑ ุจุงุฒฺฉู',
            'Ravenkeeper': 'ุดุจ ูุฑฺฏ: ูููุฏู ููุด ฑ ุจุงุฒฺฉู',
            'Virgin': 'ุฑูุฒ: ูุงูุฒุฏ ุชูุณุท ุดูุฑููุฏุ ูุฑฺฏ ูุงูุฒุฏฺฉููุฏู',
            'Slayer': 'ุฑูุฒ: ุงูุชุฎุงุจ ฑ ููุฑ. ุดุทุงูุ ูุฑฺฏ ุดุทุงู',
            'Soldier': 'ุดุจ: ููโูุฑุฏ',
            'Mayor': 'ณ ููุฑ ุขุฎุฑ: ุงฺฏุฑ ูู ุจูุฑูุ ุฎูุจ ูโุจุฑุฏ',
            'Butler': 'ุดุจ: ุงูุชุฎุงุจ ุงุฑุจุงุจ. ุฑุง ุจุง ุงุฑุจุงุจ',
            'Drunk': 'ุดูุง ูุณุช ูุณุชุฏ. ุชูุงูุง ฺฉุงุฑ ููโฺฉูุฏ',
            'Recluse': 'ุบุฑูุนุงู: ุซุจุช ุจู ุนููุงู ุดุฑุฑ/ุดุทุงู',
            'Saint': 'ุฑูุฒ: ุงุนุฏุงู ุดุฏุฏุ ุดุฑุฑ ูโุจุฑุฏ',
            'Poisoner': 'ุดุจ: ูุณููู ฺฉุฑุฏู ฑ ุจุงุฒฺฉู (ุฎุฑุงุจ ุชูุงูุง)',
            'Spy': 'ุดุจ: ุฏุฏู ููุด ููู. ุซุจุช ุจู ุนููุงู ุฎูุจ',
            'Scarlet Woman': 'ุบุฑูุนุงู: ูุฑฺฏ ุดุทุงูุ ุชุจุฏู ุจู ุดุทุงู',
            'Baron': 'ุดุฑูุน: +ฒ ุบุฑุจู ุฏุฑ ุจุงุฒ',
            'Imp': 'ุดุจ: ฺฉุดุชู ฑ ููุฑ. ุฎูุฏฺฉุดุ ุดุทุงู ุฌุฏุฏ'
        };

        // Character pools by type
        var ALL_TOWNSFOLK = ['Washerwoman', 'Librarian', 'Investigator', 'Chef', 'Empath', 'Fortune Teller', 'Undertaker', 'Monk', 'Ravenkeeper', 'Virgin', 'Slayer', 'Soldier', 'Mayor'];
        var ALL_OUTSIDERS = ['Butler', 'Drunk', 'Recluse', 'Saint'];
        var ALL_MINIONS = ['Poisoner', 'Spy', 'Scarlet Woman', 'Baron'];
        var ALL_DEMONS = ['Imp'];
        
        var TOWNSFOLK_POOL = ALL_TOWNSFOLK.slice();
        var OUTSIDER_POOL = ALL_OUTSIDERS.slice();
        var MINION_POOL = ALL_MINIONS.slice();
        var DEMON_POOL = ALL_DEMONS.slice();
        
        // Teensyville subset (Custom)
        var TEENSYVILLE_SCRIPT = {
            townsfolk: ['Washerwoman', 'Chef', 'Slayer', 'Monk', 'Fortune Teller', 'Undertaker'],
            outsiders: ['Drunk', 'Saint'],
            minions: ['Scarlet Woman', 'Poisoner', 'Baron'],
            demons: ['Imp']
        };
        
        // Teensyville No Baron subset
        var TEENSYVILLE_NO_BARON_SCRIPT = {
            townsfolk: ['Washerwoman', 'Chef', 'Slayer', 'Monk', 'Fortune Teller', 'Undertaker'],
            outsiders: ['Drunk', 'Saint'],
            minions: ['Scarlet Woman', 'Poisoner'],
            demons: ['Imp']
        };
        
        function updateScriptSelection() {
            var radios = document.getElementsByName('script-select');
            var selected = 'trouble';
            for (var i = 0; i < radios.length; i++) {
                if (radios[i].checked) selected = radios[i].value;
            }
            
            var desc = document.getElementById('script-desc');
            var rolesDisplay = document.getElementById('teensy-roles-display');
            var rolesDisplayNoBaron = document.getElementById('teensy-no-baron-roles-display');
            
            if (selected === 'trouble') {
                TOWNSFOLK_POOL = ALL_TOWNSFOLK.slice();
                OUTSIDER_POOL = ALL_OUTSIDERS.slice();
                MINION_POOL = ALL_MINIONS.slice();
                DEMON_POOL = ALL_DEMONS.slice();
                desc.innerText = "ุชูุงู ุดุฎุตุชโูุง ูุณุฎู ูพุงู. ููุงุณุจ ุจุฑุง ท+ ุจุงุฒฺฉู.";
                rolesDisplay.style.display = 'none';
                rolesDisplayNoBaron.style.display = 'none';
            } else if (selected === 'teensy') {
                TOWNSFOLK_POOL = TEENSYVILLE_SCRIPT.townsfolk.slice();
                OUTSIDER_POOL = TEENSYVILLE_SCRIPT.outsiders.slice();
                MINION_POOL = TEENSYVILLE_SCRIPT.minions.slice();
                DEMON_POOL = TEENSYVILLE_SCRIPT.demons.slice();
                desc.innerText = "ูุณุฎู ูุดุฑุฏู ุจุฑุง ต-ถ ุจุงุฒฺฉู.";
                rolesDisplay.style.display = 'block';
                rolesDisplayNoBaron.style.display = 'none';
                updateTeensyDistribution();
            } else if (selected === 'teensy-no-baron') {
                TOWNSFOLK_POOL = TEENSYVILLE_NO_BARON_SCRIPT.townsfolk.slice();
                OUTSIDER_POOL = TEENSYVILLE_NO_BARON_SCRIPT.outsiders.slice();
                MINION_POOL = TEENSYVILLE_NO_BARON_SCRIPT.minions.slice();
                DEMON_POOL = TEENSYVILLE_NO_BARON_SCRIPT.demons.slice();
                desc.innerText = "ูุณุฎู ูุดุฑุฏู ุจุฑุง ต-ถ ุจุงุฒฺฉู (ุจุฏูู ุจุงุฑูู).";
                rolesDisplay.style.display = 'none';
                rolesDisplayNoBaron.style.display = 'block';
                updateTeensyNoBaronDistribution();
            }
        }
        
        function updateTeensyDistribution() {
            var distDisplay = document.getElementById('teensy-distribution');
            if (!distDisplay) return;
            
            var currentCount = playerCount;
            var dist = CHARACTER_DISTRIBUTION[currentCount];
            
            if (dist) {
                var distText = 'ุชูุฒุน ุจุฑุง ' + currentCount + ' ุจุงุฒฺฉู: ';
                distText += '<span style="color:var(--townsfolk-color);">' + dist.townsfolk + ' ุดูุฑููุฏ</span>ุ ';
                distText += '<span style="color:var(--outsider-color);">' + dist.outsiders + ' ุบุฑุจู</span>ุ ';
                distText += '<span style="color:var(--minion-color);">' + dist.minions + ' ุฎุงุฏู</span>ุ ';
                distText += '<span style="color:var(--demon-color);">' + dist.demon + ' ุดุทุงู</span>';
                distDisplay.innerHTML = distText;
            } else {
                distDisplay.innerHTML = 'ุชุนุฏุงุฏ ุจุงุฒฺฉู ูุงูุนุชุจุฑ ุจุฑุง ุชูุฒโูู (ุจุงุฏ ต ุง ถ ุจุงุดุฏ)';
            }
        }
        
        function updateTeensyNoBaronDistribution() {
            var distDisplay = document.getElementById('teensy-no-baron-distribution');
            if (!distDisplay) return;
            
            var currentCount = playerCount;
            var dist = CHARACTER_DISTRIBUTION[currentCount];
            
            if (dist) {
                var distText = 'ุชูุฒุน ุจุฑุง ' + currentCount + ' ุจุงุฒฺฉู: ';
                distText += '<span style="color:var(--townsfolk-color);">' + dist.townsfolk + ' ุดูุฑููุฏ</span>ุ ';
                distText += '<span style="color:var(--outsider-color);">' + dist.outsiders + ' ุบุฑุจู</span>ุ ';
                distText += '<span style="color:var(--minion-color);">' + dist.minions + ' ุฎุงุฏู</span>ุ ';
                distText += '<span style="color:var(--demon-color);">' + dist.demon + ' ุดุทุงู</span>';
                distDisplay.innerHTML = distText;
            } else {
                distDisplay.innerHTML = 'ุชุนุฏุงุฏ ุจุงุฒฺฉู ูุงูุนุชุจุฑ ุจุฑุง ุชูุฒโูู (ุจุงุฏ ต ุง ถ ุจุงุดุฏ)';
            }
        }

        // --- Global State ---
        var playerCount = 7;
        var players = [];
        var savedPlayers = [];
        var currentDistIndex = 0;
        
        // Game State
        var currentDay = 1;
        var isNightPhase = true;
        var currentNightOrder = [];
        var nightIndex = 0;
        var executions = 0;
        var lastExecutionDay = 0; // Track which day the last execution happened
        var lastExecutedPlayer = null; // Track which player was last executed (for Undertaker)
        var gameLog = [];
        var grimoireVisible = false;
        var playerInfo = {}; // Track information given to each player
        var poisonedPlayers = []; // Array of {playerIndex, poisonedNight, appliesNight}
        var protectedPlayers = [];
        var markedForDeath = null; // Player marked for death by Imp this night (resolved at end of night)
        var butlerChoices = {}; // Track Butler's choices
        var slayerUsed = false;
        var virginTriggered = false;
        var fortuneTellerRedHerrings = {}; // Track red herring player for each Fortune Teller {playerIndex: redHerringPlayerIndex}

        // Completely prevent accidental refresh/back navigation
        var isGameInProgress = false;
        
        function preventAccidentalNavigation() {
            if (!isGameInProgress) return;
            
            // Completely prevent back button - push state and immediately replace
            history.pushState({page: 'game'}, '', location.href);
            history.pushState({page: 'game'}, '', location.href);
            
            window.onpopstate = function(event) {
                if (isGameInProgress) {
                    // Immediately push state back to prevent navigation
                    history.pushState({page: 'game'}, '', location.href);
                    // Show warning
                    alert('Back button is disabled during game. Use game controls to navigate.');
                }
            };
            
            // Prevent refresh with aggressive warning
            window.addEventListener('beforeunload', function(e) {
                if (isGameInProgress) {
                    e.preventDefault();
                    e.returnValue = 'Game is in progress! Reloading will lose all progress.';
                    return e.returnValue;
                }
            });
            
            // Disable keyboard shortcuts for refresh (F5, Ctrl+R, Ctrl+Shift+R)
            document.addEventListener('keydown', function(e) {
                if (isGameInProgress) {
                    // F5
                    if (e.key === 'F5' || e.keyCode === 116) {
                        e.preventDefault();
                        alert('Refresh is disabled during game. Use game controls to navigate.');
                        return false;
                    }
                    // Ctrl+R or Ctrl+Shift+R
                    if ((e.ctrlKey || e.metaKey) && (e.key === 'r' || e.key === 'R')) {
                        e.preventDefault();
                        alert('Refresh is disabled during game. Use game controls to navigate.');
                        return false;
                    }
                }
            });
            
            // Disable right-click context menu (which might have refresh option)
            if (isGameInProgress) {
                document.addEventListener('contextmenu', function(e) {
                    e.preventDefault();
                    return false;
                }, false);
            }
        }
        
        // Initialize navigation prevention
        preventAccidentalNavigation();
        
        // Auto-save game state periodically
        function saveGameState() {
            try {
                if (isGameInProgress && players.length > 0) {
                    var state = {
                        playerCount: playerCount,
                        players: players,
                        currentDay: currentDay,
                        isNightPhase: isNightPhase,
                        currentNightOrder: currentNightOrder,
                        nightIndex: nightIndex,
                        executions: executions,
                        lastExecutionDay: lastExecutionDay,
                        lastExecutedPlayer: lastExecutedPlayer,
                        gameLog: gameLog,
                        grimoireVisible: grimoireVisible,
                        playerInfo: playerInfo,
                        poisonedPlayers: poisonedPlayers,
                        protectedPlayers: protectedPlayers,
                        markedForDeath: markedForDeath,
                        butlerChoices: butlerChoices,
                        slayerUsed: slayerUsed,
                        virginTriggered: virginTriggered,
                        fortuneTellerRedHerrings: fortuneTellerRedHerrings,
                        currentDistIndex: currentDistIndex
                    };
                    localStorage.setItem('botc_game_state_farsi', JSON.stringify(state));
                }
            } catch (e) {
                // Silently fail if localStorage not available
            }
        }
        
        // Save state every 3 seconds
        setInterval(saveGameState, 3000);
        
        // Restore game state from localStorage
        function restoreGameState() {
            try {
                var stored = localStorage.getItem('botc_game_state_farsi');
                if (stored) {
                    var state = JSON.parse(stored);
                    if (confirm('ุจุงุฒ ุฏุฑ ุญุงู ุงูุฌุงู ูพุฏุง ุดุฏ. ุขุง ูโุฎูุงูุฏ ุขู ุฑุง ุจุงุฒุงุจ ฺฉูุฏุ')) {
                        // Restore all game state
                        playerCount = state.playerCount;
                        players = state.players;
                        currentDay = state.currentDay;
                        isNightPhase = state.isNightPhase;
                        currentNightOrder = state.currentNightOrder || [];
                        nightIndex = state.nightIndex;
                        executions = state.executions;
                        lastExecutionDay = state.lastExecutionDay;
                        lastExecutedPlayer = state.lastExecutedPlayer;
                        gameLog = state.gameLog || [];
                        grimoireVisible = state.grimoireVisible;
                        playerInfo = state.playerInfo || {};
                        poisonedPlayers = state.poisonedPlayers || [];
                        protectedPlayers = state.protectedPlayers || [];
                        markedForDeath = state.markedForDeath;
                        butlerChoices = state.butlerChoices || {};
                        slayerUsed = state.slayerUsed;
                        virginTriggered = state.virginTriggered;
                        fortuneTellerRedHerrings = state.fortuneTellerRedHerrings || {};
                        currentDistIndex = state.currentDistIndex;
                        
                        isGameInProgress = true;
                        preventAccidentalNavigation();
                        
                        // Determine which screen to show
                        if (currentDistIndex < players.length) {
                            // Still in distribution phase
                            showScreen('distribution-screen');
                            updateDistributionScreen();
                        } else if (players.length > 0) {
                            // Game is in progress
                            showScreen('game-screen');
                            updateGameDisplay();
                        }
                        return true;
                    } else {
                        localStorage.removeItem('botc_game_state_farsi');
                    }
                }
            } catch (e) {
                console.error('Error restoring game state:', e);
            }
            return false;
        }
        
        // --- Initialization ---
        window.onload = function() {
            loadSavedPlayers();
            renderPlayerInputs();
            updateScriptSelection(); // Initialize script
            // Try to restore game state first
            if (!restoreGameState()) {
                // No saved game, show normal setup
            }
        };

        function loadSavedPlayers() {
            var stored = localStorage.getItem('botc_players');
            if (stored) {
                savedPlayers = JSON.parse(stored);
            }
            renderSavedList();
        }

        function renderSavedList() {
            var container = document.getElementById('saved-list');
            container.innerHTML = '';
            
            if (savedPlayers.length === 0) {
                container.innerHTML = '<span style="color:#555; font-size:0.8rem;">No saved names</span>';
                return;
            }

            savedPlayers.forEach(function(name) {
                var chip = document.createElement('div');
                chip.style.display = 'inline-block';
                chip.style.background = 'rgba(255,255,255,0.1)';
                chip.style.border = '1px solid #555';
                chip.style.borderRadius = '20px';
                chip.style.padding = '6px 14px';
                chip.style.fontSize = '0.85rem';
                chip.style.cursor = 'pointer';
                chip.style.margin = '3px';
                chip.innerText = name;
                chip.onclick = function() { fillInput(name); };
                container.appendChild(chip);
            });
        }

        function fillInput(name) {
            var inputs = document.querySelectorAll('.player-input');
            for (var i = 0; i < inputs.length; i++) {
                var val = inputs[i].value;
                if (val === '') {
                    inputs[i].value = name;
                    return;
                }
            }
        }

        function updatePlayerCount(delta) {
            var newCount = playerCount + delta;
            if (newCount >= 5 && newCount <= 15) {
                playerCount = newCount;
                document.getElementById('player-count-display').innerText = playerCount;
                renderPlayerInputs();
                // Update Teensyville distribution display if Teensyville is selected
                var radios = document.getElementsByName('script-select');
                var selected = 'trouble';
                for (var i = 0; i < radios.length; i++) {
                    if (radios[i].checked) selected = radios[i].value;
                }
                if (selected === 'teensy') {
                    updateTeensyDistribution();
                }
            }
        }

        function renderPlayerInputs() {
            var container = document.getElementById('player-inputs-container');
            var currentValues = [];
            var inputs = container.querySelectorAll('.player-input');
            for(var i=0; i<inputs.length; i++) currentValues.push(inputs[i].value);

            container.innerHTML = '';
            for (var i = 0; i < playerCount; i++) {
                var val = currentValues[i] || '';
                var placeholder = "Player " + (i + 1);
                var input = document.createElement('input');
                input.type = 'text';
                input.className = 'player-input';
                input.placeholder = placeholder;
                input.value = val;
                container.appendChild(input);
            }
        }

        // --- Role Distribution ---
        function startRoleDistribution() {
            isGameInProgress = true;
            var inputs = document.querySelectorAll('.player-input');
            var names = [];
            for (var i = 0; i < inputs.length; i++) {
                var val = inputs[i].value.trim() || inputs[i].placeholder;
                names.push(val);
                
                if (inputs[i].value.trim() !== '' && savedPlayers.indexOf(val) === -1) {
                    savedPlayers.push(val);
                }
            }
            localStorage.setItem('botc_players', JSON.stringify(savedPlayers));
            renderSavedList();

            // Get character distribution
            var dist = CHARACTER_DISTRIBUTION[playerCount];
            if (!dist) {
                alert('Invalid player count: ' + playerCount);
                return;
            }

            // Select characters
            var selectedChars = [];
            
            // Select Minions first (to check for Baron)
            var minionPool = MINION_POOL.slice();
            shuffleArray(minionPool);
            var selectedMinions = [];
            for (var i = 0; i < dist.minions; i++) {
                selectedMinions.push(minionPool[i]);
            }
            
            // Check if Baron is in the game (adds +2 Outsiders)
            var baronInPlay = selectedMinions.indexOf('Baron') !== -1;
            var adjustedOutsiders = dist.outsiders;
            var adjustedTownsfolk = dist.townsfolk;
            
            if (baronInPlay) {
                // Baron adds 2 Outsiders, remove 2 Townsfolk
                adjustedOutsiders += 2;
                adjustedTownsfolk -= 2;
            }
            
            // Select Townsfolk
            var townsfolkPool = TOWNSFOLK_POOL.slice();
            shuffleArray(townsfolkPool);
            for (var i = 0; i < adjustedTownsfolk; i++) {
                selectedChars.push(townsfolkPool[i]);
            }
            
            // Select Outsiders - Drunk should have >90% chance
            var outsiderPool = OUTSIDER_POOL.slice();
            shuffleArray(outsiderPool);
            for (var i = 0; i < adjustedOutsiders; i++) {
                // If we need outsiders and Drunk is available, >90% chance to include it
                if (i === 0 && adjustedOutsiders > 0 && Math.random() > 0.1) {
                    // 90% chance to force Drunk
                    var drunkIndex = outsiderPool.indexOf('Drunk');
                    if (drunkIndex !== -1) {
                        selectedChars.push('Drunk');
                        outsiderPool.splice(drunkIndex, 1);
                    } else {
                        selectedChars.push(outsiderPool[i]);
                    }
                } else {
                    selectedChars.push(outsiderPool[i]);
                }
            }
            
            // Add selected Minions
            for (var i = 0; i < selectedMinions.length; i++) {
                selectedChars.push(selectedMinions[i]);
            }
            
            // Select Demon
            selectedChars.push(DEMON_POOL[0]);

            // Shuffle and assign to players
            shuffleArray(selectedChars);
            
            players = [];
            for (var i = 0; i < playerCount; i++) {
                var charName = selectedChars[i];
                var charDef = CHARACTERS[charName];
                
                // Drunk thinks they are a Townsfolk - assign them a fake Townsfolk role
                var actualCharDef = charDef;
                var fakeCharDef = null;
                if (charName === 'Drunk') {
                    // Give them a random Townsfolk role to think they are
                    var availableTownsfolk = TOWNSFOLK_POOL.filter(t => selectedChars.indexOf(t) === -1);
                    if (availableTownsfolk.length === 0) {
                        // If all townsfolk are in game, pick a random one anyway
                        availableTownsfolk = TOWNSFOLK_POOL.slice();
                    }
                    shuffleArray(availableTownsfolk);
                    fakeCharDef = CHARACTERS[availableTownsfolk[0]];
                }
                
                players.push({
                    name: names[i],
                    character: charName,
                    characterDef: actualCharDef, // Real character
                    fakeCharacterDef: fakeCharDef, // What Drunk thinks they are
                    alive: true,
                    index: i
                });
            }
            
            // Initialize player info tracking
            for (var i = 0; i < players.length; i++) {
                playerInfo[i] = [];
            }
            
            // Reset game state variables for Distribution phase
            poisonedPlayers = [];
            protectedPlayers = [];
            markedForDeath = null;
            butlerChoices = {};
            slayerUsed = false;
            virginTriggered = false;
            fortuneTellerRedHerrings = {};
            executions = 0;
            lastExecutionDay = 0;
            gameLog = [];
            
            currentDistIndex = 0;
            document.getElementById('dist-total-players').innerText = playerCount;
            document.getElementById('setup-screen').classList.add('hidden');
            showScreen('distribution-screen');
            updateDistScreen();
        }

        function updateDistScreen() {
            document.getElementById('dist-player-num').innerText = currentDistIndex + 1;
            document.getElementById('dist-player-name').innerText = players[currentDistIndex].name;
        }

        function revealRole() {
            var player = players[currentDistIndex];
            document.getElementById('reveal-name-header').innerText = player.name;
            
            var title = document.getElementById('role-title');
            var desc = document.getElementById('role-desc');
            var extra = document.getElementById('role-extra');
            var nightActionDiv = document.getElementById('dist-night-action');
            
            // Drunk sees their fake Townsfolk role, not that they're Drunk
            var charDef = player.fakeCharacterDef || player.characterDef;
            
            // Use original key to find icon
            var charKey = Object.keys(CHARACTERS).find(key => CHARACTERS[key].name === charDef.name) || charDef.name;
            
            // Try to find key by matching names if direct lookup fails
            if (!ROLE_ICONS[charKey]) {
                 for (var k in CHARACTERS) {
                     if (CHARACTERS[k].name === charDef.name) {
                         charKey = k;
                         break;
                     }
                 }
            }

            var icon = ROLE_ICONS[charKey] || 'โ';
            
            title.innerHTML = '<div style="font-size: 4rem; margin-bottom: 10px;">' + icon + '</div>' + charDef.name;
            title.className = 'role-title role-' + charDef.type;
            
            // Use updated description from ROLE_GUIDE_INFO if available, otherwise fall back to ability
            var roleInfo = ROLE_GUIDE_INFO[charKey];
            if (roleInfo && roleInfo.desc) {
                var fullDesc = roleInfo.desc;
                if (roleInfo.note) {
                    fullDesc += '<br><br><em style="color: var(--text-secondary); font-size: 0.9em;">ูฺฉุชู: ' + roleInfo.note + '</em>';
                }
                desc.innerHTML = fullDesc;
            } else {
            desc.innerText = charDef.ability;
            }
            
            extra.innerHTML = '';
            nightActionDiv.style.display = 'none';
            nightActionDiv.innerHTML = '';
            
            // Show teammates for evil players
            if (charDef.type === 'minion' || charDef.type === 'demon') {
                var evilPlayers = players.filter(p => 
                    (p.characterDef.type === 'minion' || p.characterDef.type === 'demon') && 
                    p.name !== player.name
                );
                if (evilPlayers.length > 0) {
                    var teamList = evilPlayers.map(p => p.name).join(', ');
                    extra.innerHTML = '<div style="margin-top: 15px; padding: 10px; background: rgba(244, 67, 54, 0.2); border: 1px solid var(--evil-color); border-radius: 8px; color: #FFCDD2;">ููโุชูโูุง ุดุฑุฑ ุดูุง: ' + teamList + '</div>';
                }
            }
            
            // Handle Night 1 Actions/Info immediately
            var nextBtn = document.getElementById('next-dist-btn');
            nextBtn.disabled = false; // Default enabled
            nextBtn.onclick = nextDistribute; // Default handler
            
            var charName = charDef.name;
            var originalCharName = player.characterDef.name; // For Drunk check
            
            // 1. Information Roles (Washerwoman, Librarian, Investigator, Chef, Empath, Fortune Teller)
            // AND Imp (First Night Info)
            if (['ุฑุฎุชโุดู', 'ฺฉุชุงุจุฏุงุฑ', 'ุจุงุฒูพุฑุณ', 'ุขุดูพุฒ', 'ููโุฏู', 'ูุงูโฺฏุฑ'].indexOf(charName) !== -1 || charName === 'ุดุทุงู') {
                nightActionDiv.style.display = 'block';
                var info = '';
                
                // Check for poisoning (if Poisoner acted earlier in distribution order)
                var isPoisoned = poisonedPlayers.some(p => p.playerIndex === player.index);
                
                if (charName === 'ุดุทุงู') {
                    // Imp Info: 3 Roles not in game
                    var allGoodRoles = TOWNSFOLK_POOL.concat(OUTSIDER_POOL);
                    var rolesInGame = players.map(p => {
                        for (var key in CHARACTERS) {
                            if (CHARACTERS[key].name === p.characterDef.name) return key;
                        }
                        return null;
                    }).filter(r => r !== null);
                    var rolesNotInGame = allGoodRoles.filter(r => rolesInGame.indexOf(r) === -1);
                    shuffleArray(rolesNotInGame);
                    info = '<strong style="color: var(--demon-color);">ุงุทูุงุนุงุช ุดุจ ุงูู (ููุดโูุง ุฎุงุฑุฌ ุงุฒ ุจุงุฒ):</strong><br>' + 
                           rolesNotInGame.slice(0, 3).map(r => CHARACTERS[r].name).join('ุ ');
                } else {
                    // Townsfolk Info
                    // We reuse the logic from giveInformation but adapted here
                    info = generateNightInfoText(player, charDef, isPoisoned);
                    info = '<strong style="color: var(--townsfolk-color);">ุงุทูุงุนุงุช ุดูุง:</strong><br>' + info;
                }
                
                nightActionDiv.innerHTML = info;
            }
            
            // 2. Choice Roles (Poisoner, Monk, Butler)
            if (['ุฒูุฑุขฺฏู', 'ุฑุงูุจ', 'ูพุดุฎุฏูุช'].indexOf(charName) !== -1) {
                nightActionDiv.style.display = 'block';
                nextBtn.disabled = true;
                nextBtn.innerText = 'ุงูุชุฎุงุจ ฺฉูุฏ...';
                
                renderDistChoice(player, charName, nightActionDiv, function() {
                    nextBtn.disabled = false;
            if (currentDistIndex === playerCount - 1) {
                        nextBtn.innerText = "ูพุงุงู ุชูุฒุน ู ุดุฑูุน ุฑูุฒ";
                    } else {
                        nextBtn.innerText = "ูุฎู ฺฉุฑุฏู ู ุจุนุฏ";
                    }
                });
            }
            
            // 3. Spy (Grimoire)
            if (charName === 'ุฌุงุณูุณ') {
                nightActionDiv.style.display = 'block';
                var btn = document.createElement('button');
                btn.className = 'action-btn';
                btn.innerText = 'ูุดุงูุฏู ุฏูุชุฑฺู';
                btn.onclick = function() {
                    // Use the modal popup for Spy Grimoire
                    showSpyGrimoireDistribution(player);
                };
                nightActionDiv.appendChild(btn);
            }

            if (currentDistIndex === playerCount - 1) {
                nextBtn.innerText = "ูพุงุงู ุชูุฒุน ู ุดุฑูุน ุฑูุฒ";
                nextBtn.style.backgroundColor = "#4CAF50";
            } else {
                if (!nextBtn.disabled) {
                nextBtn.innerText = "ูุฎู ฺฉุฑุฏู ู ุจุนุฏ";
                nextBtn.style.backgroundColor = "#b71c1c";
                }
            }
            
            document.getElementById('dist-pass-view').classList.add('hidden');
            document.getElementById('dist-reveal-view').classList.remove('hidden');
        }

        function generateNightInfoText(player, charDef, isPoisoned) {
            var info = '';
            var charName = charDef.name;
            
            if (charName === 'ุฑุฎุชโุดู') {
                // Washerwoman: 1 of 2 players is a Townsfolk
                var townsfolk = players.filter(p => p.characterDef.type === 'townsfolk' && p.name !== player.name);
                if (townsfolk.length > 0) {
                    var target = townsfolk[Math.floor(Math.random() * townsfolk.length)];
                    var randomPlayer = players[Math.floor(Math.random() * players.length)];
                    while (randomPlayer.name === player.name || randomPlayer.name === target.name) {
                        randomPlayer = players[Math.floor(Math.random() * players.length)];
                    }
                    var pair = [target, randomPlayer];
                    shuffleArray(pair);
                    info = 'ฺฉ ุงุฒ ุงู ุฏู ููุฑ ' + target.characterDef.name + ' ุงุณุช: ' + pair[0].name + 'ุ ' + pair[1].name;
                    if (isPoisoned) {
                        info += ' (ุงุทูุงุนุงุช ูุงุฏุฑุณุช - ูุณููู)';
                    }
                } else {
                    info = 'ูฺ ุดูุฑููุฏ ุฏุฑ ุจุงุฒ ูุณุช';
                }
            } else if (charName === 'ฺฉุชุงุจุฏุงุฑ') {
                // Librarian: 1 of 2 players is an Outsider
                var outsiders = players.filter(p => p.characterDef.type === 'outsider');
                if (outsiders.length > 0) {
                    var target = outsiders[Math.floor(Math.random() * outsiders.length)];
                    var randomPlayer = players[Math.floor(Math.random() * players.length)];
                    while (randomPlayer.name === player.name || randomPlayer.name === target.name) {
                        randomPlayer = players[Math.floor(Math.random() * players.length)];
                    }
                    var pair = [target, randomPlayer];
                    shuffleArray(pair);
                    info = 'ฺฉ ุงุฒ ุงู ุฏู ููุฑ ' + target.characterDef.name + ' ุงุณุช: ' + pair[0].name + 'ุ ' + pair[1].name;
                    if (isPoisoned) {
                        info += ' (ุงุทูุงุนุงุช ูุงุฏุฑุณุช - ูุณููู)';
                    }
                } else {
                    info = 'ูฺ ุบุฑุจูโุง ุฏุฑ ุจุงุฒ ูุณุช';
                }
            } else if (charName === 'ุจุงุฒูพุฑุณ') {
                // Investigator: 1 of 2 players is a SPECIFIC Minion (must name the minion role)
                // Spy appears as good, so exclude them from Minion detection
                var minions = players.filter(p => p.characterDef.type === 'minion' && p.character !== 'Spy');
                if (minions.length > 0) {
                    var target = minions[Math.floor(Math.random() * minions.length)];
                    var randomPlayer = players[Math.floor(Math.random() * players.length)];
                    while (randomPlayer.name === player.name || randomPlayer.name === target.name) {
                        randomPlayer = players[Math.floor(Math.random() * players.length)];
                    }
                    var pair = [target, randomPlayer];
                    shuffleArray(pair);
                    info = 'ฺฉ ุงุฒ ุงู ุฏู ููุฑ ' + target.characterDef.name + ' ุงุณุช: ' + pair[0].name + 'ุ ' + pair[1].name;
                    if (isPoisoned) {
                        info += ' (ุงุทูุงุนุงุช ูุงุฏุฑุณุช - ูุณููู)';
                    }
                } else {
                    info = 'ูฺ ุฎุงุฏู ุดุทุงู ุฏุฑ ุจุงุฒ ูุณุช';
                }
            } else if (charName === 'ุขุดูพุฒ') {
                // Chef: Number of pairs of evil players
                var evilPlayers = players.filter(p => p.characterDef.type === 'minion' || p.characterDef.type === 'demon');
                var pairs = 0;
                for (var i = 0; i < evilPlayers.length; i++) {
                    var nextIndex = (evilPlayers[i].index + 1) % players.length;
                    var nextPlayer = players[nextIndex];
                    if (nextPlayer.characterDef.type === 'minion' || nextPlayer.characterDef.type === 'demon') {
                        pairs++;
                    }
                }
                info = 'ุชุนุฏุงุฏ ุฌูุชโูุง ุดุฑุฑ: ' + pairs;
                if (isPoisoned) {
                    info = 'ุชุนุฏุงุฏ ุฌูุชโูุง ุดุฑุฑ: ' + Math.floor(Math.random() * 3) + ' (ุงุทูุงุนุงุช ูุงุฏุฑุณุช - ูุณููู)';
                }
            } else if (charName === 'ููโุฏู') {
                // Empath: Number of evil neighbors
                var leftIndex = (player.index - 1 + players.length) % players.length;
                var rightIndex = (player.index + 1) % players.length;
                var leftPlayer = players[leftIndex];
                var rightPlayer = players[rightIndex];
                var evilCount = 0;
                if (leftPlayer.alive && (leftPlayer.characterDef.type === 'minion' || leftPlayer.characterDef.type === 'demon')) {
                    evilCount++;
                }
                if (rightPlayer.alive && (rightPlayer.characterDef.type === 'minion' || rightPlayer.characterDef.type === 'demon')) {
                    evilCount++;
                }
                info = 'ุชุนุฏุงุฏ ููุณุงูโูุง ุดุฑุฑ: ' + evilCount;
                if (isPoisoned) {
                    info = 'ุชุนุฏุงุฏ ููุณุงูโูุง ุดุฑุฑ: ' + Math.floor(Math.random() * 3) + ' (ุงุทูุงุนุงุช ูุงุฏุฑุณุช - ูุณููู)';
                }
            } else if (charName === 'ูุงูโฺฏุฑ') {
                // Fortune Teller: Will need to choose 2 players - for now show instruction
                info = 'ุฏุฑ ุทูู ุจุงุฒุ ูุฑ ุดุจ ุฏู ููุฑ ุฑุง ุงูุชุฎุงุจ ฺฉูุฏ. ุงฺฏุฑ ฺฉ ุงุฒ ุขููุง ุดุทุงู ุจุงุดุฏุ ุจูู ูโุดููุฏ.';
            }
            
            return info;
        }

        function renderDistChoice(player, charName, container, onComplete) {
            container.innerHTML = '';
            
            if (charName === 'ุฒูุฑุขฺฏู') {
                // Poisoner: Choose a player to poison
                var title = document.createElement('div');
                title.innerHTML = '<strong>ุงูุชุฎุงุจ ฺฉูุฏ ฺู ฺฉุณ ุฑุง ูุณููู ูโฺฉูุฏ:</strong>';
                title.style.marginBottom = '10px';
                container.appendChild(title);
                
                players.forEach(function(p) {
                    if (p.name !== player.name) {
                        var btn = document.createElement('button');
                        btn.className = 'player-select-btn';
                        btn.style.margin = '5px';
                        btn.innerText = p.name;
                        btn.onclick = function() {
                            poisonedPlayers.push({ playerIndex: p.index, day: 1 });
                            container.innerHTML = '<div style="color: var(--minion-color); font-weight: bold;">ูุณููู ุดุฏ: ' + p.name + '</div>';
                            if (onComplete) onComplete();
                        };
                        container.appendChild(btn);
                    }
                });
            } else if (charName === 'ุฑุงูุจ') {
                // Monk: Choose a player to protect
                var title = document.createElement('div');
                title.innerHTML = '<strong>ุงูุชุฎุงุจ ฺฉูุฏ ฺู ฺฉุณ ุฑุง ูุญุงูุธุช ูโฺฉูุฏ:</strong>';
                title.style.marginBottom = '10px';
                container.appendChild(title);
                
                players.forEach(function(p) {
                    if (p.name !== player.name) {
                        var btn = document.createElement('button');
                        btn.className = 'player-select-btn';
                        btn.style.margin = '5px';
                        btn.innerText = p.name;
                        btn.onclick = function() {
                            protectedPlayers = [p.index];
                            container.innerHTML = '<div style="color: var(--townsfolk-color); font-weight: bold;">ูุญุงูุธุช ุดุฏ: ' + p.name + '</div>';
                            if (onComplete) onComplete();
                        };
                        container.appendChild(btn);
                    }
                });
            } else if (charName === 'ูพุดุฎุฏูุช') {
                // Butler: Choose a master
                var title = document.createElement('div');
                title.innerHTML = '<strong>ุงูุชุฎุงุจ ฺฉูุฏ ุงุฑุจุงุจ ุดูุง ฺู ฺฉุณ ุงุณุช:</strong>';
                title.style.marginBottom = '10px';
                container.appendChild(title);
                
                players.forEach(function(p) {
                    if (p.name !== player.name) {
                        var btn = document.createElement('button');
                        btn.className = 'player-select-btn';
                        btn.style.margin = '5px';
                        btn.innerText = p.name;
                        btn.onclick = function() {
                            butlerChoices[player.index] = p.index;
                            container.innerHTML = '<div style="color: var(--townsfolk-color); font-weight: bold;">ุงุฑุจุงุจ ุดูุง: ' + p.name + '</div>';
                            if (onComplete) onComplete();
                        };
                        container.appendChild(btn);
                    }
                });
            }
        }

        function nextDistribute() {
            currentDistIndex++;
            if (currentDistIndex >= playerCount) {
                startGame();
            } else {
                document.getElementById('dist-pass-view').classList.remove('hidden');
                document.getElementById('dist-reveal-view').classList.add('hidden');
                updateDistScreen();
            }
        }

        // --- Game Logic ---
        function startGame() {
            currentDay = 1;
            isNightPhase = false; // Start at day since first night was handled during distribution
            // Don't reset these - they were set during distribution
            // executions, lastExecutionDay already set
            // gameLog already initialized
            // playerInfo already initialized
            // poisonedPlayers, protectedPlayers, butlerChoices already set during distribution
            // slayerUsed, virginTriggered already initialized
            
            addLog("ุจุงุฒ ุจุง " + playerCount + " ุจุงุฒฺฉู ุดุฑูุน ุดุฏ.");
            addLog("ุดุจ ุงูู ุฏุฑ ุทูู ุชูุฒุน ููุดโูุง ุงูุฌุงู ุดุฏ.");
            addLog("ุฑูุฒ ุงูู ุดุฑูุน ูโุดูุฏ.");
            
            showScreen('game-screen');
            updateGameDisplay();
            startDayPhase(); // Skip first night, go directly to Day 1
        }

        function updateGameDisplay() {
            var living = players.filter(p => p.alive).length;
            document.getElementById('living-count').innerText = living;
            document.getElementById('current-day').innerText = currentDay;
            document.getElementById('execution-count').innerText = executions;
            
            renderGrimoire();
        }

        function startFirstNight() {
            isNightPhase = true;
            document.getElementById('phase-display').className = 'phase-display phase-night';
            document.getElementById('phase-title').innerText = 'ุดุจ ุงูู';
            document.getElementById('phase-content').innerHTML = 
                '<p>ููู ุจุงุฒฺฉูุงู ฺุดูุงู ุฎูุฏ ุฑุง ุจุจูุฏูุฏ.</p>' +
                '<p>ูุตูโฺฏู ุดุฎุตุชโูุง ุฑุง ุจู ุชุฑุชุจ ุจุฏุงุฑ ูโฺฉูุฏ.</p>';
            
            // Build night order based on characters in play
            buildNightOrder();
            nightIndex = 0;
            
            var actions = document.getElementById('action-buttons');
            actions.innerHTML = '<button class="action-btn" onclick="processNightPhase()">ุดุฑูุน ุดุจ ุงูู</button>';
        }

        function buildNightOrder() {
            currentNightOrder = [];
            
            // Order by seating position (player index) instead of character night order
            // This prevents players from knowing who the Imp is based on order
            players.forEach(function(player) {
                if (player.alive) {
                    var charDef = player.characterDef;
                    // Drunk uses their fake character for night order
                    var displayCharDef = player.fakeCharacterDef || charDef;
                    // Only include players with night abilities (check real character, but use fake for display)
                    if (charDef.nightOrder) {
                        currentNightOrder.push({
                            order: charDef.nightOrder, // Keep for game mechanics (poisoning timing, etc.)
                            player: player,
                            character: displayCharDef // Use fake character for Drunk
                        });
                    }
                }
            });
            
            // Sort by player index (seating order) to pass device sequentially
            currentNightOrder.sort(function(a, b) {
                return a.player.index - b.player.index;
            });
        }

        function processNightPhase() {
            if (nightIndex >= currentNightOrder.length) {
                // Night phase complete - now close modal and show day phase
                document.getElementById('night-modal').classList.add('hidden');
                endNightPhase();
                return;
            }
            
            var nightAction = currentNightOrder[nightIndex];
            var player = nightAction.player;
            var charDef = nightAction.character;
            
            // Drunk sees their fake Townsfolk role, not that they're Drunk
            var displayCharDef = player.fakeCharacterDef || charDef;
            
            // Show confirmation screen first
            document.getElementById('night-player-name').innerText = player.name;
            // Don't show character name - keep it hidden until player confirms
            document.getElementById('night-character-hint').innerText = '';
            
            // Hide action view, show confirm view
            document.getElementById('night-confirm-view').classList.remove('hidden');
            document.getElementById('night-action-view').classList.add('hidden');
            
            // Ensure modal is visible
            document.getElementById('night-modal').classList.remove('hidden');
        }

        function confirmNightPlayer() {
            // Hide confirmation, show action
            document.getElementById('night-confirm-view').classList.add('hidden');
            document.getElementById('night-action-view').classList.remove('hidden');
            
            var nightAction = currentNightOrder[nightIndex];
            var player = nightAction.player;
            var charDef = nightAction.character;
            
            // Drunk sees their fake Townsfolk role, not that they're Drunk
            var displayCharDef = player.fakeCharacterDef || charDef;
            
            // Check if character is poisoned for THIS activation
            var poisonEntry = poisonedPlayers.find(p => p.playerIndex === player.index);
            var isPoisoned = false;
            if (poisonEntry) {
                // Check if poison should apply this night
                if (poisonEntry.appliesNight === currentDay) {
                    isPoisoned = true;
                }
            }
            
            // Drunk sees their fake Townsfolk role, not that they're Drunk
            var displayCharDef = player.fakeCharacterDef || charDef;
            
            // Update modal content
            document.getElementById('night-character-name').innerText = displayCharDef.name + ' (' + player.name + ')';
            var info = document.getElementById('night-character-info');
            info.innerHTML = '<strong>ุชูุงูุง:</strong> ' + displayCharDef.ability;
            
            // Don't show poisoned message to player - they shouldn't know
            
            var actions = document.getElementById('night-character-actions');
            actions.innerHTML = '';
            
            // Handle specific character abilities
            // For Drunk, use their fake character for display/ability, but their ability won't work
            var charDefForAbility = displayCharDef;
            if (player.character === 'Drunk') {
                // Drunk's ability doesn't work - they think they have the fake ability but it fails
                // They'll see the button but get no info
            }
            handleNightAbility(player, charDefForAbility, isPoisoned, actions);
        }

        function handleNightAbility(player, charDef, isPoisoned, actionsContainer) {
            var charName = charDef.name;
            
            // Information roles - first night only (Washerwoman, Librarian, Investigator, Chef)
            var firstNightOnlyRoles = ['Washerwoman', 'Librarian', 'Investigator', 'Chef'];
            if (firstNightOnlyRoles.indexOf(player.character) !== -1) {
                if (currentDay === 1) {
                    var btn = document.createElement('button');
                    btn.className = 'action-btn';
                    btn.innerText = 'ุฏุงุฏู ุงุทูุงุนุงุช (ููุท ุดุจ ุงูู)';
                    btn.onclick = function() {
                        giveInformation(player, charDef, isPoisoned);
                    };
                    actionsContainer.appendChild(btn);
                } else {
                    // Not first night - no action for these roles
                    var btn = document.createElement('button');
                    btn.className = 'action-btn';
                    btn.innerText = 'ุงุฏุงูู (ููุท ุดุจ ุงูู - ุจุฏูู ุนูู)';
                    btn.onclick = function() {
                        addLog(charName + ' (' + player.name + ') - ุจุฏูู ุนูู (ุชูุงูุง ููุท ุดุจ ุงูู)');
                        skipNightAbility();
                    };
                    actionsContainer.appendChild(btn);
                }
            }
            
            // Empath - works every night
            if (player.character === 'Empath') {
                var btn = document.createElement('button');
                btn.className = 'action-btn';
                btn.innerText = 'ุฏุงุฏู ุงุทูุงุนุงุช';
                btn.onclick = function() {
                    giveInformation(player, charDef, isPoisoned);
                };
                actionsContainer.appendChild(btn);
            }
            
            // Fortune Teller - chooses a player first
            if (charName === 'ูุงูโฺฏุฑ') {
                var btn = document.createElement('button');
                btn.className = 'action-btn';
                btn.innerText = 'ุงูุชุฎุงุจ ุจุงุฒฺฉู ุจุฑุง ุจุฑุฑุณ';
                btn.onclick = function() {
                    chooseFortuneTellerTarget(player, isPoisoned);
                };
                actionsContainer.appendChild(btn);
            }
            
            // Undertaker (day ability, but included in night order)
            if (charName === 'ูุฑุฏูโุดู') {
                var btn = document.createElement('button');
                btn.className = 'action-btn';
                btn.innerText = 'ุฏุงุฏู ุงุทูุงุนุงุช (ุงฺฏุฑ ุฏุฑูุฒ ุงุนุฏุงู ุจูุฏ)';
                btn.onclick = function() {
                    giveUndertakerInfo(player, isPoisoned);
                };
                actionsContainer.appendChild(btn);
            }
            
            // Monk - protection
            if (charName === 'ุฑุงูุจ') {
                var btn = document.createElement('button');
                btn.className = 'action-btn';
                btn.innerText = 'ุงูุชุฎุงุจ ุจุงุฒฺฉู ุจุฑุง ูุญุงูุธุช';
                btn.onclick = function() {
                    chooseProtection(player);
                };
                actionsContainer.appendChild(btn);
            }
            
            // Butler - vote choice
            if (charName === 'ูพุดุฎุฏูุช') {
                var btn = document.createElement('button');
                btn.className = 'action-btn';
                btn.innerText = 'ุงูุชุฎุงุจ ุจุงุฒฺฉู ุจุฑุง ุฏูุจุงู ฺฉุฑุฏู';
                btn.onclick = function() {
                    chooseButlerTarget(player);
                };
                actionsContainer.appendChild(btn);
            }
            
            // Poisoner - poison choice
            if (charName === 'ุฒูุฑุขฺฏู') {
                var btn = document.createElement('button');
                btn.className = 'action-btn';
                btn.innerText = 'ุงูุชุฎุงุจ ุจุงุฒฺฉู ุจุฑุง ูุณููู ฺฉุฑุฏู';
                btn.onclick = function() {
                    choosePoisonTarget(player);
                };
                actionsContainer.appendChild(btn);
            }
            
            // Imp - kill choice
            if (charName === 'ุดุทุงู') {
                var btn = document.createElement('button');
                btn.className = 'action-btn';
                btn.innerText = 'ุงูุชุฎุงุจ ุจุงุฒฺฉู ุจุฑุง ฺฉุดุชู';
                btn.onclick = function() {
                    chooseKillTarget(player);
                };
                actionsContainer.appendChild(btn);
            }
            
            
            // Spy - can look at Grimoire
            if (charName === 'ุฌุงุณูุณ') {
                var btn = document.createElement('button');
                btn.className = 'action-btn';
                btn.innerText = 'ูุดุงูุฏู ุฏูุชุฑฺู';
                btn.onclick = function() {
                    showSpyGrimoire(player);
                };
                actionsContainer.appendChild(btn);
                
                var continueBtn = document.createElement('button');
                continueBtn.className = 'secondary-btn';
                continueBtn.style.marginTop = '10px';
                continueBtn.innerText = 'ุงุฏุงูู (ุนูู ูุงุฒู ูุณุช)';
                continueBtn.onclick = function() {
                    addLog('ุฌุงุณูุณ (' + player.name + ') - ุจุฏูู ุนูู ุดุจ');
                    skipNightAbility();
                };
                actionsContainer.appendChild(continueBtn);
            }
            
            // Characters with no active night ability (passive abilities)
            // Ravenkeeper's ability only triggers on death, so no night action needed
            var passiveCharacters = ['ุฒู ุณุฑุฎ', 'ุณุฑุจุงุฒ', 'ุดูุฑุฏุงุฑ', 'ุจุงฺฉุฑู', 'ุณูุงุฎ', 'ูฺฏูุจุงู ฺฉูุงุบ', 'ูุณุช', 'ฺฏูุดูโูุดู', 'ูุฏุณ', 'ุจุงุฑูู'];
            if (passiveCharacters.indexOf(charName) !== -1) {
                var btn = document.createElement('button');
                btn.className = 'action-btn';
                if (charName === 'ุฒู ุณุฑุฎ') {
                    btn.innerText = 'ุงุฏุงูู (ุบุฑูุนุงู: ุงฺฏุฑ ุดุทุงู ุจูุฑุฏ ุชุจุฏู ุจู ุดุทุงู ูโุดูุฏ)';
                } else {
                    btn.innerText = 'ุงุฏุงูู (ุจุฏูู ุนูู ุดุจ)';
                }
                btn.onclick = function() {
                    addLog(charName + ' (' + player.name + ') - No night action (passive ability)');
                    skipNightAbility();
                };
                actionsContainer.appendChild(btn);
            }
        }

        // Helper function to check if a player appears as evil to abilities
        // Recluse may appear as evil (Storyteller discretion)
        // Spy always appears as good
        function appearsAsEvil(targetPlayer) {
            // Spy always appears as good, even though they are a Minion
            if (targetPlayer.character === 'Spy') {
                return false;
            }
            if (targetPlayer.characterDef.type === 'minion' || targetPlayer.characterDef.type === 'demon') {
                return true;
            }
            // Recluse always registers as evil (Imp)
            if (targetPlayer.character === 'Recluse') {
                return true; // 100% chance to appear as evil (Imp)
            }
            return false;
        }
        
        // Helper function to check if a player appears as the Demon to Fortune Teller
        function appearsAsDemon(targetPlayer) {
            if (targetPlayer.characterDef.type === 'demon') {
                return true;
            }
            // Recluse can register as the Demon
            if (targetPlayer.character === 'Recluse') {
                return true;
            }
            return false;
        }

        function giveInformation(player, charDef, isPoisoned) {
            var charName = charDef.name;
            var info = '';
            
            // Drunk's ability "malfunctions" - they think they are a Townsfolk but get false/arbitrary info
            // We treat them as poisoned for the purpose of generating info
            if (player.character === 'Drunk') {
                isPoisoned = true;
                // Don't return early - let the code generate info for their fake role (charName)
                // The isPoisoned flag will ensure the info is randomized/false where applicable
            }
            
            // Storyteller discretion - simplified version
            if (charName === 'ุฑุฎุชโุดู') {
                var townsfolk = players.filter(p => p.characterDef.type === 'townsfolk' && p.name !== player.name);
                if (townsfolk.length > 0) {
                    shuffleArray(townsfolk);
                    var target1 = townsfolk[0];
                    var target2 = townsfolk.length > 1 ? townsfolk[1] : players[Math.floor(Math.random() * players.length)];
                    while (target2.name === target1.name) {
                        target2 = players[Math.floor(Math.random() * players.length)];
                    }
                    info = target1.name + ' ุง ' + target2.name + ' ' + target1.characterDef.name + ' ุงุณุช';
                } else {
                    info = 'ุดูุฑููุฏ ุฏฺฏุฑ ุฏุฑ ุจุงุฒ ูุณุช';
                }
            } else if (charName === 'ฺฉุชุงุจุฏุงุฑ') {
                var outsiders = players.filter(p => p.characterDef.type === 'outsider');
                if (outsiders.length > 0) {
                    shuffleArray(outsiders);
                    var target1 = outsiders[0];
                    var target2 = outsiders.length > 1 ? outsiders[1] : players[Math.floor(Math.random() * players.length)];
                    while (target2.name === target1.name) {
                        target2 = players[Math.floor(Math.random() * players.length)];
                    }
                    info = target1.name + ' ุง ' + target2.name + ' ' + target1.characterDef.name + ' ุงุณุช';
                } else {
                    info = 'ุบุฑุจูโุง ุฏุฑ ุจุงุฒ ูุณุช';
                }
            } else if (charName === 'ุจุงุฒูพุฑุณ') {
                // Spy appears as good, so exclude them from Minion detection
                var minions = players.filter(p => p.characterDef.type === 'minion' && p.character !== 'Spy');
                if (minions.length > 0) {
                    shuffleArray(minions);
                    var target1 = minions[0];
                    var target2 = minions.length > 1 ? minions[1] : players[Math.floor(Math.random() * players.length)];
                    while (target2.name === target1.name) {
                        target2 = players[Math.floor(Math.random() * players.length)];
                    }
                    info = target1.name + ' ุง ' + target2.name + ' ' + target1.characterDef.name + ' ุงุณุช';
                } else {
                    info = 'ุฎุงุฏู ุดุทุงู ุฏุฑ ุจุงุฒ ูุณุช';
                }
            } else if (charName === 'ุขุดูพุฒ') {
                // Count pairs of evil players sitting next to each other
                // Recluse may appear as evil
                var evilCount = 0;
                for (var i = 0; i < players.length; i++) {
                    var p1 = players[i];
                    var p2 = players[(i + 1) % players.length];
                    if (p1.alive && p2.alive && appearsAsEvil(p1) && appearsAsEvil(p2)) {
                        evilCount++;
                    }
                }
                    info = evilCount + ' ุฌูุช ุจุงุฒฺฉู ุดุฑุฑ ฺฉูุงุฑ ูู ูุดุณุชู ' + (evilCount === 1 ? 'ุงุณุช' : 'ุงูุฏ');
            } else if (charName === 'ููโุฏู') {
                // If Empath is dead, they learn 0
                if (!player.alive) {
                    info = 'ฐ ุจุงุฒฺฉู ุดุฑุฑ ฺฉูุงุฑ ุดูุง ูุดุณุชู ุงุณุช';
                } else {
                    var playerIndex = player.index;
                    
                    // Find the two closest living neighbors (skip dead players)
                    var leftNeighbor = null;
                    var rightNeighbor = null;
                    
                    // Find left neighbor (going backwards, skipping dead players)
                    for (var i = 1; i < players.length; i++) {
                        var leftIndex = (playerIndex - i + players.length) % players.length;
                        if (players[leftIndex].alive) {
                            leftNeighbor = players[leftIndex];
                            break;
                        }
                    }
                    
                    // Find right neighbor (going forwards, skipping dead players)
                    for (var i = 1; i < players.length; i++) {
                        var rightIndex = (playerIndex + i) % players.length;
                        if (players[rightIndex].alive) {
                            rightNeighbor = players[rightIndex];
                            break;
                        }
                    }
                    
                    var evilCount = 0;
                    // Recluse may appear as evil
                    if (leftNeighbor && appearsAsEvil(leftNeighbor)) {
                        evilCount++;
                    }
                    if (rightNeighbor && appearsAsEvil(rightNeighbor)) {
                        evilCount++;
                    }
                    
                    info = evilCount + ' ุจุงุฒฺฉู ุดุฑุฑ ฺฉูุงุฑ ุดูุง ูุดุณุชู ' + (evilCount === 1 ? 'ุงุณุช' : 'ุงูุฏ');
                }
            }
            
            if (isPoisoned && info !== '') {
                // Give false information
                var randomPlayer = players[Math.floor(Math.random() * players.length)];
                while (!randomPlayer.alive || randomPlayer.name === player.name) {
                    randomPlayer = players[Math.floor(Math.random() * players.length)];
                }
                if (charName === 'ุขุดูพุฒ') {
                    var fakeCount = Math.floor(Math.random() * 3);
                    info = fakeCount + ' ุฌูุช ุจุงุฒฺฉู ุดุฑุฑ ฺฉูุงุฑ ูู ูุดุณุชู ' + (fakeCount === 1 ? 'ุงุณุช' : 'ุงูุฏ');
                } else if (charName === 'ููโุฏู') {
                    // Empath should get wrong info when poisoned, not "no info"
                    var fakeCount = Math.floor(Math.random() * 3);
                    info = fakeCount + ' ุจุงุฒฺฉู ุดุฑุฑ ฺฉูุงุฑ ุดูุง ูุดุณุชู ' + (fakeCount === 1 ? 'ุงุณุช' : 'ุงูุฏ');
                } else {
                    info = randomPlayer.name;
                }
            }
            
            // Ensure info is set (but if Empath is poisoned, we already set fake info above)
            if (!info || info === '') {
                info = 'ุงุทูุงุนุงุช ุฏุฑ ุฏุณุชุฑุณ ูุณุช';
            }
            
            // Initialize playerInfo array if needed
            if (!playerInfo[player.index]) {
                playerInfo[player.index] = [];
            }
            
            playerInfo[player.index].push({
                night: currentDay,
                info: info,
                character: charName
            });
            
            addLog(charName + ' (' + player.name + ') ุงุทูุงุนุงุช ุฏุฑุงูุช ฺฉุฑุฏ: ' + info);
            
            // Show information to player
            showInformationToPlayer(player, charName, info);
        }

        function showInformationToPlayer(player, charName, info) {
            // Hide night modal content but keep modal open to hide game screen
            // Show information modal on top
            document.getElementById('info-character-name').innerText = charName;
            document.getElementById('info-player-name').innerText = player.name;
            document.getElementById('info-text').innerText = info;
            document.getElementById('info-modal').classList.remove('hidden');
            // Keep night modal open but hidden behind info modal
        }

        function closeInfoModal() {
            document.getElementById('info-modal').classList.add('hidden');
            // If Ravenkeeper just used their ability (they're dead), update display and continue
            var currentPlayer = currentNightOrder[nightIndex] ? currentNightOrder[nightIndex].player : null;
            if (currentPlayer && !currentPlayer.alive && currentPlayer.character === 'Ravenkeeper') {
                updateGameDisplay();
            }
            // Move to next character - night modal should still be open to hide game screen
            nightIndex++;
            processNightPhase();
        }

        function giveUndertakerInfo(player, isPoisoned) {
            // Only works if someone was executed yesterday (the previous day)
            // Check if someone was executed on the previous day
            if (currentDay > 1 && lastExecutionDay === currentDay - 1 && lastExecutedPlayer) {
                var info = lastExecutedPlayer.name + ' ' + lastExecutedPlayer.characterDef.name + ' ุจูุฏ';
                    if (isPoisoned) {
                    // Give false information - random wrong character
                    var allCharacters = Object.keys(CHARACTERS);
                    var randomChar = allCharacters[Math.floor(Math.random() * allCharacters.length)];
                    while (randomChar === lastExecutedPlayer.character) {
                        randomChar = allCharacters[Math.floor(Math.random() * allCharacters.length)];
                    }
                    info = lastExecutedPlayer.name + ' ' + CHARACTERS[randomChar].name + ' ุจูุฏ (ุงุทูุงุนุงุช ูุงุฏุฑุณุช ุจู ุฏูู ูุณูููุช)';
                    }
                    
                    if (!playerInfo[player.index]) {
                        playerInfo[player.index] = [];
                    }
                    playerInfo[player.index].push({
                        day: currentDay,
                        info: info,
                        character: 'ูุฑุฏูโุดู'
                    });
                    
                    addLog('ูุฑุฏูโุดู (' + player.name + ') ุงุทูุงุนุงุช ุฏุฑุงูุช ฺฉุฑุฏ: ' + info);
                    showInformationToPlayer(player, 'ูุฑุฏูโุดู', info);
                    return;
            }
            // No execution yesterday or first night
            showInformationToPlayer(player, 'ูุฑุฏูโุดู', 'ุฏุฑูุฒ ฺฉุณ ุงุนุฏุงู ูุดุฏ');
        }

        function chooseProtection(monkPlayer) {
            var list = document.createElement('div');
            list.style.marginTop = '15px';
            
            players.forEach(function(p) {
                if (p.alive && p.name !== monkPlayer.name) {
                    var btn = document.createElement('button');
                    btn.className = 'player-select-btn';
                    btn.style.marginTop = '10px';
                    btn.innerText = p.name;
                    btn.onclick = function() {
                        protectedPlayers = [p.index];
                        addLog('ุฑุงูุจ (' + monkPlayer.name + ') ุงุฒ ' + p.name + ' ูุญุงูุธุช ฺฉุฑุฏ');
                        nextNightAction();
                    };
                    list.appendChild(btn);
                }
            });
            
            document.getElementById('night-character-actions').innerHTML = '';
            document.getElementById('night-character-actions').appendChild(list);
        }

        function chooseButlerTarget(butlerPlayer) {
            var list = document.createElement('div');
            list.style.marginTop = '15px';
            
            players.forEach(function(p) {
                if (p.alive && p.name !== butlerPlayer.name) {
                    var btn = document.createElement('button');
                    btn.className = 'player-select-btn';
                    btn.style.marginTop = '10px';
                    btn.innerText = p.name;
                    btn.onclick = function() {
                        butlerChoices[butlerPlayer.index] = p.index;
                        addLog('ูพุดุฎุฏูุช (' + butlerPlayer.name + ') ุฑุง ' + p.name + ' ุฑุง ุฏูุจุงู ุฎูุงูุฏ ฺฉุฑุฏ');
                        nextNightAction();
                    };
                    list.appendChild(btn);
                }
            });
            
            document.getElementById('night-character-actions').innerHTML = '';
            document.getElementById('night-character-actions').appendChild(list);
        }

        function triggerRavenkeeperAbility(ravenkeeperPlayer) {
            // Ravenkeeper died at night - show their ability
            var container = document.getElementById('night-character-actions');
            container.innerHTML = '';
            
            var instructionDiv = document.createElement('div');
            instructionDiv.style.marginBottom = '15px';
            instructionDiv.innerHTML = '<p style="margin-bottom:15px; font-weight: bold; color: var(--accent-color);">ูฺฏูุจุงู ุฒุงุบ (' + ravenkeeperPlayer.name + ') ุฏุฑ ุดุจ ูุฑุฏ. ฺฉ ุจุงุฒฺฉู ุฑุง ุงูุชุฎุงุจ ฺฉูุฏ ุชุง ุดุฎุตุช ุงู ุฑุง ุงุฏ ุจฺฏุฑุฏ:</p>';
            container.appendChild(instructionDiv);
            
            var list = document.createElement('div');
            list.style.marginTop = '15px';
            
            players.forEach(function(p) {
                if (p.name !== ravenkeeperPlayer.name) {
                    var btn = document.createElement('button');
                    btn.className = 'player-select-btn';
                    btn.style.marginTop = '10px';
                    btn.innerText = p.name;
                    btn.onclick = function() {
                        var info = p.name + ' ' + p.characterDef.name + ' ุงุณุช';
                        
                        if (!playerInfo[ravenkeeperPlayer.index]) {
                            playerInfo[ravenkeeperPlayer.index] = [];
                        }
                        playerInfo[ravenkeeperPlayer.index].push({
                            night: currentDay,
                            info: info,
                            character: 'Ravenkeeper'
                        });
                        
                        addLog('ูฺฏูุจุงู ุฒุงุบ (' + ravenkeeperPlayer.name + ') ุงุฏ ฺฏุฑูุช: ' + info);
                        // Update game display to show Ravenkeeper is dead
                        updateGameDisplay();
                        showInformationToPlayer(ravenkeeperPlayer, 'ูฺฏูุจุงู ุฒุงุบ', info);
                        // After showing info, continue night phase
                        // The info modal will handle continuing
                    };
                    list.appendChild(btn);
                }
            });
            
            container.appendChild(list);
            
            // Update night character display
            document.getElementById('night-character-name').innerText = 'ูฺฏูุจุงู ุฒุงุบ';
            document.getElementById('night-player-name').innerText = ravenkeeperPlayer.name;
            document.getElementById('night-character-info').innerText = 'ุงฺฏุฑ ุฏุฑ ุดุจ ุจูุฑุฏุ ฺฉ ุจุงุฒฺฉู ุฑุง ุงูุชุฎุงุจ ฺฉูุฏ: ุดุฎุตุช ุงู ุฑุง ุงุฏ ุจฺฏุฑุฏ.';
        }

        function chooseFortuneTellerTarget(fortuneTellerPlayer, isPoisoned) {
            var container = document.getElementById('night-character-actions');
            container.innerHTML = '';
            
            var instructionDiv = document.createElement('div');
            instructionDiv.style.marginBottom = '15px';
            instructionDiv.id = 'fortune-teller-instruction';
            instructionDiv.innerHTML = '<p style="margin-bottom:15px; font-weight: bold;">ูุงูโฺฏุฑ: ุฏู ุจุงุฒฺฉู ุฑุง ุงูุชุฎุงุจ ฺฉูุฏ:</p>';
            container.appendChild(instructionDiv);
            
            var list = document.createElement('div');
            list.style.marginTop = '15px';
            
            var selectedPlayers = [];
            
            players.forEach(function(p) {
                if (p.alive && p.name !== fortuneTellerPlayer.name) {
                    var btn = document.createElement('button');
                    btn.className = 'player-select-btn';
                    btn.style.marginTop = '10px';
                    btn.innerText = p.name;
                    btn.dataset.playerIndex = p.index;
                    
                    btn.onclick = function() {
                        if (selectedPlayers.indexOf(p.index) === -1 && selectedPlayers.length < 2) {
                            selectedPlayers.push(p.index);
                            btn.style.background = 'rgba(183, 28, 28, 0.4)';
                            btn.style.border = '3px solid var(--accent-color)';
                            btn.innerText = p.name + ' โ';
                            btn.disabled = true;
                            
                            if (selectedPlayers.length === 1) {
                                instructionDiv.innerHTML = '<p style="margin-bottom:15px; font-weight: bold;">ูุงูโฺฏุฑ: ฺฉ ุจุงุฒฺฉู ุฏฺฏุฑ ุงูุชุฎุงุจ ฺฉูุฏ:</p>';
                            } else if (selectedPlayers.length === 2) {
                                giveFortuneTellerInfo(fortuneTellerPlayer, selectedPlayers, isPoisoned);
                            }
                        }
                    };
                    
                    list.appendChild(btn);
                }
            });
            
            container.appendChild(list);
        }

        function giveFortuneTellerInfo(fortuneTellerPlayer, selectedPlayerIndices, isPoisoned) {
            var player1 = players.find(p => p.index === selectedPlayerIndices[0]);
            var player2 = players.find(p => p.index === selectedPlayerIndices[1]);
            
            // First night: Designate a red herring if not already set
            if (currentDay === 1 && !fortuneTellerRedHerrings[fortuneTellerPlayer.index]) {
                // Select a random good player (not the Demon or Minions) as the red herring
                var goodPlayers = players.filter(p => 
                    p.alive && 
                    p.index !== fortuneTellerPlayer.index && 
                    p.characterDef.type !== 'demon' && 
                    p.characterDef.type !== 'minion'
                );
                if (goodPlayers.length > 0) {
                    var redHerring = goodPlayers[Math.floor(Math.random() * goodPlayers.length)];
                    fortuneTellerRedHerrings[fortuneTellerPlayer.index] = redHerring.index;
                    addLog('ูุงูโฺฏุฑ (' + fortuneTellerPlayer.name + ') ูุดุงูู ฺฉุงุฐุจ ุชุนู ุดุฏ: ' + redHerring.name);
                }
            }
            
            var info = '';
            var isDemon1 = appearsAsDemon(player1);
            var isDemon2 = appearsAsDemon(player2);
            var isRedHerring1 = fortuneTellerRedHerrings[fortuneTellerPlayer.index] === player1.index;
            var isRedHerring2 = fortuneTellerRedHerrings[fortuneTellerPlayer.index] === player2.index;
            
                if (isPoisoned) {
                // Poisoned - give random false information
                info = Math.random() > 0.5 ? 'ุจูู' : 'ุฎุฑ';
            } else if (isDemon1 || isDemon2 || isRedHerring1 || isRedHerring2) {
                // One of them is the Demon (or Recluse) OR the red herring
                info = 'ุจูู';
                    } else {
                // Neither is the Demon nor the red herring
                info = 'ุฎุฑ';
            }
            
            if (!playerInfo[fortuneTellerPlayer.index]) {
                playerInfo[fortuneTellerPlayer.index] = [];
            }
            
            playerInfo[fortuneTellerPlayer.index].push({
                night: currentDay,
                info: 'ุขุง ฺฉ ุงุฒ ' + player1.name + ' ุง ' + player2.name + ' ุดุทุงู ุงุณุชุ ' + info,
                character: 'ูุงูโฺฏุฑ',
                targets: player1.name + ' ู ' + player2.name
            });
            
            addLog('ูุงูโฺฏุฑ (' + fortuneTellerPlayer.name + ') ' + player1.name + ' ู ' + player2.name + ' ุฑุง ุจุฑุฑุณ ฺฉุฑุฏ - ุฏุฑุงูุช ฺฉุฑุฏ: ' + info);
            showInformationToPlayer(fortuneTellerPlayer, 'ูุงูโฺฏุฑ', 'ุขุง ฺฉ ุงุฒ ' + player1.name + ' ุง ' + player2.name + ' ุดุทุงู ุงุณุชุ ' + info);
        }

        function choosePoisonTarget(poisonerPlayer) {
            var list = document.createElement('div');
            list.style.marginTop = '15px';
            
            // Find Poisoner's position in the actual night sequence
            var poisonerSequenceIndex = -1;
            for (var i = 0; i < currentNightOrder.length; i++) {
                if (currentNightOrder[i].player.index === poisonerPlayer.index) {
                    poisonerSequenceIndex = i;
                    break;
                }
            }
            
            players.forEach(function(p) {
                if (p.alive && p.name !== poisonerPlayer.name) {
                    var btn = document.createElement('button');
                    btn.className = 'player-select-btn';
                    btn.style.marginTop = '10px';
                    btn.innerText = p.name;
                    
                    // Find target's position in the actual night sequence
                    var targetSequenceIndex = -1;
                    for (var j = 0; j < currentNightOrder.length; j++) {
                        if (currentNightOrder[j].player.index === p.index) {
                            targetSequenceIndex = j;
                            break;
                        }
                    }
                    
                    var appliesThisNight = false;
                    var appliesNextNight = false;
                    
                    // Determine when poison applies based on actual sequence position
                    if (targetSequenceIndex === -1) {
                        // Character not in night sequence (day ability only) - poisoned for day phase
                        appliesThisNight = true;
                        btn.innerText += ' (poisoned for day)';
                    } else if (targetSequenceIndex < poisonerSequenceIndex) {
                        // Target comes BEFORE Poisoner in sequence - poisoned for NEXT night
                        appliesNextNight = true;
                        btn.innerText += ' (poisoned for next night)';
                    } else if (targetSequenceIndex > poisonerSequenceIndex) {
                        // Target comes AFTER Poisoner in sequence - poisoned for THIS night
                        appliesThisNight = true;
                        btn.innerText += ' (poisoned for this night)';
                    } else {
                        // Same position (shouldn't happen, but handle it)
                        appliesThisNight = true;
                        btn.innerText += ' (poisoned for this night)';
                    }
                    
                    btn.onclick = function() {
                        // Remove any existing poison for this player
                        poisonedPlayers = poisonedPlayers.filter(poison => poison.playerIndex !== p.index);
                        
                        // Add new poison entry
                        var appliesNight = appliesNextNight ? currentDay + 1 : currentDay;
                        poisonedPlayers.push({
                            playerIndex: p.index,
                            poisonedNight: currentDay,
                            appliesNight: appliesNight
                        });
                        
                        var whenText = appliesNextNight ? 'next night' : (appliesThisNight ? 'this night/day' : 'next activation');
                        addLog('Poisoner (' + poisonerPlayer.name + ') poisoned ' + p.name + ' (effect applies ' + whenText + ')');
                        nextNightAction();
                    };
                    list.appendChild(btn);
                }
            });
            
            document.getElementById('night-character-actions').innerHTML = '';
            document.getElementById('night-character-actions').appendChild(list);
        }

        function chooseKillTarget(impPlayer) {
            // First night: Imp doesn't kill, but learns 3 roles not in the game
            if (currentDay === 1 && isNightPhase) {
                addLog('ุดุจ ุงูู: ุดุทุงู ฺฉุณ ุฑุง ููโฺฉุดุฏ');
                
                // Get all possible GOOD roles (Townsfolk and Outsiders only - not Minions/Demons)
                var allGoodRoles = TOWNSFOLK_POOL.concat(OUTSIDER_POOL);
                // Get roles in the game
                var rolesInGame = players.map(p => {
                    // Find the character key from the characterDef
                    for (var key in CHARACTERS) {
                        if (CHARACTERS[key].name === p.characterDef.name) {
                            return key;
                        }
                    }
                    return null;
                }).filter(r => r !== null);
                
                // Find GOOD roles NOT in the game (Imp learns about good characters they can claim to be)
                var rolesNotInGame = allGoodRoles.filter(r => rolesInGame.indexOf(r) === -1);
                shuffleArray(rolesNotInGame);
                
                // Show message with 3 roles not in game
                var actions = document.getElementById('night-character-actions');
                var infoText = '<div style="padding: 15px; background: rgba(213, 0, 0, 0.2); border: 2px solid var(--demon-color); border-radius: 8px; margin: 15px 0;">';
                infoText += '<p style="color: var(--text-primary); font-weight: bold; margin-bottom: 10px;">ุดุจ ุงูู: ุดุทุงู ฺฉุณ ุฑุง ููโฺฉุดุฏ.</p>';
                infoText += '<p style="color: var(--text-primary); margin-top: 15px; font-weight: bold;">ุณู ุดุฎุตุช ฺฉู ุฏุฑ ุงู ุจุงุฒ ูุณุชูุฏ:</p>';
                infoText += '<ul style="margin: 10px 0; padding-right: 20px;">';
                for (var i = 0; i < 3 && i < rolesNotInGame.length; i++) {
                    infoText += '<li style="margin: 5px 0;">' + CHARACTERS[rolesNotInGame[i]].name + '</li>';
                }
                infoText += '</ul></div>';
                actions.innerHTML = infoText;
                
                // Store this info for the Imp
                if (!playerInfo[impPlayer.index]) {
                    playerInfo[impPlayer.index] = [];
                }
                var rolesList = rolesNotInGame.slice(0, 3).map(r => CHARACTERS[r].name).join('ุ ');
                playerInfo[impPlayer.index].push({
                    night: currentDay,
                    info: 'ุณู ุดุฎุตุช ฺฉู ุฏุฑ ุงู ุจุงุฒ ูุณุชูุฏ: ' + rolesList,
                    character: 'ุดุทุงู'
                });
                
                var btn = document.createElement('button');
                btn.className = 'action-btn';
                btn.innerText = 'ุงุฏุงูู';
                btn.onclick = function() {
                    nextNightAction();
                };
                actions.appendChild(btn);
                return;
            }
            
            var list = document.createElement('div');
            list.style.marginTop = '15px';
            
            var livingPlayers = players.filter(p => p.alive && p.name !== impPlayer.name);
            
            if (livingPlayers.length === 0) {
                var actions = document.getElementById('night-character-actions');
                actions.innerHTML = '<p style="color: var(--text-secondary);">ุจุงุฒฺฉู ุฒูุฏู ุฏฺฏุฑ ุจุฑุง ฺฉุดุชู ูุฌูุฏ ูุฏุงุฑุฏ.</p>';
                var btn = document.createElement('button');
                btn.className = 'action-btn';
                btn.innerText = 'ุงุฏุงูู';
                btn.onclick = function() {
                    nextNightAction();
                };
                actions.appendChild(btn);
                return;
            }
            
            list.innerHTML = '<p style="margin-bottom: 15px; font-weight: bold;">ุจุงุฒฺฉู ุฑุง ุจุฑุง ฺฉุดุชู ุงูุชุฎุงุจ ฺฉูุฏ:</p>';
            
            livingPlayers.forEach(function(p) {
                var btn = document.createElement('button');
                btn.className = 'player-select-btn';
                btn.style.marginTop = '10px';
                btn.innerText = p.name;
                // Don't show protection status to Imp - they shouldn't know who is protected
                
                btn.onclick = function() {
                    // Mark player for death (will be resolved at end of night)
                    // This allows Monk to protect them even if Monk acts after Imp
                    markedForDeath = p;
                    addLog('ุดุทุงู ' + p.name + ' ุฑุง ูุฏู ูุฑุงุฑ ุฏุงุฏ');
                    // Move to next character without closing modal (to hide game screen)
                    nightIndex++;
                    processNightPhase();
                };
                list.appendChild(btn);
            });
            
            // Add self-kill (Starpass) option
            var selfKillBtn = document.createElement('button');
            selfKillBtn.className = 'player-select-btn';
            selfKillBtn.style.marginTop = '15px';
            selfKillBtn.style.background = 'linear-gradient(135deg, rgba(139, 0, 0, 0.5), rgba(178, 34, 34, 0.5))';
            selfKillBtn.style.border = '2px solid rgba(255, 0, 0, 0.6)';
            selfKillBtn.innerText = 'ุฎูุฏุชุงู - ุงูุชูุงู ุดุทุงู';
            selfKillBtn.onclick = function() {
                // Find living Minions
                var livingMinions = players.filter(p => p.alive && p.characterDef.type === 'minion' && p.name !== impPlayer.name);
                
                if (livingMinions.length === 0) {
                    alert('ูฺ ุฎุงุฏู ุฒูุฏูโุง ุจุฑุง ุงูุชูุงู ููุด ุดุทุงู ูุฌูุฏ ูุฏุงุฑุฏ.');
                    return;
                }
                
                // Imp kills itself and passes role to a random Minion
                markedForDeath = impPlayer;
                
                // Randomly select a living Minion to become the new Imp
                var newImp = livingMinions[Math.floor(Math.random() * livingMinions.length)];
                newImp.characterDef = CHARACTERS['Imp'];
                
                addLog('ุดุทุงู (' + impPlayer.name + ') ุฎูุฏ ุฑุง ฺฉุดุช ู ' + newImp.name + ' ุชุจุฏู ุจู ุดุทุงู ุฌุฏุฏ ุดุฏ!');
                
                nightIndex++;
                processNightPhase();
            };
            list.appendChild(selfKillBtn);
            
            document.getElementById('night-character-actions').innerHTML = '';
            document.getElementById('night-character-actions').appendChild(list);
        }

        function skipNightAbility() {
            nextNightAction();
        }

        function nextNightAction() {
            // Don't close modal yet - keep it open to hide the game screen
            nightIndex++;
            // Process next phase immediately without closing modal
            processNightPhase();
        }

        function startDayPhase() {
            // Clear protection (lasts until next day)
            protectedPlayers = [];
            // Clear poisoning that was applied this night (one-time effect)
            poisonedPlayers = poisonedPlayers.filter(poison => {
                // Keep poisons that apply next night, remove ones that applied this night
                return poison.appliesNight > currentDay;
            });
            
            // Update game display to reflect any deaths that occurred during the night
            updateGameDisplay();
            
            isNightPhase = false;
            document.getElementById('phase-display').className = 'phase-display phase-day';
            document.getElementById('phase-title').innerText = 'ุฑูุฒ ' + currentDay;
            
            // Calculate important day phase info
            var livingPlayers = players.filter(p => p.alive);
            var livingCount = livingPlayers.length;
            var deadCount = players.length - livingCount;
            var votesNeeded = Math.floor(livingCount / 2) + 1; // Majority = more than half
            
            // Check for special conditions
            var specialConditions = '';
            if (livingCount === 2) {
                specialConditions += '<div style="background: rgba(244, 67, 54, 0.2); padding: 10px; border-radius: 5px; margin-top: 10px; border: 2px solid var(--evil-color); text-align: right;">' +
                    '<strong style="color: var(--evil-color);">โ๏ธ ุฏู ููุฑ ููุง:</strong> <strong>ุดุฑุฑุงู ุจุฑูุฏู ูโุดููุฏ</strong> - ุจุงุฒ ุชูุงู ุดุฏ!' +
                    '</div>';
            }
            
            // Check for deaths during the night
            var nightDeathsHTML = '';
            var deadPlayers = players.filter(p => !p.alive && p.diedAtNight === currentDay);
            if (deadPlayers.length > 0) {
                var deathNames = deadPlayers.map(p => p.name).join('ุ ');
                nightDeathsHTML = 
                    '<div id="night-death-announcement" onclick="this.remove()" style="background: linear-gradient(135deg, rgba(156, 39, 176, 0.4) 0%, rgba(123, 31, 162, 0.25) 100%); padding: 40px 30px; border-radius: 20px; text-align: center; margin-bottom: 35px; border: 4px solid #9c27b0; box-shadow: 0 12px 32px rgba(156, 39, 176, 0.6), inset 0 2px 4px rgba(255,255,255,0.1); animation: pulseGlow 2s ease-in-out infinite; direction: rtl; cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform=\'scale(0.98)\'" onmouseout="this.style.transform=\'scale(1)\'">' +
                    '<div style="font-size: 5rem; margin-bottom: 15px; animation: fadeIn 1s;">โ๏ธ</div>' +
                    '<h2 style="font-size: 2.2rem; font-weight: bold; color: #fff; text-shadow: 0 4px 8px rgba(0,0,0,0.8), 0 0 30px rgba(156, 39, 176, 0.8); margin: 0 0 15px 0; text-transform: uppercase; letter-spacing: 3px;">ูุฑฺฏ ุฏุฑ ุดุจ</h2>' +
                    '<p style="font-size: 1.8rem; font-weight: 700; color: #e1bee7; text-shadow: 0 2px 4px rgba(0,0,0,0.5); margin: 0;">' + deathNames + '</p>' +
                    '<p style="font-size: 1.2rem; color: rgba(255,255,255,0.7); margin-top: 10px; font-style: italic;">ูุฑุฏู ูพุฏุง ุดุฏ</p>' +
                    '<p style="font-size: 0.9rem; color: rgba(255,255,255,0.5); margin-top: 15px; font-style: italic;">ุจุฑุง ุจุณุชู ฺฉูฺฉ ฺฉูุฏ</p>' +
                    '</div>';
            } else if (currentDay > 1) {
                nightDeathsHTML = 
                    '<div id="night-death-announcement" onclick="this.remove()" style="background: linear-gradient(135deg, rgba(76, 175, 80, 0.3) 0%, rgba(76, 175, 80, 0.15) 100%); padding: 30px; border-radius: 16px; text-align: center; margin-bottom: 30px; border: 3px solid var(--good-color); box-shadow: 0 8px 24px rgba(76, 175, 80, 0.4); direction: rtl; cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform=\'scale(0.98)\'" onmouseout="this.style.transform=\'scale(1)\'">' +
                    '<div style="font-size: 3.5rem; margin-bottom: 10px;">โจ</div>' +
                    '<h3 style="font-size: 1.6rem; font-weight: bold; color: var(--good-color); text-shadow: 0 2px 4px rgba(0,0,0,0.5); margin: 0;">ูฺ ูุฑฺฏ ุฏุฑ ุงู ุดุจ</h3>' +
                    '<p style="font-size: 1rem; color: var(--text-secondary); margin-top: 8px;">ุฏูฺฉุฏู ฺฉ ุดุจ ุฏฺฏุฑ ุฌุงู ุณุงูู ุจู ุฏุฑ ุจุฑุฏ</p>' +
                    '<p style="font-size: 0.9rem; color: rgba(255,255,255,0.4); margin-top: 10px; font-style: italic;">ุจุฑุง ุจุณุชู ฺฉูฺฉ ฺฉูุฏ</p>' +
                    '</div>';
            }
            
            document.getElementById('phase-content').innerHTML = 
                nightDeathsHTML +
                '<!-- Critical Stats Cards -->' +
                '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-bottom: 30px; direction: rtl;">' +
                
                '<!-- Living Players Card -->' +
                '<div style="background: linear-gradient(135deg, rgba(76, 175, 80, 0.3) 0%, rgba(76, 175, 80, 0.15) 100%); padding: 30px 20px; border-radius: 16px; text-align: center; border: 3px solid var(--good-color); box-shadow: 0 8px 24px rgba(76, 175, 80, 0.4), inset 0 1px 0 rgba(255,255,255,0.1); position: relative; overflow: hidden; transition: transform 0.2s;">' +
                '<div style="position: absolute; top: -50%; right: -50%; width: 200%; height: 200%; background: radial-gradient(circle, rgba(76, 175, 80, 0.1) 0%, transparent 70%);"></div>' +
                '<div style="position: relative; z-index: 1;">' +
                '<div style="font-size: 4.5rem; font-weight: 900; color: var(--good-color); text-shadow: 0 4px 8px rgba(0,0,0,0.5), 0 0 20px rgba(76, 175, 80, 0.3); margin-bottom: 12px; line-height: 1;">' + livingCount + '</div>' +
                '<div style="font-size: 1.1rem; color: var(--text-primary); font-weight: 600; text-transform: uppercase; letter-spacing: 2px;">ุจุงุฒฺฉู ุฒูุฏู</div>' +
                '</div>' +
                '</div>' +
                
                '<!-- Votes Needed Card -->' +
                '<div style="background: linear-gradient(135deg, rgba(244, 67, 54, 0.3) 0%, rgba(244, 67, 54, 0.15) 100%); padding: 30px 20px; border-radius: 16px; text-align: center; border: 3px solid var(--accent-color); box-shadow: 0 8px 24px rgba(244, 67, 54, 0.4), inset 0 1px 0 rgba(255,255,255,0.1); position: relative; overflow: hidden; transition: transform 0.2s;">' +
                '<div style="position: absolute; top: -50%; right: -50%; width: 200%; height: 200%; background: radial-gradient(circle, rgba(244, 67, 54, 0.1) 0%, transparent 70%);"></div>' +
                '<div style="position: relative; z-index: 1;">' +
                '<div style="font-size: 4.5rem; font-weight: 900; color: var(--accent-color); text-shadow: 0 4px 8px rgba(0,0,0,0.5), 0 0 20px rgba(244, 67, 54, 0.3); margin-bottom: 12px; line-height: 1;">' + votesNeeded + '</div>' +
                '<div style="font-size: 1.1rem; color: var(--text-primary); font-weight: 600; text-transform: uppercase; letter-spacing: 2px;">ุฑุง ุจุฑุง ุงุนุฏุงู</div>' +
                '</div>' +
                '</div>' +
                
                '</div>' +
                
                specialConditions;
            
            var actions = document.getElementById('action-buttons');
            actions.innerHTML = 
                '<!-- Action Buttons -->' +
                '<div style="display: grid; gap: 15px; margin-bottom: 30px;">' +
                '<button class="action-btn" onclick="openExecutionSelection()" style="font-size: 1.1rem; padding: 18px; background: linear-gradient(135deg, #c62828 0%, #b71c1c 100%); box-shadow: 0 6px 20px rgba(198, 40, 40, 0.6); border: none; color: #fff; font-weight: 700;">๐ช ุซุจุช ุงุนุฏุงู</button>' +
                '<button class="secondary-btn" onclick="openSlayerAbility()" style="font-size: 1rem; padding: 15px; background: linear-gradient(135deg, #f57c00 0%, #e65100 100%); border: 2px solid #ff9800; color: #fff; font-weight: 600; box-shadow: 0 4px 16px rgba(245, 124, 0, 0.5);"><span style="font-size: 1.5rem;">โ๏ธ</span> ุณูุงุฎ</button>' +
                '<button class="secondary-btn" onclick="endDay()" style="font-size: 1rem; padding: 15px; background: linear-gradient(135deg, #5e35b1 0%, #4527a0 100%); border: 2px solid #7e57c2; color: #fff; font-weight: 600; box-shadow: 0 4px 16px rgba(94, 53, 177, 0.5);">๐ ุจุฏูู ุงุนุฏุงู - ูพุงุงู ุฑูุฒ</button>' +
                '</div>' +
                '<details style="background: rgba(0,0,0,0.2); padding: 20px; border-radius: 12px; cursor: pointer; border: 1px solid rgba(255,255,255,0.05); margin-bottom: 20px; text-align: right; direction: rtl;">' +
                '<summary style="font-weight: 600; font-size: 1rem; cursor: pointer; user-select: none; color: var(--text-secondary); display: flex; align-items: center; gap: 10px; direction: rtl;">' +
                '<span style="font-size: 1.2rem;">๐</span><span>ููุงูู ุชูุตู ุงุนุฏุงู</span>' +
                '</summary>' +
                '<div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1);">' +
                '<ul style="margin: 0; padding-right: 25px; font-size: 0.9rem; line-height: 2; color: var(--text-secondary);">' +
                '<li><strong style="color: var(--text-primary);">ูุงูุฒุฏฺฉุฑุฏู:</strong> ูุฑ ุจุงุฒฺฉู ุฒูุฏู ูโุชูุงูุฏ ุจุงุฒฺฉู ุฏฺฏุฑ ุฑุง ูุงูุฒุฏ ฺฉูุฏ</li>' +
                '<li><strong style="color: var(--text-primary);">ฺฉ ูุงูุฒุฏ ุจู ุงุฒุง ูุฑ ุจุงุฒฺฉู:</strong> ูุฑ ุจุงุฒฺฉู ฺฉ ุจุงุฑ ุฏุฑ ุฑูุฒ ูุงูุฒุฏ ูโฺฉูุฏ</li>' +
                '<li><strong style="color: var(--text-primary);">ุฑุงโฺฏุฑ:</strong> ุจุนุฏ ุงุฒ ูุงูุฒุฏฺฉุฑุฏูุ ููู ุจุงุฒฺฉูุงู ูโุชูุงููุฏ ุฑุง ุฏููุฏ</li>' +
                '<li><strong style="color: var(--text-primary);">ูุญุฏูุฏุช ุฑุง ูุฑุฏูโูุง:</strong> ุจุงุฒฺฉูุงู ูุฑุฏู ฺฉ ุฑุง ุฏุฑ ฺฉู ุจุงุฒ ุฏุงุฑูุฏ</li>' +
                '<li><strong style="color: var(--text-primary);">ุขุณุชุงูู ุงุนุฏุงู:</strong> ' + votesNeeded + '+ ุฑุง ูุงุฒู ุงุณุช</li>' +
                '<li><strong style="color: var(--text-primary);">ฺฉ ุงุนุฏุงู ุฏุฑ ุฑูุฒ:</strong> ุญุฏุงฺฉุซุฑ ฺฉ ุงุนุฏุงู ุฏุฑ ุฑูุฒ (ุจุดุชุฑู ุฑุง)</li>' +
                '<li><strong style="color: var(--text-primary);">ุจุฏูู ูุงุดโุณุงุฒ:</strong> ุดุฎุตุช ุงุนุฏุงูโุดุฏฺฏุงู ูุงุด ููโุดูุฏ</li>' +
                '<li><strong style="color: var(--text-primary);">ูุฑุฏูโูุง ูโุชูุงููุฏ ุตุญุจุช ฺฉููุฏ:</strong> ุจุงุฒฺฉูุงู ูุฑุฏู ุฏุฑ ุจุญุซโูุง ุดุฑฺฉุช ูโฺฉููุฏ</li>' +
                '<li><strong style="color: var(--text-primary);">ุณูุงุฎ:</strong> ุฏุฑ ุทูู ุฑูุฒ ูุงุจู ุงุณุชูุงุฏู ุงุณุช (ฺฉ ุจุงุฑ)</li>' +
                '</ul>' +
                '</div>' +
                '</details>' +
                '<div style="text-align: center; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.1);">' +
                '<button class="secondary-btn" onclick="toggleGrimoire()" style="font-size: 0.9rem; padding: 12px 20px; background: rgba(96, 125, 139, 0.2); border: 1px solid #607d8b; color: var(--text-secondary); font-weight: 500;">๐ ููุงุด ุฏูุชุฑฺู (ูุตูโฺฏู)</button>' +
                '</div>';
            
            addLog('ุฑูุฒ ' + currentDay + ' ุดุฑูุน ูโุดูุฏ.');
        }

        function endNightPhase() {
            // Resolve death marked by Imp (after all night actions including Monk protection)
            if (markedForDeath) {
                var target = markedForDeath;
                var isProtected = protectedPlayers.indexOf(target.index) !== -1;
                var isSoldier = target.characterDef.name === 'ุณุฑุจุงุฒ';
                
                if (isProtected) {
                    addLog('ุดุทุงู ุณุน ฺฉุฑุฏ ' + target.name + ' ุฑุง ุจฺฉุดุฏ (ูุญุงูุธุช ุดุฏู ุชูุณุท ุฑุงูุจ)');
                } else if (isSoldier) {
                    addLog('ุดุทุงู ุณุน ฺฉุฑุฏ ' + target.name + ' ุฑุง ุจฺฉุดุฏ (ุณุฑุจุงุฒ - ููโุชูุงูุฏ ุฏุฑ ุดุจ ุจูุฑุฏ)');
                } else {
                    target.alive = false;
                    target.diedAtNight = currentDay;
                    addLog('ุดุทุงู ' + target.name + ' ุฑุง ฺฉุดุช');
                    // Check if killed player is Ravenkeeper - trigger their ability
                    if (target.character === 'Ravenkeeper') {
                        // Ravenkeeper died - they get to use their ability
                        // We need to handle this before day starts
                        triggerRavenkeeperAbility(target);
                        // Return early - the Ravenkeeper modal will handle continuing to day
                        return;
                    }
                }
                markedForDeath = null; // Clear the marked target
            }
            
            // Clear protection (lasts until next day)
            protectedPlayers = [];
            // Clear poisoning that was applied this night (one-time effect)
            poisonedPlayers = poisonedPlayers.filter(poison => {
                // Keep poisons that apply next night, remove ones that applied this night
                return poison.appliesNight > currentDay;
            });
            
            // Update game display to reflect any deaths that occurred during the night
            updateGameDisplay();
            
            // Check win conditions after night deaths
            checkWinConditions();
            
            // Start the day phase
            startDayPhase();
        }

        function openSlayerAbility() {
            var list = document.getElementById('nomination-votes');
            list.innerHTML = '';
            
            var livingPlayers = players.filter(p => p.alive);
            
            list.innerHTML = '<p style="margin-bottom:15px;"><strong>ุณูุงุฎ:</strong> ฺฉ ุจุงุฑ ุฏุฑ ุจุงุฒุ ฺฉ ุจุงุฒฺฉู ุฑุง ุงูุชุฎุงุจ ฺฉูุฏ. ุงฺฏุฑ ุขููุง ุดุทุงู ุจุงุดูุฏุ ูโูุฑูุฏ.</p>';
            list.innerHTML += '<p style="margin-bottom:15px; color: var(--text-secondary); font-size: 0.9rem;">ูุฑ ุจุงุฒฺฉู ูโุชูุงูุฏ ุงุฏุนุง ฺฉูุฏ ฺฉู ุณูุงุฎ ุงุณุช ู ุงู ุชูุงูุง ุฑุง ุงูุชุญุงู ฺฉูุฏ. ููุท ุณูุงุฎ ูุงูุน ูโุชูุงูุฏ ุดุทุงู ุฑุง ุจฺฉุดุฏ.</p>';
            list.innerHTML += '<p style="margin-bottom:15px;"><strong>ุจุงุฒฺฉู ฺฉู ุงุฏุนุง ูโฺฉูุฏ ุณูุงุฎ ุงุณุช ุฑุง ุงูุชุฎุงุจ ฺฉูุฏ:</strong></p>';
            
            livingPlayers.forEach(function(p) {
                var btn = document.createElement('button');
                btn.className = 'player-select-btn';
                btn.style.marginTop = '10px';
                btn.innerText = p.name;
                btn.onclick = function() {
                    selectSlayerTarget(p);
                };
                list.appendChild(btn);
            });
            
            document.getElementById('nomination-text').innerText = 'ฺฉ ุจุงุฒฺฉู ุงุฏุนุง ูโฺฉูุฏ ฺฉู ุณูุงุฎ ุงุณุช. ุงูุชุฎุงุจ ฺฉูุฏ ฺู ฺฉุณ ุงุฏุนุง ูโฺฉูุฏุ ุณูพุณ ูุฏู ุงู ุฑุง ุงูุชุฎุงุจ ฺฉูุฏ.';
            document.getElementById('nomination-modal').classList.remove('hidden');
        }

        function selectSlayerTarget(slayerClaimant) {
            var list = document.getElementById('nomination-votes');
            list.innerHTML = '';
            
            list.innerHTML = '<div style="margin-bottom:15px;"><strong>ุงุฏุนุงฺฉููุฏู ุณูุงุฎ:</strong> ' + slayerClaimant.name + '</div>';
            list.innerHTML += '<div style="margin-bottom:15px;"><strong>ุงูุชุฎุงุจ ูุฏู:</strong></div>';
            
            var livingPlayers = players.filter(p => p.alive && p.name !== slayerClaimant.name);
            
            livingPlayers.forEach(function(p) {
                var btn = document.createElement('button');
                btn.className = 'player-select-btn';
                btn.style.marginTop = '10px';
                btn.innerText = p.name;
                btn.onclick = function() {
                    processSlayerAbility(slayerClaimant, p);
                };
                list.appendChild(btn);
            });
        }

        function processSlayerAbility(slayerClaimant, target) {
            document.getElementById('nomination-modal').classList.add('hidden');
            
            var isRealSlayer = slayerClaimant.characterDef.name === 'ุณูุงุฎ';
            var isTargetDemon = target.characterDef.type === 'demon';
            var slayerHasUsed = slayerUsed;
            var targetWasAlive = target.alive;
            
            // Slayer ability only works if:
            // 1. The claimant is the real Slayer
            // 2. The target is the Demon
            // 3. The Slayer hasn't used it before
            
            var resultContent = document.getElementById('slayer-result-content');
            var targetDied = false;
            
            if (isRealSlayer && isTargetDemon && !slayerHasUsed) {
                // Real Slayer targets Demon - it works!
                target.alive = false;
                targetDied = true;
                slayerUsed = true;
                addLog('ุณูุงุฎ (' + slayerClaimant.name + ') ' + target.name + ' ุฑุง ฺฉุดุช (ุดุทุงู)!');
                
                // Check for Scarlet Woman (only becomes Demon if 5+ players alive)
                var livingCount = players.filter(p => p.alive).length;
                var scarletWoman = players.find(p => p.alive && p.characterDef.name === 'ุฒู ุณุฑุฎ');
                if (scarletWoman && livingCount >= 4) {
                    scarletWoman.characterDef = CHARACTERS['Imp'];
                    addLog('ุฒู ุณุฑุฎ (' + scarletWoman.name + ') ุชุจุฏู ุจู ุดุทุงู ุดุฏ!');
                } else {
                    endGame('good', 'ุดุทุงู ุชูุณุท ุณูุงุฎ ฺฉุดุชู ุดุฏ! ุฎูุจ ุจุฑูุฏู ุดุฏ!');
                    return;
                }
                
                updateGameDisplay();
                checkWinConditions();
                
                // Show result: Target died
                resultContent.innerHTML = 
                    '<div style="font-size: 2rem; margin-bottom: 15px;">โ๏ธ</div>' +
                    '<div style="font-size: 1.5rem; font-weight: bold; color: var(--demon-color); margin-bottom: 10px;">' + target.name + ' ูุฑุฏ!</div>' +
                    '<p style="font-size: 1.1rem; color: var(--text-primary);">ุณูุงุฎ ูููู ุจูุฏ. ' + target.name + ' ุดุทุงู ุจูุฏ ู ฺฉุดุชู ุดุฏ.</p>';
                resultContent.style.background = 'rgba(213, 0, 0, 0.2)';
                resultContent.style.border = '2px solid var(--demon-color)';
            } else {
                // Either not the real Slayer, or wrong target, or already used
                // Show result: Target survived (don't reveal why)
                resultContent.innerHTML = 
                    '<div style="font-size: 2rem; margin-bottom: 15px;">๐ก๏ธ</div>' +
                    '<div style="font-size: 1.5rem; font-weight: bold; color: var(--good-color); margin-bottom: 10px;">' + target.name + ' ุฒูุฏู ูุงูุฏ</div>' +
                    '<p style="font-size: 1.1rem; color: var(--text-primary);">ุณูุงุฎ ุจโุงุซุฑ ุจูุฏ. ' + target.name + ' ูููุฒ ุฒูุฏู ุงุณุช.</p>';
                resultContent.style.background = 'rgba(76, 175, 80, 0.2)';
                resultContent.style.border = '2px solid var(--good-color)';
                
                addLog(slayerClaimant.name + ' ุชูุงูุง ุณูุงุฎ ุฑุง ุฑู ' + target.name + ' ุงูุชุญุงู ฺฉุฑุฏ (ุจโุงุซุฑ)');
            }
            
            // Show result modal
            document.getElementById('slayer-result-modal').classList.remove('hidden');
        }

        function closeSlayerResult() {
            document.getElementById('slayer-result-modal').classList.add('hidden');
            
            // Return to day phase - restore the proper day phase layout
            var livingPlayers = players.filter(p => p.alive);
            var livingCount = livingPlayers.length;
            var votesNeeded = Math.floor(livingCount / 2) + 1;
            
            // Check for special conditions
            var specialConditions = '';
            if (livingCount === 2) {
                specialConditions += '<div style="background: rgba(244, 67, 54, 0.2); padding: 10px; border-radius: 5px; margin-top: 10px; border: 2px solid var(--evil-color); text-align: right;">' +
                    '<strong style="color: var(--evil-color);">โ๏ธ ุฏู ููุฑ ููุง:</strong> <strong>ุดุฑุฑุงู ุจุฑูุฏู ูโุดููุฏ</strong> - ุจุงุฒ ุชูุงู ุดุฏ!' +
                    '</div>';
            }
            
            // Remove night death announcement if still present
            var nightDeathEl = document.getElementById('night-death-announcement');
            if (nightDeathEl) {
                nightDeathEl.remove();
            }
            
            document.getElementById('phase-title').innerText = 'ุฑูุฒ ' + currentDay;
            document.getElementById('phase-content').innerHTML = 
                '<!-- Critical Stats Cards -->' +
                '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-bottom: 30px; direction: rtl;">' +
                
                '<!-- Living Players Card -->' +
                '<div style="background: linear-gradient(135deg, rgba(76, 175, 80, 0.3) 0%, rgba(76, 175, 80, 0.15) 100%); padding: 30px 20px; border-radius: 16px; text-align: center; border: 3px solid var(--good-color); box-shadow: 0 8px 24px rgba(76, 175, 80, 0.4), inset 0 1px 0 rgba(255,255,255,0.1); position: relative; overflow: hidden; transition: transform 0.2s;">' +
                '<div style="position: absolute; top: -50%; right: -50%; width: 200%; height: 200%; background: radial-gradient(circle, rgba(76, 175, 80, 0.1) 0%, transparent 70%);"></div>' +
                '<div style="position: relative; z-index: 1;">' +
                '<div style="font-size: 4.5rem; font-weight: 900; color: var(--good-color); text-shadow: 0 4px 8px rgba(0,0,0,0.5), 0 0 20px rgba(76, 175, 80, 0.3); margin-bottom: 12px; line-height: 1;">' + livingCount + '</div>' +
                '<div style="font-size: 1.1rem; color: var(--text-primary); font-weight: 600; text-transform: uppercase; letter-spacing: 2px;">ุจุงุฒฺฉู ุฒูุฏู</div>' +
                '</div>' +
                '</div>' +
                
                '<!-- Votes Needed Card -->' +
                '<div style="background: linear-gradient(135deg, rgba(244, 67, 54, 0.3) 0%, rgba(244, 67, 54, 0.15) 100%); padding: 30px 20px; border-radius: 16px; text-align: center; border: 3px solid var(--accent-color); box-shadow: 0 8px 24px rgba(244, 67, 54, 0.4), inset 0 1px 0 rgba(255,255,255,0.1); position: relative; overflow: hidden; transition: transform 0.2s;">' +
                '<div style="position: absolute; top: -50%; right: -50%; width: 200%; height: 200%; background: radial-gradient(circle, rgba(244, 67, 54, 0.1) 0%, transparent 70%);"></div>' +
                '<div style="position: relative; z-index: 1;">' +
                '<div style="font-size: 4.5rem; font-weight: 900; color: var(--accent-color); text-shadow: 0 4px 8px rgba(0,0,0,0.5), 0 0 20px rgba(244, 67, 54, 0.3); margin-bottom: 12px; line-height: 1;">' + votesNeeded + '</div>' +
                '<div style="font-size: 1.1rem; color: var(--text-primary); font-weight: 600; text-transform: uppercase; letter-spacing: 2px;">ุฑุง ุจุฑุง ุงุนุฏุงู</div>' +
                '</div>' +
                '</div>' +
                
                '</div>' +
                
                specialConditions;
            
            var actions = document.getElementById('action-buttons');
            actions.innerHTML = 
                '<!-- Action Buttons -->' +
                '<div style="display: grid; gap: 15px; margin-bottom: 30px;">' +
                '<button class="action-btn" onclick="openExecutionSelection()" style="font-size: 1.1rem; padding: 18px; background: linear-gradient(135deg, #c62828 0%, #b71c1c 100%); box-shadow: 0 6px 20px rgba(198, 40, 40, 0.6); border: none; color: #fff; font-weight: 700;">๐ช ุซุจุช ุงุนุฏุงู</button>' +
                '<button class="secondary-btn" onclick="openSlayerAbility()" style="font-size: 1rem; padding: 15px; background: linear-gradient(135deg, #f57c00 0%, #e65100 100%); border: 2px solid #ff9800; color: #fff; font-weight: 600; box-shadow: 0 4px 16px rgba(245, 124, 0, 0.5);"><span style="font-size: 1.5rem;">โ๏ธ</span> ุณูุงุฎ</button>' +
                '<button class="secondary-btn" onclick="endDay()" style="font-size: 1rem; padding: 15px; background: linear-gradient(135deg, #5e35b1 0%, #4527a0 100%); border: 2px solid #7e57c2; color: #fff; font-weight: 600; box-shadow: 0 4px 16px rgba(94, 53, 177, 0.5);">๐ ุจุฏูู ุงุนุฏุงู - ูพุงุงู ุฑูุฒ</button>' +
                '</div>' +
                '<details style="background: rgba(0,0,0,0.2); padding: 20px; border-radius: 12px; cursor: pointer; border: 1px solid rgba(255,255,255,0.05); margin-bottom: 20px; text-align: right; direction: rtl;">' +
                '<summary style="font-weight: 600; font-size: 1rem; cursor: pointer; user-select: none; color: var(--text-secondary); display: flex; align-items: center; gap: 10px; direction: rtl;">' +
                '<span style="font-size: 1.2rem;">๐</span><span>ููุงูู ุชูุตู ุงุนุฏุงู</span>' +
                '</summary>' +
                '<div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1);">' +
                '<ul style="margin: 0; padding-right: 25px; font-size: 0.9rem; line-height: 2; color: var(--text-secondary);">' +
                '<li><strong style="color: var(--text-primary);">ูุงูุฒุฏฺฉุฑุฏู:</strong> ูุฑ ุจุงุฒฺฉู ุฒูุฏู ูโุชูุงูุฏ ุจุงุฒฺฉู ุฏฺฏุฑ ุฑุง ูุงูุฒุฏ ฺฉูุฏ</li>' +
                '<li><strong style="color: var(--text-primary);">ฺฉ ูุงูุฒุฏ ุจู ุงุฒุง ูุฑ ุจุงุฒฺฉู:</strong> ูุฑ ุจุงุฒฺฉู ฺฉ ุจุงุฑ ุฏุฑ ุฑูุฒ ูุงูุฒุฏ ูโฺฉูุฏ</li>' +
                '<li><strong style="color: var(--text-primary);">ุฑุงโฺฏุฑ:</strong> ุจุนุฏ ุงุฒ ูุงูุฒุฏฺฉุฑุฏูุ ููู ุจุงุฒฺฉูุงู ูโุชูุงููุฏ ุฑุง ุฏููุฏ</li>' +
                '<li><strong style="color: var(--text-primary);">ูุญุฏูุฏุช ุฑุง ูุฑุฏูโูุง:</strong> ุจุงุฒฺฉูุงู ูุฑุฏู ฺฉ ุฑุง ุฏุฑ ฺฉู ุจุงุฒ ุฏุงุฑูุฏ</li>' +
                '<li><strong style="color: var(--text-primary);">ุขุณุชุงูู ุงุนุฏุงู:</strong> ' + votesNeeded + '+ ุฑุง ูุงุฒู ุงุณุช</li>' +
                '<li><strong style="color: var(--text-primary);">ฺฉ ุงุนุฏุงู ุฏุฑ ุฑูุฒ:</strong> ุญุฏุงฺฉุซุฑ ฺฉ ุงุนุฏุงู ุฏุฑ ุฑูุฒ (ุจุดุชุฑู ุฑุง)</li>' +
                '<li><strong style="color: var(--text-primary);">ุจุฏูู ูุงุดโุณุงุฒ:</strong> ุดุฎุตุช ุงุนุฏุงูโุดุฏฺฏุงู ูุงุด ููโุดูุฏ</li>' +
                '<li><strong style="color: var(--text-primary);">ูุฑุฏูโูุง ูโุชูุงููุฏ ุตุญุจุช ฺฉููุฏ:</strong> ุจุงุฒฺฉูุงู ูุฑุฏู ุฏุฑ ุจุญุซโูุง ุดุฑฺฉุช ูโฺฉููุฏ</li>' +
                '<li><strong style="color: var(--text-primary);">ุณูุงุฎ:</strong> ุฏุฑ ุทูู ุฑูุฒ ูุงุจู ุงุณุชูุงุฏู ุงุณุช (ฺฉ ุจุงุฑ)</li>' +
                '</ul>' +
                '</div>' +
                '</details>' +
                '<div style="text-align: center; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.1);">' +
                '<button class="secondary-btn" onclick="toggleGrimoire()" style="font-size: 0.9rem; padding: 12px 20px; background: rgba(96, 125, 139, 0.2); border: 1px solid #607d8b; color: var(--text-secondary); font-weight: 500;">๐ ููุงุด ุฏูุชุฑฺู (ูุตูโฺฏู)</button>' +
                '</div>';
        }

        function openExecutionSelection() {
            var list = document.getElementById('nomination-votes');
            list.innerHTML = '';
            
            var livingPlayers = players.filter(p => p.alive);
            
            if (livingPlayers.length === 0) {
                alert('ูฺ ุจุงุฒฺฉู ุฒูุฏูโุง ุจุฑุง ุงุนุฏุงู ูุฌูุฏ ูุฏุงุฑุฏ.');
                return;
            }
            
            list.innerHTML = '<p style="margin-bottom:15px;">ุจุงุฒฺฉู ฺฉู ุงุนุฏุงู ุดุฏ ุฑุง ุงูุชุฎุงุจ ฺฉูุฏ:</p>';
            
            livingPlayers.forEach(function(p) {
                var btn = document.createElement('button');
                btn.className = 'player-select-btn';
                btn.style.marginTop = '10px';
                btn.innerText = p.name;
                btn.onclick = function() {
                    processExecution(p);
                };
                list.appendChild(btn);
            });
            
            document.getElementById('nomination-text').innerText = 'ฺฉ ุจุงุฒฺฉู ุฏุฑ ุทูู ุฑูุฒ ุงุนุฏุงู ุดุฏ. ุงูุชุฎุงุจ ฺฉูุฏ ฺู ฺฉุณ ุงุนุฏุงู ุดุฏ.';
            document.getElementById('nomination-modal').classList.remove('hidden');
        }

        function processExecution(target) {
            document.getElementById('nomination-modal').classList.add('hidden');
            
            // Check for Virgin ability (if nominated by Townsfolk, nominator dies instead)
            if (target.characterDef.name === 'ุจุงฺฉุฑู' && !virginTriggered) {
                var confirmMsg = target.name + ' ุจุงฺฉุฑู ุงุณุช. ุงฺฏุฑ ุชูุณุท ฺฉ ุดูุฑููุฏ ูุงูุฒุฏ ุดูุฏุ ูุงูุฒุฏฺฉููุฏู ุจู ุฌุง ุงู ุงุนุฏุงู ูโุดูุฏ. ุขุง ูุงูุฒุฏฺฉููุฏู ฺฉ ุดูุฑููุฏ ุจูุฏุ';
                if (confirm(confirmMsg)) {
                    // Show selection for who the nominator was
                    showVirginExecution(target);
                    return;
                }
            }
            
            // Check for Saint
            if (target.characterDef.name === 'ูุฏุณ') {
                if (confirm('ูุดุฏุงุฑ: ' + target.name + ' ูุฏุณ ุงุณุช. ุงฺฏุฑ ุงุนุฏุงู ุดูุฏุ ุดุฑุฑ ุจุฑูุฏู ูโุดูุฏ! ุขุง ุจุง ุงุนุฏุงู ุงุฏุงูู ุฏูุฏุ')) {
                    executePlayer(target);
                    endGame('evil', 'ูุฏุณ ุงุนุฏุงู ุดุฏ! ุดุฑุฑ ุจุฑูุฏู ุดุฏ!');
                    return;
                } else {
                    return;
                }
            }
            
            // Normal execution
            executePlayer(target);
        }

        function showVirginExecution(virgin) {
            var list = document.getElementById('nomination-votes');
            list.innerHTML = '';
            
            var livingPlayers = players.filter(p => p.alive && p.name !== virgin.name && p.characterDef.type === 'townsfolk');
            
            if (livingPlayers.length === 0) {
                // No Townsfolk to execute, so Virgin is executed normally
                executePlayer(virgin);
                return;
            }
            
            list.innerHTML = '<p style="margin-bottom:15px;">ุจุงฺฉุฑู ูุนุงู ุดุฏ! ุงูุชุฎุงุจ ฺฉูุฏ ฺฉุฏุงู ุดูุฑููุฏ ุจุงฺฉุฑู ุฑุง ูุงูุฒุฏ ฺฉุฑุฏ (ุจู ุฌุง ุงู ุงุนุฏุงู ูโุดูุฏ):</p>';
            
            livingPlayers.forEach(function(p) {
                var btn = document.createElement('button');
                btn.className = 'player-select-btn';
                btn.style.marginTop = '10px';
                btn.innerText = p.name;
                btn.onclick = function() {
                    addLog('ุจุงฺฉุฑู ูุนุงู ุดุฏ! ' + p.name + ' ุจู ุฌุง ' + virgin.name + ' ุงุนุฏุงู ุดุฏ');
                    virginTriggered = true;
                    // Close the modal first
                    document.getElementById('nomination-modal').classList.add('hidden');
                    executePlayer(p);
                };
                list.appendChild(btn);
            });
            
            document.getElementById('nomination-text').innerText = 'ุชูุงูุง ุจุงฺฉุฑู ูุนุงู ุดุฏ - ูุงูุฒุฏฺฉููุฏู ุจู ุฌุง ุงู ุงุนุฏุงู ูโุดูุฏ.';
            document.getElementById('nomination-modal').classList.remove('hidden');
        }

        function executePlayer(player) {
            player.alive = false;
            executions++;
            lastExecutionDay = currentDay; // Track which day this execution happened
            lastExecutedPlayer = player; // Track who was executed for Undertaker
            addLog(player.name + ' ุงุนุฏุงู ุดุฏ.'); // Character NOT revealed - rule of the game
            
            // Check if Demon was executed
            if (player.characterDef.type === 'demon') {
                // Check for Scarlet Woman
                // Scarlet Woman only becomes Demon if there are 5 or more living players (including the Demon who just died)
                // We check survivors >= 4 (meaning 5+ before death)
                var livingCount = players.filter(p => p.alive).length;
                
                var scarletWoman = players.find(p => p.alive && p.characterDef.name === 'ุฒู ุณุฑุฎ');
                if (scarletWoman && livingCount >= 4) {
                    scarletWoman.characterDef = CHARACTERS['Imp'];
                    addLog('ุฒู ุณุฑุฎ (' + scarletWoman.name + ') ุชุจุฏู ุจู ุดุทุงู ุดุฏ!');
                } else {
                    endGame('good', 'ุดุทุงู ุงุนุฏุงู ุดุฏ! ุฎูุจ ุจุฑูุฏู ุดุฏ!');
                    return;
                }
            }
            
            updateGameDisplay();
            checkWinConditions();
            
            // Return to day phase - execution happened, can end day or continue discussion
            document.getElementById('phase-title').innerText = 'Day ' + currentDay;
            document.getElementById('phase-content').innerHTML = 
                '<p><strong>' + player.name + '</strong> ุงุนุฏุงู ุดุฏ.</p>' +
                '<p style="font-size: 0.9rem; color: var(--text-secondary);">ุดุฎุตุช ู ููโุณู ุจู ุจุงุฒฺฉูุงู ุฏฺฏุฑ ูุงุด ููโุดูุฏ.</p>' +
                '<p>ุจุญุซ ูโุชูุงูุฏ ุงุฏุงูู ุงุจุฏุ ุงูุง ููุท ฺฉ ุงุนุฏุงู ุฏุฑ ุฑูุฒ.</p>';
            
            var actions = document.getElementById('action-buttons');
            actions.innerHTML = '<button class="action-btn" onclick="endDay()">ูพุงุงู ุฑูุฒ</button>';
        }

        function closeNomination() {
            document.getElementById('nomination-modal').classList.add('hidden');
        }

        function endDay() {
            var living = players.filter(p => p.alive).length;
            if (living <= 2) {
                endGame('evil', 'Only ' + living + ' players remain! Evil wins!');
                return;
            }
            
            currentDay++;
            isNightPhase = true;
            buildNightOrder();
            nightIndex = 0;
            
            document.getElementById('phase-display').className = 'phase-display phase-night';
            document.getElementById('phase-title').innerText = 'ุดุจ ' + currentDay;
            document.getElementById('phase-content').innerHTML = 
                '<p>ููู ุจุงุฒฺฉูุงู ฺุดูุงู ุฎูุฏ ุฑุง ุจุจูุฏูุฏ.</p>' +
                '<p>ูุตูโฺฏู ุดุฎุตุชโูุง ุฑุง ุจู ุชุฑุชุจ ุจุฏุงุฑ ูโฺฉูุฏ.</p>';
            
            var actions = document.getElementById('action-buttons');
            actions.innerHTML = '<button class="action-btn" onclick="processNightPhase()">ุดุฑูุน ูุงุฒ ุดุจ</button>';
            
            addLog('ุดุจ ' + currentDay + ' ุดุฑูุน ูโุดูุฏ.');
        }

        function checkWinConditions() {
            var living = players.filter(p => p.alive).length;
            var demon = players.find(p => p.alive && p.characterDef.type === 'demon');
            
            if (!demon) {
                    endGame('good', 'ุดุทุงู ุงุนุฏุงู ุดุฏ! ุฎูุจ ุจุฑูุฏู ุดุฏ!');
                return;
            }
            
            // Check for Mayor's special win condition: if only 3 players remain and Mayor dies, good wins
            if (living === 3) {
                var mayor = players.find(p => p.character === 'Mayor');
                if (mayor && !mayor.alive) {
                    // Mayor died with exactly 3 players remaining - good wins
                    endGame('good', 'ุดูุฑุฏุงุฑ ุจุง ููุท ณ ุจุงุฒฺฉู ุจุงูโูุงูุฏู ูุฑุฏ! ุฎูุจ ุจุฑูุฏู ุดุฏ!');
                    return;
                }
            }
            
            if (living <= 2) {
                endGame('evil', 'ููุท ' + living + ' ุจุงุฒฺฉู ุจุงู ูุงูุฏู! ุดุฑุฑ ุจุฑูุฏู ุดุฏ!');
                return;
            }
        }

        function endGame(winner, message) {
            isGameInProgress = false;
            localStorage.removeItem('botc_game_state_farsi');
            var titleEl = document.getElementById('end-game-title');
            titleEl.innerText = (winner === 'good' ? 'ุฎูุจ' : 'ุดุฑุฑ') + ' ุจุฑูุฏู ุดุฏ!';
            titleEl.style.color = winner === 'good' ? '#4CAF50' : '#F44336';
            document.getElementById('end-game-message').innerText = message;
            document.getElementById('end-game-modal').classList.remove('hidden');
            addLog('GAME OVER: ' + message);
        }

        function renderGrimoire() {
            var container = document.getElementById('grimoire-view');
            container.innerHTML = '';
            
            players.forEach(function(player) {
                var token = document.createElement('div');
                token.className = 'grimoire-token ' + player.characterDef.type;
                if (!player.alive) token.classList.add('dead');
                
                var extraInfo = '';
                // Show Butler's master choice
                if (player.characterDef.name === 'ูพุดุฎุฏูุช' && butlerChoices[player.index] !== undefined) {
                    var master = players.find(p => p.index === butlerChoices[player.index]);
                    if (master) {
                        extraInfo = '<div style="font-size:0.65rem; color:#FFB74D; margin-top:3px;">ุงุฑุจุงุจ: ' + master.name + '</div>';
                    }
                }
                
                token.innerHTML = 
                    '<div style="font-weight:bold; margin-bottom:5px;">' + player.name + '</div>' +
                    '<div style="font-size:0.75rem; color:var(--text-secondary);">' + player.characterDef.name + '</div>' +
                    extraInfo;
                
                container.appendChild(token);
            });
        }

        function toggleGrimoire() {
            var grimoire = document.getElementById('grimoire-view');
            grimoire.classList.toggle('hidden');
            grimoireVisible = !grimoireVisible;
        }

        function showSpyGrimoireDistribution(spyPlayer) {
            // Show Spy Grimoire during distribution phase
            showSpyGrimoire(spyPlayer, true);
        }

        function showSpyGrimoire(spyPlayer, isDistribution) {
            // Render Grimoire for Spy to see in a modal
            var container = document.getElementById('spy-grimoire-content');
            container.innerHTML = '';
            
            var grimoireDiv = document.createElement('div');
            grimoireDiv.style.padding = '25px';
            grimoireDiv.style.background = 'linear-gradient(135deg, rgba(230, 81, 0, 0.25) 0%, rgba(245, 124, 0, 0.15) 100%)';
            grimoireDiv.style.borderRadius = '16px';
            grimoireDiv.style.border = '3px solid var(--minion-color)';
            grimoireDiv.style.boxShadow = '0 8px 24px rgba(230, 81, 0, 0.5), inset 0 2px 4px rgba(255,255,255,0.1)';
            grimoireDiv.style.direction = 'rtl';
            
            var header = document.createElement('div');
            header.style.textAlign = 'center';
            header.style.marginBottom = '25px';
            header.innerHTML = 
                '<div style="font-size: 2.5rem; margin-bottom: 10px;">๐</div>' +
                '<h2 style="color: var(--minion-color); margin: 0; font-size: 1.8rem; text-shadow: 0 2px 8px rgba(0,0,0,0.5); text-transform: uppercase; letter-spacing: 2px;">ุฏูุชุฑฺู ุฌุงุณูุณ</h2>' +
                '<p style="color: rgba(255,255,255,0.7); margin: 8px 0 0 0; font-size: 0.9rem; font-style: italic;">ููู ุงุณุฑุงุฑ ูุงุด ุดุฏ</p>';
            grimoireDiv.appendChild(header);
            
            // Organize players by type
            var townsfolk = players.filter(p => p.characterDef.type === 'townsfolk');
            var outsiders = players.filter(p => p.characterDef.type === 'outsider');
            var minions = players.filter(p => p.characterDef.type === 'minion');
            var demons = players.filter(p => p.characterDef.type === 'demon');
            
            function renderCategory(title, playerList, categoryColor, emoji) {
                if (playerList.length === 0) return;
                
                var categoryDiv = document.createElement('div');
                categoryDiv.style.marginBottom = '20px';
                
                var categoryTitle = document.createElement('div');
                categoryTitle.style.fontSize = '1.1rem';
                categoryTitle.style.fontWeight = 'bold';
                categoryTitle.style.color = categoryColor;
                categoryTitle.style.marginBottom = '10px';
                categoryTitle.style.textTransform = 'uppercase';
                categoryTitle.style.letterSpacing = '1.5px';
                categoryTitle.innerHTML = emoji + ' ' + title;
                categoryDiv.appendChild(categoryTitle);
                
                playerList.forEach(function(player) {
                var token = document.createElement('div');
                    token.style.padding = '14px 16px';
                    token.style.margin = '8px 0';
                    token.style.background = 'rgba(0,0,0,0.4)';
                    token.style.borderRight = '5px solid ' + categoryColor;
                    token.style.borderRadius = '10px';
                    token.style.textAlign = 'right';
                    token.style.boxShadow = '0 2px 8px rgba(0,0,0,0.3)';
                    token.style.transition = 'transform 0.2s';
                
                if (!player.alive) {
                    token.style.opacity = '0.5';
                        token.style.background = 'rgba(0,0,0,0.6)';
                }
                
                token.innerHTML = 
                        '<div style="display: flex; justify-content: space-between; align-items: center; direction: rtl;">' +
                        '<div style="font-size: 1.5rem; opacity: 0.7;">' + 
                        (player.characterDef.type === 'townsfolk' ? '๐ค' : 
                         player.characterDef.type === 'outsider' ? '๐ท' : 
                         player.characterDef.type === 'minion' ? 'โก' : 'โ๏ธ') + 
                        '</div>' +
                        '<div style="text-align: right;">' +
                        '<div style="font-weight: bold; font-size: 1.1rem; margin-bottom: 4px; color: #fff;">' + 
                        player.name + 
                        (player.alive ? '' : ' <span style="color: #999; font-size: 0.9rem;">โ๏ธ ูุฑุฏู</span>') + 
                        '</div>' +
                        '<div style="font-size: 0.9rem; color: ' + categoryColor + '; font-weight: 600;">' + 
                        player.characterDef.name + 
                        '</div>' +
                        '</div>' +
                        '</div>';
                    
                    categoryDiv.appendChild(token);
                });
                
                grimoireDiv.appendChild(categoryDiv);
            }
            
            renderCategory('ุงูุงู ุดูุฑ', townsfolk, 'var(--townsfolk-color)', '๐ฅ');
            renderCategory('ุทุฑุฏ ุดุฏฺฏุงู', outsiders, 'var(--outsider-color)', '๐ท');
            renderCategory('ุงุฑุงู ุดุฑ', minions, 'var(--minion-color)', 'โก');
            renderCategory('ุดุทุงู', demons, 'var(--demon-color)', 'โ๏ธ');
            
            container.appendChild(grimoireDiv);
            
            var closeBtn = document.createElement('button');
            closeBtn.className = 'action-btn';
            closeBtn.style.marginTop = '20px';
            closeBtn.style.fontSize = '1.1rem';
            closeBtn.style.padding = '15px';
            closeBtn.style.background = 'linear-gradient(135deg, #e65100 0%, #bf360c 100%)';
            closeBtn.style.boxShadow = '0 4px 16px rgba(230, 81, 0, 0.5)';
            closeBtn.style.width = '100%';
            closeBtn.innerText = 'โ ุจุณุชู ุฏูุชุฑฺู' + (isDistribution ? '' : ' ู ุงุฏุงูู');
            closeBtn.onclick = function() {
                document.getElementById('spy-grimoire-modal').classList.add('hidden');
                if (!isDistribution) {
                addLog('ุฌุงุณูุณ (' + spyPlayer.name + ') ุฏูุชุฑฺู ุฑุง ูุดุงูุฏู ฺฉุฑุฏ');
                skipNightAbility();
                }
            };
            container.appendChild(closeBtn);
            
            // Show the modal
            document.getElementById('spy-grimoire-modal').classList.remove('hidden');
        }

        function toggleLog() {
            var log = document.getElementById('game-log');
            log.classList.toggle('hidden');
        }

        function addLog(message) {
            var timestamp = new Date().toLocaleTimeString();
            gameLog.push('[' + timestamp + '] ' + message);
            
            var content = document.getElementById('log-content');
            content.innerHTML = '';
            gameLog.slice().reverse().forEach(function(entry) {
                var div = document.createElement('div');
                div.className = 'log-entry';
                div.innerText = entry;
                content.appendChild(div);
            });
        }

        function showScreen(id) {
            var screens = ['setup-screen', 'distribution-screen', 'game-screen'];
            screens.forEach(s => {
                var el = document.getElementById(s);
                if (el) el.classList.add('hidden');
            });
            var target = document.getElementById(id);
            if (target) target.classList.remove('hidden');
        }

        var ROLE_GUIDE_INFO = {
            'Washerwoman': { desc: 'ุฏุฑ ุดุจ ุงููุ ูุชูุฌู ูโุดูุฏ ฺฉู ฺฉ ุงุฒ ุฏู ุจุงุฒฺฉู ูุดุฎุตุ ฺฉ ุดุฎุตุช ุดูุฑููุฏ ุฎุงุต ุงุณุช.', note: 'ุงฺฏุฑ "ูุณุช" ุง "ุฒูุฑุขฺฏู" ุจุงุดุฏุ ููฺฉู ุงุณุช ุงุทูุงุนุงุช ูุงุฏุฑุณุช ุฏุฑุงูุช ฺฉูุฏ.' },
            'Librarian': { desc: 'ุฏุฑ ุดุจ ุงููุ ูุชูุฌู ูโุดูุฏ ฺฉู ฺฉ ุงุฒ ุฏู ุจุงุฒฺฉู ูุดุฎุตุ ฺฉ ุดุฎุตุช ุบุฑุจู ุฎุงุต ุงุณุช.', note: 'ุงฺฏุฑ ุบุฑุจูโุง ุฏุฑ ุจุงุฒ ูุจุงุดุฏุ ุจู ุดูุง ฺฏูุชู ูโุดูุฏ "ูฺ ุบุฑุจูโุง ุฏุฑ ุจุงุฒ ูุณุช".' },
            'Investigator': { desc: 'ุฏุฑ ุดุจ ุงููุ ูุชูุฌู ูโุดูุฏ ฺฉู ฺฉ ุงุฒ ุฏู ุจุงุฒฺฉู ูุดุฎุตุ ฺฉ ุดุฎุตุช ุฎุงุฏู ุดุทุงู ุฎุงุต ุงุณุช.', note: 'ุดุฎุตุช "ฺฏูุดูโูุดู" ููฺฉู ุงุณุช ุจู ุนููุงู ุฎุงุฏู ุจู ุดูุง ูุดุงู ุฏุงุฏู ุดูุฏ.' },
            'Chef': { desc: 'ุฏุฑ ุดุจ ุงููุ ูุชูุฌู ูโุดูุฏ ฺูุฏ ุฌูุช ุจุงุฒฺฉู ุดุฑุฑ ฺฉูุงุฑ ูู ูุดุณุชูโุงูุฏ.', note: '"ุดุฑุฑ" ุดุงูู ุฎุงุฏู ู ุดุทุงู ุงุณุช. "ฺฏูุดูโูุดู" ููฺฉู ุงุณุช ุจู ุนููุงู ุดุฑุฑ ุซุจุช ุดูุฏ.' },
            'Empath': { desc: 'ูุฑ ุดุจุ ูุชูุฌู ูโุดูุฏ ฺูุฏ ุจุงุฒฺฉู ุดุฑุฑ ุฏุฑ ฺฉูุงุฑ ุดูุง ูุดุณุชูโุงูุฏ.', note: 'ููุณุงูโูุง ุจุงุฒฺฉูุงู "ุฒูุฏู" ูุณุชูุฏ. "ฺฏูุดูโูุดู" ููฺฉู ุงุณุช ุจู ุนููุงู ุดุฑุฑ ุซุจุช ุดูุฏ.' },
            'Fortune Teller': { desc: 'ูุฑ ุดุจุ ุฏู ุจุงุฒฺฉู ุฑุง ุงูุชุฎุงุจ ูโฺฉูุฏ ู ูุชูุฌู ูโุดูุฏ ุขุง ฺฉ ุงุฒ ุขููุง ุดุทุงู ุงุณุช.', note: 'ุฏุฑ ุดุจ ุงููุ ฺฉ ุจุงุฒฺฉู ุฎูุจ ุจู ุนููุงู "ูุดุงูู ฺฉุงุฐุจ" ุชุนู ูโุดูุฏ ฺฉู ููุดู "ุจูู" ุฏุฑุงูุช ูโฺฉูุฏ.' },
            'Undertaker': { desc: 'ูุฑ ุดุจุ ุงฺฏุฑ ฺฉุณ ุฏุฑ ุฑูุฒ ูุจู ุงุนุฏุงู ุดุฏู ุจุงุดุฏุ ุดุฎุตุช ุงู ุฑุง ูโูููุฏ.', note: 'ุงฺฏุฑ ฺฉุณ ุงุนุฏุงู ูุดุฏู ุจุงุดุฏุ ุจุฏุงุฑ ููโุดูุฏ.' },
            'Monk': { desc: 'ูุฑ ุดุจุ ฺฉ ุจุงุฒฺฉู (ุบุฑ ุงุฒ ุฎูุฏุชุงู) ุฑุง ุงูุชุฎุงุจ ูโฺฉูุฏ ู ุขููุง ุฏุฑ ุขู ุดุจ ููโุชูุงููุฏ ุชูุณุท ุดุทุงู ฺฉุดุชู ุดููุฏ.', note: 'ุงู ุงุฒ "ุงุนุฏุงู" ูุญุงูุธุช ููโฺฉูุฏุ ููุท ุงุฒ ูุฑฺฏ ุฏุฑ ุดุจ ุชูุณุท ุดุทุงู.' },
            'Ravenkeeper': { desc: 'ุงฺฏุฑ ุฏุฑ ุดุจ ุจูุฑุฏุ ุจุฏุงุฑ ูโุดูุฏ ู ฺฉ ุจุงุฒฺฉู ุฑุง ุงูุชุฎุงุจ ูโฺฉูุฏ ุชุง ุดุฎุตุช ุงู ุฑุง ุจูููุฏ.', note: 'ุงฺฏุฑ ุงุนุฏุงู ุดูุฏุ ุงู ูุงุจูุช ูุนุงู ููโุดูุฏ.' },
            'Virgin': { desc: 'ุงููู ุจุงุฑ ฺฉู ูุงูุฒุฏ ุงุนุฏุงู ูโุดูุฏุ ุงฺฏุฑ ูุงูุฒุฏฺฉููุฏู ุดูุง ฺฉ ุดูุฑููุฏ ุจุงุดุฏุ ุจู ุฌุง ุดูุง ุงุนุฏุงู ูโุดูุฏ.', note: 'ุงฺฏุฑ ูุงูุฒุฏฺฉููุฏู ุบุฑุจูุ ุฎุงุฏู ุง ุดุทุงู ุจุงุดุฏุ ูฺ ุงุชูุงู ููโุงูุชุฏ.' },
            'Slayer': { desc: 'ฺฉ ุจุงุฑ ุฏุฑ ฺฉู ุจุงุฒุ ุฏุฑ ุทูู ุฑูุฒ ูโุชูุงูุฏ ุจู ฺฉ ุจุงุฒฺฉู ุดูฺฉ ฺฉูุฏ. ุงฺฏุฑ ุดุทุงู ุจุงุดุฏุ ูโูุฑุฏ.', note: 'ุงฺฏุฑ ุจู ุฎุงุฏู ุง ุดูุฑููุฏ ุดูฺฉ ฺฉูุฏุ ุชุฑ ุดูุง ูุฏุฑ ูโุฑูุฏ.' },
            'Soldier': { desc: 'ุดูุง ููโุชูุงูุฏ ุฏุฑ ุดุจ ุจูุฑุฏ (ุชูุณุท ุดุทุงู).', note: 'ุดูุง ููฺูุงู ูโุชูุงูุฏ ุฏุฑ ุฑูุฒ ุงุนุฏุงู ุดูุฏ.' },
            'Mayor': { desc: 'ุงฺฏุฑ ููุท ณ ุจุงุฒฺฉู ุฒูุฏู ุจุงู ุจูุงููุฏ ู ูฺโฺฉุณ ุงุนุฏุงู ูุดูุฏุ ุชู ุฎูุจ ุจุฑูุฏู ูโุดูุฏ.', note: 'ุงฺฏุฑ ุฏุฑ ุดุจ ููุฑุฏ ุญููู ูุฑุงุฑ ุจฺฏุฑุฏุ ููฺฉู ุงุณุช ุจุงุฒฺฉู ุฏฺฏุฑ ุจู ุฌุง ุดูุง ุจูุฑุฏ.' },
            'Butler': { desc: 'ูุฑ ุดุจุ ฺฉ ุจุงุฒฺฉู (ุงุฑุจุงุจ) ุฑุง ุงูุชุฎุงุจ ูโฺฉูุฏ. ูุฑุฏุงุ ููุท ูโุชูุงูุฏ ุฒูุงู ุฑุง ุฏูุฏ ฺฉู ุงุฑุจุงุจโุชุงู ุฑุง ุฏูุฏ.', note: 'ุดูุง ฺฉ ุบุฑุจู ูุณุชุฏ. ุงฺฏุฑ ุงุฑุจุงุจ ุฑุง ูุฏูุฏุ ุดูุง ูู ููโุชูุงูุฏ ุฑุง ุฏูุฏ.' },
            'Drunk': { desc: 'ุดูุง ูฺฉุฑ ูโฺฉูุฏ ฺฉ ุดูุฑููุฏ ูุณุชุฏุ ุงูุง ุฏุฑ ูุงูุน ูุณุชุฏ. ุดูุง ูุณุช ูุณุชุฏ.', note: 'ุดูุง ูุงุจูุช ุขู ุดูุฑููุฏ ุฑุง ูุฏุงุฑุฏุ ุงูุง ุฏุงุณุชุงูโฺฏู ุทูุฑ ูุงูููุฏ ูโฺฉูุฏ ฺฉู ุฏุงุฑุฏ.' },
            'Recluse': { desc: 'ุดูุง ุชู ุฎูุจ ูุณุชุฏุ ุงูุง ููฺฉู ุงุณุช ุจู ุนููุงู "ุดุฑุฑ" ุซุจุช ุดูุฏ.', note: 'ุงู ุจุงุนุซ ูโุดูุฏ ุขุดูพุฒุ ููโุฏู ุง ูุงูโฺฏุฑ ุงุทูุงุนุงุช ุงุดุชุจุงู ุจฺฏุฑูุฏ.' },
            'Saint': { desc: 'ุงฺฏุฑ ุดูุง ุจุง ุฑุงโฺฏุฑ ุฏุฑ ุฑูุฒ ุงุนุฏุงู ุดูุฏุ ุชู ุดุฑุฑ ููุฑุงู ุจุฑูุฏู ูโุดูุฏ.', note: 'ุงฺฏุฑ ุฏุฑ ุดุจ ุจูุฑุฏุ ุจุงุฒ ุงุฏุงูู ูโุงุจุฏ.' },
            'Poisoner': { desc: 'ูุฑ ุดุจุ ฺฉ ุจุงุฒฺฉู ุฑุง ูุณููู ูโฺฉูุฏ. ูุงุจูุช ุขููุง ุงูุดุจ ู ูุฑุฏุง ุฑูุฒ ฺฉุงุฑ ููโฺฉูุฏ.', note: 'ุขููุง ููโููููุฏ ฺฉู ูุณููู ุดุฏูโุงูุฏ.' },
            'Spy': { desc: 'ุดูุง ูโุชูุงูุฏ ุฏูุชุฑฺู ุฑุง ุจุจูุฏ. ุดูุง ุจู ุนููุงู "ุฎูุจ" ุซุจุช ูโุดูุฏ.', note: 'ุดูุง ุฏููุงู ูโุฏุงูุฏ ฺู ฺฉุณ ฺู ููุด ุฏุงุฑุฏ.' },
            'Scarlet Woman': { desc: 'ุงฺฏุฑ ุดุทุงู ุจูุฑุฏ ู ต ุง ุจุดุชุฑ ุจุงุฒฺฉู ุฒูุฏู ุจุงุดูุฏ (ูุจู ุงุฒ ูุฑฺฏ ุดุทุงู)ุ ุดูุง ููุฑุงู ุชุจุฏู ุจู ุดุทุงู ุฌุฏุฏ ูโุดูุฏ.', note: 'ุดุฑุท ต+ ุจุงุฒฺฉู ุฒูุฏู ูุจู ุงุฒ ูุฑฺฏ ุดุทุงู ุจุฑุฑุณ ูโุดูุฏ. ุงฺฏุฑ ฺฉูุชุฑ ุงุฒ ต ููุฑ ุฒูุฏู ุจุงุดูุฏ ู ุดุทุงู ุจูุฑุฏุ ุจุงุฒ ุชูุงู ูโุดูุฏ ู ุชู ุดุฑุฑ ุจุฑูุฏู ูโุดูุฏ.' },
            'Baron': { desc: 'ุฏู ุบุฑุจู ุงุถุงู ุฏุฑ ุจุงุฒ ูุฌูุฏ ุฏุงุฑูุฏ [+ฒ ุบุฑุจู].', note: 'ุงู ฺฉ ูุงุจูุช ูููุนู ุงุณุช ฺฉู ุฏุฑ ุงุจุชุฏุง ุจุงุฒ ุงุนูุงู ูโุดูุฏ. ฒ ุดูุฑููุฏ ฺฉูุชุฑ ู ฒ ุบุฑุจู ุจุดุชุฑ ุชูุฒุน ูโุดูุฏ.' },
            'Imp': { desc: 'ูุฑ ุดุจุ ฺฉ ุจุงุฒฺฉู ุฑุง ุงูุชุฎุงุจ ูโฺฉูุฏ ุชุง ุจฺฉุดุฏ. ุดูุง ูโุชูุงูุฏ ุฎูุฏุชุงู ุฑุง ุจฺฉุดุฏ.', note: 'ุงฺฏุฑ ุฎูุฏุชุงู ุฑุง ุจฺฉุดุฏุ ฺฉ ุฎุงุฏู ุชุจุฏู ุจู ุดุทุงู ุฌุฏุฏ ูโุดูุฏ.' }
        };

        function showPlayerGuide() {
            var content = document.getElementById('guide-content');
            var playerCount = document.getElementById('player-count-display') ? parseInt(document.getElementById('player-count-display').innerText) : 7;
            var dist = CHARACTER_DISTRIBUTION[playerCount] || CHARACTER_DISTRIBUTION[7];
            
            var html = '<div style="margin-bottom: 30px;">';
            html += '<h2 style="color: var(--accent-color); margin-top: 20px; margin-bottom: 10px;">ุชูุฒุน ุดุฎุตุชโูุง</h2>';
            html += '<p><strong>ุจุฑุง ' + playerCount + ' ุจุงุฒฺฉู:</strong></p>';
            html += '<ul style="margin: 10px 0; padding-right: 25px;">';
            html += '<li><strong>' + dist.townsfolk + ' ุดูุฑููุฏ</strong></li>';
            html += '<li><strong>' + dist.outsiders + ' ุบุฑุจู</strong></li>';
            html += '<li><strong>' + dist.minions + ' ุฎุงุฏู ุดุทุงู</strong></li>';
            html += '<li><strong>' + dist.demon + ' ุดุทุงู</strong></li>';
            html += '</ul>';
            html += '</div>';

            var pools = [
                { name: 'ุดูุฑููุฏุงู (ุชู ุฎูุจ) [' + dist.townsfolk + ']', color: 'var(--townsfolk-color)', bg: 'rgba(2, 119, 189, 0.1)', list: TOWNSFOLK_POOL },
                { name: 'ุบุฑุจู (ุชู ุฎูุจุ ุงูุง ุจุง ูุนุงุจ) [' + dist.outsiders + ']', color: 'var(--outsider-color)', bg: 'rgba(25, 118, 210, 0.1)', list: OUTSIDER_POOL },
                { name: 'ุฎุงุฏู ุดุทุงู (ุชู ุดุฑุฑ) [' + dist.minions + ']', color: 'var(--minion-color)', bg: 'rgba(230, 81, 0, 0.1)', list: MINION_POOL },
                { name: 'ุดุทุงู (ุชู ุดุฑุฑ) [' + dist.demon + ']', color: 'var(--demon-color)', bg: 'rgba(213, 0, 0, 0.1)', list: DEMON_POOL }
            ];

            pools.forEach(pool => {
            html += '<div style="margin-bottom: 30px;">';
                html += '<h2 style="color: ' + pool.color + '; margin-top: 20px; margin-bottom: 10px;">' + pool.name + '</h2>';
                
                pool.list.forEach(roleKey => {
                    var char = CHARACTERS[roleKey];
                    var info = ROLE_GUIDE_INFO[roleKey] || {desc: char.ability, note: ''};
                    
                    html += '<div style="background: ' + pool.bg + '; padding: 15px; border-radius: 8px; margin-bottom: 15px;">';
                    html += '<strong>' + char.name + '</strong><br>';
                    html += '<span style="font-size: 0.9rem; color: var(--text-secondary);">' + info.desc + '<br><br><em>ูฺฉุชู: ' + info.note + '</em></span>';
            html += '</div>';
                });
            html += '</div>';
            });

            html += '<div style="margin-bottom: 30px;">';
            html += '<h2 style="color: var(--accent-color); margin-top: 20px; margin-bottom: 10px;">ุดุฑุงุท ุจุฑูุฏู ุดุฏู</h2>';
            html += '<div style="background: rgba(76, 175, 80, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 15px;">';
            html += '<strong>ุชู ุฎูุจ ุจุฑูุฏู ูโุดูุฏ ุงฺฏุฑ:</strong><br>';
            html += '<span style="font-size: 0.9rem; color: var(--text-secondary);">ุดุทุงู ุงุนุฏุงู ุดูุฏ.</span>';
            html += '</div>';
            html += '<div style="background: rgba(244, 67, 54, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 15px;">';
            html += '<strong>ุชู ุดุฑุฑ ุจุฑูุฏู ูโุดูุฏ ุงฺฏุฑ:</strong><br>';
            html += '<span style="font-size: 0.9rem; color: var(--text-secondary);">ููุท ุฏู ุจุงุฒฺฉู ุฒูุฏู ุจูุงูุฏ (ุดุทุงู ู ฺฉ ููุฑ ุฏฺฏุฑ).</span>';
            html += '</div>';
            html += '</div>';

            html += '<div style="margin-bottom: 30px;">';
            html += '<h2 style="color: var(--accent-color); margin-top: 20px; margin-bottom: 10px;">ูฺฉุงุช ููู</h2>';
            html += '<ul style="margin: 10px 0; padding-right: 25px; font-size: 0.9rem; line-height: 1.8;">';
            html += '<li>ุจุงุฒฺฉูุงู ูุฑุฏู ูููุฒ ูโุชูุงููุฏ ุตุญุจุช ฺฉููุฏ ู ุฏุฑ ุจุญุซโูุง ุดุฑฺฉุช ฺฉููุฏ</li>';
            html += '<li>ุจุงุฒฺฉูุงู ูุฑุฏู ุฏุฑ ูุฌููุน ฺฉ ุฑุง ุจุฑุง ุจุงู ุจุงุฒ ุฏุงุฑูุฏ</li>';
            html += '<li>ูุฑ ุจุงุฒฺฉู ููุท ฺฉ ุจุงุฑ ุฏุฑ ุฑูุฒ ูโุชูุงูุฏ ูุงูุฒุฏ ฺฉูุฏ</li>';
            html += '<li>ุจุฑุง ุงุนุฏุงู ุฑุง ุงฺฉุซุฑุช ูุงุฒู ุงุณุช (ุจุด ุงุฒ ูู ุงุฒ ุจุงุฒฺฉูุงู ุฒูุฏู)</li>';
            html += '<li>ุดุฎุตุชโูุง ููุช ุจุงุฒฺฉูุงู ูโูุฑูุฏ ูุงุด ููโุดููุฏ</li>';
            html += '<li>ุงุทูุงุนุงุช ุฏุงุฏู ุดุฏู ุชูุณุท ูุตูโฺฏู ููฺฉู ุงุณุช ูุงุฏุฑุณุช ุจุงุดุฏ (ุจู ุฎุตูุต ุจุฑุง ุจุงุฒฺฉูุงู ูุณููู ุดุฏู)</li>';
            html += '</ul>';
            html += '</div>';

            content.innerHTML = html;
            document.getElementById('guide-modal').classList.remove('hidden');
        }

        function closePlayerGuide() {
            document.getElementById('guide-modal').classList.add('hidden');
        }

        function shuffleArray(array) {
            for (var i = array.length - 1; i > 0; i--) {
                var j = Math.floor(Math.random() * (i + 1));
                var temp = array[i];
                array[i] = array[j];
                array[j] = temp;
            }
        }

        function showCheatSheet() {
            var container = document.getElementById('cheat-sheet-content');
            // Always clear and rebuild to support script changes
            container.innerHTML = '';
            
            var playerCount = document.getElementById('player-count-display') ? parseInt(document.getElementById('player-count-display').innerText) : 7;
            var dist = CHARACTER_DISTRIBUTION[playerCount] || CHARACTER_DISTRIBUTION[7];

            // Create container wrapper
            container.className = 'cheat-sheet-container';
            
            // Define sections with pools
            var sections = [
                { type: 'townsfolk', header: 'ุดูุฑููุฏุงู (ุชู ุฎูุจ) [' + dist.townsfolk + ']', headerClass: 'cs-townsfolk-header', pool: TOWNSFOLK_POOL },
                { type: 'outsider', header: 'ุบุฑุจูโูุง (ุชู ุฎูุจ) [' + dist.outsiders + ']', headerClass: 'cs-outsider-header', pool: OUTSIDER_POOL },
                { type: 'minion', header: 'ุฎุงุฏูุงู ุดุทุงู (ุชู ุดุฑุฑ) [' + dist.minions + ']', headerClass: 'cs-minion-header', pool: MINION_POOL },
                { type: 'demon', header: 'ุดุงุทู (ุชู ุดุฑุฑ) [' + dist.demon + ']', headerClass: 'cs-demon-header', pool: DEMON_POOL }
            ];
            
            sections.forEach(function(section) {
                // Create section container
                var sectionDiv = document.createElement('div');
                sectionDiv.className = 'cheat-sheet-section';
                
                // Add header
                var header = document.createElement('div');
                header.className = 'cheat-sheet-header ' + section.headerClass;
                header.innerText = section.header;
                sectionDiv.appendChild(header);
                
                // Create grid for this section
                var grid = document.createElement('div');
                grid.className = 'cheat-sheet-grid';
                
                section.pool.forEach(function(key) {
                    var char = CHARACTERS[key];
                    var card = document.createElement('div');
                    card.className = 'cheat-sheet-card role-' + section.type;
                    
                    var rebus = ROLE_REBUS[key] || char.ability;
                    
                    card.innerHTML = 
                        '<div class="cs-icon">' + (ROLE_ICONS[key] || 'โ') + '</div>' +
                        '<div class="cs-name">' + char.name + '</div>' +
                        '<div class="cs-rebus">' + rebus + '</div>';
                        
                    grid.appendChild(card);
                });
                
                sectionDiv.appendChild(grid);
                container.appendChild(sectionDiv);
            });
            
            // Add Winning Conditions
            var winDiv = document.createElement('div');
            winDiv.className = 'win-conditions';
            winDiv.innerHTML = 
                '<div class="win-card win-good">' +
                    '<h3 style="color:var(--good-color); margin:0 0 10px 0;">ูพุฑูุฒ ุชู ุฎูุจ</h3>' +
                    '<p style="margin:0; font-size:0.9rem;">ุงุนุฏุงู ุดุทุงู</p>' +
                '</div>' +
                '<div class="win-card win-evil">' +
                    '<h3 style="color:var(--evil-color); margin:0 0 10px 0;">ูพุฑูุฒ ุชู ุดุฑุฑ</h3>' +
                    '<p style="margin:0; font-size:0.9rem;">ููุท ฒ ุจุงุฒฺฉู ุฒูุฏู ุจูุงููุฏ</p>' +
                '</div>';
            container.appendChild(winDiv);

            document.getElementById('cheat-sheet-modal').classList.remove('hidden');
        }

        function closeCheatSheet() {
            document.getElementById('cheat-sheet-modal').classList.add('hidden');
        }
    </script>
</body>
</html>


