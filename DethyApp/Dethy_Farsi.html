<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù…Ø§ÙÛŒØ§ Ûµ Ù†ÙØ±Ù‡ (Ø¯ÙØªÛŒ)</title>
    <style>
        :root {
            --bg-color: #0f172a; /* Dark Slate */
            --card-bg: #1e293b;
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
            --accent-color: #3b82f6; /* Blue for Cop */
            --mafia-color: #ef4444;
            --cop-color: #3b82f6;
            --btn-color: #3b82f6;
            --border-radius: 16px;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Tahoma', 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            overflow-x: hidden;
            user-select: none;
        }

        .container {
            width: 95%;
            max-width: 500px;
            padding: 20px;
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            margin-top: 20px;
            margin-bottom: 20px;
        }

        h1 { font-size: 1.8rem; margin: 0 0 0.5rem 0; font-weight: 900; color: var(--accent-color); }
        h2 { font-size: 1.2rem; margin: 10px 0; color: var(--text-secondary); }
        p { font-size: 1rem; color: var(--text-secondary); margin-bottom: 1rem; line-height: 1.6; }

        .setup-info {
            background: rgba(255,255,255,0.05);
            padding: 15px;
            border-radius: 12px;
            margin: 10px 0;
            width: 100%;
            text-align: right;
            font-size: 0.9rem;
            color: #ddd;
        }

        /* Inputs */
        .player-input {
            width: 100%;
            padding: 12px;
            margin-bottom: 10px;
            background-color: #334155;
            border: 1px solid #475569;
            border-radius: 8px;
            color: white;
            font-family: inherit;
            font-size: 1rem;
            text-align: center;
        }
        .player-input:focus { outline: 2px solid var(--accent-color); border-color: transparent; }

        /* Bottom Bar */
        .bottom-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: #1e293b;
            padding: 15px;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.5);
            border-top: 1px solid #334155;
            display: flex;
            justify-content: center;
            z-index: 100;
        }

        button.action-btn {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 1.1rem;
            font-family: inherit;
            font-weight: 700;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
            width: 100%;
            max-width: 400px;
            transition: transform 0.1s;
        }
        button.action-btn:active { transform: scale(0.95); }

        /* Screens */
        .hidden { display: none !important; }
        
        .role-card {
            background: rgba(0,0,0,0.2);
            padding: 20px;
            border-radius: 16px;
            width: 100%;
            margin: 20px 0;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .role-title { font-size: 2rem; font-weight: 900; margin-bottom: 10px; }

        /* Night Action UI */
        .target-btn {
            width: 100%;
            background: #334155;
            border: 1px solid #475569;
            color: white;
            padding: 15px;
            margin-bottom: 8px;
            border-radius: 10px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: background 0.2s;
        }
        .target-btn:active { background: var(--accent-color); }

        .result-box {
            background: rgba(255,255,255,0.1);
            border: 2px solid var(--accent-color);
            padding: 20px;
            border-radius: 12px;
            font-size: 1.5rem;
            font-weight: bold;
            margin: 20px 0;
            animation: popIn 0.3s ease-out;
        }

        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        .mafia-text { color: #ef4444; }
        .town-text { color: #22c55e; }

    </style>
</head>
<body>

    <!-- 1. Setup Screen -->
    <div id="setup-screen" class="container" style="padding-bottom: 100px;">
        <h1>Ù…Ø§ÙÛŒØ§ Ûµ Ù†ÙØ±Ù‡ (Ø¯ÙØªÛŒ)</h1>
        <p>Ø³Ù†Ø§Ø±ÛŒÙˆÛŒ Û± Ù…Ø§ÙÛŒØ§ Ùˆ Û´ Ù¾Ù„ÛŒØ³</p>

        <div class="setup-info">
            <strong>Ù†Ù‚Ø´â€ŒÙ‡Ø§:</strong><br>
            â€¢ Û± <span style="color:var(--mafia-color)">Ù…Ø§ÙÛŒØ§</span> (Ú¯Ø§Ø¯ ÙØ§Ø¯Ø±)<br>
            â€¢ Û± <span style="color:var(--cop-color)">Ù¾Ù„ÛŒØ³ Ù…Ø¹ØªØ¨Ø±</span> (Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø¯Ø±Ø³Øª)<br>
            â€¢ Û± <span style="color:var(--cop-color)">Ù¾Ù„ÛŒØ³ Ø¨Ø±Ø¹Ú©Ø³</span> (Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø¨Ø±Ø¹Ú©Ø³)<br>
            â€¢ Û± <span style="color:var(--cop-color)">Ù¾Ù„ÛŒØ³ Ø¨Ø¯Ø¨ÛŒÙ†</span> (Ù‡Ù…ÛŒØ´Ù‡ Ù…Ø§ÙÛŒØ§)<br>
            â€¢ Û± <span style="color:var(--cop-color)">Ù¾Ù„ÛŒØ³ Ø³Ø§Ø¯Ù‡â€ŒÙ„ÙˆØ­</span> (Ù‡Ù…ÛŒØ´Ù‡ Ø´Ù‡Ø±ÙˆÙ†Ø¯)<br>
            <br>
            <em>Ù†Ú©ØªÙ‡: Ù‡ÛŒÚ† Ù¾Ù„ÛŒØ³ÛŒ Ù†Ù…ÛŒâ€ŒØ¯Ø§Ù†Ø¯ Ú©Ø¯Ø§Ù… Ù†ÙˆØ¹ Ù¾Ù„ÛŒØ³ Ø§Ø³Øª. Ù‡Ù…Ù‡ ÙÙ‚Ø· Ù…ÛŒâ€ŒØ¯Ø§Ù†Ù†Ø¯ "Ù¾Ù„ÛŒØ³" Ù‡Ø³ØªÙ†Ø¯.</em>
        </div>

        <div style="text-align: right; width: 100%; margin-bottom: 10px; font-weight: bold;">Ø§Ø³Ø§Ù…ÛŒ Ø¨Ø§Ø²ÛŒÚ©Ù†Ø§Ù†:</div>
        <div id="player-inputs">
            <input type="text" class="player-input" placeholder="Ø¬ÙˆØ§Ø¯" value="Ø¬ÙˆØ§Ø¯">
            <input type="text" class="player-input" placeholder="Ø±ÛŒØ­Ø§Ù†Ù‡" value="Ø±ÛŒØ­Ø§Ù†Ù‡">
            <input type="text" class="player-input" placeholder="Ø±Ø§ÛŒØ§Ù†" value="Ø±Ø§ÛŒØ§Ù†">
            <input type="text" class="player-input" placeholder="Ø¨Ø§Ø²ÛŒÚ©Ù† Û´" value="Ø¨Ø§Ø²ÛŒÚ©Ù† Û´">
            <input type="text" class="player-input" placeholder="Ø¨Ø§Ø²ÛŒÚ©Ù† Ûµ" value="Ø¨Ø§Ø²ÛŒÚ©Ù† Ûµ">
        </div>
    </div>

    <!-- Setup Bottom Bar -->
    <div id="setup-bar" class="bottom-bar">
        <button class="action-btn" onclick="startDistribution()">ØªÙˆØ²ÛŒØ¹ Ù†Ù‚Ø´â€ŒÙ‡Ø§</button>
    </div>

    <!-- 2. Pass Screen (Shared) -->
    <div id="pass-screen" class="container hidden">
        <div style="font-size: 0.9rem; color: #888; margin-bottom: 20px;">
            Ù†ÙˆØ¨Øª: <span id="player-name-pass"></span>
        </div>
        <div style="font-size: 5rem; margin: 30px;">ğŸ“±</div>
        <h2>Ú¯ÙˆØ´ÛŒ Ø±Ø§ Ø¨Ø¯Ù‡ÛŒØ¯ Ø¨Ù‡:</h2>
        <h1 id="pass-target-name" style="color: var(--accent-color);"></h1>
        <button id="pass-action-btn" class="action-btn" style="margin-top: 20px;" onclick="revealContent()">Ù…Ø´Ø§Ù‡Ø¯Ù‡</button>
    </div>

    <!-- 3. Role Reveal Screen -->
    <div id="reveal-screen" class="container hidden">
        <h2 id="reveal-player-name"></h2>
        
        <div class="role-card">
            <div id="role-title" class="role-title">...</div>
            <div id="role-desc" style="color: #ccc; font-size: 0.95rem; line-height: 1.6;">...</div>
        </div>

        <p style="font-size: 0.9rem; opacity: 0.6; margin-top: 20px;">Ù†Ù‚Ø´ Ø±Ø§ Ø¨Ù‡ Ø®Ø§Ø·Ø± Ø¨Ø³Ù¾Ø§Ø±ÛŒØ¯.</p>
        <button class="action-btn" style="background-color: #334155;" onclick="nextDistribute()">Ù†ÙØ± Ø¨Ø¹Ø¯ÛŒ</button>
    </div>

    <!-- 4. Distribution End / Phase Menu -->
    <div id="phase-menu" class="container hidden">
        <h1>ÙØ§Ø² Ø¨Ø§Ø²ÛŒ</h1>
        <p id="night-indicator" style="font-weight:bold; color:var(--accent-color);">Ø´Ø±ÙˆØ¹ Ø¨Ø§Ø²ÛŒ</p>
        <p>Ú¯ÙˆØ´ÛŒ Ø±Ø§ Ø¨Ù‡ Ø±Ø§ÙˆÛŒ Ø¨Ø¯Ù‡ÛŒØ¯.</p>
        
        <button class="action-btn" style="margin-bottom: 15px;" onclick="startNight()">Ø´Ø±ÙˆØ¹ Ø´Ø¨ Ø¬Ø¯ÛŒØ¯</button>
        
        <div style="border-top: 1px solid #334155; margin: 20px 0; width: 100%;"></div>
        
        <div class="setup-info" style="text-align: center;">
            <h3>Ù†ØªØ§ÛŒØ¬ ÙˆØ§Ù‚Ø¹ÛŒ (Ù…Ø®ØµÙˆØµ Ø±Ø§ÙˆÛŒ/Ú¯Ø§Ø¯)</h3>
            <button onclick="toggleGodView()" style="background:none; border:1px solid #555; color:#aaa; padding:5px 10px; border-radius:4px;">Ù†Ù…Ø§ÛŒØ´/Ù…Ø®ÙÛŒ</button>
            <div id="god-view" class="hidden" style="text-align: right; margin-top: 10px; font-size: 0.85rem;"></div>
            <div id="mafia-kill-log" style="text-align: right; margin-top: 10px; font-size: 0.85rem; color: #ef4444;"></div>
        </div>
        
        <button class="action-btn" style="background-color: #ef4444; margin-top: 20px;" onclick="location.reload()">Ø¨Ø§Ø²ÛŒ Ø¬Ø¯ÛŒØ¯</button>
    </div>

    <!-- 5. Night Action Screen -->
    <div id="night-screen" class="container hidden">
        <h2 id="night-player-name"></h2>
        <p>ÛŒÚ© Ù†ÙØ± Ø±Ø§ Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:</p>
        
        <div id="target-list" style="width: 100%;">
            <!-- Target Buttons -->
        </div>

        <button class="action-btn" style="background-color: #334155; margin-top: 10px;" onclick="nextNight()">Ø±Ø¯ Ø´Ø¯Ù† / Ù†ÙØ± Ø¨Ø¹Ø¯ÛŒ</button>
    </div>

    <!-- 6. Result Screen -->
    <div id="result-screen" class="container hidden">
        <h2>Ù†ØªÛŒØ¬Ù‡ Ø§Ø³ØªØ¹Ù„Ø§Ù…</h2>
        <p>ÙˆØ¶Ø¹ÛŒØª Ø¨Ø§Ø²ÛŒÚ©Ù† Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡:</p>
        
        <div id="result-box" class="result-box">
            ...
        </div>

        <button class="action-btn" onclick="finishResult()">ØªØ§ÛŒÛŒØ¯ Ùˆ Ù†ÙØ± Ø¨Ø¹Ø¯ÛŒ</button>
    </div>

    <script>
        // --- Constants ---
        var ROLE_DEFS = {
            mafia: { name: 'Ù…Ø§ÙÛŒØ§', color: '#ef4444', desc: 'Ø´Ù…Ø§ Ù…Ø§ÙÛŒØ§ Ù‡Ø³ØªÛŒØ¯. Ù‡Ø¯Ù Ø´Ù…Ø§ Ø­Ø°Ù Ø´Ù‡Ø±ÙˆÙ†Ø¯Ø§Ù† Ø§Ø³Øª.' },
            sane: { name: 'Ù¾Ù„ÛŒØ³', realType: 'sane', color: '#3b82f6', desc: 'Ø´Ù…Ø§ Ù¾Ù„ÛŒØ³ Ù‡Ø³ØªÛŒØ¯. Ù‡Ø± Ø´Ø¨ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø§Ø³ØªØ¹Ù„Ø§Ù… ÛŒÚ© Ù†ÙØ± Ø±Ø§ Ø¨Ú¯ÛŒØ±ÛŒØ¯.' },
            insane: { name: 'Ù¾Ù„ÛŒØ³', realType: 'insane', color: '#3b82f6', desc: 'Ø´Ù…Ø§ Ù¾Ù„ÛŒØ³ Ù‡Ø³ØªÛŒØ¯. Ù‡Ø± Ø´Ø¨ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø§Ø³ØªØ¹Ù„Ø§Ù… ÛŒÚ© Ù†ÙØ± Ø±Ø§ Ø¨Ú¯ÛŒØ±ÛŒØ¯.' },
            paranoid: { name: 'Ù¾Ù„ÛŒØ³', realType: 'paranoid', color: '#3b82f6', desc: 'Ø´Ù…Ø§ Ù¾Ù„ÛŒØ³ Ù‡Ø³ØªÛŒØ¯. Ù‡Ø± Ø´Ø¨ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø§Ø³ØªØ¹Ù„Ø§Ù… ÛŒÚ© Ù†ÙØ± Ø±Ø§ Ø¨Ú¯ÛŒØ±ÛŒØ¯.' },
            naive: { name: 'Ù¾Ù„ÛŒØ³', realType: 'naive', color: '#3b82f6', desc: 'Ø´Ù…Ø§ Ù¾Ù„ÛŒØ³ Ù‡Ø³ØªÛŒØ¯. Ù‡Ø± Ø´Ø¨ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø§Ø³ØªØ¹Ù„Ø§Ù… ÛŒÚ© Ù†ÙØ± Ø±Ø§ Ø¨Ú¯ÛŒØ±ÛŒØ¯.' }
        };

        // --- State ---
        var playerNames = [];
        var players = []; // { name, roleKey, roleObj }
        var currentIndex = 0;
        var isNightPhase = false;
        var nightNumber = 0;
        var isGameInProgress = false;
        
        // Completely prevent accidental refresh/back navigation
        // Set up event listeners once (always active, check flag when firing)
        window.addEventListener('beforeunload', function(e) {
            if (isGameInProgress) {
                e.preventDefault();
                e.returnValue = 'Game is in progress! Reloading will lose all progress.';
                return e.returnValue;
            }
        });
        
        // Disable keyboard shortcuts for refresh (F5, Ctrl+R, Ctrl+Shift+R)
        document.addEventListener('keydown', function(e) {
            if (isGameInProgress) {
                // F5
                if (e.key === 'F5' || e.keyCode === 116) {
                    e.preventDefault();
                    alert('Refresh is disabled during game. Use game controls to navigate.');
                    return false;
                }
                // Ctrl+R or Ctrl+Shift+R
                if ((e.ctrlKey || e.metaKey) && (e.key === 'r' || e.key === 'R')) {
                    e.preventDefault();
                    alert('Refresh is disabled during game. Use game controls to navigate.');
                    return false;
                }
            }
        });
        
        // Disable right-click context menu during game
        document.addEventListener('contextmenu', function(e) {
            if (isGameInProgress) {
                e.preventDefault();
                return false;
            }
        }, false);
        
        // Handle back button
        window.onpopstate = function(event) {
            if (isGameInProgress) {
                // Immediately push state back to prevent navigation
                history.pushState({page: 'game'}, '', location.href);
                // Show warning
                alert('Back button is disabled during game. Use game controls to navigate.');
            }
        };
        
        function preventAccidentalNavigation() {
            if (isGameInProgress) {
                // Completely prevent back button - push state and immediately replace
                history.pushState({page: 'game'}, '', location.href);
                history.pushState({page: 'game'}, '', location.href);
            }
        }

        // --- Setup ---
        function startDistribution() {
            isGameInProgress = true;
            preventAccidentalNavigation();
            // Get Names
            var inputs = document.querySelectorAll('.player-input');
            playerNames = [];
            for (var i = 0; i < inputs.length; i++) {
                playerNames.push(inputs[i].value.trim() || inputs[i].getAttribute('placeholder'));
            }

            // Assign Roles
            var deck = ['mafia', 'sane', 'insane', 'paranoid', 'naive'];
            shuffleArray(deck);

            players = [];
            var godHtml = "";
            for (var j = 0; j < 5; j++) {
                var rKey = deck[j];
                var rObj = ROLE_DEFS[rKey];
                players.push({
                    id: j,
                    name: playerNames[j],
                    roleKey: rKey,
                    roleObj: rObj
                });

                // Build God View String
                var realRoleName = rObj.name;
                if (rKey === 'sane') realRoleName += " (Ù…Ø¹ØªØ¨Ø±)";
                if (rKey === 'insane') realRoleName += " (Ø¨Ø±Ø¹Ú©Ø³)";
                if (rKey === 'paranoid') realRoleName += " (Ø¨Ø¯Ø¨ÛŒÙ†/Ù‡Ù…ÛŒØ´Ù‡ Ù…Ø§ÙÛŒØ§)";
                if (rKey === 'naive') realRoleName += " (Ø³Ø§Ø¯Ù‡â€ŒÙ„ÙˆØ­/Ù‡Ù…ÛŒØ´Ù‡ Ø´Ù‡Ø±)";
                
                godHtml += "<strong>" + playerNames[j] + ":</strong> " + realRoleName + "<br>";
            }
            document.getElementById('god-view').innerHTML = godHtml;

            // Start Flow
            currentIndex = 0;
            document.getElementById('setup-screen').classList.add('hidden');
            document.getElementById('setup-bar').classList.add('hidden');
            
            showPassScreen(false); // false = distribution mode
        }

        // --- Distribution Flow ---
        function showPassScreen(nightMode) {
            var p = players[currentIndex];
            document.getElementById('player-name-pass').innerText = nightMode ? ("Ø´Ø¨ - Ù†ÙØ± " + (currentIndex + 1)) : ("ØªÙˆØ²ÛŒØ¹ - Ù†ÙØ± " + (currentIndex + 1));
            document.getElementById('pass-target-name').innerText = p.name;
            
            var btn = document.getElementById('pass-action-btn');
            btn.onclick = nightMode ? startNightTurn : revealRole;
            btn.innerText = nightMode ? "Ø´Ø±ÙˆØ¹ Ù†ÙˆØ¨Øª" : "Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù†Ù‚Ø´";

            showScreen('pass-screen');
        }

        function revealRole() {
            var p = players[currentIndex];
            document.getElementById('reveal-player-name').innerText = p.name;
            
            var titleEl = document.getElementById('role-title');
            var descEl = document.getElementById('role-desc');
            
            titleEl.innerText = p.roleObj.name;
            titleEl.style.color = p.roleObj.color;
            descEl.innerText = p.roleObj.desc;

            showScreen('reveal-screen');
        }

        function nextDistribute() {
            currentIndex++;
            if (currentIndex >= 5) {
                showScreen('phase-menu');
            } else {
                showPassScreen(false);
            }
        }

        // --- Night Flow ---
        function startNight() {
            currentIndex = 0;
            isNightPhase = true;
            nightNumber++;
            document.getElementById('night-indicator').innerText = "Ø´Ø¨ " + nightNumber;
            showPassScreen(true);
        }

        function startNightTurn() {
            var p = players[currentIndex];
            document.getElementById('night-player-name').innerText = p.name;

            // Build Target List
            var list = document.getElementById('target-list');
            list.innerHTML = "";

            // Add default Next button behavior back for Mafia case
            var nextBtn = document.querySelector('#night-screen .action-btn');
            nextBtn.classList.add('hidden'); // Hide default button initially, we control flow

            if (p.roleKey === 'mafia') {
                if (nightNumber === 1) {
                     list.innerHTML = "<div style='color:#ef4444; font-weight:bold; margin-bottom:20px;'>Ø´Ø¨ Ù…Ø¹Ø§Ø±ÙÙ‡ (Headstart)<br>Ø´Ù…Ø§ Ø§Ù…Ø´Ø¨ Ø´Ù„ÛŒÚ© Ù†Ø¯Ø§Ø±ÛŒØ¯.</div>";
                     
                     var btn = document.createElement('button');
                     btn.className = 'target-btn';
                     btn.innerText = "ØªØ§ÛŒÛŒØ¯ Ùˆ Ø±Ø¯ Ø´Ø¯Ù†";
                     btn.onclick = function() { nextNight(); };
                     list.appendChild(btn);
                } else {
                     list.innerHTML = "<div style='color:#ef4444; font-weight:bold; margin-bottom:10px;'>Ø´Ù„ÛŒÚ© Ø´Ø¨ " + nightNumber + "</div>";
                     for (var i = 0; i < players.length; i++) {
                        if (i === currentIndex) continue; 
                        
                        var target = players[i];
                        var btn = document.createElement('button');
                        btn.className = 'target-btn';
                        btn.innerText = "Ø´Ù„ÛŒÚ© Ø¨Ù‡ " + target.name;
                        btn.style.borderColor = "#ef4444";
                        
                        // Closure for click
                        (function(tgt) {
                            btn.onclick = function() { recordMafiaKill(tgt); };
                        })(target);

                        list.appendChild(btn);
                    }
                }
            } else {
                // Cops
                for (var i = 0; i < players.length; i++) {
                    if (i === currentIndex) continue;
                    
                    var target = players[i];
                    var btn = document.createElement('button');
                    btn.className = 'target-btn';
                    btn.innerText = target.name;
                    
                    (function(tgt) {
                        btn.onclick = function() { processInvestigation(p, tgt); };
                    })(target);

                    list.appendChild(btn);
                }
            }

            showScreen('night-screen');
        }

        function recordMafiaKill(target) {
             var logEl = document.getElementById('mafia-kill-log');
             logEl.innerHTML += "Ø´Ø¨ " + nightNumber + ": Ø´Ù„ÛŒÚ© Ø¨Ù‡ <strong>" + target.name + "</strong><br>";
             
             var resBox = document.getElementById('result-box');
             resBox.innerText = "Ø´Ù„ÛŒÚ© Ø«Ø¨Øª Ø´Ø¯";
             resBox.className = "result-box mafia-text";
             resBox.style.borderColor = "#ef4444";
             
             isGameInProgress = false;
             localStorage.removeItem('dethy_farsi_game_state');
             showScreen('result-screen');
        }

        function processInvestigation(cop, target) {
            var result = "";
            var copType = cop.roleKey;
            var targetIsMafia = (target.roleKey === 'mafia');

            // Logic based on Dethy Wiki
            if (copType === 'sane') {
                // Reliable: Truth
                result = targetIsMafia ? "Ù…Ø§ÙÛŒØ§" : "Ø´Ù‡Ø±ÙˆÙ†Ø¯";
            } else if (copType === 'insane') {
                // Inverse: Opposite
                result = targetIsMafia ? "Ø´Ù‡Ø±ÙˆÙ†Ø¯" : "Ù…Ø§ÙÛŒØ§";
            } else if (copType === 'paranoid') {
                // Cynical: Always Mafia
                result = "Ù…Ø§ÙÛŒØ§";
            } else if (copType === 'naive') {
                // Naive: Always Town
                result = "Ø´Ù‡Ø±ÙˆÙ†Ø¯";
            }

            var resBox = document.getElementById('result-box');
            resBox.innerText = result;
            
            if (result === "Ù…Ø§ÙÛŒØ§") {
                resBox.className = "result-box mafia-text";
                resBox.style.borderColor = "#ef4444";
            } else {
                resBox.className = "result-box town-text";
                resBox.style.borderColor = "#22c55e";
            }

            isGameInProgress = false;
            localStorage.removeItem('dethy_farsi_game_state');
            showScreen('result-screen');
        }

        function finishResult() {
            nextNight();
        }

        function nextNight() {
            currentIndex++;
            if (currentIndex >= 5) {
                // End of Night
                showScreen('phase-menu');
            } else {
                showPassScreen(true);
            }
        }

        // --- Utils ---
        function shuffleArray(array) {
            for (var i = array.length - 1; i > 0; i--) {
                var j = Math.floor(Math.random() * (i + 1));
                var temp = array[i];
                array[i] = array[j];
                array[j] = temp;
            }
        }

        function showScreen(id) {
            var screens = ['setup-screen', 'pass-screen', 'reveal-screen', 'phase-menu', 'night-screen', 'result-screen'];
            for (var i = 0; i < screens.length; i++) {
                document.getElementById(screens[i]).classList.add('hidden');
            }
            document.getElementById(id).classList.remove('hidden');
        }

        function toggleGodView() {
            var el = document.getElementById('god-view');
            if (el.classList.contains('hidden')) el.classList.remove('hidden');
            else el.classList.add('hidden');
        }

    </script>
</body>
</html>

5t