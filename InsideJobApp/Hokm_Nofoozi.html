<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø­Ú©Ù… Ù†ÙÙˆØ°ÛŒ (Inside Job)</title>
    <style>
        :root {
            --bg-color: #1a1a1a;
            --card-bg: #f5f5dc; /* Beige/Cream Color */
            --text-primary: #e0e0e0;
            --text-secondary: #a0a0a0;
            --accent-color: #ff9800; /* Orange for 'Intel' */
            --insider-color: #f44336; /* Red for Insider */
            --agent-color: #4caf50; /* Green for Agents */
            --btn-bg: #333;
            --border-radius: 12px;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }
        
        /* RTL Support */
        body.rtl {
            direction: rtl;
            font-family: 'Tahoma', 'Segoe UI', sans-serif;
        }

        .container {
            width: 100%;
            max-width: 600px;
            padding: 20px;
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 10px;
            border-bottom: 1px solid #444;
        }

        h1 { margin: 0; font-size: 1.5rem; }

        .header-buttons {
            display: flex;
            gap: 8px;
        }
        
        .lang-toggle, .rules-btn {
            background: none;
            border: 1px solid #666;
            color: #aaa;
            padding: 5px 10px;
            font-size: 0.8rem;
            border-radius: 6px;
            cursor: pointer;
        }

        .rules-btn {
            border-color: var(--accent-color);
            color: var(--accent-color);
        }
        
        .score-board {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            background: #00000033;
            padding: 15px;
            border-radius: var(--border-radius);
        }

        .score-box {
            flex: 1;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .score-label { font-size: 0.85rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px; }
        .score-value { font-size: 2rem; font-weight: bold; margin-top: 5px; }
        
        .agent-score { color: var(--agent-color); }
        .insider-score { color: var(--insider-color); }

        /* Mission Card */
        .mission-card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 30px 20px;
            text-align: center;
            box-shadow: 0 8px 24px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 300px;
            position: relative;
            border: 2px solid #444;
            transition: transform 0.3s ease, border-color 0.3s;
        }

        .mission-card.active {
            border-color: var(--accent-color);
        }

        .mission-wager {
            position: absolute;
            top: 15px;
            right: 15px;
            background: var(--accent-color);
            color: #000;
            font-weight: bold;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        body.rtl .mission-wager {
            right: auto;
            left: 15px;
        }

        body.rtl #risky-indicator {
            left: auto;
            right: 15px;
        }

        .mission-title {
            font-size: 1.8rem;
            margin-bottom: 15px;
            color: #000;
        }

        .mission-desc {
            font-size: 1.1rem;
            color: #333;
            line-height: 1.5;
            max-width: 90%;
        }

        .trump-indicator {
            margin-top: 25px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }
        
        .trump-icon {
            font-size: 3rem;
        }

        .controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: auto;
        }

        button {
            border: none;
            padding: 16px;
            font-size: 1rem;
            font-weight: bold;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: opacity 0.2s;
            color: white;
        }

        button:active { opacity: 0.8; }

        .btn-success { background-color: var(--agent-color); }
        .btn-fail { background-color: var(--insider-color); }
        .btn-next { background-color: var(--btn-bg); grid-column: span 2; margin-top: 10px; }
        .btn-reset { background-color: transparent; color: #666; border: 1px solid #444; font-size: 0.8rem; padding: 8px 12px; margin-left: 10px; }
        body.rtl .btn-reset { margin-left: 0; margin-right: 10px; }

        .hidden { display: none !important; }

        /* Modal */
        .modal {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex; justify-content: center; align-items: center;
            z-index: 100;
        }
        .modal-content {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 16px;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            border: 1px solid #444;
        }
        .close-btn {
            position: absolute; top: 10px; right: 15px;
            font-size: 1.5rem; cursor: pointer; color: #888;
        }
        body.rtl .close-btn { right: auto; left: 15px; }
        .rules-text p { margin: 10px 0; line-height: 1.4; font-size: 0.95rem; border-bottom: 1px solid #333; padding-bottom: 8px; }
        .rules-text b { color: var(--accent-color); }

        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-in { animation: fadeIn 0.4s ease-out; }

        .suit-red { color: #d32f2f; }
        .suit-black { color: #000000; }
    </style>
</head>
<body>

    <!-- Setup Screen -->
    <div id="setup-screen" class="container">
        <h1>Ø­Ú©Ù… Ù†ÙÙˆØ°ÛŒ <span style="font-size:0.8rem; color:#888;">(ØªÙ†Ø¸ÛŒÙ…Ø§Øª)</span></h1>
        <div style="text-align:center; margin-top:20px; width: 100%;">
            <p id="setup-msg" style="color: #aaa; font-size: 1.1rem;">ØªØ¹Ø¯Ø§Ø¯ Ø¨Ø§Ø²ÛŒÚ©Ù†Ø§Ù† Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:</p>
            
            <div style="display:flex; gap:15px; justify-content:center; margin-bottom:20px;">
                <button onclick="startGame(3)" style="background:#333; width:70px; font-size: 1.2rem;">Û³</button>
                <button onclick="startGame(4)" style="background:#333; width:70px; font-size: 1.2rem;">Û´</button>
                <button onclick="startGame(5)" style="background:#333; width:70px; font-size: 1.2rem;">Ûµ</button>
            </div>

            <div style="display:flex; align-items:center; justify-content:center; gap:10px; margin-bottom:30px; direction: rtl;">
                <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size: 0.95rem;">
                    <input type="checkbox" id="include-risky" checked style="width:20px; height:20px; cursor:pointer;">
                    <span>Ø´Ø§Ù…Ù„ Ù…Ø§Ù…ÙˆØ±ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ù¾Ø±Ø®Ø·Ø± (Ø¨Ø§ Ú˜ØªÙˆÙ†)</span>
                </label>
            </div>

            <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 12px; font-size: 0.9rem; text-align: right; direction: rtl;">
                <h3 style="margin: 0 0 10px 0; color: var(--accent-color); text-align: center;">Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ù„ÛŒØ¯ÛŒ Ø¨Ø§Ø²ÛŒ</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 8px; border-bottom: 1px solid #444; padding-bottom: 5px; font-weight: bold; font-size: 0.8rem;">
                    <span>Ù†ÙØ±Ø§Øª</span>
                    <span>Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§</span>
                    <span>Ù…Ø§Ù…ÙˆØ±ÛŒØª</span>
                    <span>Ú˜ØªÙˆÙ†</span>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 8px; padding: 8px 0; border-bottom: 1px solid #333;">
                    <span>Û³ Ù†ÙØ±</span>
                    <span>Û±Û³</span>
                    <span>Û¹</span>
                    <span>Û¶</span>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 8px; padding: 8px 0; border-bottom: 1px solid #333;">
                    <span>Û´ Ù†ÙØ±</span>
                    <span>Û±Û²</span>
                    <span>Û·</span>
                    <span>Ûµ</span>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 8px; padding: 8px 0;">
                    <span>Ûµ Ù†ÙØ±</span>
                    <span>Û±Û°</span>
                    <span>Û¶</span>
                    <span>Û´</span>
                </div>
                <p style="margin-top: 15px; font-size: 0.8rem; color: #888; text-align: center;">
                    * Ù¾Ø§ÛŒØ§Ù† Ø¨Ø§Ø²ÛŒ (Ø±Ø§ÛŒâ€ŒÚ¯ÛŒØ±ÛŒ): Ø²Ù…Ø§Ù†ÛŒ Ú©Ù‡ Û² Ú©Ø§Ø±Øª (Ø¨Ø±Ø§ÛŒ Ûµ Ù†ÙØ± Û± Ú©Ø§Ø±Øª) Ø¯Ø± Ø¯Ø³Øª Ø¨Ø§Ù‚ÛŒ Ù…Ø§Ù†Ø¯Ù‡ Ø§Ø³Øª.<br>
                    <span style="color: var(--accent-color); display: block; margin-top: 8px;">
                        * Ù‡Ù…Ù‡ Ø¨Ø§ Û± Ú˜ØªÙˆÙ† Ø´Ø±ÙˆØ¹ Ù…ÛŒâ€ŒÚ©Ù†Ù†Ø¯ Ùˆ Ø¨Ø±Ù†Ø¯Ù‡ Ù‡Ø± Ø¯Ø³Øª Û± Ú˜ØªÙˆÙ† Ù…ÛŒâ€ŒÚ¯ÛŒØ±Ø¯.
                    </span>
                </p>
            </div>
        </div>
    </div>

    <!-- Main Game Screen -->
    <div id="game-screen" class="container hidden">
        <header>
            <div>
                <h1 id="app-title">Inside Job</h1>
            </div>
            <div class="header-buttons">
                <button class="rules-btn" onclick="toggleMissions()" id="btn-missions">Ù…Ø§Ù…ÙˆØ±ÛŒØªâ€ŒÙ‡Ø§ ğŸ“‹</button>
                <button class="rules-btn" onclick="toggleRules()" id="btn-rules">Rules ğŸ“œ</button>
                <!-- Lang Toggle Removed/Hidden for Farsi Focus, or kept if user wants to switch back? User said "Only Farsi". Let's hide it but keep logic if needed -->
                <!-- <button class="lang-toggle" onclick="toggleLang()">EN / FA</button> -->
                <button class="btn-reset" onclick="confirmReset()" id="btn-reset">Reset</button>
            </div>
        </header>

        <!-- Scoreboard -->
        <div class="score-board" style="justify-content: space-between;">
            <div class="score-box" style="flex: 1.5;">
                <span class="score-label" id="score-agents-label">Ù…Ø§Ù…ÙˆØ±ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯Ù‡</span>
                <span id="agent-score" class="score-value agent-score">0</span>
            </div>
            <div class="score-box" style="flex: 1; border-right: 1px solid #444; padding-right: 10px;">
                <span class="score-label">Ù‚ÙˆØ§Ù†ÛŒÙ† Ø³Ø±ÛŒØ¹</span>
                <div id="quick-rules-rebus" style="font-size: 0.85rem; margin-top: 8px; text-align: right; line-height: 1.4;">
                    <!-- Dynamic Rebus Rules -->
                </div>
            </div>
        </div>

        <!-- Pass Phone Screen -->
        <div id="pass-screen" class="container hidden" style="justify-content: center; text-align: center;">
            <div style="font-size: 4rem;">ğŸ“±</div>
            <h2>Ú¯ÙˆØ´ÛŒ Ø±Ø§ Ø¨Ù‡ Ø­Ø§Ú©Ù… (Ø´Ø±ÙˆØ¹â€ŒÚ©Ù†Ù†Ø¯Ù‡) Ø¨Ø¯Ù‡ÛŒØ¯</h2>
            <p>Ø¨Ø±Ø§ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù…Ø§Ù…ÙˆØ±ÛŒØª Ø¬Ø¯ÛŒØ¯</p>
            <button onclick="showSelection()" style="background-color: var(--accent-color); color: black; margin-top: 20px;">Ù…Ù† Ø­Ø§Ú©Ù… Ù‡Ø³ØªÙ…</button>
        </div>

        <!-- Selection Screen (Hidden by default) -->
        <div id="selection-area" class="mission-card hidden" style="justify-content: flex-start; padding-top: 20px;">
            <div class="mission-title" style="font-size: 1.4rem; margin-bottom: 20px; direction: rtl;">ÛŒÚ© Ù…Ø§Ù…ÙˆØ±ÛŒØª Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</div>
            <div style="display: flex; flex-direction: column; gap: 15px; width: 100%; flex: 1;">
                <button onclick="selectMission(0)" class="btn-next" style="flex:1; font-size: 1.1rem; padding: 20px; direction: rtl; display: flex; flex-direction: column; align-items: center; justify-content: center; background-color: var(--card-bg); border: 2px solid #444; color: black;">
                    <span id="sel-opt-1" style="width: 100%;">...</span>
                </button>
                <button onclick="selectMission(1)" class="btn-next" style="flex:1; font-size: 1.1rem; padding: 20px; direction: rtl; display: flex; flex-direction: column; align-items: center; justify-content: center; background-color: var(--card-bg); border: 2px solid #444; color: black;">
                    <span id="sel-opt-2" style="width: 100%;">...</span>
                </button>
            </div>
        </div>

        <!-- Current Mission Display -->
        <div id="mission-area" class="mission-card active animate-in hidden">
            <div class="mission-wager" style="display: none;"> <!-- Wager hidden as pot is physical -->
                <span id="wager-amount">2</span> ğŸŒ°
            </div>
            <div id="risky-indicator" style="position: absolute; top: 15px; left: 15px; background: #ff9800; color: #000; font-weight: bold; padding: 5px 12px; border-radius: 20px; font-size: 0.9rem; display: none;">
                âš ï¸ Ù¾Ø±Ø®Ø·Ø± (Ú˜ØªÙˆÙ† Ù„Ø§Ø²Ù…)
            </div>
            <div class="mission-title" id="mission-title" style="direction: rtl;">Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</div>
            <div class="mission-desc" id="mission-desc" style="direction: rtl;">Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ Ø¯Ú©Ù…Ù‡ Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯.</div>
            
            <div class="trump-indicator">
                <span style="font-size:0.8rem; color:#888; text-transform:uppercase;" id="trump-label">Ø­Ú©Ù…</span>
                <div id="trump-icon" class="trump-icon">â™ </div>
            </div>
        </div>

        <!-- Action Controls -->
        <div id="controls-area" class="controls hidden">
            <div style="grid-column: span 2; text-align: center; color: #888; font-size: 0.8rem; margin-bottom: 5px; direction: rtl;">ÙˆØ¶Ø¹ÛŒØª Ù…Ø§Ù…ÙˆØ±ÛŒØª</div>
            <button class="btn-success" onclick="resolveMission(true)">
                <span id="btn-success-text">Ù…Ø§Ù…ÙˆØ±ÛŒØª Ù…ÙˆÙÙ‚</span> (+Û±)
            </button>
            <button class="btn-fail" onclick="resolveMission(false)" id="btn-fail-text">Ù…Ø§Ù…ÙˆØ±ÛŒØª Ù†Ø§Ù…ÙˆÙÙ‚</button>
            
            <!-- Trick Winner buttons removed as we don't track insider pot -->
            
            <button class="btn-vote" onclick="triggerFinalVote()" id="btn-vote-text" style="grid-column: span 2; background-color: #9c27b0; margin-top: 10px;">ğŸ—³ï¸ Ø±Ø§ÛŒâ€ŒÚ¯ÛŒØ±ÛŒ Ù†Ù‡Ø§ÛŒÛŒ</button>
        </div>
    </div>

<!-- Rules Modal -->
<div id="rules-modal" class="modal hidden" onclick="toggleRules()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <span class="close-btn" onclick="toggleRules()">&times;</span>
        <h2 id="rules-header">Ù‚ÙˆØ§Ù†ÛŒÙ† ğŸ“œ</h2>
        <div id="rules-body" class="rules-text">
            <!-- Rules Injected Here -->
        </div>
    </div>
</div>

<!-- Missions Modal -->
<div id="missions-modal" class="modal hidden" onclick="toggleMissions()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <span class="close-btn" onclick="toggleMissions()">&times;</span>
        <h2>Ù„ÛŒØ³Øª Ù…Ø§Ù…ÙˆØ±ÛŒØªâ€ŒÙ‡Ø§</h2>
        <div id="missions-list" class="rules-text" style="direction: rtl;">
            <!-- Missions injected here -->
        </div>
    </div>
</div>

<script>
    // --- Localization ---
    let currentLang = 'fa'; // Default to Farsi

    const TEXTS = {
        en: {
            appTitle: "Inside Job",
            reset: "Reset",
            rulesBtn: "Rules ğŸ“œ",
            rulesHeader: "Quick Rules",
            agentsLabel: "Agents (Missions)",
            insiderLabel: "Insider",
            trumpLabel: "Trump Suit",
            btnSuccess: "Mission Success",
            btnFail: "Mission Failed",
            btnVote: "ğŸ—³ï¸ Final Vote",
            btnSkip: "Skip / New Mission",
            confirmReset: "Reset the game scores?",
            voteMsg: "End Game Vote: If you ran out of cards, vote now!\n\nMost votes on Insider = Agents Win.\nWrong vote = Insider Wins.",
            rulesBody: `
                <p>ğŸ•µï¸ <b>Roles:</b> Agents vs 1 Insider.</p>
                <p>ğŸ¯ <b>Goal:</b><br>
                âœ… <b>Agents:</b> Complete <span id='rule-mission-limit'>--</span> Missions.<br>
                âŒ <b>Insider:</b> Collect Tokens (Track Physically).</p>
                <p>ğŸƒ <b>Trick:</b> Must follow suit. ğŸ­ <b>Insider</b> can cheat.</p>
            `,
            suits: {
                Spades: "Spades", Hearts: "Hearts", Clubs: "Clubs", Diamonds: "Diamonds"
            }
        },
        fa: {
            appTitle: "Ø­Ú©Ù… Ù†ÙÙˆØ°ÛŒ",
            reset: "Ø´Ø±ÙˆØ¹ Ù…Ø¬Ø¯Ø¯",
            rulesBtn: "Ù‚ÙˆØ§Ù†ÛŒÙ† ğŸ“œ",
            rulesHeader: "Ù‚ÙˆØ§Ù†ÛŒÙ† Ø³Ø±ÛŒØ¹",
            agentsLabel: "Ù…Ø§Ù…ÙˆØ±ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯Ù‡",
            insiderLabel: "Ù†ÙÙˆØ°ÛŒ",
            trumpLabel: "Ø­Ú©Ù…",
            btnSuccess: "Ù…Ø§Ù…ÙˆØ±ÛŒØª Ù…ÙˆÙÙ‚",
            btnFail: "Ù…Ø§Ù…ÙˆØ±ÛŒØª Ù†Ø§Ù…ÙˆÙÙ‚",
            btnVote: "ğŸ—³ï¸ Ø±Ø§ÛŒâ€ŒÚ¯ÛŒØ±ÛŒ Ù†Ù‡Ø§ÛŒÛŒ",
            btnSkip: "Ø±Ø¯ Ú©Ø±Ø¯Ù† / Ù…Ø§Ù…ÙˆØ±ÛŒØª Ø¬Ø¯ÛŒØ¯",
            confirmReset: "Ø¢ÛŒØ§ Ø§Ù…ØªÛŒØ§Ø²Ù‡Ø§ ØµÙØ± Ø´ÙˆØ¯ØŸ",
            voteMsg: "Ø±Ø§ÛŒâ€ŒÚ¯ÛŒØ±ÛŒ Ù†Ù‡Ø§ÛŒÛŒ: Ø§Ú¯Ø± Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ ØªÙ…Ø§Ù… Ø´Ø¯ØŒ Ø±Ø§ÛŒ Ø¯Ù‡ÛŒØ¯!\n\nØ§Ú©Ø«Ø±ÛŒØª Ø±ÙˆÛŒ Ù†ÙÙˆØ°ÛŒ = Ø¨Ø±Ø¯ Ù…Ø§Ù…ÙˆØ±Ù‡Ø§.\nØ±Ø§ÛŒ Ø§Ø´ØªØ¨Ø§Ù‡ = Ø¨Ø±Ø¯ Ù†ÙÙˆØ°ÛŒ.",
            rulesBody: `
                <p>ğŸ•µï¸ <b>Ù†Ù‚Ø´â€ŒÙ‡Ø§:</b> Ù…Ø§Ù…ÙˆØ±Ù‡Ø§ Ø¹Ù„ÛŒÙ‡ Û± Ù†ÙÙˆØ°ÛŒ.</p>
                <p>ğŸ¯ <b>Ù‡Ø¯Ù:</b><br>
                âœ… <b>Ù…Ø§Ù…ÙˆØ±Ù‡Ø§:</b> Ø§Ù†Ø¬Ø§Ù… <span id='rule-mission-limit'>--</span> Ù…Ø§Ù…ÙˆØ±ÛŒØª.<br>
                âŒ <b>Ù†ÙÙˆØ°ÛŒ:</b> Ø¬Ù…Ø¹â€ŒØ¢ÙˆØ±ÛŒ Ú˜ØªÙˆÙ† (ÙÛŒØ²ÛŒÚ©ÛŒ Ø¨Ø´Ù…Ø§Ø±ÛŒØ¯).</p>
                <p>ğŸƒ <b>Ø¯Ø³Øª:</b> Ù¾ÛŒØ±ÙˆÛŒ Ø§Ø² Ø®Ø§Ù„ Ø§Ø¬Ø¨Ø§Ø±ÛŒ. ğŸ­ <b>Ù†ÙÙˆØ°ÛŒ</b> Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ ØªÙ‚Ù„Ø¨ Ú©Ù†Ø¯.</p>
            `,
            suits: {
                Spades: "Ù¾ÛŒÚ©", Hearts: "Ø¯Ù„", Clubs: "Ú¯Ø´Ù†ÛŒØ²", Diamonds: "Ø®Ø´Øª"
            }
        }
    };

    // --- Game Data ---
    const SUITS = [
        { name: 'Spades', symbol: 'â™ ', color: 'suit-black' },
        { name: 'Hearts', symbol: 'â™¥', color: 'suit-red' },
        { name: 'Clubs', symbol: 'â™£', color: 'suit-black' },
        { name: 'Diamonds', symbol: 'â™¦', color: 'suit-red' }
    ];

    // Official Missions (trump suits assigned randomly at game start)
    const MISSIONS = [
        { title_fa: "ØªÙ†Ø§ÙˆØ¨ Ø²ÙˆØ¬ Ùˆ ÙØ±Ø¯", desc_fa: "Ù‡Ø± Ú©Ø§Ø±Øª Ø¨Ø§Ø²ÛŒ Ø´Ø¯Ù‡ Ø¨Ø§ÛŒØ¯ Ø¨Ù‡ ØµÙˆØ±Øª Ù…ØªÙ†Ø§ÙˆØ¨ Ø²ÙˆØ¬ Ùˆ ÙØ±Ø¯ Ø¨Ø§Ø´Ø¯." },
        { title_fa: "Ù‡Ù…â€ŒØ®Ø§Ù„", desc_fa: "ØªÙ…Ø§Ù… Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ø²ÛŒ Ø´Ø¯Ù‡ Ø¨Ø§ÛŒØ¯ Ø§Ø² ÛŒÚ© Ø®Ø§Ù„ Ø¨Ø§Ø´Ù†Ø¯." },
        { title_fa: "Ø¢Ø®Ø±ÛŒÙ† Ú©Ù…ØªØ±ÛŒÙ†", desc_fa: "Ø¢Ø®Ø±ÛŒÙ† Ú©Ø§Ø±Øª Ø¨Ø§Ø²ÛŒ Ø´Ø¯Ù‡ Ø¨Ø§ÛŒØ¯ Ø§Ø² ØªÙ…Ø§Ù… Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ÛŒ Ø¯ÛŒÚ¯Ø± Ú©ÙˆÚ†Ú©ØªØ± Ø¨Ø§Ø´Ø¯." },
        { title_fa: "Ø¯ÙˆÙ…ÛŒÙ† Ú©Ù…ØªØ±ÛŒÙ†", desc_fa: "Ø¯ÙˆÙ…ÛŒÙ† Ú©Ø§Ø±Øª Ø¨Ø§Ø²ÛŒ Ø´Ø¯Ù‡ Ø¨Ø§ÛŒØ¯ Ú©Ù…ØªØ±ÛŒÙ† Ø¹Ø¯Ø¯ Ø§Ø² ØªÙ…Ø§Ù… Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ø²ÛŒ Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯." },
        { title_fa: "ÙÙ‚Ø· Ø²ÙˆØ¬", desc_fa: "ÙÙ‚Ø· Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ÛŒ Ø¨Ø§ Ø¹Ø¯Ø¯ Ø²ÙˆØ¬ Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ù†Ø¯ Ø¨Ø§Ø²ÛŒ Ø´ÙˆÙ†Ø¯." },
        { title_fa: "Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø±Ù†Ø¯Ù‡", desc_fa: "Ø¢Ø®Ø±ÛŒÙ† Ú©Ø§Ø±Øª Ø¨Ø§ÛŒØ¯ Ø¯Ø³Øª Ø±Ø§ Ø¨Ø¨Ø±Ø¯." },
        { title_fa: "ÙÙ‚Ø· ÙØ±Ø¯", desc_fa: "ÙÙ‚Ø· Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ÛŒ Ø¨Ø§ Ø¹Ø¯Ø¯ ÙØ±Ø¯ Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ù†Ø¯ Ø¨Ø§Ø²ÛŒ Ø´ÙˆÙ†Ø¯." },
        { title_fa: "Ø³ÙˆÙ…ÛŒÙ† Ø¨ÛŒØ´ØªØ±ÛŒÙ†", desc_fa: "Ø³ÙˆÙ…ÛŒÙ† Ú©Ø§Ø±Øª Ø¨Ø§ÛŒØ¯ Ø¨ÛŒØ´ØªØ±ÛŒÙ† Ø¹Ø¯Ø¯ Ø§Ø² ØªÙ…Ø§Ù… Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ø²ÛŒ Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯." },
        { title_fa: "Ø§ÙˆÙ„ÛŒÙ† Ø¨Ø±Ù†Ø¯Ù‡", desc_fa: "Ø§ÙˆÙ„ÛŒÙ† Ú©Ø§Ø±Øª Ø¨Ø§Ø²ÛŒ Ø´Ø¯Ù‡ Ø¨Ø§ÛŒØ¯ Ø¯Ø³Øª Ø±Ø§ Ø¨Ø¨Ø±Ø¯." },
        { title_fa: "Ø§ÙˆÙ„ Ùˆ Ø¢Ø®Ø± Ù‡Ù…â€ŒØ®Ø§Ù„", desc_fa: "Ø§ÙˆÙ„ÛŒÙ† Ùˆ Ø¢Ø®Ø±ÛŒÙ† Ú©Ø§Ø±Øª Ø¨Ø§Ø²ÛŒ Ø´Ø¯Ù‡ Ø¨Ø§ÛŒØ¯ Ø§Ø² ÛŒÚ© Ø®Ø§Ù„ Ø¨Ø§Ø´Ù†Ø¯." },
        { title_fa: "Ù†Ø²ÙˆÙ„ÛŒ", desc_fa: "Ù‡Ø± Ú©Ø§Ø±Øª Ø¨Ø§Ø²ÛŒ Ø´Ø¯Ù‡ Ø¨Ø§ÛŒØ¯ Ø§Ø² Ú©Ø§Ø±Øª Ù‚Ø¨Ù„ÛŒ Ú©ÙˆÚ†Ú©ØªØ± Ø¨Ø§Ø´Ø¯." },
        { title_fa: "Ø³ÙˆÙ…ÛŒÙ† Ú©Ù…ØªØ±ÛŒÙ†", desc_fa: "Ø³ÙˆÙ…ÛŒÙ† Ú©Ø§Ø±Øª Ø¨Ø§ÛŒØ¯ Ø§Ø² ØªÙ…Ø§Ù… Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ÛŒ Ø¯ÛŒÚ¯Ø± Ú©ÙˆÚ†Ú©ØªØ± Ø¨Ø§Ø´Ø¯." },
        { title_fa: "Ø§ÙˆÙ„ Ùˆ Ø¯ÙˆÙ… Ù‡Ù…â€ŒØ®Ø§Ù„", desc_fa: "Ø§ÙˆÙ„ÛŒÙ† Ùˆ Ø¯ÙˆÙ…ÛŒÙ† Ú©Ø§Ø±Øª Ø¨Ø§ÛŒØ¯ Ø§Ø² ÛŒÚ© Ø®Ø§Ù„ Ø¨Ø§Ø´Ù†Ø¯." },
        { title_fa: "Ø§ÙˆÙ„ Ùˆ Ø³ÙˆÙ… Ù‡Ù…â€ŒØ®Ø§Ù„", desc_fa: "Ø§ÙˆÙ„ÛŒÙ† Ùˆ Ø³ÙˆÙ…ÛŒÙ† Ú©Ø§Ø±Øª Ø¨Ø§ÛŒØ¯ Ø§Ø² ÛŒÚ© Ø®Ø§Ù„ Ø¨Ø§Ø´Ù†Ø¯." },
        { title_fa: "ÙÙ‚Ø· ÛŒÚ© ØªØ§ Ù‡ÙØª", desc_fa: "ÙÙ‚Ø· Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ÛŒ Ø¨Ø§ Ø¹Ø¯Ø¯ ÛŒÚ© ØªØ§ Ù‡ÙØª Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ù†Ø¯ Ø¨Ø§Ø²ÛŒ Ø´ÙˆÙ†Ø¯." },
        { title_fa: "ØµØ¹ÙˆØ¯ÛŒ", desc_fa: "Ù‡Ø± Ú©Ø§Ø±Øª Ø¨Ø§Ø²ÛŒ Ø´Ø¯Ù‡ Ø¨Ø§ÛŒØ¯ Ø§Ø² Ú©Ø§Ø±Øª Ù‚Ø¨Ù„ÛŒ Ø¨Ø²Ø±Ú¯ØªØ± Ø¨Ø§Ø´Ø¯." },
        { title_fa: "Ø§ÙˆÙ„ÛŒÙ† Ø¨ÛŒØ´ØªØ±ÛŒÙ†", desc_fa: "Ø§ÙˆÙ„ÛŒÙ† Ú©Ø§Ø±Øª Ø¨Ø§Ø²ÛŒ Ø´Ø¯Ù‡ Ø¨Ø§ÛŒØ¯ Ø¨ÛŒØ´ØªØ±ÛŒÙ† Ø¹Ø¯Ø¯ Ø§Ø² ØªÙ…Ø§Ù… Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ø²ÛŒ Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯." },
        { title_fa: "Ø¯ÙˆÙ…ÛŒÙ† Ø¨ÛŒØ´ØªØ±ÛŒÙ†", desc_fa: "Ø¯ÙˆÙ…ÛŒÙ† Ú©Ø§Ø±Øª Ø¨Ø§Ø²ÛŒ Ø´Ø¯Ù‡ Ø¨Ø§ÛŒØ¯ Ø¨ÛŒØ´ØªØ±ÛŒÙ† Ø¹Ø¯Ø¯ Ø§Ø² ØªÙ…Ø§Ù… Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ø²ÛŒ Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯." },
        { title_fa: "Ø¢Ø®Ø±ÛŒÙ† Ø¨ÛŒØ´ØªØ±ÛŒÙ†", desc_fa: "Ø¢Ø®Ø±ÛŒÙ† Ú©Ø§Ø±Øª Ø¨Ø§Ø²ÛŒ Ø´Ø¯Ù‡ Ø¨Ø§ÛŒØ¯ Ø¨ÛŒØ´ØªØ±ÛŒÙ† Ø¹Ø¯Ø¯ Ø§Ø² ØªÙ…Ø§Ù… Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ÛŒ Ø¯ÛŒÚ¯Ø± Ø¨Ø§Ø´Ø¯." },
        { title_fa: "Ø§ÙˆÙ„ÛŒÙ† Ú©Ù…ØªØ±ÛŒÙ†", desc_fa: "Ø§ÙˆÙ„ÛŒÙ† Ú©Ø§Ø±Øª Ø¨Ø§Ø²ÛŒ Ø´Ø¯Ù‡ Ø¨Ø§ÛŒØ¯ Ú©Ù…ØªØ±ÛŒÙ† Ø¹Ø¯Ø¯ Ø§Ø² ØªÙ…Ø§Ù… Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ø²ÛŒ Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯." },
        { title_fa: "Ø¯ÙˆÙ…ÛŒÙ† Ø¨Ø±Ù†Ø¯Ù‡", desc_fa: "Ø¯ÙˆÙ…ÛŒÙ† Ú©Ø§Ø±Øª Ø¨Ø§Ø²ÛŒ Ø´Ø¯Ù‡ Ø¨Ø§ÛŒØ¯ Ø¯Ø³Øª Ø±Ø§ Ø¨Ø¨Ø±Ø¯." },
        { title_fa: "Ø³ÙˆÙ…ÛŒÙ† Ø¨Ø±Ù†Ø¯Ù‡", desc_fa: "Ø³ÙˆÙ…ÛŒÙ† Ú©Ø§Ø±Øª Ø¨Ø§Ø²ÛŒ Ø´Ø¯Ù‡ Ø¨Ø§ÛŒØ¯ Ø¯Ø³Øª Ø±Ø§ Ø¨Ø¨Ø±Ø¯." },
        { title_fa: "Ø¯ÙˆÙ… Ùˆ Ø³ÙˆÙ… Ù‡Ù…â€ŒØ®Ø§Ù„", desc_fa: "Ø¯ÙˆÙ…ÛŒÙ† Ùˆ Ø³ÙˆÙ…ÛŒÙ† Ú©Ø§Ø±Øª Ø¨Ø§ÛŒØ¯ Ø§Ø² ÛŒÚ© Ø®Ø§Ù„ Ø¨Ø§Ø´Ù†Ø¯." },
        { title_fa: "Ø¯ÙˆÙ… Ùˆ Ø¢Ø®Ø± Ù‡Ù…â€ŒØ®Ø§Ù„", desc_fa: "Ø¯ÙˆÙ…ÛŒÙ† Ùˆ Ø¢Ø®Ø±ÛŒÙ† Ú©Ø§Ø±Øª Ø¨Ø§ÛŒØ¯ Ø§Ø² ÛŒÚ© Ø®Ø§Ù„ Ø¨Ø§Ø´Ù†Ø¯." }
    ];

    // Risky Missions (require Intel tokens, trump suits assigned randomly at game start)
    const RISKY_MISSIONS = [
        { title_fa: "Ú˜ØªÙˆÙ† Ø¯Ø± Ø¯ÙˆÙ…ÛŒÙ† Ú©Ø§Ø±Øª", desc_fa: "Ø¯ÙˆÙ…ÛŒÙ† Ú©Ø§Ø±Øª Ø¨Ø§ÛŒØ¯ Ø¨Ø§ Ú˜ØªÙˆÙ† Ø§Ø·Ù„Ø§Ø¹Ø§ØªÛŒ Ø¨Ø§Ø²ÛŒ Ø´ÙˆØ¯.", isRisky: true },
        { title_fa: "Ú˜ØªÙˆÙ† Ø¯Ø± Ø³ÙˆÙ…ÛŒÙ† Ú©Ø§Ø±Øª", desc_fa: "Ø³ÙˆÙ…ÛŒÙ† Ú©Ø§Ø±Øª Ø¨Ø§ÛŒØ¯ Ø¨Ø§ Ú˜ØªÙˆÙ† Ø§Ø·Ù„Ø§Ø¹Ø§ØªÛŒ Ø¨Ø§Ø²ÛŒ Ø´ÙˆØ¯.", isRisky: true },
        { title_fa: "Ú˜ØªÙˆÙ† Ø¯Ø± Ø¢Ø®Ø±ÛŒÙ† Ú©Ø§Ø±Øª", desc_fa: "Ø¢Ø®Ø±ÛŒÙ† Ú©Ø§Ø±Øª Ø¨Ø§ÛŒØ¯ Ø¨Ø§ Ú˜ØªÙˆÙ† Ø§Ø·Ù„Ø§Ø¹Ø§ØªÛŒ Ø¨Ø§Ø²ÛŒ Ø´ÙˆØ¯.", isRisky: true },
        { title_fa: "Ú˜ØªÙˆÙ† Ø¯Ø± Ø¯ÙˆÙ… ÛŒØ§ Ø³ÙˆÙ…", desc_fa: "Ø¯ÙˆÙ…ÛŒÙ† ÛŒØ§ Ø³ÙˆÙ…ÛŒÙ† Ú©Ø§Ø±Øª Ø¨Ø§ÛŒØ¯ Ø¨Ø§ Ú˜ØªÙˆÙ† Ø§Ø·Ù„Ø§Ø¹Ø§ØªÛŒ Ø¨Ø§Ø²ÛŒ Ø´ÙˆØ¯.", isRisky: true }
    ];

    // --- State ---
    // Completely prevent accidental refresh/back navigation
    var isGameInProgress = false;
    
    function preventAccidentalNavigation() {
        if (!isGameInProgress) return;
        
        // Completely prevent back button - push state and immediately replace
        history.pushState({page: 'game'}, '', location.href);
        history.pushState({page: 'game'}, '', location.href);
        
        window.onpopstate = function(event) {
            if (isGameInProgress) {
                // Immediately push state back to prevent navigation
                history.pushState({page: 'game'}, '', location.href);
                // Show warning
                alert('Back button is disabled during game. Use game controls to navigate.');
            }
        };
        
        // Prevent refresh with aggressive warning
        window.addEventListener('beforeunload', function(e) {
            if (isGameInProgress) {
                e.preventDefault();
                e.returnValue = 'Game is in progress! Reloading will lose all progress.';
                return e.returnValue;
            }
        });
        
        // Disable keyboard shortcuts for refresh (F5, Ctrl+R, Ctrl+Shift+R)
        document.addEventListener('keydown', function(e) {
            if (isGameInProgress) {
                // F5
                if (e.key === 'F5' || e.keyCode === 116) {
                    e.preventDefault();
                    alert('Refresh is disabled during game. Use game controls to navigate.');
                    return false;
                }
                // Ctrl+R or Ctrl+Shift+R
                if ((e.ctrlKey || e.metaKey) && (e.key === 'r' || e.key === 'R')) {
                    e.preventDefault();
                    alert('Refresh is disabled during game. Use game controls to navigate.');
                    return false;
                }
            }
        });
        
        // Disable right-click context menu (which might have refresh option)
        if (isGameInProgress) {
            document.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                return false;
            }, false);
        }
    }
    
    // Initialize navigation prevention
    preventAccidentalNavigation();
    
    let gameState = {
        agentScore: 0, // Not used directly anymore, tracking missionsCompleted
        currentMission: null,
        currentTrump: null,
        missionsCompleted: 0,
        roundsPlayed: 0,
        playerCount: 4,
        winLimitMissions: 8,
        winLimitTokens: 5,
        usedMissions: [], // Track indices of used missions to ensure uniqueness
        includeRisky: true, // Whether to include risky missions
        assignedMissions: [] // Missions with assigned trump suits for this game
    };

    // WIN CONDITIONS CONFIG
    const WIN_CONFIG = {
        3: { missions: 9, tokens: 6, cardsDealt: 13, stopAt: 2, agents: 2 },
        4: { missions: 7, tokens: 5, cardsDealt: 12, stopAt: 2, agents: 3 },
        5: { missions: 6, tokens: 4, cardsDealt: 10, stopAt: 1, agents: 4 }
    };

    // --- Functions ---
    function startGame(players) {
        isGameInProgress = true;
        preventAccidentalNavigation();
        gameState.playerCount = players;
        gameState.winLimitMissions = WIN_CONFIG[players].missions;
        gameState.winLimitTokens = WIN_CONFIG[players].tokens;
        gameState.cardsDealt = WIN_CONFIG[players].cardsDealt;
        gameState.stopAt = WIN_CONFIG[players].stopAt;
        gameState.agentCount = WIN_CONFIG[players].agents;
        gameState.includeRisky = document.getElementById('include-risky').checked;
        
        document.getElementById('setup-screen').classList.add('hidden');
        document.getElementById('game-screen').classList.remove('hidden');
        
        initGame();
    }

    function assignTrumpsToMissions() {
        // Combine regular and risky missions
        let allMissions = MISSIONS.map(m => ({ ...m }));
        if (gameState.includeRisky) {
            allMissions = [...allMissions, ...RISKY_MISSIONS.map(m => ({ ...m }))];
        }
        
        // Create balanced trump assignment: 6 missions per suit (for 24 missions)
        // If risky missions included, distribute evenly across all missions
        const totalMissions = allMissions.length;
        const missionsPerSuit = Math.floor(totalMissions / SUITS.length);
        const remainder = totalMissions % SUITS.length;
        
        // Create array of suits: 6 of each, then distribute remainder
        let suitAssignment = [];
        for (let i = 0; i < SUITS.length; i++) {
            const count = missionsPerSuit + (i < remainder ? 1 : 0);
            for (let j = 0; j < count; j++) {
                suitAssignment.push(SUITS[i]);
            }
        }
        
        // Shuffle the suit assignment
        for (let i = suitAssignment.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [suitAssignment[i], suitAssignment[j]] = [suitAssignment[j], suitAssignment[i]];
        }
        
        // Assign trumps to missions
        gameState.assignedMissions = allMissions.map((mission, index) => ({
            ...mission,
            trumpSuit: suitAssignment[index]
        }));
    }

    function initGame() {
        gameState.missionsCompleted = 0;
        gameState.roundsPlayed = 0;
        gameState.candidateMissions = [];
        gameState.usedMissions = []; // Reset used missions
        currentLang = 'fa'; // Enforce Farsi
        
        // Assign trumps to missions at game start
        assignTrumpsToMissions();
        
        updateScoreboard();
        startTurn(); 
        updateUIText(); // Triggers Rebus Update
    }
    
    function getUniqueRandomMission() {
        const availableMissions = gameState.assignedMissions;
        
        // If all missions used, reset used list (reshuffle)
        if (gameState.usedMissions.length >= availableMissions.length) {
            gameState.usedMissions = []; // Reshuffle if exhausted
        }
        
        let idx;
        do {
            idx = Math.floor(Math.random() * availableMissions.length);
        } while (gameState.usedMissions.includes(idx));
        
        gameState.usedMissions.push(idx);
        return availableMissions[idx];
    }

    function startTurn() {
        // Check if deck is empty scenario handled by getUniqueRandomMission logic above (auto-reshuffle)
        
        // Generate 2 candidates with unique missions (trump suits assigned at game start)
        const m1 = getUniqueRandomMission();
        const m2 = getUniqueRandomMission();
        
        gameState.candidateMissions = [
            { m: m1, t: m1.trumpSuit },
            { m: m2, t: m2.trumpSuit }
        ];
        
        // Reset UI to Pass Screen first
        document.getElementById('pass-screen').classList.remove('hidden');
        document.getElementById('selection-area').classList.add('hidden');
        document.getElementById('mission-area').classList.add('hidden');
        document.getElementById('controls-area').classList.add('hidden');
    }
    
    function showSelection() {
        document.getElementById('pass-screen').classList.add('hidden');
        document.getElementById('selection-area').classList.remove('hidden');
        
        // Render Options (Full Details in Farsi)
        const m1 = gameState.candidateMissions[0].m;
        const t1 = gameState.candidateMissions[0].t;
        const m2 = gameState.candidateMissions[1].m;
        const t2 = gameState.candidateMissions[1].t;
        
        const risky1 = m1.isRisky ? '<span style="color: #ff9800; font-size: 0.9rem;">âš ï¸ Ù¾Ø±Ø®Ø·Ø±</span>' : '';
        const risky2 = m2.isRisky ? '<span style="color: #ff9800; font-size: 0.9rem;">âš ï¸ Ù¾Ø±Ø®Ø·Ø±</span>' : '';
        
        document.getElementById('sel-opt-1').innerHTML = `
            <div style="font-size: 3rem; line-height: 1;" class="${t1.color}">${t1.symbol}</div>
            <b style="font-size: 1.2rem; display:block; margin: 10px 0;">${m1.title_fa} ${risky1}</b>
            <small style="color: #444;">${m1.desc_fa}</small>
        `;
        document.getElementById('sel-opt-2').innerHTML = `
            <div style="font-size: 3rem; line-height: 1;" class="${t2.color}">${t2.symbol}</div>
            <b style="font-size: 1.2rem; display:block; margin: 10px 0;">${m2.title_fa} ${risky2}</b>
            <small style="color: #444;">${m2.desc_fa}</small>
        `;
    }

    function selectMission(index) {
        const selection = gameState.candidateMissions[index];
        gameState.currentMission = selection.m;
        gameState.currentTrump = selection.t;
        
        // Show Active Mission
        document.getElementById('selection-area').classList.add('hidden');
        document.getElementById('mission-area').classList.remove('hidden');
        document.getElementById('controls-area').classList.remove('hidden');
        
        renderMission();
    }

    function getRandomItem(arr) {
        return arr[Math.floor(Math.random() * arr.length)];
    }

    function renderMission() {
        if (!gameState.currentMission) return;
        const m = gameState.currentMission;
        const t = gameState.currentTrump;

        // Text in Farsi (missions only have Farsi now)
        document.getElementById('mission-title').innerText = m.title_fa;
        document.getElementById('mission-desc').innerText = m.desc_fa;

        // Show risky indicator if applicable
        const riskyIndicator = document.getElementById('risky-indicator');
        if (m.isRisky) {
            riskyIndicator.style.display = 'flex';
        } else {
            riskyIndicator.style.display = 'none';
        }

        // Trump (fixed for each mission, but allow manual override via cycleTrump)
        const trumpEl = document.getElementById('trump-icon');
        trumpEl.innerText = t.symbol;
        trumpEl.className = `trump-icon ${t.color}`;
        trumpEl.onclick = cycleTrump; 
        trumpEl.style.cursor = 'pointer';

        // Re-trigger animation
        const card = document.getElementById('mission-area');
        card.classList.remove('animate-in');
        void card.offsetWidth; 
        card.classList.add('animate-in');
    }
    
    // Separated Logic
    function resolveMission(success) {
        if (success) {
            gameState.missionsCompleted++;
            updateScoreboard();
            if (checkWinCondition()) return; // Stop if game over
            // Removed alert as per user request
        } else {
             // Removed alert as per user request
        }
        // Proceed to next turn
        gameState.roundsPlayed++;
        startTurn();
    }
    
    // Removed resolveTrick

    function checkWinCondition() {
        // Only check Agent win. Insider tracks own tokens.
        if (gameState.missionsCompleted >= gameState.winLimitMissions) {
             alert("âœ… Ù…Ø§Ù…ÙˆØ±Ù‡Ø§ Ø¨Ø±Ù†Ø¯Ù‡ Ø´Ø¯Ù†Ø¯! (ØªÚ©Ù…ÛŒÙ„ Ù…Ø§Ù…ÙˆØ±ÛŒØªâ€ŒÙ‡Ø§)");
             document.getElementById('game-screen').classList.add('hidden');
             document.getElementById('setup-screen').classList.remove('hidden');
             return true;
        }
        return false;
    }

    function updateScoreboard() {
        document.getElementById('agent-score').innerText = `${gameState.missionsCompleted}/${gameState.winLimitMissions}`; 
    }

    function updateUIText() {
        const t = TEXTS[currentLang];
        document.getElementById('app-title').innerText = t.appTitle;
        document.getElementById('btn-reset').innerText = t.reset;
        document.getElementById('btn-rules').innerText = t.rulesBtn;
        document.getElementById('rules-header').innerText = t.rulesHeader;
        document.getElementById('rules-body').innerHTML = t.rulesBody;
        document.getElementById('score-agents-label').innerText = t.agentsLabel;
        // document.getElementById('score-insider-label').innerText = t.insiderLabel;
        document.getElementById('trump-label').innerText = t.trumpLabel;
        document.getElementById('btn-success-text').innerText = t.btnSuccess;
        document.getElementById('btn-fail-text').innerText = t.btnFail;
        document.getElementById('btn-vote-text').innerText = t.btnVote;
        // document.getElementById('btn-skip-text').innerText = t.btnSkip; // Removed

        // Update Dynamic Rules (Modal)
        if (document.getElementById('rule-mission-limit')) {
            document.getElementById('rule-mission-limit').innerText = gameState.winLimitMissions;
        }
        if (document.getElementById('rule-token-limit')) {
            document.getElementById('rule-token-limit').innerText = gameState.winLimitTokens;
        }
        
        // Update Rebus Rules (Scoreboard)
        const rebusEl = document.getElementById('quick-rules-rebus');
        if (rebusEl) {
            rebusEl.innerHTML = `
                <div style="display:flex; justify-content:space-between; border-bottom:1px solid #444; padding-bottom:2px; margin-bottom:2px;"><span>âœ… Ù…Ø§Ù…ÙˆØ±ÛŒØª:</span> <b>${gameState.winLimitMissions}</b></div>
                <div style="display:flex; justify-content:space-between; border-bottom:1px solid #444; padding-bottom:2px; margin-bottom:2px;"><span>âŒ Ú˜ØªÙˆÙ†:</span> <b>${gameState.winLimitTokens}</b></div>
                <div style="display:flex; justify-content:space-between; border-bottom:1px solid #444; padding-bottom:2px; margin-bottom:2px;"><span>ğŸƒ Ú©Ø§Ø±Øª:</span> <b>${gameState.cardsDealt}</b></div>
                <div style="display:flex; justify-content:space-between;"><span>ğŸ›‘ Ø±Ø§ÛŒ:</span> <b>${gameState.stopAt}</b></div>
            `;
        }
        
        // Selection Text update removed to prevent overwriting HTML in showSelection

        // RTL switch
        if (currentLang === 'fa') {
            document.body.classList.add('rtl');
            document.documentElement.lang = 'fa';
        } else {
            document.body.classList.remove('rtl');
            document.documentElement.lang = 'en';
        }
        
        renderMission(); 
    }

    function triggerFinalVote() {
        const msg = TEXTS[currentLang].voteMsg;
        alert(msg);
    }

    function toggleMissions() {
        const modal = document.getElementById('missions-modal');
        const list = document.getElementById('missions-list');
        
        if (modal.classList.contains('hidden')) {
            // Populate with assigned missions (only show if game has started)
            const availableMissions = gameState.assignedMissions.length > 0 
                ? gameState.assignedMissions 
                : [...MISSIONS, ...(gameState.includeRisky ? RISKY_MISSIONS : [])];
            
            let html = '';
            availableMissions.forEach((m, index) => {
                const isRisky = m.isRisky || false;
                const trumpSuit = m.trumpSuit || { symbol: '?', color: 'suit-black' };
                html += `
                    <div style="border-bottom: 1px solid #444; padding: 10px 0;">
                        <div style="font-weight: bold; color: ${isRisky ? '#ff9800' : 'var(--accent-color)'};">
                            ${index + 1}. ${m.title_fa}${isRisky ? ' âš ï¸ (Ù¾Ø±Ø®Ø·Ø±)' : ''}
                        </div>
                        <div style="font-size: 0.9rem; color: #ccc;">${m.desc_fa}</div>
                        <div style="font-size: 1.2rem; margin-top: 5px;" class="${trumpSuit.color}">Ø­Ú©Ù…: ${trumpSuit.symbol}</div>
                    </div>
                `;
            });
            list.innerHTML = html;
            modal.classList.remove('hidden');
        } else {
            modal.classList.add('hidden');
        }
    }

    function toggleRules() {
        const modal = document.getElementById('rules-modal');
        if (modal.classList.contains('hidden')) {
            modal.classList.remove('hidden');
        } else {
            modal.classList.add('hidden');
        }
    }

    function toggleLang() {
        currentLang = currentLang === 'en' ? 'fa' : 'en';
        updateUIText();
    }

    function cycleTrump() {
        const currentIdx = SUITS.findIndex(s => s.name === gameState.currentTrump.name);
        const nextIdx = (currentIdx + 1) % SUITS.length;
        gameState.currentTrump = SUITS[nextIdx];
        
        const trumpEl = document.getElementById('trump-icon');
        trumpEl.innerText = gameState.currentTrump.symbol;
        trumpEl.className = `trump-icon ${gameState.currentTrump.color}`;
    }

    function confirmReset() {
        const msg = TEXTS[currentLang].confirmReset;
        if(confirm(msg)) {
            document.getElementById('game-screen').classList.add('hidden');
            document.getElementById('setup-screen').classList.remove('hidden');
        }
    }

    // window.onload = initGame; // Removed auto-init, wait for setup


</script>
</body>
</html>