<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ú©Ø±Ø§Ø´ Ù†Ø§ÛŒØªÙ„Ø³ (Crush Nightless)</title>
    <style>
        :root {
            --bg-color: #121212;
            --card-bg: #1E1E1E;
            --text-primary: #E0E0E0;
            --text-secondary: #A0A0A0;
            --accent-color: #FF9800; /* Orange for Crush */
            --mafia-color: #F44336;
            --town-color: #4CAF50;
            --condemner-color: #9C27B0;
            --border-radius: 16px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Tahoma', 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            user-select: none;
        }

        .container {
            width: 95%;
            max-width: 500px;
            padding: 24px;
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            margin: 20px 0;
            text-align: center;
        }

        h1 { font-size: 1.8rem; margin: 0 0 0.5rem 0; color: var(--accent-color); font-weight: 900; }
        p { font-size: 1rem; color: var(--text-secondary); margin-bottom: 1.5rem; line-height: 1.6; }

        .setup-info {
            background: rgba(255,255,255,0.05);
            padding: 15px;
            border-radius: 12px;
            margin: 10px 0;
            text-align: right;
            font-size: 0.9rem;
            color: #ccc;
        }

        .input-group { margin-bottom: 10px; }
        .player-input {
            width: 100%;
            padding: 12px;
            background-color: #333;
            border: 1px solid #444;
            border-radius: 8px;
            color: white;
            font-size: 1rem;
            text-align: center;
            font-family: inherit;
        }
        .player-input:focus { outline: 2px solid var(--accent-color); border-color: transparent; }

        .action-btn {
            background-color: var(--accent-color);
            color: #121212;
            border: none;
            padding: 14px 30px;
            font-size: 1.1rem;
            font-weight: 800;
            border-radius: 50px;
            cursor: pointer;
            width: 100%;
            margin-top: 15px;
            box-shadow: 0 4px 15px rgba(255, 152, 0, 0.3);
            font-family: inherit;
        }
        .action-btn:active { transform: scale(0.95); }

        .secondary-btn {
            background-color: #333;
            color: #ccc;
            border: 1px solid #444;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 10px;
            width: 100%;
            font-family: inherit;
        }

        .hidden { display: none !important; }

        /* Chips */
        .player-chip {
            background: rgba(255,255,255,0.1);
            border: 1px solid #555;
            border-radius: 20px;
            padding: 6px 14px;
            font-size: 0.85rem;
            cursor: pointer;
            margin: 3px;
            display: inline-block;
        }

        /* Role Card */
        .role-card {
            background: rgba(0,0,0,0.2);
            padding: 20px;
            border-radius: 16px;
            border: 1px solid rgba(255,255,255,0.1);
            margin: 20px 0;
        }
        .role-title { font-size: 2rem; font-weight: 900; margin-bottom: 10px; }
        
        .target-box {
            background: rgba(156, 39, 176, 0.15);
            border: 1px solid var(--condemner-color);
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            color: #E1BEE7;
            font-weight: bold;
        }
        
        .mafia-box {
            background: rgba(244, 67, 54, 0.15);
            border: 1px solid var(--mafia-color);
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            color: #FFCDD2;
            font-weight: bold;
        }

        .god-view {
            text-align: right;
            background: #000;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            margin-top: 10px;
            direction: rtl;
        }
    </style>
</head>
<body>

    <!-- 1. Setup Screen -->
    <div id="setup-screen" class="container">
        <h1>Ú©Ø±Ø§Ø´ Ù†Ø§ÛŒØªÙ„Ø³</h1>
        <p>Ø³Ù†Ø§Ø±ÛŒÙˆÛŒ Û¶ Ù†ÙØ±Ù‡ (Ø¨Ø¯ÙˆÙ† Ø´Ø¨)</p>

        <div class="setup-info">
            <strong>Ù†Ù‚Ø´â€ŒÙ‡Ø§:</strong><br>
            â€¢ Û± <span style="color:var(--mafia-color)">Ù¾Ø¯Ø±Ø®ÙˆØ§Ù†Ø¯Ù‡</span> (Ù…Ø±Ú¯ Ù…ØªØµÙ„)<br>
            â€¢ Û± <span style="color:var(--mafia-color)">Ù…Ø§ÙÛŒØ§ Ø³Ø§Ø¯Ù‡ (Goon)</span><br>
            â€¢ Û± <span style="color:var(--condemner-color)">Ú©ÛŒÙ†Ù‡â€ŒØªÙˆØ² (Condemner)</span><br>
            â€¢ Û³ <span style="color:var(--town-color)">Ø´Ù‡Ø±ÙˆÙ†Ø¯</span> (ÛŒÚ©ÛŒ Ø§Ø² Ø¢Ù†Ù‡Ø§ Ù‡Ø¯Ù Ø§Ø³Øª)<br>
            <br>
            <strong>Ù‚ÙˆØ§Ù†ÛŒÙ†:</strong><br>
            â€¢ <strong>Ø¨Ø¯ÙˆÙ† Ø´Ø¨:</strong> Ø¨Ø§Ø²ÛŒ ÙØ§Ø² Ø´Ø¨ Ùˆ Ø´Ù„ÛŒÚ© Ù†Ø¯Ø§Ø±Ø¯. ÙÙ‚Ø· Ø±Ø£ÛŒâ€ŒÚ¯ÛŒØ±ÛŒ.<br>
            â€¢ <strong>Ù…Ø±Ú¯ Ù…ØªØµÙ„:</strong> Ø§Ú¯Ø± Ù¾Ø¯Ø±Ø®ÙˆØ§Ù†Ø¯Ù‡ Ø­Ø°Ù Ø´ÙˆØ¯ØŒ Ù…Ø§ÙÛŒØ§ Ø³Ø§Ø¯Ù‡ Ù‡Ù… Ø¨Ø§ Ø§Ùˆ Ù…ÛŒâ€ŒÙ…ÛŒØ±Ø¯.<br>
            â€¢ <strong>Ø¨Ø±Ø¯ Ú©ÛŒÙ†Ù‡â€ŒØªÙˆØ²:</strong> Ø§Ú¯Ø± Â«Ù‡Ø¯ÙÂ» Ø¨Ø§ Ø±Ø£ÛŒâ€ŒÚ¯ÛŒØ±ÛŒ Ø­Ø°Ù Ø´ÙˆØ¯ØŒ Ú©ÛŒÙ†Ù‡â€ŒØªÙˆØ² Ù‡Ù…Ø§Ù† Ù„Ø­Ø¸Ù‡ Ø¨Ø±Ù†Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.<br>
            â€¢ <strong>Ø¨Ø±Ø¯ Ø´Ù‡Ø±ÙˆÙ†Ø¯:</strong> Ø­Ø°Ù ØªÙ…Ø§Ù… Ù…Ø§ÙÛŒØ§Ù‡Ø§ Ùˆ Ú©ÛŒÙ†Ù‡â€ŒØªÙˆØ² (Ø§Ú¯Ø± Ù…Ø§ÙÛŒØ§Ù‡Ø§ Ø­Ø°Ù Ø´ÙˆÙ†Ø¯ Ø¨Ø§Ø²ÛŒ Ø§Ø¯Ø§Ù…Ù‡ Ø¯Ø§Ø±Ø¯ ØªØ§ Ú©ÛŒÙ†Ù‡â€ŒØªÙˆØ² Ù‡Ù… Ø­Ø°Ù Ø´ÙˆØ¯).<br>
            â€¢ <strong>Ø­Ø§Ù„Øª Ø®Ø§Øµ:</strong> Ø§Ú¯Ø± Ø¯Ø± Ù†Ù‡Ø§ÛŒØª ÙÙ‚Ø· Ú©ÛŒÙ†Ù‡â€ŒØªÙˆØ² Ùˆ Ù‡Ø¯Ù Ø¨Ø§Ù‚ÛŒ Ø¨Ù…Ø§Ù†Ù†Ø¯ (Û² Ù†ÙØ± Ø¢Ø®Ø±)ØŒ Ø´Ù‡Ø±ÙˆÙ†Ø¯ Ø¨Ø±Ù†Ø¯Ù‡ Ø§Ø³Øª.
        </div>

        <div style="text-align: right; margin-bottom: 5px; font-weight: bold; font-size: 0.9rem;">Ø§Ø³Ø§Ù…ÛŒ Ø¨Ø§Ø²ÛŒÚ©Ù†Ø§Ù†:</div>
        <div id="inputs-container"></div>

        <div style="text-align: left; margin-top: 10px;">
            <button onclick="clearInputs()" style="background:none; border:none; color:#888; cursor:pointer; font-size:0.8rem;">Ù¾Ø§Ú© Ú©Ø±Ø¯Ù†</button>
        </div>

        <!-- Saved Players -->
        <div id="saved-section" style="margin-top: 20px; text-align: right;">
            <div style="font-size: 0.8rem; color: #888; margin-bottom: 5px;">Ø¨Ø§Ø²ÛŒÚ©Ù†Ø§Ù† Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù‡:</div>
            <div id="saved-list"></div>
            <button onclick="clearSaved()" style="background:none; border:none; color:#F44336; cursor:pointer; font-size:0.8rem; margin-top:5px;">Ø­Ø°Ù ØªØ§Ø±ÛŒØ®Ú†Ù‡</button>
        </div>

        <button class="action-btn" onclick="startGame()">ØªÙˆØ²ÛŒØ¹ Ù†Ù‚Ø´â€ŒÙ‡Ø§</button>
    </div>

    <!-- 2. Pass Screen -->
    <div id="pass-screen" class="container hidden">
        <p>Ù†ÙØ± <span id="pass-num">1</span> Ø§Ø² 6</p>
        <div style="font-size: 4rem; margin: 20px;">ğŸ“±</div>
        <h2>Ú¯ÙˆØ´ÛŒ Ø±Ø§ Ø¨Ø¯Ù‡ÛŒØ¯ Ø¨Ù‡ <span id="pass-name" style="color:var(--accent-color)">Ù†Ø§Ù…</span></h2>
        <button class="action-btn" onclick="revealRole()">Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù†Ù‚Ø´</button>
    </div>

    <!-- 3. Reveal Screen -->
    <div id="reveal-screen" class="container hidden">
        <h2 id="reveal-name" style="color:#888; font-size:1.2rem;">Ù†Ø§Ù…</h2>
        
        <div class="role-card">
            <div id="role-title" class="role-title">Ù†Ù‚Ø´</div>
            <div id="role-desc" style="color:#ddd; font-size:0.95rem;">ØªÙˆØ¶ÛŒØ­Ø§Øª</div>
            
            <div id="extra-info-box"></div>
        </div>

        <p style="font-size:0.8rem; color:#666;">Ù†Ù‚Ø´ Ùˆ Ù‡Ø¯Ù Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù‡ Ø®Ø§Ø·Ø± Ø¨Ø³Ù¾Ø§Ø±ÛŒØ¯.</p>
        <button id="next-btn" class="action-btn" style="background-color:#333;" onclick="nextPlayer()">Ù¾Ù†Ù‡Ø§Ù† Ú©Ø±Ø¯Ù† Ùˆ Ù†ÙØ± Ø¨Ø¹Ø¯ÛŒ</button>
    </div>

    <!-- 4. Game Screen -->
    <div id="game-screen" class="container hidden">
        <h1>Ø¨Ø§Ø²ÛŒ Ø´Ø±ÙˆØ¹ Ø´Ø¯</h1>
        <p style="color:var(--town-color);">Ù†Ù‚Ø´â€ŒÙ‡Ø§ ØªÙˆØ²ÛŒØ¹ Ø´Ø¯Ù†Ø¯!</p>
        
        <div class="setup-info">
            <strong>ÙØ§Ø²: ÙÙ‚Ø· Ø±ÙˆØ²</strong><br>
            Ø¨Ø­Ø« Ú©Ù†ÛŒØ¯ Ùˆ Ø¨Ø§ Ø±Ø£ÛŒ Ø§Ú©Ø«Ø±ÛŒØª ÛŒÚ© Ù†ÙØ± Ø±Ø§ Ø­Ø°Ù Ú©Ù†ÛŒØ¯.<br>
            Ù…Ø±Ø§Ù‚Ø¨ Ú©ÛŒÙ†Ù‡â€ŒØªÙˆØ² Ø¨Ø§Ø´ÛŒØ¯ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡Ø¯ Â«Ù‡Ø¯ÙÂ» Ø®ÙˆØ¯ Ø±Ø§ Ø¨ÛŒØ±ÙˆÙ† Ú©Ù†Ø¯!<br>
            <span style="font-size:0.8rem; color:#888;">(Ø§Ú¯Ø± Ù…Ø§ÙÛŒØ§ Ø­Ø°Ù Ø´Ø¯ Ø¨Ø§Ø²ÛŒ Ø§Ø¯Ø§Ù…Ù‡ Ø¯Ø§Ø±Ø¯. Ø§Ú¯Ø± ÙÙ‚Ø· Ú©ÛŒÙ†Ù‡â€ŒØªÙˆØ² Ùˆ Ù‡Ø¯Ù Ù…Ø§Ù†Ø¯Ù†Ø¯ØŒ Ø´Ù‡Ø±ÙˆÙ†Ø¯ Ø¨Ø±Ù†Ø¯Ù‡ Ø§Ø³Øª)</span>
        </div>

        <button class="secondary-btn" onclick="toggleGodView()">Ù†Ù…Ø§ÛŒØ´/Ù…Ø®ÙÛŒ Ø¯ÙØªØ±Ú†Ù‡ Ú¯Ø§Ø¯</button>
        <div id="god-view" class="god-view hidden"></div>

        <div style="margin-top: 30px; border-top: 1px solid #333; padding-top: 20px;">
            <button class="action-btn" style="background-color:var(--mafia-color);" onclick="restartGame()">Ø¨Ø§Ø²ÛŒ Ù…Ø¬Ø¯Ø¯ (Restart)</button>
            <button class="secondary-btn" onclick="newSetup()">ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¬Ø¯ÛŒØ¯</button>
        </div>
    </div>

    <script>
        // --- State ---
        var players = [];
        var savedPlayers = [];
        var currentIndex = 0;
        var playerCount = 6;
        var isGameInProgress = false;
        
        // Completely prevent accidental refresh/back navigation
        // Set up event listeners once (always active, check flag when firing)
        window.addEventListener('beforeunload', function(e) {
            if (isGameInProgress) {
                e.preventDefault();
                e.returnValue = 'Ø¨Ø§Ø²ÛŒ Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù… Ø§Ø³Øª! Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…Ø¬Ø¯Ø¯ Ø¨Ø§Ø¹Ø« Ø§Ø² Ø¯Ø³Øª Ø±ÙØªÙ† Ù¾ÛŒØ´Ø±ÙØª Ù…ÛŒâ€ŒØ´ÙˆØ¯.';
                return e.returnValue;
            }
        });
        
        // Disable keyboard shortcuts for refresh (F5, Ctrl+R, Ctrl+Shift+R)
        document.addEventListener('keydown', function(e) {
            if (isGameInProgress) {
                // F5
                if (e.key === 'F5' || e.keyCode === 116) {
                    e.preventDefault();
                    alert('Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…Ø¬Ø¯Ø¯ Ø¯Ø± Ø·ÙˆÙ„ Ø¨Ø§Ø²ÛŒ ØºÛŒØ±ÙØ¹Ø§Ù„ Ø§Ø³Øª. Ø§Ø² Ú©Ù†ØªØ±Ù„â€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ø²ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ø§ÙˆØ¨Ø±ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.');
                    return false;
                }
                // Ctrl+R or Ctrl+Shift+R
                if ((e.ctrlKey || e.metaKey) && (e.key === 'r' || e.key === 'R')) {
                    e.preventDefault();
                    alert('Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…Ø¬Ø¯Ø¯ Ø¯Ø± Ø·ÙˆÙ„ Ø¨Ø§Ø²ÛŒ ØºÛŒØ±ÙØ¹Ø§Ù„ Ø§Ø³Øª. Ø§Ø² Ú©Ù†ØªØ±Ù„â€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ø²ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ø§ÙˆØ¨Ø±ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.');
                    return false;
                }
            }
        });
        
        // Disable right-click context menu during game
        document.addEventListener('contextmenu', function(e) {
            if (isGameInProgress) {
                e.preventDefault();
                return false;
            }
        }, false);
        
        // Handle back button
        window.onpopstate = function(event) {
            if (isGameInProgress) {
                // Immediately push state back to prevent navigation
                history.pushState({page: 'game'}, '', location.href);
                // Show warning
                alert('Ø¯Ú©Ù…Ù‡ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¯Ø± Ø·ÙˆÙ„ Ø¨Ø§Ø²ÛŒ ØºÛŒØ±ÙØ¹Ø§Ù„ Ø§Ø³Øª. Ø§Ø² Ú©Ù†ØªØ±Ù„â€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ø²ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ø§ÙˆØ¨Ø±ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.');
            }
        };
        
        function preventAccidentalNavigation() {
            if (isGameInProgress) {
                // Completely prevent back button - push state and immediately replace
                history.pushState({page: 'game'}, '', location.href);
                history.pushState({page: 'game'}, '', location.href);
            }
        }
        
        // Initialize navigation prevention
        preventAccidentalNavigation();

        // --- Init ---
        window.onload = function() {
            loadSaved();
            renderInputs();
        };

        // --- Storage ---
        function loadSaved() {
            var s = localStorage.getItem('crush_players');
            if(s) savedPlayers = JSON.parse(s);
            renderSaved();
        }

        function renderSaved() {
            var div = document.getElementById('saved-list');
            div.innerHTML = '';
            if(savedPlayers.length === 0) div.innerHTML = '<span style="color:#555; font-size:0.8rem;">Ù‡Ù†ÙˆØ² Ù†Ø§Ù…ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ù†Ø´Ø¯Ù‡</span>';
            
            savedPlayers.forEach(function(name) {
                var chip = document.createElement('div');
                chip.className = 'player-chip';
                chip.innerText = name;
                chip.onclick = function() { fillInput(name); };
                div.appendChild(chip);
            });
        }

        function fillInput(name) {
            var inputs = document.querySelectorAll('.player-input');
            for(var i=0; i<inputs.length; i++) {
                if(inputs[i].value === '') {
                    inputs[i].value = name;
                    return;
                }
            }
        }

        function clearInputs() {
            var inputs = document.querySelectorAll('.player-input');
            for(var i=0; i<inputs.length; i++) inputs[i].value = '';
        }

        function clearSaved() {
            if(confirm('Ø¢ÛŒØ§ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø§Ø³Ø§Ù…ÛŒ Ù¾Ø§Ú© Ø´ÙˆØ¯ØŸ')) {
                savedPlayers = [];
                localStorage.removeItem('crush_players');
                renderSaved();
            }
        }

        function renderInputs() {
            var c = document.getElementById('inputs-container');
            c.innerHTML = '';
            for(var i=0; i<playerCount; i++) {
                var inp = document.createElement('input');
                inp.className = 'player-input';
                inp.placeholder = 'Ø¨Ø§Ø²ÛŒÚ©Ù† ' + (i+1);
                c.appendChild(inp);
            }
        }

        // --- Game Logic ---
        function startGame() {
            isGameInProgress = true;
            preventAccidentalNavigation();
            isGameInProgress = true;
            // Names
            var inputs = document.querySelectorAll('.player-input');
            var names = [];
            for(var i=0; i<inputs.length; i++) {
                var val = inputs[i].value.trim();
                if(val) {
                    names.push(val);
                    if(savedPlayers.indexOf(val) === -1) savedPlayers.push(val);
                } else {
                    names.push('Ø¨Ø§Ø²ÛŒÚ©Ù† ' + (i+1));
                }
            }
            localStorage.setItem('crush_players', JSON.stringify(savedPlayers));
            renderSaved();

            // Roles
            // 1 GF, 1 Goon, 1 Condemner, 3 Townies
            var deck = [
                { id: 'gf', name: 'Ù¾Ø¯Ø±Ø®ÙˆØ§Ù†Ø¯Ù‡', color: '#F44336', desc: 'Ø´Ù…Ø§ Ù¾Ø¯Ø±Ø®ÙˆØ§Ù†Ø¯Ù‡ Ù‡Ø³ØªÛŒØ¯. Ø§Ú¯Ø± Ø­Ø°Ù Ø´ÙˆÛŒØ¯ØŒ ÛŒØ§Ø± Ø´Ù…Ø§ (Ù…Ø§ÙÛŒØ§ Ø³Ø§Ø¯Ù‡) Ù‡Ù… Ù…ÛŒâ€ŒÙ…ÛŒØ±Ø¯.' },
                { id: 'goon', name: 'Ù…Ø§ÙÛŒØ§ Ø³Ø§Ø¯Ù‡', color: '#F44336', desc: 'Ø´Ù…Ø§ Ù…Ø§ÙÛŒØ§ Ø³Ø§Ø¯Ù‡ Ù‡Ø³ØªÛŒØ¯. Ø§Ú¯Ø± Ù¾Ø¯Ø±Ø®ÙˆØ§Ù†Ø¯Ù‡ Ø­Ø°Ù Ø´ÙˆØ¯ØŒ Ø´Ù…Ø§ Ù‡Ù… Ù…ÛŒâ€ŒÙ…ÛŒØ±ÛŒØ¯.' },
                { id: 'condemner', name: 'Ú©ÛŒÙ†Ù‡â€ŒØªÙˆØ²', color: '#9C27B0', desc: 'Ø´Ù…Ø§ Ú©ÛŒÙ†Ù‡â€ŒØªÙˆØ² Ù‡Ø³ØªÛŒØ¯. Ø¨Ø±Ø§ÛŒ Ø¨Ø±Ù†Ø¯Ù‡ Ø´Ø¯Ù† Ø¨Ø§ÛŒØ¯ Ú©Ø§Ø±ÛŒ Ú©Ù†ÛŒØ¯ Ú©Ù‡ Â«Ù‡Ø¯ÙÂ» Ø´Ù…Ø§ Ø¨Ø§ Ø±Ø£ÛŒâ€ŒÚ¯ÛŒØ±ÛŒ Ø­Ø°Ù Ø´ÙˆØ¯.' },
                { id: 'town', name: 'Ø´Ù‡Ø±ÙˆÙ†Ø¯', color: '#4CAF50', desc: 'Ø´Ù…Ø§ Ø´Ù‡Ø±ÙˆÙ†Ø¯ Ù‡Ø³ØªÛŒØ¯. Ù…Ø§ÙÛŒØ§Ù‡Ø§ Ùˆ Ù†Ù‚Ø´â€ŒÙ‡Ø§ÛŒ Ù…Ù†ÙÛŒ Ø±Ø§ Ù¾ÛŒØ¯Ø§ Ú©Ù†ÛŒØ¯.' },
                { id: 'town', name: 'Ø´Ù‡Ø±ÙˆÙ†Ø¯', color: '#4CAF50', desc: 'Ø´Ù…Ø§ Ø´Ù‡Ø±ÙˆÙ†Ø¯ Ù‡Ø³ØªÛŒØ¯. Ù…Ø§ÙÛŒØ§Ù‡Ø§ Ùˆ Ù†Ù‚Ø´â€ŒÙ‡Ø§ÛŒ Ù…Ù†ÙÛŒ Ø±Ø§ Ù¾ÛŒØ¯Ø§ Ú©Ù†ÛŒØ¯.' },
                { id: 'town', name: 'Ø´Ù‡Ø±ÙˆÙ†Ø¯', color: '#4CAF50', desc: 'Ø´Ù…Ø§ Ø´Ù‡Ø±ÙˆÙ†Ø¯ Ù‡Ø³ØªÛŒØ¯. Ù…Ø§ÙÛŒØ§Ù‡Ø§ Ùˆ Ù†Ù‚Ø´â€ŒÙ‡Ø§ÛŒ Ù…Ù†ÙÛŒ Ø±Ø§ Ù¾ÛŒØ¯Ø§ Ú©Ù†ÛŒØ¯.' }
            ];

            shuffle(deck);

            players = [];
            var townIndices = [];
            var condemnerIdx = -1;
            var gfIdx = -1;
            var goonIdx = -1;

            // Assign initial roles
            for(var i=0; i<playerCount; i++) {
                players.push({
                    name: names[i],
                    role: deck[i],
                    target: null // For condemner
                });
                
                if(deck[i].id === 'town') townIndices.push(i);
                if(deck[i].id === 'condemner') condemnerIdx = i;
                if(deck[i].id === 'gf') gfIdx = i;
                if(deck[i].id === 'goon') goonIdx = i;
            }

            // Pick Target for Condemner (Must be a Townie)
            // Wiki: "3 Townies (one of whom is unknowingly the condemner's target)"
            if(condemnerIdx !== -1 && townIndices.length > 0) {
                var targetIdx = townIndices[Math.floor(Math.random() * townIndices.length)];
                players[condemnerIdx].target = players[targetIdx].name;
            }

            // Build God View
            var godHtml = "";
            players.forEach(p => {
                var color = p.role.color;
                var extra = "";
                if(p.role.id === 'condemner') extra = " [Ù‡Ø¯Ù: " + p.target + "]";
                if(p.role.id === 'town' && players[condemnerIdx] && players[condemnerIdx].target === p.name) extra = " [Ù‡Ø¯Ù Ø§Ø³Øª]";
                godHtml += "<div style='color:"+color+"'>" + p.name + ": " + p.role.name + extra + "</div>";
            });
            document.getElementById('god-view').innerHTML = godHtml;

            // Mafia Knowledge
            if(gfIdx !== -1 && goonIdx !== -1) {
                players[gfIdx].partner = players[goonIdx].name;
                players[goonIdx].partner = players[gfIdx].name;
            }

            // Start UI
            currentIndex = 0;
            document.getElementById('setup-screen').classList.add('hidden');
            showScreen('pass-screen');
            updatePassScreen();
        }

        function updatePassScreen() {
            document.getElementById('pass-num').innerText = currentIndex + 1;
            document.getElementById('pass-name').innerText = players[currentIndex].name;
        }

        function revealRole() {
            var p = players[currentIndex];
            document.getElementById('reveal-name').innerText = p.name;
            
            var title = document.getElementById('role-title');
            var desc = document.getElementById('role-desc');
            var extra = document.getElementById('extra-info-box');
            
            title.innerText = p.role.name;
            title.style.color = p.role.color;
            desc.innerText = p.role.desc;
            extra.innerHTML = '';

            if(p.role.id === 'condemner') {
                extra.innerHTML = "<div class='target-box'>ğŸ¯ Ù‡Ø¯Ù Ø´Ù…Ø§: " + p.target + "</div>";
            }
            
            if(p.role.id === 'gf') {
                extra.innerHTML = "<div class='mafia-box'>ğŸ‘¿ ÛŒØ§Ø± Ø´Ù…Ø§: " + p.partner + "</div>";
            }
            
            if(p.role.id === 'goon') {
                extra.innerHTML = "<div class='mafia-box'>ğŸ‘¹ Ù¾Ø¯Ø±Ø®ÙˆØ§Ù†Ø¯Ù‡: " + p.partner + "</div>";
            }

            var btn = document.getElementById('next-btn');
            if(currentIndex === playerCount - 1) {
                btn.innerText = "Ø´Ø±ÙˆØ¹ Ø¨Ø§Ø²ÛŒ";
                btn.style.backgroundColor = "#FF9800";
                btn.style.color = "black";
            } else {
                btn.innerText = "Ù¾Ù†Ù‡Ø§Ù† Ú©Ø±Ø¯Ù† Ùˆ Ù†ÙØ± Ø¨Ø¹Ø¯ÛŒ";
                btn.style.backgroundColor = "#333";
                btn.style.color = "white";
            }

            showScreen('reveal-screen');
        }

        function nextPlayer() {
            currentIndex++;
            if(currentIndex >= playerCount) {
                showScreen('game-screen');
            } else {
                updatePassScreen();
                showScreen('pass-screen');
            }
        }

        function restartGame() {
            if(confirm("Ø¢ÛŒØ§ Ø¨Ø§Ø²ÛŒ Ø¨Ø§ Ù‡Ù…Ø§Ù† Ø¨Ø§Ø²ÛŒÚ©Ù†Ø§Ù† Ù…Ø¬Ø¯Ø¯Ø§Ù‹ Ø´Ø±ÙˆØ¹ Ø´ÙˆØ¯ØŸ")) {
                startGame();
            }
        }

        function newSetup() {
            document.getElementById('game-screen').classList.add('hidden');
            document.getElementById('setup-screen').classList.remove('hidden');
        }

        function toggleGodView() {
            var g = document.getElementById('god-view');
            if(g.classList.contains('hidden')) g.classList.remove('hidden');
            else g.classList.add('hidden');
        }

        function showScreen(id) {
            var screens = ['setup-screen', 'pass-screen', 'reveal-screen', 'game-screen'];
            screens.forEach(s => document.getElementById(s).classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        }

        function shuffle(array) {
            for (var i = array.length - 1; i > 0; i--) {
                var j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }
    </script>
</body>
</html>