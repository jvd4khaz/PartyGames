<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ูุจุฑุฏ ูุฑุฏูู</title>
    <style>
        :root {
            --bg-color: #0a192f;
            --card-bg: #112240;
            --text-primary: #e6f1ff;
            --text-secondary: #8892b0;
            --accent-color: #00ff88;
            --good-color: #00ff88;
            --evil-color: #ff3366;
            --quest-color: #FF9800;
            --amulet-color: #9C27B0;
            --btn-color: #00ff88;
            --btn-text: #0a192f;
            --border-radius: 8px;
            --success-glow: rgba(0, 255, 136, 0.8);
            --fail-glow: rgba(255, 51, 102, 0.8);
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Tahoma', 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            overflow-x: hidden;
            user-select: none;
        }

        .container {
            width: 95%;
            max-width: 600px;
            padding: 20px;
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            margin: 20px 0;
            text-align: center;
            transition: transform 0.3s ease;
        }

        h1 { font-size: 1.8rem; margin-bottom: 0.5rem; color: var(--accent-color); font-weight: 900; }
        h2 { font-size: 1.2rem; margin: 10px 0; color: var(--text-secondary); }
        p { font-size: 1rem; color: var(--text-secondary); margin-bottom: 1rem; line-height: 1.5; }

        .setup-info {
            background: rgba(255,255,255,0.05);
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: left;
            font-size: 0.9rem;
            line-height: 1.6;
        }

        .input-group { margin-bottom: 10px; text-align: left; }
        .input-group label { display: block; margin-bottom: 5px; color: var(--text-secondary); font-size: 0.9rem; }
        
        .player-input {
            width: 100%;
            padding: 12px;
            background-color: #233554;
            border: 1px solid #303C55;
            border-radius: 4px;
            color: var(--text-primary);
            font-size: 1rem;
            text-align: center;
        }
        .player-input:focus { outline: 1px solid var(--accent-color); }

        .action-btn {
            background-color: var(--btn-color);
            color: var(--btn-text);
            border: none;
            padding: 14px 20px;
            font-size: 1rem;
            font-weight: bold;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            margin-top: 15px;
            transition: transform 0.1s;
        }
        .action-btn:active { transform: scale(0.98); }
        
        .secondary-btn {
            background-color: transparent;
            color: var(--accent-color);
            border: 1px solid var(--accent-color);
            padding: 10px 15px;
            font-size: 0.9rem;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
            width: 100%;
        }

        /* Player Selection Buttons */
        .player-select-btn {
            background: linear-gradient(135deg, rgba(100, 255, 218, 0.2) 0%, rgba(100, 255, 218, 0.1) 100%);
            color: var(--accent-color);
            border: 3px solid var(--accent-color);
            padding: 18px 24px;
            font-size: 1.2rem;
            font-weight: bold;
            border-radius: 12px;
            cursor: pointer;
            width: 100%;
            margin: 12px 0;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(100, 255, 218, 0.2);
            text-align: center;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .player-select-btn:hover {
            background: linear-gradient(135deg, rgba(100, 255, 218, 0.3) 0%, rgba(100, 255, 218, 0.2) 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(100, 255, 218, 0.4);
            border-color: var(--accent-color);
        }
        .player-select-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 10px rgba(100, 255, 218, 0.3);
        }

        .hidden { display: none !important; }

        /* Role Card */
        .role-card {
            background: rgba(0,0,0,0.2);
            padding: 20px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.1);
            margin: 20px 0;
        }
        .role-title { 
            font-size: 2rem; 
            font-weight: 900; 
            margin-bottom: 10px; 
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .role-good { 
            color: var(--good-color); 
            text-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
            font-weight: 900;
        }
        .role-evil { 
            color: var(--evil-color); 
            text-shadow: 0 0 10px rgba(255, 51, 102, 0.5);
            font-weight: 900;
        }

        @keyframes popIn {
            from { opacity: 0; transform: scale(0.5); }
            to { opacity: 1; transform: scale(1); }
        }

        /* Quest Board Visualization */
        .quest-board-visual {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
            padding: 20px;
            background: linear-gradient(135deg, rgba(255,152,0,0.1) 0%, rgba(255,152,0,0.05) 100%);
            border-radius: 12px;
            border: 2px solid rgba(255,152,0,0.3);
            direction: ltr; /* Quest order left to right */
        }
        .quest-marker {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 3px solid rgba(255,255,255,0.15);
            background: rgba(255,255,255,0.06);
            position: relative;
            transition: all 0.3s ease;
        }
        .quest-marker.active {
            border-color: #ff9800;
            background: radial-gradient(circle, rgba(255,152,0,0.35) 0%, rgba(255,152,0,0.15) 70%, rgba(0,0,0,0.15) 100%);
            box-shadow: 0 0 12px rgba(255,152,0,0.45);
            animation: questPulse 1.8s ease-in-out infinite;
            transform: scale(1.07);
        }
        .quest-marker.completed {
            border-color: var(--good-color);
            background: rgba(76, 175, 80, 0.3);
        }
        @keyframes questPulse {
            0% {
                box-shadow: 0 0 0 0 rgba(255, 152, 0, 0.45);
            }
            60% {
                box-shadow: 0 0 0 16px rgba(255, 152, 0, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(255, 152, 0, 0);
            }
        }
        .quest-marker.failed {
            border-color: var(--evil-color);
            background: rgba(244, 67, 54, 0.3);
        }
        .quest-number {
            font-size: 0.9rem;
            font-weight: bold;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }
        .quest-size {
            font-size: 1.8rem;
            font-weight: 900;
            color: var(--quest-color);
        }
        .quest-status {
            font-size: 0.7rem;
            margin-top: 5px;
            font-weight: bold;
        }
        .quest-status.success { color: var(--good-color); }
        .quest-status.failure { color: var(--evil-color); }
        .quest-fail-note {
            font-size: 0.9rem;
            font-weight: bold;
            color: var(--evil-color);
            margin-top: 5px;
        }
        .quest-amulet-marker {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: rgba(156, 39, 176, 0.3);
            border: 2px solid var(--amulet-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            z-index: 10;
            animation: amuletPulse 2s ease-in-out infinite;
        }
        .quest-amulet-marker.amulet-available {
            background: rgba(156, 39, 176, 0.6);
            box-shadow: 0 0 15px rgba(156, 39, 176, 0.8);
            animation: amuletPulse 1s ease-in-out infinite;
        }
        .quest-amulet-marker.amulet-given {
            background: rgba(156, 39, 176, 0.4);
            opacity: 0.7;
            animation: none;
        }
        @keyframes amuletPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        /* Game Status */
        .game-status {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
            padding: 15px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
        }
        .status-item {
            text-align: center;
        }
        .status-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }
        .status-value {
            font-size: 1.5rem;
            font-weight: bold;
        }

        /* Leader Display */
        .leader-display {
            padding: 15px;
            background: rgba(100, 255, 218, 0.1);
            border: 2px solid var(--accent-color);
            border-radius: 8px;
            margin: 15px 0;
        }
        .leader-name {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--accent-color);
            margin: 10px 0;
        }

        /* Amulet Display */
        .amulet-section {
            margin: 20px 0;
            padding: 15px;
            background: rgba(156, 39, 176, 0.1);
            border: 2px solid var(--amulet-color);
            border-radius: 8px;
        }
        .amulet-title {
            font-size: 1.1rem;
            font-weight: bold;
            color: var(--amulet-color);
            margin-bottom: 10px;
        }
        .amulet-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-top: 10px;
        }
        .amulet-item {
            padding: 8px 12px;
            background: rgba(156, 39, 176, 0.2);
            border: 1px solid var(--amulet-color);
            border-radius: 20px;
            font-size: 0.9rem;
        }
        .amulet-item.used {
            opacity: 0.5;
            text-decoration: line-through;
        }

        /* Saved Players */
        .saved-list-container {
            margin-top: 15px;
            padding: 10px;
            background: rgba(255,255,255,0.03);
            border-radius: 8px;
            min-height: 40px;
        }
        .saved-list-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 25, 47, 0.98);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            pointer-events: auto;
        }
        .modal-overlay.hidden {
            display: none;
        }

        /* Log */
        .log-entry {
            font-size: 0.85rem;
            text-align: left;
            border-bottom: 1px solid #233554;
            padding: 5px 0;
            color: #8892b0;
        }

        /* Card Animations */
        .quest-card-display {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 150px;
            height: 200px;
            border-radius: 12px;
            margin: 10px;
            font-size: 2rem;
            font-weight: 900;
            position: relative;
            transition: all 0.3s;
            box-shadow: 0 8px 20px rgba(0,0,0,0.4);
            cursor: pointer;
            user-select: none;
            -webkit-user-select: none;
            pointer-events: auto;
        }
        .quest-card-success {
            background: linear-gradient(135deg, #4CAF50 0%, #66BB6A 100%);
            color: white;
            border: 3px solid #81C784;
            box-shadow: 0 8px 20px rgba(76, 175, 80, 0.4);
        }
        .quest-card-success:hover {
            transform: scale(1.05);
            box-shadow: 0 12px 30px rgba(76, 175, 80, 0.6);
            border-color: #A5D6A7;
        }
        .quest-card-fail {
            background: linear-gradient(135deg, #F44336 0%, #E57373 100%);
            color: white;
            border: 3px solid #EF5350;
            box-shadow: 0 8px 20px rgba(244, 67, 54, 0.4);
        }
        .quest-card-fail:hover {
            transform: scale(1.05);
            box-shadow: 0 12px 30px rgba(244, 67, 54, 0.6);
            border-color: #EF9A9A;
        }
        .quest-card-animate {
            animation: cardFlip 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .quest-card-glow {
            animation: cardGlow 1s ease-in-out infinite alternate;
        }
        @keyframes cardFlip {
            0% { transform: rotateY(0deg) scale(0.8); opacity: 0; }
            50% { transform: rotateY(90deg) scale(1.1); }
            100% { transform: rotateY(0deg) scale(1); opacity: 1; }
        }
        @keyframes cardGlow {
            from { box-shadow: 0 0 20px var(--success-glow); }
            to { box-shadow: 0 0 40px var(--success-glow), 0 0 60px var(--success-glow); }
        }
        .card-reveal-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 8px;
            margin: 10px 0;
            padding: 10px;
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
        }

        /* Role Selection */
        .role-select-item {
            background: rgba(255,255,255,0.05);
            border: 3px solid #444;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            cursor: pointer;
            transition: all 0.3s;
            text-align: right;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .role-select-item:hover {
            transform: translateX(-5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
        }
        .role-select-item.selected {
            border-width: 3px;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.5);
            transform: translateX(-5px);
        }
        .role-select-item[data-alignment="good"] {
            border-right: 5px solid var(--good-color);
        }
        .role-select-item[data-alignment="good"]:hover {
            background: rgba(0, 255, 136, 0.15);
            border-color: var(--good-color);
        }
        .role-select-item[data-alignment="good"].selected {
            background: linear-gradient(270deg, rgba(0, 255, 136, 0.25) 0%, rgba(0, 255, 136, 0.1) 100%);
            border-color: var(--good-color);
        }
        .role-select-item[data-alignment="evil"] {
            border-right: 5px solid var(--evil-color);
        }
        .role-select-item[data-alignment="evil"]:hover {
            background: rgba(255, 51, 102, 0.15);
            border-color: var(--evil-color);
        }
        .role-select-item[data-alignment="evil"].selected {
            background: linear-gradient(270deg, rgba(255, 51, 102, 0.25) 0%, rgba(255, 51, 102, 0.1) 100%);
            border-color: var(--evil-color);
        }
        .role-badge {
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        .badge-good { 
            background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%); 
            color: #0a192f;
            font-weight: 900;
        }
        .badge-evil { 
            background: linear-gradient(135deg, #ff3366 0%, #cc1a4d 100%); 
            color: white;
            font-weight: 900;
        }

        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        .container, .modal-overlay > .container { 
            animation: fadeIn 0.3s ease-out; 
        }
        .card-reveal-container > div {
            animation: slideIn 0.4s ease-out backwards;
        }
        .card-reveal-container > div:nth-child(1) { animation-delay: 0.1s; }
        .card-reveal-container > div:nth-child(2) { animation-delay: 0.2s; }
        .card-reveal-container > div:nth-child(3) { animation-delay: 0.3s; }
        .card-reveal-container > div:nth-child(4) { animation-delay: 0.4s; }
        .card-reveal-container > div:nth-child(5) { animation-delay: 0.5s; }
    </style>
</head>
<body>

    <!-- 1. Setup Screen -->
    <div id="setup-screen" class="container">
        <h1>ูุจุฑุฏ ูุฑุฏูู</h1>
        <p>ุจุงุฒ ููุดโุขูุฑู ู ุงุณุชูุชุงุฌ</p>

        <div class="setup-info">
            <strong>ุฎูุงุตู ุจุงุฒ:</strong><br>
            โข ุจู ุงุฑุงู ููุดโูุง ุฎูุจ ุง ุจุฏ (ูุดฺฉุฑ ุถุญุงฺฉ) ุจู ุตูุฑุช ูพููุงู ุฏุงุฏู ูโุดูุฏ<br>
            โข ุณุฑุฏุงุฑ ุงุนุถุง ฺฏุฑูู ุฑุง ุจุฑุง ูุฑ ูพฺฉุงุฑ ุจุฑูโฺฏุฒูุฏ<br>
            โข ฺฏุฑูู ูพฺฉุงุฑ ุฑุง ุจุง ฺฏุฒูุด ูุดุงู ูพุฑูุฒ ุง ุดฺฉุณุช ุงุฌุฑุง ูโฺฉูุฏ<br>
            โข ุณูพุงู ูุฑุฏูู ุจุง ุชฺฉูู ณ ูพฺฉุงุฑ ูพุฑูุฒ ุจุฑูุฏู ูโุดูุฏ<br>
            โข ูุดฺฉุฑ ุถุญุงฺฉ ุจุง ุดฺฉุณุช ณ ูพฺฉุงุฑ ุจุฑูุฏู ูโุดูุฏ<br>
            โข ุจุฑุง ด ุชุง ฑฐ ุงุฑ
        </div>

        <div class="input-group">
            <label>ุชุนุฏุงุฏ ุงุฑุงู:</label>
            <div style="display:flex; align-items:center; justify-content:center; gap:15px;">
                <button class="secondary-btn" style="width:40px;" onclick="updatePlayerCount(-1)">-</button>
                <span id="player-count-display" style="font-size:1.5rem; font-weight:bold;">ท</span>
                <button class="secondary-btn" style="width:40px;" onclick="updatePlayerCount(1)">+</button>
            </div>
        </div>

        <div id="player-inputs-container" style="margin-top:20px;"></div>
        
        <!-- Saved Players List -->
        <div class="saved-list-container">
            <div class="saved-list-label">ุงุณุงู ุฐุฎุฑู ุดุฏู (ุจุฑุง ูพุฑ ฺฉุฑุฏู ููุณ ฺฉูุฏ):</div>
            <div id="saved-list" style="text-align: center;"></div>
        </div>

        <button class="action-btn" onclick="showRoleSelection()">ุชูุธู ููุดโูุง</button>
        
        <!-- Thematic Introduction -->
        <div class="setup-info" style="margin-top: 20px; background: rgba(255, 152, 0, 0.1); border: 2px solid rgba(255, 152, 0, 0.3);">
            <strong style="color: var(--quest-color);">๐ ุฑูุงุช ุขุบุงุฒู (ุจุฑุง ุฎูุงูุฏู ุชูุณุท ฺฏู ูุณุชุฑ):</strong>
            <div style="margin-top: 10px; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 6px; text-align: right; line-height: 1.8; font-size: 0.95rem;">
                <p style="margin: 10px 0;">ุง ุงุฑุงูุ ูุดุงุฑ ุจุงุดุฏ!</p>
                <p style="margin: 10px 0;">ูุฒุงุฑ ุณุงู ุงุณุช ฺฉู ุถุญูุงฺฉู ูุงุฑุฏูุด ุจุฑ ุงู ุณุฑุฒูู ูุฑูุงู ูโุฑุงูุฏ ู ุฏูุด ุจู ุฏุฑูุบู ุงูุฑูู ุขููุฏู ุงุณุช. ุงูุง ุงฺฉููู ุฒูุงูู ุฎุฒุด ูุฑุง ุฑุณุฏู ุงุณุช! ฺฉุงููู ุขููฺฏุฑ ุฏุฑูุดู ฺุฑูู ุฑุง ุจุฑุงูุฑุงุดุชู ู ูุฑุฏููู ุฑุงุณุชฺฉุงุฑุ ุดุงูู ุฑุงุณุชู ูุงุ ุฏุฑ ูพุดุงูพุดู ุณูพุงู ูโุชุงุฒุฏ ุชุง ููุฑู ุฎุณุฑูุงู ุฑุง ุจุงุฒฺฏุฑุฏุงูุฏ.</p>
                <p style="margin: 10px 0;">ุดูุง ููฺฏ ุฏุฑ ุงู ูุจุฑุฏู ูุงูพุณู ฺฏุฑุฏ ุขูุฏูโุงุฏ. ุฏุฑ ูุงูู ุดูุง ุณูพุงูู ูุฑุฏูู ุงุณุชุงุฏู ุงุณุช โ ุฑุฒููุฏฺฏุงูู ุดุงูู ุฑุงุณุชู ู ูพูุงูโุจุณุชฺฏุงูู ุฑุงูู ุฑูุดูุง. ุงูุง ุจูพุฑูุฒุฏ! ูุดฺฉุฑู ุถุญูุงฺฉ ูุฒ ุฏุฑ ูุงูู ูุง ูพููุงู ุงุณุช โ ูพุฑูุงูู ุชุงุฑฺฉ ู ุณุชู.</p>
                <p style="margin: 10px 0;">ุจุณุงุฑ ุงุฒ ุดูุง ุณุฑุฏุงุฑุงูู ุฏูุฑู ุณูพุงูู ููุฑ ูุณุชุฏ. ุงูุง ุดูุงุฑุ ุฎุงุฆูุงูู ุชุจูฺฉุงุฑ ู ูพุฑูุงูู ุขุดูุจ ู ูุฑุงูโุงูุฏ.</p>
                <p style="margin: 10px 0;">ุจุฑุง ุณุฑุงูุฑุงุฒุ ุจุงุฏ ูพูุฌ ูพฺฉุงุฑู ุจุฒุฑฺฏ ุฑุง ูพุดุช ุณุฑ ุจฺฏุฐุงุฑุฏ:</p>
                <p style="margin: 10px 0;">ููฺฏุงู ฺฉู ุณุงูุงุฑ ฺฏุฑูู ุฑุง ุจุฑุง ูพฺฉุงุฑ ุจุฑูโฺฏุฒูุฏุ ุณุฑุฏุงุฑุงูู ุฑุงุณุชู ุจุงุฏ ููุฑุงู ฺฉููุฏ.</p>
                <p style="margin: 10px 0;">ุฎุงุฆูุงูู ูพููุงูุ ูุฑูฺฏ ุฎูุงููุฏ ฺฉุฑุฏ.</p>
                <p style="margin: 10px 0;">ฺูู ุณุงูุงุฑ ุจู ุฑุงุณุชู ฺฉุณ ฺฏูุงู ุจุจุฑุฏุ ูโุชูุงูุฏ ุฏุฑูุด ฺฉุงูุงู ุจุฑ ุงู ุนุทุง ฺฉูุฏ ุชุง ุจู ุฑุงุณุช ฺฏุงู ุจุฑุฏุงุฑุฏ. ู ุงฺฏุฑ ุดฺฉ ุจุฑ ูุง ฺุฑู ุขุฏุ ูโุชูุงูู ุฌุงูู ุฌูุงูโููุง ุฑุง ุจูฺฏุฑู ุชุง ุญููุชู ุงุฑุงู ุฑุง ุจุจูู.</p>
                <p style="margin: 10px 0;">ุงฺฏุฑ ุณู ูพฺฉุงุฑ ุจู ูุงฺฉุงู ุจุงูุฌุงูุฏุ ุงูุฑููุงู ุฎูุงููุฏ ฺฉูุดุฏ ุชุง ุจฺฏุฑุฒูุฏ โ ุงูุง ููโุชูุงููุฏ ุณุฑุงูุฑุงุฒ ฺฏุฑุฏูุฏ ูฺฏุฑ ุงุฒ ูุงูพุณู ูุจุฑุฏ ุฌุงู ุจู ุฏุฑ ุจุฑูุฏ!</p>
                <p style="margin: 10px 0; font-weight: bold; color: var(--accent-color);">ูพฺฉุงุฑ ุขุบุงุฒ ูโุดูุฏ! ุง ุณุงูุงุฑุ ูุฎุณุชู ฺฏุฑููู ุฎูุด ุฑุง ุจุฑุง ูพฺฉุงุฑ ุจุฑฺฏุฒู!</p>
            </div>
        </div>
    </div>

    <!-- Role Selection Screen -->
    <div id="role-selection-screen" class="container hidden">
        <h1>ฺฏุฒูุด ููุดโูุง</h1>
        <p id="role-selection-info" style="color: var(--text-secondary); margin-bottom: 20px;"></p>
        <div id="role-selection-list"></div>
        <button class="action-btn" onclick="confirmRoleSelection()">ุชุฃุฏ ููุดโูุง</button>
        <button class="secondary-btn" onclick="useRecommendedRoles()">ุงุณุชูุงุฏู ุงุฒ ูพุดููุงุฏ</button>
    </div>

    <!-- 2. Role Distribution Phase -->
    <div id="distribution-screen" class="container hidden">
        <div id="dist-pass-view">
            <p>ุฏุณุชฺฏุงู ุฑุง ุจู:</p>
            <h2 id="dist-player-name" style="font-size:2rem; color:var(--accent-color);">ูุงู ุงุฑ</h2>
            <div style="font-size:4rem; margin:20px;">๐ฑ</div>
            <p>ุงุฑ <span id="dist-player-num">ฑ</span> ุงุฒ <span id="dist-total-players">ท</span></p>
            <button class="action-btn" onclick="revealRole()">ููุงุด ููุด</button>
        </div>

        <div id="dist-reveal-view" class="hidden">
            <h2 id="reveal-name-header">ูุงู ุงุฑ</h2>
            <div class="role-card">
                <div id="role-title" class="role-title">ููุด</div>
                <div id="role-desc" style="font-size:0.95rem; margin-bottom:10px; color:#ddd;"></div>
                <div id="role-extra" style="font-size:0.9rem; color:#ffd700;"></div>
            </div>
            <p style="font-size:0.8rem; color:#666;">ููุด ุฎูุฏ ุฑุง ุญูุธ ฺฉูุฏ ู ูพููุงู ฺฉูุฏ.</p>
            <button id="next-dist-btn" class="action-btn" onclick="nextDistribute()">ูพููุงู ู ุจุนุฏ</button>
        </div>
    </div>

    <!-- 3. Leader Announcement -->
    <div id="leader-announce-screen" class="container hidden">
        <h1>ุณุฑุฏุงุฑ ุงูู</h1>
        <div class="leader-display">
            <p style="color: var(--text-secondary);">ุณุฑุฏุงุฑ ุงูู:</p>
            <div class="leader-name" id="first-leader-name">ูุงู ุงุฑ</div>
        </div>
        
        <!-- Thematic Narrative for First Quest -->
        <div class="setup-info" style="margin-top: 20px; background: rgba(255, 152, 0, 0.1); border: 2px solid rgba(255, 152, 0, 0.3);">
            <strong style="color: var(--quest-color);">๐ ุฑูุงุช ุขุบุงุฒ ูพฺฉุงุฑ (ุจุฑุง ุฎูุงูุฏู ุชูุณุท ฺฏู ูุณุชุฑ):</strong>
            <div style="margin-top: 10px; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 6px; text-align: right; line-height: 1.8; font-size: 0.95rem;">
                <p style="margin: 10px 0;">ุง ุณุฑุฏุงุฑุ ุงฺฉููู ุฒูุงูู ูุฎุณุชู ูพฺฉุงุฑ ูุฑุง ุฑุณุฏู ุงุณุช. ุฏุฑูุดู ฺฉุงูู ุจุฑุงูุฑุงุดุชู ู ุณูพุงูู ูุฑุฏูู ุขูุงุฏูู ูุจุฑุฏ ุงุณุช. ุงูุง ูุดุงุฑ ุจุงุด! ุฏุฑ ูุงูู ุงุฑุงู ุชูุ ุฎุงุฆูุงูู ุถุญูุงฺฉ ูุฒ ูพููุงูโุงูุฏ.</p>
                <p style="margin: 10px 0;">ฺฏุฑูู ุฑุง ุจุฑุง ุงู ูพฺฉุงุฑ ุจุฑฺฏุฒู. ุณุฑุฏุงุฑุงูู ุฑุงุณุชู ููุฑุงู ุฎูุงููุฏ ฺฉุฑุฏุ ุงูุง ุงฺฏุฑ ุฎุงุฆู ุฏุฑ ูุงู ุจุงุดุฏุ ูุฑูฺฏ ุฎูุงูุฏ ฺฉุฑุฏ ู ูพฺฉุงุฑ ุจู ูุงฺฉุงู ุฎูุงูุฏ ุงูุฌุงูุฏ.</p>
                <p style="margin: 10px 0; font-weight: bold; color: var(--accent-color);">ุง ุณุฑุฏุงุฑุ ูุฎุณุชู ฺฏุฑููู ุฎูุด ุฑุง ุจุฑุง ูพฺฉุงุฑ ุจุฑฺฏุฒู!</p>
            </div>
        </div>
        
        <p style="color: var(--text-secondary); margin-top: 15px;">ุณุฑุฏุงุฑ ุงุนุถุง ฺฏุฑูู ุฑุง ุจุฑุง ูพฺฉุงุฑ ฑ ุจุฑูโฺฏุฒูุฏ.</p>
        <button class="action-btn" onclick="startGame()">ุดุฑูุน ูพฺฉุงุฑ ฑ</button>
    </div>

    <!-- 4. Main Game Screen -->
    <div id="game-screen" class="container hidden">
        <h1>ูุฏุงู ูุจุฑุฏ</h1>
        
        <!-- Compact Team Layout -->
        <div style="display: flex; gap: 8px; margin-bottom: 20px;">
            <!-- Evil Team (Left) -->
            <div style="flex: 1; background: rgba(244, 67, 54, 0.05); border: 1px solid var(--evil-color); border-radius: 8px; padding: 8px; min-height: 60px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; font-size: 0.85rem; color: var(--evil-color); font-weight: bold;">
                    <span>ูุดฺฉุฑ ุถุญุงฺฉ</span>
                    <span>ุจุฑุฏ: <strong id="evil-wins-display" style="color: var(--evil-color); font-size: 0.95rem;">ฐ</strong></span>
                </div>
                <div id="evil-team-list" style="display: flex; flex-wrap: wrap; gap: 4px; justify-content: flex-start; align-content: flex-start;">
                    <!-- Evil roles will be listed here -->
                </div>
            </div>
            
            <!-- Good Team (Right) -->
            <div style="flex: 1; background: rgba(76, 175, 80, 0.05); border: 1px solid var(--good-color); border-radius: 8px; padding: 8px; min-height: 60px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; font-size: 0.85rem; color: var(--good-color); font-weight: bold;">
                    <span>ุณูพุงู ูุฑุฏูู</span>
                    <span>ุจุฑุฏ: <strong id="good-wins-display" style="color: var(--good-color); font-size: 0.95rem;">ฐ</strong></span>
                </div>
                <div id="good-team-list" style="display: flex; flex-wrap: wrap; gap: 4px; justify-content: flex-start; align-content: flex-start;">
                    <!-- Good roles will be listed here -->
                </div>
            </div>
        </div>

        <!-- Quest Board Visualization -->
        <div class="quest-board-visual" id="quest-board-visual">
            <!-- Quest markers will be generated here -->
        </div>

        <!-- Current Leader -->
        <div class="leader-display">
            <div class="status-label">ุณุฑุฏุงุฑ ูุนู</div>
            <div class="leader-name" id="current-leader-name">ูุงู ุงุฑ</div>
        </div>

        <!-- Action Buttons -->
        <div id="action-buttons" style="margin-top: 20px;"></div>

        <!-- Current Phase Display -->
        <div id="phase-display" style="margin: 20px 0; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px;">
            <div id="phase-title" style="font-size: 1.2rem; font-weight: bold; color: var(--accent-color); margin-bottom: 10px;"></div>
            <div id="phase-content"></div>
        </div>

        <!-- Amulets Section -->
        <div class="amulet-section" id="amulet-section">
            <div class="amulet-title">๐ฎ ุฌุงูโูุง ุฌูุงูโุจู</div>
            <p style="font-size: 0.85rem; color: var(--text-secondary); margin: 10px 0;" id="amulet-explanation">
                ุฌุงูโูุง ุชูุณุท ุณุฑุฏุงุฑ ุขุฎุฑู ูพฺฉุงุฑ ุจู ุฏฺฏุฑุงู ุฏุงุฏู ูโุดููุฏ ู ุงุฌุงุฒู ูโุฏููุฏ ฺฉ ุจุงุฒฺฉู ููุงุฏุงุฑ ุจุงุฒฺฉู ุฏฺฏุฑ ุฑุง ุจุฑุฑุณ ฺฉูุฏ.
            </p>
            <div class="amulet-list" id="amulet-list">
                <!-- Amulets will be generated here -->
            </div>
        </div>

        <!-- Game Log -->
        <button class="secondary-btn" onclick="toggleLog()">ููุงุด/ูพููุงู ูุงฺฏ ุจุงุฒ</button>
        <div id="game-log" class="hidden" style="margin-top: 15px; max-height: 200px; overflow-y: auto; text-align: right; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px;">
            <div id="log-content"></div>
        </div>

        <!-- End Game Modal -->
        <div id="end-game-modal" class="modal-overlay hidden">
            <div class="container" style="max-width:500px; border: 2px solid var(--accent-color);">
                <h1 id="end-game-title" style="margin-bottom: 20px;">ูพุงุงู ุจุงุฒ</h1>
                <p id="end-game-message" style="font-size: 1.2rem; margin-bottom: 30px;"></p>
                <button class="action-btn" onclick="location.reload()">ุจุงุฒ ุฌุฏุฏ</button>
            </div>
        </div>
    </div>


    <!-- Magic Token Modal -->
    <div id="magic-modal" class="modal-overlay hidden">
        <div class="container" style="max-width:500px;">
            <h2>ุฏุฑูุด ฺฉุงูุงู</h2>
            <p style="margin: 15px 0;">ุณุฑุฏุงุฑ: ุงุฑ ุฑุง ุจุฑุง ุฏุฑุงูุช ุฏุฑูุด ฺฉุงูุงู ุจุฑฺฏุฒูุฏ.</p>
            <p style="color: var(--text-secondary); font-size: 0.9rem;">ุงุฑ ฺฉู ุฏุฑูุด ฺฉุงูุงู ุฏุงุฑุฏ ููโุชูุงูุฏ ูุฑูฺฏ ฺฉูุฏ (ูฺฏุฑ ุงูฺฉู ููุดุด ุงุฌุงุฒู ุฏูุฏ).</p>
            <div id="magic-player-list" style="margin: 20px 0;"></div>
            <button class="secondary-btn" onclick="document.getElementById('magic-modal').classList.add('hidden')">ุฑุฏ ฺฉุฑุฏู (ุฑู ุณุฑุฏุงุฑ ุจฺฏุฐุงุฑุฏ)</button>
        </div>
    </div>

    <!-- Quest Card Selection Modal -->
    <div id="quest-card-modal" class="modal-overlay hidden">
        <div class="container" style="max-width:500px;">
            <!-- Confirmation Screen -->
            <div id="quest-card-confirmation-screen">
                <h2 style="font-size: 2rem; margin-bottom: 30px; color: var(--accent-color);">ุชุฃุฏ ูููุนุช ุดูุง</h2>
                <div id="quest-card-confirmation-text" style="font-size: 4rem; font-weight: 900; color: #4CAF50; text-align: center; margin: 40px 0; text-shadow: 3px 3px 6px rgba(0,0,0,0.3); line-height: 1.2;">
                    ุนุถู ฺฏุฑูู<br><span id="quest-card-confirmation-number" style="font-size: 6rem; color: #FF5722;">ฑ</span>
                </div>
                <p id="quest-card-confirmation-total" style="font-size: 1.5rem; text-align: center; color: var(--text-secondary); margin: 20px 0;"></p>
                <button class="action-btn" onclick="confirmQuestCardPlayer(); return false;" style="font-size: 1.5rem; padding: 20px 40px; margin: 30px auto; display: block; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);">
                    ูู ุงู ุดุฎุต ูุณุชู
                </button>
            </div>
            
            <!-- Card Selection Screen -->
            <div id="quest-card-selection-screen" class="hidden">
                <h2 style="font-size: 1.3rem; margin-bottom: 10px;">ุดุฑูุน ูพฺฉุงุฑ</h2>
                <p id="quest-card-player" style="margin: 10px 0; font-size: 1rem; color: var(--accent-color); font-weight: bold;"></p>
                <p id="quest-card-magic-note" style="color: var(--amulet-color); font-weight: bold; margin: 10px 0; padding: 10px; background: rgba(156, 39, 176, 0.2); border-radius: 8px; font-size: 0.9rem;"></p>
                <p style="color: var(--text-secondary); margin: 20px 0; font-size: 0.85rem;">ฺฉ ูุดุงู ุจุฑุง ูพฺฉุงุฑ ุจุฑฺฏุฒูุฏ:</p>
                <div id="quest-card-buttons-container" style="display: flex; gap: 15px; justify-content: center; margin: 20px 0; flex-wrap: wrap;">
                    <!-- Cards will be dynamically inserted here in random order -->
                </div>
                <p id="quest-card-progress" style="margin-top: 10px; color: var(--text-secondary); font-size: 0.9rem;"></p>
            </div>
        </div>
    </div>

    <!-- Quest Cards Reveal Modal -->
    <div id="quest-cards-reveal-modal" class="modal-overlay hidden">
        <div class="container" style="max-width:90%; max-height:90vh; overflow-y: auto; padding: 15px;">
            <h2 style="color: var(--accent-color); font-size: 1.2rem; margin-bottom: 8px;">ูุดุงูโูุง ูพฺฉุงุฑ ููุงุด ุฏุงุฏู ุดุฏ</h2>
            <div class="card-reveal-container" id="revealed-cards-container" style="margin: 10px 0;"></div>
            <div id="quest-result-summary" style="margin: 10px 0; padding: 10px; border-radius: 8px; font-size: 0.95rem; font-weight: bold;"></div>
            <button class="action-btn" onclick="closeQuestReveal()" style="margin-top: 8px; padding: 10px 20px; font-size: 0.95rem;">ุงุฏุงูู</button>
            <p style="margin-top: 8px; color: var(--text-secondary); font-size: 0.8rem;"></p>
        </div>
    </div>


    <!-- Leader Selection Modal -->
    <div id="leader-select-modal" class="modal-overlay hidden">
        <div class="container" style="max-width:90%; max-height:85vh; overflow-y: auto;">
            <h2>ฺฏุฒูุด ุณุฑุฏุงุฑ ุจุนุฏ</h2>
            <div id="leader-select-list" style="margin: 15px 0;"></div>
            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1);">
                <p style="margin: 10px 0;">ุณุฑุฏุงุฑ ูุนู: <strong id="current-leader-select-name"></strong></p>
                <p style="margin: 10px 0; color: var(--text-secondary); font-size: 0.9rem;">ุงุฑ ุฑุง ุจุฑฺฏุฒูุฏ ฺฉู ูุจูุงู ุณุฑุฏุงุฑ ูุจูุฏู ู ุฌุงู ุฌูุงูโุจู ูุฏุงุฑุฏ.</p>
            </div>
        </div>
    </div>

    <!-- Amulet Selection Modal -->
    <div id="amulet-select-modal" class="modal-overlay hidden">
        <div class="container" style="max-width:90%; max-height:85vh; overflow-y: auto;">
            <h2>ุฌุงู ุฌูุงูโุจู ุฏุฑ ุฏุณุชุฑุณ</h2>
            <div id="amulet-select-list" style="margin: 15px 0;"></div>
            <button class="secondary-btn" onclick="skipAmulet()" style="margin-top: 10px;">ุฑุฏ ฺฉุฑุฏู ุฌุงู ุฌูุงูโุจู</button>
            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1);">
                <p style="margin: 10px 0; color: var(--text-secondary); font-size: 0.9rem;">ุจุนุฏ ุงุฒ ูพฺฉุงุฑ <span id="amulet-quest-num"></span> ฺฉ ุฌุงู ุฌูุงูโุจู ุฏุฑ ุฏุณุชุฑุณ ุงุณุช.</p>
                <p style="margin: 10px 0; color: var(--text-secondary); font-size: 0.9rem;">ุงุฑ ุฑุง ุจุฑุง ุฏุฑุงูุช ุฌุงู ุฌูุงูโุจู ุจุฑฺฏุฒูุฏ (ููโุชูุงูุฏ ุณุฑุฏุงุฑ ุฌุฏุฏ ุจุงุดุฏ ู ููโุชูุงูุฏ ูุดุงู ฺฉูููโุณุฑุจุงุฒ/ุฌุงู ุฌูุงูโุจู ุฏุงุดุชู ุจุงุดุฏ).</p>
            </div>
        </div>
    </div>

    <!-- Amulet Check Modal -->
    <div id="amulet-check-modal" class="modal-overlay hidden">
        <div class="container" style="max-width:90%; max-height:85vh; overflow-y: auto;">
            <h2>ุจุฑุฑุณ ุฌุงู ุฌูุงูโุจู</h2>
            <div id="amulet-check-list" style="margin: 15px 0;"></div>
            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1);">
                <p id="amulet-holder-name" style="margin: 10px 0; color: var(--amulet-color); font-weight: bold;"></p>
                <p style="margin: 10px 0; color: var(--text-secondary); font-size: 0.9rem;">ุงุฑ ุฑุง ุจุฑุง ุจุฑุฑุณ ููุงุฏุงุฑ ุจุฑฺฏุฒูุฏ.</p>
            </div>
        </div>
    </div>

    <!-- Amulet Result Modal -->
    <div id="amulet-result-modal" class="modal-overlay hidden">
        <div class="container" style="max-width:90%; max-height:85vh; overflow-y: auto; padding: 20px;">
            <h2 style="color: var(--amulet-color); margin-bottom: 15px;">ูุชุฌู ุจุฑุฑุณ ุฌุงู ุฌูุงูโุจู</h2>
            <p style="margin: 15px 0; font-size: 1.1rem;">ุดูุง ุจุฑุฑุณ ฺฉุฑุฏุฏ:</p>
            <p id="amulet-checked-name" style="margin: 10px 0; font-size: 1.3rem; font-weight: bold; color: var(--accent-color);"></p>
            <div id="amulet-result-text" style="margin: 20px 0; padding: 20px; border-radius: 12px; text-align: center; background: rgba(0,0,0,0.3); border: 3px solid;"></div>
            <button class="action-btn" onclick="closeAmuletResult()" style="margin-top: 15px;">ุงุฏุงูู</button>
        </div>
    </div>

    <!-- Amulet Result Modal -->
    <div id="amulet-result-modal" class="modal-overlay hidden">
        <div class="container" style="max-width:90%; max-height:85vh; overflow-y: auto; padding: 20px;">
            <h2 style="color: var(--amulet-color); margin-bottom: 15px;">ูุชุฌู ุจุฑุฑุณ ุฌุงู ุฌูุงูโุจู</h2>
            <p style="margin: 15px 0; font-size: 1.1rem;">ุดูุง ุจุฑุฑุณ ฺฉุฑุฏุฏ:</p>
            <p id="amulet-checked-name" style="margin: 10px 0; font-size: 1.3rem; font-weight: bold; color: var(--accent-color);"></p>
            <div id="amulet-result-text" style="margin: 20px 0; padding: 20px; border-radius: 12px; text-align: center; background: rgba(0,0,0,0.3); border: 3px solid;"></div>
            <button class="action-btn" onclick="closeAmuletResult()" style="margin-top: 15px;">ุงุฏุงูู</button>
        </div>
    </div>

    <!-- Final Quest Modal -->
    <div id="final-quest-modal" class="modal-overlay hidden">
        <div class="container" style="max-width:90%; max-height:85vh; overflow-y: auto;">
            <h2>ูุงูพุณู ูพฺฉุงุฑ</h2>
            <div id="final-quest-content"></div>
        </div>
    </div>

    <script>
        // --- Game Configuration (Director's Cut) ---
        // Quest 3 for 4 players can be 2 or 3 (handled dynamically)
        var QUEST_CONFIG = {
            4: { quests: [3, 2, 3, 2], fails: [1, 1, 1, 1], evil: 2, quest3Options: [2, 3] },
            5: { quests: [3, 2, 3, 4, 3], fails: [1, 1, 1, 2, 1], evil: 3 },
            6: { quests: [3, 2, 3, 4, 3], fails: [1, 1, 1, 2, 1], evil: 3 },
            7: { quests: [3, 2, 3, 4, 3], fails: [1, 1, 1, 2, 1], evil: 4 },
            8: { quests: [4, 3, 4, 5, 4], fails: [1, 1, 2, 2, 1], evil: 4 },
            9: { quests: [4, 3, 4, 5, 4], fails: [1, 1, 2, 2, 1], evil: 5 },
            10: { quests: [4, 3, 4, 5, 4], fails: [1, 1, 2, 2, 1], evil: 5 }
        };
        
        // Amulet placement: [quest after which amulet appears]
        var AMULET_CONFIG = {
            6: [4],  // 1 amulet after Quest 4
            7: [4, 3],  // 2 amulets: after Quest 4 and Quest 3
            8: [4, 3, 2],  // 3 amulets: after Quest 4, 3, and 2
            9: [4, 3, 2],
            10: [4, 3, 2]
        };

        // --- Role Definitions ---
        // Role strength ranking (higher number = stronger/more important)
        var ROLE_STRENGTH = {
            // Evil: Zahhak > Neghabdar > Khaen
            'Morgan': 30,      // ุถุญุงฺฉ ูุงุฑุฏูุด - strongest evil
            'Blind Hunter': 20, // ููุงุจโุฏุงุฑ
            'Minion': 10,      // ุฎุงุฆู - weakest evil
            
            // Good: Cleric > Duke > Archduke > Troublemaker > Youth > Loyal Servant
            'Cleric': 60,      // ููุจุฏ - strongest good
            'Duke': 50,        // ฺฉุงูู ุขููฺฏุฑ
            'Archduke': 40,    // ุฑุณุชู ุฏุณุชุงู
            'Troublemaker': 30, // ุณุงูุด
            'Youth': 20,       // ุฌูุงู ุฎุงู
            'Loyal Servant': 10 // ุณุฑุจุงุฒ - weakest good
        };
        
        var ROLE_DEFINITIONS = {
            'Loyal Servant': { name: 'ุณุฑุจุงุฒ', symbol: '๐ก๏ธ', rebus: '๐ก๏ธ', alignment: 'good', description: 'ุณุฑุจุงุฒ ฺฉู ุจุฑุง ุฎูุจ ูโุฌูฺฏุฏ.' },
            'Cleric': { name: 'ููุจุฏ', symbol: '๐ฎ', rebus: '๐ฎ', alignment: 'good', description: 'ูโุฏุงูุฏ ุงููู ุณุฑุฏุงุฑ ุฎูุจ ุงุณุช ุง ุจุฏ.', required: false },
            'Youth': { name: 'ุฌูุงู ุฎุงู', symbol: '๐ฑ', rebus: '๐ฑ', alignment: 'good', description: 'ุงฺฏุฑ ุฏุฑูุด ฺฉุงูุงู ุจู ุดูุง ุฏุงุฏู ุดูุฏุ ุจุงุฏ ูุฑูฺฏ ฺฉูุฏ. ุงู ูุดุงูู ูุงูพุฎุชฺฏ ู ุจโุชุฌุฑุจฺฏ ุดูุงุณุช.', required: false },
            'Troublemaker': { name: 'ุณุงูุด', symbol: 'โ๏ธ', rebus: 'โ๏ธ', alignment: 'good', description: 'ุดูุง ุจู ูุงุญู ูุชูู ุดุฏูโุงุฏ. ุงฺฏุฑ ุจุฑุง ููุงุฏุงุฑ ุจุฑุฑุณ ุดูุฏุ ุจู ููุจุฏ ู ุฏุฑ ุฌุงู ุฌูุงูโุจู ุฌุฒู ูุดฺฉุฑ ุถุญุงฺฉ ูุดุงู ุฏุงุฏู ูโุดูุฏ.', required: false },
            'Duke': { name: 'ฺฉุงูู ุขููฺฏุฑ', symbol: '๐จ', rebus: '๐จ', alignment: 'good', description: 'ูโุชูุงูุฏ ฺฉ ุฏุณุช ุฑุง ุฏุฑ ูุงูพุณู ูพฺฉุงุฑ ุญุฐู ฺฉูุฏ.', required: false },
            'Archduke': { name: 'ุฑุณุชู ุฏุณุชุงู', symbol: '๐ช', rebus: '๐ช', alignment: 'good', description: 'ูโุชูุงูุฏ ฺฉ ุฏุณุช ุฑุง ุฏุฑ ูุงูพุณู ูพฺฉุงุฑ ุนูุถ ฺฉูุฏ.', required: false },
            'Minion': { name: 'ุฎุงุฆู', symbol: '๐ก๏ธ', rebus: '๐ก๏ธ', alignment: 'evil', description: 'ุฎุงุฆู ฺฉู ุจุฑุง ุจุฏ ูโุฌูฺฏุฏ.', required: false },
            'Morgan': { name: 'ุถุญุงฺฉ ูุงุฑุฏูุด', symbol: '๐', rebus: '๐', alignment: 'evil', description: 'ูโุชูุงูุฏ ุฏุฑูุด ฺฉุงูุงู ุฑุง ูุงุฏุฏู ุจฺฏุฑุฏ ู ูุฑูฺฏ ุง ููุฑุงู ฺฉูุฏ.', required: false },
            'Blind Hunter': { name: 'ููุงุจโุฏุงุฑ', symbol: '๐ญ', rebus: '๐ญ', alignment: 'evil', description: 'ุณุงุฑ ุงุนุถุง ูุดฺฉุฑ ุถุญุงฺฉ ุฑุง ููโุดูุงุณุฏ. ูโุชูุงูุฏ ุฏุฑ ูพฺฉุงุฑ ููุง ุดฺฉุงุฑ ฺฉูุฏ.', required: false }
        };

        // Recommended roles by player count
        var RECOMMENDED_ROLES = {
            4: ['Loyal Servant', 'Loyal Servant', 'Morgan', 'Blind Hunter'],
            5: ['Loyal Servant', 'Loyal Servant', 'Minion', 'Morgan', 'Blind Hunter'],
            6: ['Cleric', 'Troublemaker', 'Duke', 'Morgan', 'Blind Hunter', 'Minion'],
            7: ['Cleric', 'Troublemaker', 'Duke', 'Morgan', 'Blind Hunter', 'Minion', 'Minion'],
            8: ['Cleric', 'Troublemaker', 'Duke', 'Loyal Servant', 'Morgan', 'Blind Hunter', 'Minion', 'Minion'],
            9: ['Cleric', 'Troublemaker', 'Archduke', 'Loyal Servant', 'Loyal Servant', 'Morgan', 'Blind Hunter', 'Minion', 'Minion'],
            10: ['Cleric', 'Troublemaker', 'Duke', 'Loyal Servant', 'Loyal Servant', 'Loyal Servant', 'Morgan', 'Blind Hunter', 'Minion', 'Minion']
        };

        var SCENARIOS = {
            4: [
                { name: 'ูุจุฑุฏ ฺฉูุงุณฺฉ', description: 'ุณุฑุจุงุฒุ ุณุฑุจุงุฒ ุฏุฑ ุจุฑุงุจุฑ ุถุญุงฺฉ ู ููุงุจโุฏุงุฑ', roles: ['Loyal Servant', 'Loyal Servant', 'Morgan', 'Blind Hunter'] },
                { name: 'ูุจุฑุฏ ูุจูู', description: 'ฒ ููุด ุงุฒ (ููุจุฏุ ุฌูุงู ุฎุงูุ ุณุฑุจุงุฒ) + ุถุญุงฺฉ ู ููุงุจโุฏุงุฑ (ต ููุดุ ฑ ููุด ุญุฐู ูโุดูุฏ)', roles: ['Cleric', 'Youth', 'Loyal Servant', 'Morgan', 'Blind Hunter'] }
            ],
            5: [
                { name: 'ูุจุฑุฏ ฺฉูุงุณฺฉ', description: 'ฒ ุณุฑุจุงุฒ ุฏุฑ ุจุฑุงุจุฑ ุถุญุงฺฉุ ููุงุจโุฏุงุฑ ู ุฎุงุฆู', roles: ['Loyal Servant', 'Loyal Servant', 'Morgan', 'Blind Hunter', 'Minion'] },
                { name: 'ูุจุฑุฏ ูุจูู', description: 'ฒ ููุด ุงุฒ (ููุจุฏุ ุฌูุงู ุฎุงูุ ุณุฑุจุงุฒ) + ุถุญุงฺฉุ ููุงุจโุฏุงุฑ ู ุฎุงุฆู (ถ ููุดุ ฑ ููุด ุญุฐู ูโุดูุฏ)', roles: ['Cleric', 'Youth', 'Loyal Servant', 'Morgan', 'Blind Hunter', 'Minion'] }
            ],
            6: [
                { name: 'ูุณุฎู ฺฉุงุฑฺฏุฑุฏุงู', description: 'ููุจุฏุ ฺฉุงููุ ุณุงูุด ุฏุฑ ุจุฑุงุจุฑ ุถุญุงฺฉุ ููุงุจโุฏุงุฑุ ุฎุงุฆู', roles: ['Cleric', 'Duke', 'Troublemaker', 'Morgan', 'Blind Hunter', 'Minion'] },
                { name: 'ูุจุฑุฏ ฺฉูุงุณฺฉ', description: 'ณ ุณุฑุจุงุฒ ุฏุฑ ุจุฑุงุจุฑ ุถุญุงฺฉุ ููุงุจโุฏุงุฑุ ุฎุงุฆู', roles: ['Loyal Servant', 'Loyal Servant', 'Loyal Servant', 'Morgan', 'Blind Hunter', 'Minion'] }
            ],
            7: [
                { name: 'ูุณุฎู ฺฉุงุฑฺฏุฑุฏุงู', description: 'ููุจุฏุ ฺฉุงููุ ุณุงูุด ุฏุฑ ุจุฑุงุจุฑ ุถุญุงฺฉุ ููุงุจโุฏุงุฑุ ฒ ุฎุงุฆู', roles: ['Cleric', 'Duke', 'Troublemaker', 'Morgan', 'Blind Hunter', 'Minion', 'Minion'] },
                { name: 'ูุจุฑุฏ ฺฉูุงุณฺฉ', description: 'ณ ุณุฑุจุงุฒ ุฏุฑ ุจุฑุงุจุฑ ุถุญุงฺฉุ ููุงุจโุฏุงุฑุ ฒ ุฎุงุฆู', roles: ['Loyal Servant', 'Loyal Servant', 'Loyal Servant', 'Morgan', 'Blind Hunter', 'Minion', 'Minion'] }
            ],
            8: [
                { name: 'ูุณุฎู ฺฉุงุฑฺฏุฑุฏุงู', description: 'ููุจุฏุ ฺฉุงููุ ุณุงูุดุ ุณุฑุจุงุฒ ุฏุฑ ุจุฑุงุจุฑ ุถุญุงฺฉุ ููุงุจโุฏุงุฑุ ฒ ุฎุงุฆู', roles: ['Cleric', 'Duke', 'Troublemaker', 'Loyal Servant', 'Morgan', 'Blind Hunter', 'Minion', 'Minion'] },
                { name: 'ูุจุฑุฏ ฺฉูุงุณฺฉ', description: 'ด ุณุฑุจุงุฒ ุฏุฑ ุจุฑุงุจุฑ ุถุญุงฺฉุ ููุงุจโุฏุงุฑุ ฒ ุฎุงุฆู', roles: ['Loyal Servant', 'Loyal Servant', 'Loyal Servant', 'Loyal Servant', 'Morgan', 'Blind Hunter', 'Minion', 'Minion'] }
            ],
            9: [
                { name: 'ูุณุฎู ฺฉุงุฑฺฏุฑุฏุงู', description: 'ููุจุฏุ ุฑุณุชูุ ุณุงูุดุ ฒ ุณุฑุจุงุฒ ุฏุฑ ุจุฑุงุจุฑ ุถุญุงฺฉุ ููุงุจโุฏุงุฑุ ณ ุฎุงุฆู', roles: ['Cleric', 'Archduke', 'Troublemaker', 'Loyal Servant', 'Loyal Servant', 'Morgan', 'Blind Hunter', 'Minion', 'Minion', 'Minion'] },
                { name: 'ูุจุฑุฏ ฺฉูุงุณฺฉ', description: 'ด ุณุฑุจุงุฒ ุฏุฑ ุจุฑุงุจุฑ ุถุญุงฺฉุ ููุงุจโุฏุงุฑุ ณ ุฎุงุฆู', roles: ['Loyal Servant', 'Loyal Servant', 'Loyal Servant', 'Loyal Servant', 'Morgan', 'Blind Hunter', 'Minion', 'Minion', 'Minion'] }
            ],
            10: [
                { name: 'ูุณุฎู ฺฉุงุฑฺฏุฑุฏุงู', description: 'ููุจุฏุ ุฑุณุชูุ ฺฉุงููุ ุณุงูุดุ ฒ ุณุฑุจุงุฒ ุฏุฑ ุจุฑุงุจุฑ ุถุญุงฺฉุ ููุงุจโุฏุงุฑุ ณ ุฎุงุฆู', roles: ['Cleric', 'Archduke', 'Duke', 'Troublemaker', 'Loyal Servant', 'Loyal Servant', 'Morgan', 'Blind Hunter', 'Minion', 'Minion', 'Minion'] },
                { name: 'ูุจุฑุฏ ฺฉูุงุณฺฉ', description: 'ต ุณุฑุจุงุฒ ุฏุฑ ุจุฑุงุจุฑ ุถุญุงฺฉุ ููุงุจโุฏุงุฑุ ณ ุฎุงุฆู', roles: ['Loyal Servant', 'Loyal Servant', 'Loyal Servant', 'Loyal Servant', 'Loyal Servant', 'Morgan', 'Blind Hunter', 'Minion', 'Minion', 'Minion'] }
            ]
        };

        // --- Global State ---
        var playerCount = 7;
        var players = [];
        var savedPlayers = [];
        var currentDistIndex = 0;
        var selectedRoles = []; // Roles selected for this game
        var rolesOnGround = []; // Roles selected but not assigned (ambiguity rule)
        
        // Game State
        var currentQuest = 1;
        var goodWins = 0;
        var evilWins = 0;
        var currentLeader = 0;
        var questHistory = [];
        var currentTeam = [];
        var questCards = []; // Array of {player, card: 'success' or 'fail'}
        var questCardSelectionMode = 'confirmation'; // 'confirmation' or 'selection'
        var isGameEnded = false;
        var gameLog = [];
        var isGameInProgress = false;
        
        // Completely prevent accidental refresh/back navigation
        // Set up event listeners once (always active, check flag when firing)
        window.addEventListener('beforeunload', function(e) {
            if (isGameInProgress) {
                e.preventDefault();
                e.returnValue = 'Game is in progress! Reloading will lose all progress.';
                return e.returnValue;
            }
        });
        
        // Disable keyboard shortcuts for refresh (F5, Ctrl+R, Ctrl+Shift+R)
        document.addEventListener('keydown', function(e) {
            if (isGameInProgress) {
                // F5
                if (e.key === 'F5' || e.keyCode === 116) {
                    e.preventDefault();
                    alert('Refresh is disabled during game. Use game controls to navigate.');
                    return false;
                }
                // Ctrl+R or Ctrl+Shift+R
                if ((e.ctrlKey || e.metaKey) && (e.key === 'r' || e.key === 'R')) {
                    e.preventDefault();
                    alert('Refresh is disabled during game. Use game controls to navigate.');
                    return false;
                }
            }
        });
        
        // Disable right-click context menu during game
        document.addEventListener('contextmenu', function(e) {
            if (isGameInProgress) {
                e.preventDefault();
                return false;
            }
        }, false);
        
        // Handle back button
        window.onpopstate = function(event) {
            if (isGameInProgress) {
                // Immediately push state back to prevent navigation
                history.pushState({page: 'game'}, '', location.href);
                // Show warning
                alert('Back button is disabled during game. Use game controls to navigate.');
            }
        };
        
        function preventAccidentalNavigation() {
            if (isGameInProgress) {
                // Completely prevent back button - push state and immediately replace
                history.pushState({page: 'game'}, '', location.href);
                history.pushState({page: 'game'}, '', location.href);
            }
        }
        
        // Initialize navigation prevention
        preventAccidentalNavigation();
        var amulets = []; // Array of {quest: number, available: boolean, holder: null or playerIndex, checked: []}
        var veterans = []; // Array of player indices who have been leaders
        var magicTokenHolder = null; // Player index with magic token
        var magicTokenTeamMemberIndex = null; // Which team member (0-based) has magic token
        var amuletHolders = []; // Players who have received amulets
        var checkedByAmulet = []; // Players checked by amulets
        var quest3Size = null; // For 4 players, track if Quest 3 is 2 or 3
        
        // Handle page visibility to prevent freezing on mobile
        var audioContext = null;
        function getAudioContext() {
            if (!audioContext) {
                try {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                } catch (e) {
                    // Audio not supported
                }
            }
            // Resume audio context if suspended (common on mobile when returning to app)
            if (audioContext && audioContext.state === 'suspended') {
                audioContext.resume().catch(function() {});
            }
            return audioContext;
        }
        
        // Handle page visibility changes to prevent freezing
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                // Page is now visible - resume audio context and wake up the page
                getAudioContext();
                // Force a repaint to wake up the page
                if (document.body) {
                    var display = document.body.style.display;
                    document.body.style.display = 'none';
                    document.body.offsetHeight; // Trigger reflow
                    document.body.style.display = display;
                }
            }
        });
        
        // Handle page focus to prevent freezing
        window.addEventListener('focus', function() {
            getAudioContext();
        });
        
        // Auto-save game state periodically to prevent data loss
        function saveGameState() {
            try {
                // Only save if game is in progress
                if (players.length > 0 && !isGameEnded) {
                    var state = {
                        playerCount: playerCount,
                        players: players,
                        currentQuest: currentQuest,
                        currentLeader: currentLeader,
                        goodWins: goodWins,
                        evilWins: evilWins,
                        questHistory: questHistory,
                        veterans: veterans,
                        amuletHolders: amuletHolders,
                        checkedByAmulet: checkedByAmulet,
                        quest3Size: quest3Size,
                        amulets: amulets,
                        questCards: questCards,
                        questCardSelectionMode: questCardSelectionMode,
                        currentTeam: currentTeam,
                        magicTokenTeamMemberIndex: magicTokenTeamMemberIndex,
                        selectedRoles: selectedRoles,
                        currentDistIndex: currentDistIndex
                    };
                    localStorage.setItem('quest_game_state_farsi', JSON.stringify(state));
                }
            } catch (e) {
                // Silently fail if localStorage not available
            }
        }
        
        // Save state every 3 seconds
        setInterval(saveGameState, 3000);
        
        // Keep page alive with minimal activity
        setInterval(function() {
            if (!document.hidden) {
                // Small periodic activity to prevent page from being suspended
                getAudioContext();
            }
        }, 10000);

        // Restore game state from localStorage
        function restoreGameState() {
            try {
                var stored = localStorage.getItem('quest_game_state_farsi');
                if (stored) {
                    var state = JSON.parse(stored);
                    if (confirm('ุจุงุฒ ุฏุฑ ุญุงู ุงูุฌุงู ูพุฏุง ุดุฏ. ุขุง ูโุฎูุงูุฏ ุขู ุฑุง ุจุงุฒุงุจ ฺฉูุฏุ')) {
                        // Restore all game state
                        playerCount = state.playerCount;
                        players = state.players;
                        currentQuest = state.currentQuest;
                        currentLeader = state.currentLeader;
                        goodWins = state.goodWins;
                        evilWins = state.evilWins;
                        questHistory = state.questHistory;
                        veterans = state.veterans || [];
                        amuletHolders = state.amuletHolders || [];
                        checkedByAmulet = state.checkedByAmulet || [];
                        quest3Size = state.quest3Size;
                        amulets = state.amulets || [];
                        questCards = state.questCards || [];
                        questCardSelectionMode = state.questCardSelectionMode || 'confirmation';
                        currentTeam = state.currentTeam || [];
                        magicTokenTeamMemberIndex = state.magicTokenTeamMemberIndex;
                        selectedRoles = state.selectedRoles || [];
                        currentDistIndex = state.currentDistIndex;
                        
                        isGameInProgress = true;
                        preventAccidentalNavigation();
                        
                        // Determine which screen to show
                        if (currentDistIndex < players.length) {
                            // Still in distribution phase
                            showScreen('distribution-screen');
                            updateDistScreen();
                        } else if (players.length > 0 && !isGameEnded) {
                            // Game is in progress - restore to game screen
                            showScreen('game-screen');
                            updateGameDisplay();
                            
                            // Restore game phase based on state
                            var config = QUEST_CONFIG[playerCount];
                            var teamSize = config.quests[currentQuest - 1];
                            if (playerCount === 4 && currentQuest === 3 && quest3Size !== null) {
                                teamSize = quest3Size;
                            }
                            
                            if (questCards.length > 0 && questCards.length < teamSize) {
                                // In quest card selection phase - partially complete
                                // Open the modal and show the selection screen
                                var modal = document.getElementById('quest-card-modal');
                                if (modal) {
                                    modal.classList.remove('hidden');
                                    if (questCardSelectionMode === 'selection') {
                                        document.getElementById('quest-card-confirmation-screen').classList.add('hidden');
                                        document.getElementById('quest-card-selection-screen').classList.remove('hidden');
                                        updateQuestCardSelection();
                                    } else {
                                        document.getElementById('quest-card-confirmation-screen').classList.remove('hidden');
                                        document.getElementById('quest-card-selection-screen').classList.add('hidden');
                                        showQuestCardConfirmation();
                                    }
                                }
                            } else if (questCards.length >= teamSize) {
                                // All cards selected, show confirmation screen
                                var modal = document.getElementById('quest-card-modal');
                                if (modal) {
                                    modal.classList.remove('hidden');
                                    document.getElementById('quest-card-confirmation-screen').classList.remove('hidden');
                                    document.getElementById('quest-card-selection-screen').classList.add('hidden');
                                    showQuestCardConfirmation();
                                }
                            } else if (currentTeam.length > 0) {
                                // Team selected but cards not started yet
                                var actions = document.getElementById('action-buttons');
                                actions.innerHTML = '<button class="action-btn" onclick="startQuestCardSelection()">ุชู ุงูุชุฎุงุจ ุดุฏ - ุดุฑูุน ุงูุชุฎุงุจ ฺฉุงุฑุช</button>';
                            } else {
                                // No team selected yet, start team selection
                                startTeamSelection();
                            }
                        }
                        return true;
                    } else {
                        // User chose not to restore, clear saved state
                        localStorage.removeItem('quest_game_state_farsi');
                    }
                }
            } catch (e) {
                console.error('Error restoring game state:', e);
            }
            return false;
        }
        
        // --- Initialization ---
        window.onload = function() {
            loadSavedPlayers();
            renderPlayerInputs();
            // Try to restore game state first
            if (!restoreGameState()) {
                // No saved game, show normal setup
            }
        };

        function loadSavedPlayers() {
            var stored = localStorage.getItem('quest_players');
            if (stored) {
                savedPlayers = JSON.parse(stored);
            }
            renderSavedList();
        }

        function renderSavedList() {
            var container = document.getElementById('saved-list');
            container.innerHTML = '';
            
            if (savedPlayers.length === 0) {
                container.innerHTML = '<span style="color:#555; font-size:0.8rem;">ูฺ ูุงู ุฐุฎุฑูโุดุฏูโุง ูุฌูุฏ ูุฏุงุฑุฏ</span>';
                return;
            }

            savedPlayers.forEach(function(name) {
                var chip = document.createElement('div');
                chip.className = 'player-chip';
                chip.style.display = 'inline-block';
                chip.style.background = 'rgba(255,255,255,0.1)';
                chip.style.border = '1px solid #555';
                chip.style.borderRadius = '20px';
                chip.style.padding = '6px 14px';
                chip.style.fontSize = '0.85rem';
                chip.style.cursor = 'pointer';
                chip.style.margin = '3px';
                chip.innerText = name;
                chip.onclick = function() { fillInput(name); };
                container.appendChild(chip);
            });
        }

        function fillInput(name) {
            var inputs = document.querySelectorAll('.player-input');
            for (var i = 0; i < inputs.length; i++) {
                var val = inputs[i].value;
                if (val === '') {
                    inputs[i].value = name;
                    return;
                }
            }
        }

        function updatePlayerCount(delta) {
            var newCount = playerCount + delta;
            if (newCount >= 4 && newCount <= 10) {
                playerCount = newCount;
                document.getElementById('player-count-display').innerText = toFarsiNum(playerCount);
                renderPlayerInputs();
            }
        }

        function renderPlayerInputs() {
            var container = document.getElementById('player-inputs-container');
            var currentValues = [];
            var inputs = container.querySelectorAll('.player-input');
            for(var i=0; i<inputs.length; i++) currentValues.push(inputs[i].value);

            container.innerHTML = '';
            for (var i = 0; i < playerCount; i++) {
                var val = currentValues[i] || '';
                var placeholder = "ุงุฑ " + toFarsiNum(i + 1);
                var input = document.createElement('input');
                input.type = 'text';
                input.className = 'player-input';
                input.placeholder = placeholder;
                input.value = val;
                container.appendChild(input);
            }
        }

        function showRoleSelection() {
            // Hide setup screen and show role selection first
            var setupScreen = document.getElementById('setup-screen');
            var roleScreen = document.getElementById('role-selection-screen');
            if (setupScreen) setupScreen.classList.add('hidden');
            if (roleScreen) {
                roleScreen.classList.remove('hidden');
            }
            
            // Load recommended roles if none selected, then render
            if (selectedRoles.length === 0) {
                useRecommendedRoles();
            } else {
                renderRoleSelection();
            }
        }

        function useRecommendedRoles() {
            selectedRoles = RECOMMENDED_ROLES[playerCount].slice();
            renderRoleSelection();
        }

        function applyScenario(roles) {
            selectedRoles = roles.slice();
            renderRoleSelection();
        }

        function renderRoleSelection() {
            var info = document.getElementById('role-selection-info');
            var list = document.getElementById('role-selection-list');
            
            if (!info || !list) return;
            
            info.innerHTML = 'ุจุฑุง ุงู ุจุงุฒ ' + toFarsiNum(playerCount) + ' ููุด ุจุฑฺฏุฒูุฏ.';
            list.innerHTML = '';
            
            // Scenario Selection UI
            var scenarios = SCENARIOS[playerCount];
            if (scenarios && scenarios.length > 0) {
                var scenarioContainer = document.createElement('div');
                scenarioContainer.style.marginBottom = '20px';
                scenarioContainer.style.padding = '15px';
                scenarioContainer.style.background = 'rgba(0, 150, 136, 0.1)';
                scenarioContainer.style.border = '1px solid var(--accent-color)';
                scenarioContainer.style.borderRadius = '8px';

                var scenarioTitle = document.createElement('h3');
                scenarioTitle.innerText = 'ุณูุงุฑููุง ูพุดููุงุฏ';
                scenarioTitle.style.marginTop = '0';
                scenarioTitle.style.fontSize = '1rem';
                scenarioTitle.style.color = 'var(--accent-color)';
                scenarioContainer.appendChild(scenarioTitle);

                scenarios.forEach(function(scenario) {
                    var btn = document.createElement('button');
                    btn.className = 'secondary-btn';
                    btn.style.marginTop = '8px';
                    btn.style.textAlign = 'right';
                    btn.innerHTML = '<strong>' + scenario.name + '</strong><br><span style="font-size:0.8rem; color:var(--text-secondary);">' + scenario.description + '</span>';
                    btn.onclick = function() { applyScenario(scenario.roles); };
                    scenarioContainer.appendChild(btn);
                });

                list.appendChild(scenarioContainer);
            }

            var availableRoles = ['Cleric', 'Youth', 'Troublemaker', 'Duke', 'Archduke', 'Morgan', 'Blind Hunter', 'Loyal Servant', 'Minion'];
            
            var roleCounts = {};
            selectedRoles.forEach(function(role) {
                roleCounts[role] = (roleCounts[role] || 0) + 1;
            });
            
            availableRoles.forEach(function(roleKey) {
                var role = ROLE_DEFINITIONS[roleKey];
                if (!role) return;
                
                var item = document.createElement('div');
                item.className = 'role-select-item';
                item.setAttribute('data-alignment', role.alignment);
                
                var count = roleCounts[roleKey] || 0;
                if (count > 0) item.classList.add('selected');
                
                var left = document.createElement('div');
                left.innerHTML = '<div style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;"><span style="font-size: 1.5rem;">' + (role.rebus || 'โ') + '</span><strong>' + role.name + '</strong></div><span style="font-size: 0.85rem; color: var(--text-secondary);">' + role.description + '</span>';
                
                var right = document.createElement('div');
                right.style.display = 'flex';
                right.style.alignItems = 'center';
                right.style.gap = '10px';
                
                var badge = document.createElement('span');
                badge.className = 'role-badge ' + (role.alignment === 'good' ? 'badge-good' : 'badge-evil');
                badge.innerText = role.alignment === 'good' ? 'ุฎูุจ' : 'ุจุฏ';
                right.appendChild(badge);
                
                var countDisplay = document.createElement('span');
                countDisplay.style.fontSize = '1.2rem';
                countDisplay.style.fontWeight = 'bold';
                countDisplay.style.minWidth = '30px';
                countDisplay.innerText = toFarsiNum(count);
                right.appendChild(countDisplay);
                
                var minusBtn = document.createElement('button');
                minusBtn.innerText = 'โ';
                minusBtn.style.width = '30px';
                minusBtn.style.height = '30px';
                minusBtn.style.borderRadius = '50%';
                minusBtn.style.border = '2px solid var(--accent-color)';
                minusBtn.style.background = 'transparent';
                minusBtn.style.color = 'var(--accent-color)';
                minusBtn.style.cursor = 'pointer';
                minusBtn.onclick = function(e) { e.stopPropagation(); removeRole(roleKey); };
                right.appendChild(minusBtn);
                
                var plusBtn = document.createElement('button');
                plusBtn.innerText = '+';
                plusBtn.style.width = '30px';
                plusBtn.style.height = '30px';
                plusBtn.style.borderRadius = '50%';
                plusBtn.style.border = '2px solid var(--accent-color)';
                plusBtn.style.background = 'transparent';
                plusBtn.style.color = 'var(--accent-color)';
                plusBtn.style.cursor = 'pointer';
                plusBtn.onclick = function(e) { e.stopPropagation(); addRole(roleKey); };
                right.appendChild(plusBtn);
                
                item.appendChild(left);
                item.appendChild(right);
                list.appendChild(item);
            });
            
            var total = selectedRoles.length;
            var totalDiv = document.createElement('div');
            totalDiv.style.marginTop = '20px';
            totalDiv.style.padding = '15px';
            totalDiv.style.background = total === playerCount ? 'rgba(76, 175, 80, 0.2)' : 'rgba(255, 152, 0, 0.2)';
            totalDiv.style.borderRadius = '8px';
            totalDiv.style.fontWeight = 'bold';
                totalDiv.innerText = 'ุชุนุฏุงุฏ ููุดโูุง: ' + toFarsiNum(total) + ' / ' + toFarsiNum(playerCount);
            list.appendChild(totalDiv);
        }

        function addRole(roleKey) {
            var total = selectedRoles.length;
                // Special rule for 4-5 players: if ambiguity pool roles are selected, allow N+1 roles
                var allowedCount = playerCount;
                // Check for ambiguity pool roles: Cleric, Youth, Loyal Servant
                var hasAmbiguityRoles = selectedRoles.includes('Cleric') || selectedRoles.includes('Youth') || selectedRoles.includes('Loyal Servant');
                // Also check if the role being added is from ambiguity pool
                var addingAmbiguityRole = roleKey === 'Cleric' || roleKey === 'Youth' || roleKey === 'Loyal Servant';
                if ((playerCount === 4 || playerCount === 5) && (hasAmbiguityRoles || addingAmbiguityRole)) {
                    allowedCount = playerCount + 1;
                }

                if (total >= allowedCount) {
                    alert('ุดูุง ' + toFarsiNum(total) + ' ููุด ุจุฑฺฏุฒุฏูโุงุฏ. ุงุจุชุฏุง ฺฉ ููุด ุฑุง ุญุฐู ฺฉูุฏ.');
                    return;
                }
            selectedRoles.push(roleKey);
            renderRoleSelection();
        }

        function removeRole(roleKey) {
            var index = selectedRoles.lastIndexOf(roleKey);
            if (index !== -1) {
                selectedRoles.splice(index, 1);
                renderRoleSelection();
            }
        }

        function confirmRoleSelection() {
            // Special rule for 4-5 players with ambiguity pool roles
            var allowedCount = playerCount;
            // Check for ambiguity pool roles: Cleric, Youth, Loyal Servant
            var hasAmbiguityRoles = selectedRoles.includes('Cleric') || selectedRoles.includes('Youth') || selectedRoles.includes('Loyal Servant');
            if ((playerCount === 4 || playerCount === 5) && hasAmbiguityRoles) {
                allowedCount = playerCount + 1;
            }

            if (selectedRoles.length !== playerCount && selectedRoles.length !== allowedCount) {
                alert('ูุทูุงู ' + toFarsiNum(playerCount) + ' (ุง ' + toFarsiNum(allowedCount) + ' ุฏุฑ ุตูุฑุช ูุฌูุฏ ููุดโูุง ูุจูู) ููุด ุจุฑฺฏุฒูุฏ.');
                return;
            }
            
            // No role restrictions - allow any combination
            document.getElementById('role-selection-screen').classList.add('hidden');
            startRoleDistribution();
        }

        // --- Role Distribution ---
        function startRoleDistribution() {
            isGameInProgress = true;
            // If no roles selected, use recommended
            if (selectedRoles.length === 0) {
                useRecommendedRoles();
            }
            
            // Validate roles
            var allowedCount = playerCount;
            // Check for ambiguity pool roles: Cleric, Youth, Loyal Servant
            var hasAmbiguityRoles = selectedRoles.includes('Cleric') || selectedRoles.includes('Youth') || selectedRoles.includes('Loyal Servant');
            if ((playerCount === 4 || playerCount === 5) && hasAmbiguityRoles) {
                allowedCount = playerCount + 1;
            }

            if (selectedRoles.length !== playerCount && selectedRoles.length !== allowedCount) {
                alert('ูุทูุงู ุงุจุชุฏุง ููุดโูุง ุฑุง ุชูุธู ฺฉูุฏ. ุฏฺฉูู "ุชูุธู ููุดโูุง" ุฑุง ุจุฒูุฏ.');
                return;
            }
            
            var inputs = document.querySelectorAll('.player-input');
            var names = [];
            for (var i = 0; i < inputs.length; i++) {
                var val = inputs[i].value.trim() || inputs[i].placeholder;
                names.push(val);
                
                if (inputs[i].value.trim() !== '' && savedPlayers.indexOf(val) === -1) {
                    savedPlayers.push(val);
                }
            }
            localStorage.setItem('quest_players', JSON.stringify(savedPlayers));
            renderSavedList();

            // Randomly select first leader BEFORE assigning roles
            currentLeader = Math.floor(Math.random() * playerCount);
            addLog('ุณุฑุฏุงุฑ ุงูู ุจู ุตูุฑุช ุชุตุงุฏู ุจุฑฺฏุฒุฏู ุดุฏ: ุงุฑ ' + toFarsiNum(currentLeader + 1));

            // Handle N+1 ambiguity rule: randomization only between ambiguity pool roles
            var rolesToAssign = [];
            
            // Define ambiguity pools for different player counts
            var ambiguityPool = [];
            if (playerCount === 4 || playerCount === 5) {
                // For 4-5 players: ambiguity pool is [Cleric, Youth, Loyal Servant]
                ambiguityPool = ['Cleric', 'Youth', 'Loyal Servant'];
            }
            // For 6+ players, no ambiguity rule applies (all roles are fixed)
            
            // Separate roles into ambiguity pool and fixed roles
            var ambiguityRoles = [];
            var fixedRoles = [];
            
            for (var i = 0; i < selectedRoles.length; i++) {
                if (ambiguityPool.length > 0 && ambiguityPool.indexOf(selectedRoles[i]) !== -1) {
                    ambiguityRoles.push(selectedRoles[i]);
                } else {
                    fixedRoles.push(selectedRoles[i]);
                }
            }
            
            // If we have ambiguity roles and N+1 total roles, apply ambiguity rule
            if (selectedRoles.length === playerCount + 1 && ambiguityRoles.length > 0) {
                // Randomly select required number from ambiguity pool
                // For 4-5 players: need 2 from [Cleric, Youth, Loyal Servant]
                var requiredFromAmbiguity = 2;
                shuffleArray(ambiguityRoles);
                var selectedAmbiguity = ambiguityRoles.slice(0, requiredFromAmbiguity);
                
                // Combine selected ambiguity roles with fixed roles
                rolesToAssign = selectedAmbiguity.concat(fixedRoles);
                
                // Shuffle the final assignment
                shuffleArray(rolesToAssign);
                
                // Track which roles are on the ground
                rolesOnGround = [];
                for (var j = 0; j < ambiguityRoles.length; j++) {
                    if (selectedAmbiguity.indexOf(ambiguityRoles[j]) === -1) {
                        rolesOnGround.push(ambiguityRoles[j]);
                    }
                }
                if (rolesOnGround.length > 0) {
                    var removedNames = rolesOnGround.map(function(r) { return ROLE_DEFINITIONS[r].name; });
                    addLog('ฺฉ ููุด ุงุฒ ููุดโูุง ูุจูู ุจู ุตูุฑุช ุชุตุงุฏู ุญุฐู ุดุฏ (ูุงููู ุงุจูุงู): ' + removedNames.join('ุ '));
                }
            } else {
                // Normal case: shuffle all roles
                rolesToAssign = selectedRoles.slice();
                shuffleArray(rolesToAssign);
                rolesOnGround = []; // No roles on ground in normal case
                
                // If we still have N+1 roles (shouldn't happen in normal flow, but handle it)
                if (rolesToAssign.length > playerCount) {
                    // Only remove from ambiguity pool if present
                    if (ambiguityRoles.length > 0) {
                        var rolesToRemove = [];
                        for (var k = 0; k < rolesToAssign.length; k++) {
                            if (ambiguityPool.indexOf(rolesToAssign[k]) !== -1) {
                                rolesToRemove.push(k);
                            }
                        }
                        if (rolesToRemove.length > 0) {
                            var removeIndex = rolesToRemove[Math.floor(Math.random() * rolesToRemove.length)];
                            var removedRole = rolesToAssign[removeIndex];
                            rolesToAssign.splice(removeIndex, 1);
                            rolesOnGround = [removedRole];
                            addLog('ฺฉ ููุด ุงุฒ ููุดโูุง ูุจูู ุจู ุตูุฑุช ุชุตุงุฏู ุญุฐู ุดุฏ (ูุงููู ุงุจูุงู): ' + ROLE_DEFINITIONS[removedRole].name);
                        } else {
                            // Fallback: remove last role
                            var droppedRole = rolesToAssign[playerCount];
                            rolesOnGround = [droppedRole];
                            addLog('ฺฉ ููุด ุจู ุตูุฑุช ุชุตุงุฏู ุญุฐู ุดุฏ (ูุงููู ุงุจูุงู): ' + ROLE_DEFINITIONS[droppedRole].name);
                        }
                    } else {
                        // No ambiguity pool: remove last role
                        var droppedRole = rolesToAssign[playerCount];
                        rolesOnGround = [droppedRole];
                        addLog('ฺฉ ููุด ุจู ุตูุฑุช ุชุตุงุฏู ุญุฐู ุดุฏ (ูุงููู ุงุจูุงู): ' + ROLE_DEFINITIONS[droppedRole].name);
                    }
                }
            }
            
            players = [];
            for (var i = 0; i < playerCount; i++) {
                var roleKey = rolesToAssign[i];
                var roleDef = ROLE_DEFINITIONS[roleKey];
                if (!roleDef) {
                    alert('Error: Invalid role ' + roleKey + '. Please reconfigure roles.');
                    return;
                }
                players.push({
                    name: names[i],
                    roleKey: roleKey,
                    role: roleDef.name,
                    alignment: roleDef.alignment,
                    description: roleDef.description,
                    eliminated: false
                });
            }
            
            // Don't shuffle players - keep them in input order
            
            currentDistIndex = 0;
            document.getElementById('dist-total-players').innerText = toFarsiNum(playerCount);
            document.getElementById('role-selection-screen').classList.add('hidden');
            showScreen('distribution-screen');
            updateDistScreen();
        }

        function updateDistScreen() {
            document.getElementById('dist-player-num').innerText = toFarsiNum(currentDistIndex + 1);
            document.getElementById('dist-player-name').innerText = players[currentDistIndex].name;
        }

        function revealRole() {
            var player = players[currentDistIndex];
            document.getElementById('reveal-name-header').innerText = player.name;
            
            var title = document.getElementById('role-title');
            var desc = document.getElementById('role-desc');
            var extra = document.getElementById('role-extra');
            
            var isGood = player.alignment === 'good';
            var roleDef = ROLE_DEFINITIONS[player.roleKey];
            var rebus = roleDef ? roleDef.rebus : (isGood ? '๐ก๏ธ' : 'โ๏ธ');
            title.innerHTML = '<span style="font-size: 2rem; margin-left: 10px;">' + rebus + '</span> ' + player.role;
            title.className = 'role-title ' + (isGood ? 'role-good' : 'role-evil');
            desc.innerText = player.description;
            
            extra.innerHTML = '';
            
            // Show information for Cleric about first leader (all player counts)
            if (player.roleKey === 'Cleric') {
                var firstLeader = players[currentLeader];
                var firstLeaderIsGood = firstLeader.alignment === 'good';
                extra.innerHTML = '<div style="margin-top: 15px; padding: 10px; background: rgba(76, 175, 80, 0.2); border: 1px solid var(--good-color); border-radius: 8px; color: #C8E6C9;"><strong>ุงุทูุงุนุงุช ููุจุฏ:</strong><br>ุณุฑุฏุงุฑ ุงูู: <strong>' + firstLeader.name + '</strong><br>ุณุฑุฏุงุฑ ุงูู <strong style="color: ' + (firstLeaderIsGood ? 'var(--good-color)' : 'var(--evil-color)') + ';">' + (firstLeaderIsGood ? 'ุฎูุจ' : 'ุจุฏ') + '</strong> ุงุณุช.</div>';
            }
            
            // Show teammates for evil players
            if (!isGood) {
                if (player.roleKey === 'Blind Hunter') {
                    // Blind Hunter never knows other evil players (any player count)
                    extra.innerHTML = '<div style="margin-top: 15px; padding: 10px; background: rgba(244, 67, 54, 0.2); border: 1px solid var(--evil-color); border-radius: 8px; color: #FFCDD2;"><strong>ููู:</strong> ุดูุง ููโุฏุงูุฏ ุณุงุฑ ุงุนุถุง ูุดฺฉุฑ ุถุญุงฺฉ ฺู ฺฉุณุงู ูุณุชูุฏ. ุดูุง ุชููุง ูุณุชุฏ.</div>';
                } else {
                    // Other evil players (Morgan, Minion)
                    // Show all evil teammates including Blind Hunter
                    var evilPlayers = players.filter(p => p.alignment === 'evil' && p.name !== player.name);
                    
                    if (evilPlayers.length > 0) {
                        var teamList = evilPlayers.map(p => {
                            var roleDef = ROLE_DEFINITIONS[p.roleKey];
                            var roleName = roleDef ? roleDef.name : p.roleKey;
                            return p.name + ' (' + roleName + ')';
                        }).join('ุ ');
                        extra.innerHTML = '<div style="margin-top: 15px; padding: 10px; background: rgba(244, 67, 54, 0.2); border: 1px solid var(--evil-color); border-radius: 8px; color: #FFCDD2;"><strong>ููโฺฏุฑููโูุง ูุดฺฉุฑ ุถุญุงฺฉ ุดูุง:</strong> ' + teamList + '</div>';
                    }
                }
            }
            
            var nextBtn = document.getElementById('next-dist-btn');
            if (currentDistIndex === playerCount - 1) {
                nextBtn.innerText = "ูพุงุงู ุชูุฒุน";
                nextBtn.style.backgroundColor = "#4CAF50";
            } else {
                nextBtn.innerText = "ูพููุงู ู ุจุนุฏ";
                nextBtn.style.backgroundColor = "#64ffda";
            }
            
            document.getElementById('dist-pass-view').classList.add('hidden');
            document.getElementById('dist-reveal-view').classList.remove('hidden');
        }

        function nextDistribute() {
            currentDistIndex++;
            if (currentDistIndex >= playerCount) {
                // All roles distributed, show first leader announcement
                document.getElementById('first-leader-name').innerText = players[currentLeader].name;
                addLog('ุณุฑุฏุงุฑ ุงูู: ' + players[currentLeader].name);
                showScreen('leader-announce-screen');
            } else {
                document.getElementById('dist-pass-view').classList.remove('hidden');
                document.getElementById('dist-reveal-view').classList.add('hidden');
                updateDistScreen();
            }
        }

        // --- Game Logic ---
        function startGame() {
            currentQuest = 1;
            goodWins = 0;
            evilWins = 0;
            questHistory = [];
            isGameEnded = false;
            gameLog = [];
            veterans = [currentLeader]; // First leader is a veteran
            magicTokenHolder = null;
            magicTokenTeamMemberIndex = null;
            amuletHolders = [];
            checkedByAmulet = [];
            quest3Size = null;
            
            // Initialize amulets based on player count
            amulets = [];
            if (playerCount >= 6) {
                var amuletQuests = AMULET_CONFIG[playerCount] || [];
                amuletQuests.forEach(function(questNum) {
                    amulets.push({ 
                        quest: questNum, 
                        available: false, 
                        holder: null,
                        used: false
                    });
                });
            }
            
            addLog("ุจุงุฒ ุจุง " + toFarsiNum(playerCount) + " ุงุฑ ุดุฑูุน ุดุฏ.");
            addLog("ุณุฑุฏุงุฑ ุงูู: " + players[currentLeader].name);
            
            showScreen('game-screen');
            updateGameDisplay();
            startTeamSelection();
        }

        function updateGameDisplay() {
            document.getElementById('good-wins-display').innerText = toFarsiNum(goodWins);
            document.getElementById('evil-wins-display').innerText = toFarsiNum(evilWins);
            document.getElementById('current-leader-name').innerText = players[currentLeader].name;
            
            // Update team lists
            renderTeamLists();
            
            // Update quest board visualization
            renderQuestBoard();
            
            // Update amulets
            renderAmulets();
        }
        
        function renderTeamLists() {
            var goodList = document.getElementById('good-team-list');
            var evilList = document.getElementById('evil-team-list');
            
            goodList.innerHTML = '';
            evilList.innerHTML = '';
            
            // Count roles by type (not showing which player has which - secret info)
            var goodRoleCounts = {};
            var evilRoleCounts = {};
            
            players.forEach(function(player) {
                if (player.eliminated) return;
                if (player.alignment === 'good') {
                    goodRoleCounts[player.roleKey] = (goodRoleCounts[player.roleKey] || 0) + 1;
                } else {
                    evilRoleCounts[player.roleKey] = (evilRoleCounts[player.roleKey] || 0) + 1;
                }
            });
            
            // Add "on the ground" roles to counts
            if (rolesOnGround && rolesOnGround.length > 0) {
                rolesOnGround.forEach(function(roleKey) {
                    var roleDef = ROLE_DEFINITIONS[roleKey];
                    if (roleDef) {
                        if (roleDef.alignment === 'good') {
                            goodRoleCounts[roleKey] = (goodRoleCounts[roleKey] || 0) + 1;
                        } else {
                            evilRoleCounts[roleKey] = (evilRoleCounts[roleKey] || 0) + 1;
                        }
                    }
                });
            }
            
            // Render Good team roles (right side) - sorted by strength
            var goodRoleKeys = Object.keys(goodRoleCounts);
            goodRoleKeys.sort(function(a, b) {
                return (ROLE_STRENGTH[b] || 0) - (ROLE_STRENGTH[a] || 0); // Higher strength first
            });
            
            if (goodRoleKeys.length === 0) {
                goodList.innerHTML = '<span style="font-size: 0.8rem; color: var(--text-secondary);">-</span>';
            } else {
                goodRoleKeys.forEach(function(roleKey) {
                    var roleDef = ROLE_DEFINITIONS[roleKey];
                    var count = goodRoleCounts[roleKey];
                    var item = document.createElement('div');
                    // Compact chip style
                    item.style.cssText = 'display: inline-flex; align-items: center; padding: 2px 6px; background: rgba(76, 175, 80, 0.15); border: 1px solid var(--good-color); border-radius: 4px; font-size: 0.75rem; white-space: nowrap;';
                    item.innerHTML = '<span style="font-size: 1rem; margin-left: 4px;">' + (roleDef ? roleDef.rebus : 'โ') + '</span><span style="font-weight: bold; color: var(--good-color);">' + (roleDef ? roleDef.name : roleKey) + '</span>' + (count > 1 ? '<span style="margin-right: 3px; font-weight: bold; opacity: 0.8;">ร' + toFarsiNum(count) + '</span>' : '');
                    goodList.appendChild(item);
                });
            }
            
            // Render Evil team roles (left side) - sorted by strength
            var evilRoleKeys = Object.keys(evilRoleCounts);
            evilRoleKeys.sort(function(a, b) {
                return (ROLE_STRENGTH[b] || 0) - (ROLE_STRENGTH[a] || 0); // Higher strength first
            });
            
            if (evilRoleKeys.length === 0) {
                evilList.innerHTML = '<span style="font-size: 0.8rem; color: var(--text-secondary);">-</span>';
            } else {
                evilRoleKeys.forEach(function(roleKey) {
                    var roleDef = ROLE_DEFINITIONS[roleKey];
                    var count = evilRoleCounts[roleKey];
                    var item = document.createElement('div');
                    // Compact chip style
                    item.style.cssText = 'display: inline-flex; align-items: center; padding: 2px 6px; background: rgba(244, 67, 54, 0.15); border: 1px solid var(--evil-color); border-radius: 4px; font-size: 0.75rem; white-space: nowrap;';
                    item.innerHTML = '<span style="font-size: 1rem; margin-left: 4px;">' + (roleDef ? roleDef.rebus : 'โ') + '</span><span style="font-weight: bold; color: var(--evil-color);">' + (roleDef ? roleDef.name : roleKey) + '</span>' + (count > 1 ? '<span style="margin-right: 3px; font-weight: bold; opacity: 0.8;">ร' + toFarsiNum(count) + '</span>' : '');
                    evilList.appendChild(item);
                });
            }
        }

        function renderQuestBoard() {
            var config = QUEST_CONFIG[playerCount];
            var board = document.getElementById('quest-board-visual');
            board.innerHTML = '';
            
            for (var q = 1; q <= config.quests.length; q++) {
                var marker = document.createElement('div');
                marker.className = 'quest-marker';
                
                var questData = questHistory.find(h => h.quest === q);
                if (questData) {
                    marker.classList.add(questData.success ? 'completed' : 'failed');
                } else if (q === currentQuest) {
                    marker.classList.add('active');
                }
                
                // Remove quest number label for cleaner look
                
                var size = document.createElement('div');
                size.className = 'quest-size';
                // Handle Quest 3 for 4 players
                var teamSize = config.quests[q - 1];
                if (playerCount === 4 && q === 3 && quest3Size !== null) {
                    teamSize = quest3Size;
                }
                size.innerText = toFarsiNum(teamSize);
                marker.appendChild(size);
                
                if (questData) {
                    var status = document.createElement('div');
                    status.className = 'quest-status ' + (questData.success ? 'success' : 'failure');
                    status.innerText = questData.success ? 'โ' : 'โ';
                    marker.appendChild(status);
                }
                
                if (config.fails[q - 1] === 2) {
                    var failNote = document.createElement('div');
                    failNote.className = 'quest-fail-note';
                    failNote.innerText = toFarsiNum(2) + ' โ';
                    marker.appendChild(failNote);
                }
                
                // Check if this quest has an amulet
                var amuletConfig = AMULET_CONFIG[playerCount] || [];
                if (amuletConfig.indexOf(q) !== -1) {
                    var amuletMarker = document.createElement('div');
                    amuletMarker.className = 'quest-amulet-marker';
                    amuletMarker.title = 'ุฌุงู ุฌูุงูโุจู ุจุนุฏ ุงุฒ ุงู ูพฺฉุงุฑ ุฏุฑ ุฏุณุชุฑุณ ุงุณุช';
                    amuletMarker.innerText = '๐ฎ';
                    marker.appendChild(amuletMarker);
                    
                    // Check if amulet is available or has been given
                    var amulet = amulets.find(a => a.quest === q);
                    if (amulet) {
                        if (amulet.available && amulet.holder !== null) {
                            amuletMarker.classList.add('amulet-given');
                            amuletMarker.title = 'ุฌุงู ุฌูุงูโุจู ุจู ' + (amulet.holder !== null ? players[amulet.holder].name : 'ฺฉุณ') + ' ุฏุงุฏู ุดุฏ';
                        } else if (amulet.available) {
                            amuletMarker.classList.add('amulet-available');
                            amuletMarker.title = 'ุฌุงู ุฌูุงูโุจู ุฏุฑ ุฏุณุชุฑุณ';
                        }
                    }
                }
                
                board.appendChild(marker);
            }
        }

        function renderAmulets() {
            var container = document.getElementById('amulet-list');
            var explanation = document.getElementById('amulet-explanation');
            container.innerHTML = '';
            
            // Hide explanation and section if no amulets for this player count
            if (amulets.length === 0) {
                if (explanation) explanation.style.display = 'none';
                var amuletSection = document.getElementById('amulet-section');
                if (amuletSection) amuletSection.style.display = 'none';
                return;
            } else {
                // Show explanation and section if amulets exist
                if (explanation) explanation.style.display = 'block';
                var amuletSection = document.getElementById('amulet-section');
                if (amuletSection) amuletSection.style.display = 'block';
            }
            
            amulets.forEach(function(amulet, index) {
                if (amulet.available) {
                    var item = document.createElement('div');
                    item.className = 'amulet-item';
                    if (amulet.holder !== null) {
                        item.innerText = 'ูพฺฉุงุฑ ' + toFarsiNum(amulet.quest) + ' - ' + (amulet.holder !== null ? players[amulet.holder].name : 'ุฏุฑ ุฏุณุชุฑุณ');
                        if (amulet.used) item.classList.add('used');
                    } else {
                        item.innerText = 'ูพฺฉุงุฑ ' + toFarsiNum(amulet.quest) + ' - ุฏุฑ ุฏุณุชุฑุณ';
                    }
                    container.appendChild(item);
                }
            });
        }

        function startTeamSelection() {
            var config = QUEST_CONFIG[playerCount];
            var teamSize = config.quests[currentQuest - 1];
            
            // Handle Quest 3 for 4 players (can be 2 or 3)
            if (playerCount === 4 && currentQuest === 3 && quest3Size === null) {
                // Auto-select size 3 instead of asking
                setQuest3Size(3);
                return;
            }
            
            document.getElementById('phase-title').innerText = 'ฺฏุฒูุด ฺฏุฑูู';
            document.getElementById('phase-content').innerHTML = 
                '<p><strong>' + players[currentLeader].name + '</strong> ุณุฑุฏุงุฑ ุงุณุช.</p>' +
                '<p><strong>ูุฑุญูู ' + toFarsiNum(1) + ':</strong> ุณุฑุฏุงุฑ ฺฏุฑูู ุงุฒ <strong>' + toFarsiNum(teamSize) + '</strong> ุงุฑ ุจุฑุง ูพฺฉุงุฑ ' + toFarsiNum(currentQuest) + ' ุจุฑูโฺฏุฒูุฏ.</p>' +
                '<p style="font-size: 0.9rem; color: var(--text-secondary);">ฺฏุฒูุด ฺฏุฑูู ุฎูุฏ ุฑุง ุงุนูุงู ฺฉูุฏ. ฺฏุฒูุด ฺฏุฑูู ุจู ุตูุฑุช ุขููุงู ุงูุฌุงู ูโุดูุฏ - ููุท ุจู ููู ุจฺฏูุฏ ฺู ฺฉุณุงู ุฏุฑ ฺฏุฑูู ูุณุชูุฏ.</p>';
            
            var actions = document.getElementById('action-buttons');
            actions.innerHTML = '<button class="action-btn" onclick="startQuestCardSelection()">ฺฏุฑูู ุจุฑฺฏุฒุฏู ุดุฏ - ุดุฑูุน ูพฺฉุงุฑ</button>';
        }

        function setQuest3Size(size) {
            quest3Size = size;
            var config = QUEST_CONFIG[4];
            config.quests[2] = size; // Update Quest 3 size
            startTeamSelection();
        }

        function startQuestCardSelection() {
            var config = QUEST_CONFIG[playerCount];
            var teamSize = config.quests[currentQuest - 1];
            
            addLog('ุณุฑุฏุงุฑ ' + players[currentLeader].name + ' ฺฏุฑูู ุฑุง ุจุฑุง ูพฺฉุงุฑ ' + toFarsiNum(currentQuest) + ' ุจุฑฺฏุฒุฏ (ุงูุฏุงุฒู: ' + toFarsiNum(teamSize) + ')');
            addLog('ุฏุฑูุด ฺฉุงูุงู ุฑู ุงููู ุนุถู ฺฏุฑูู ฺฉู ูุดุงู ุจุฑูโฺฏุฒูุฏ ุฎูุงูุฏ ุจูุฏ.');
            
            // Magic token is automatically on the first person who selects a card
            magicTokenHolder = null; // We don't track which player, just that first selector has it
            magicTokenTeamMemberIndex = null; // Will be set to 0 when first card is selected
            
            // Directly open the quest card modal
            openQuestCardModal();
        }

        function openQuestCardModal() {
            var config = QUEST_CONFIG[playerCount];
            var teamSize = config.quests[currentQuest - 1];
            
            questCards = [];
            questCardSelectionMode = 'confirmation';
            
            var modal = document.getElementById('quest-card-modal');
            if (!modal) {
                console.error('Quest card modal not found!');
                return;
            }
            
            var revealBtn = document.getElementById('quest-reveal-btn');
            if (revealBtn) revealBtn.classList.add('hidden');
            
            // Show confirmation screen, hide selection screen
            document.getElementById('quest-card-confirmation-screen').classList.remove('hidden');
            document.getElementById('quest-card-selection-screen').classList.add('hidden');
            
            modal.classList.remove('hidden');
            showQuestCardConfirmation();
        }
        
        function showQuestCardConfirmation() {
            var config = QUEST_CONFIG[playerCount];
            var teamSize = config.quests[currentQuest - 1];
            var memberNum = questCards.length + 1;
            
            document.getElementById('quest-card-confirmation-number').innerText = toFarsiNum(memberNum);
            document.getElementById('quest-card-confirmation-total').innerText = 'ุงุฒ ' + toFarsiNum(teamSize);
        }
        
        function confirmQuestCardPlayer() {
            questCardSelectionMode = 'selection';
            
            // Hide confirmation screen, show selection screen
            document.getElementById('quest-card-confirmation-screen').classList.add('hidden');
            document.getElementById('quest-card-selection-screen').classList.remove('hidden');
            
            updateQuestCardSelection();
        }

        function updateQuestCardSelection() {
            var config = QUEST_CONFIG[playerCount];
            var teamSize = config.quests[currentQuest - 1];
            
            // Don't update if all cards are selected (handled in selectQuestCard)
            if (questCards.length >= teamSize) {
                return;
            }
            
            var memberNum = questCards.length + 1;
            document.getElementById('quest-card-player').innerText = 
                'ุนุถู ฺฏุฑูู ' + toFarsiNum(memberNum) + ' ุงุฒ ' + toFarsiNum(teamSize);
            
            // Check if this team member has magic token
            // The first person to select a card automatically has the magic token
            var hasMagic = (questCards.length === 0);
            if (hasMagic) {
                magicTokenTeamMemberIndex = 0; // First team member to select has magic token
                document.getElementById('quest-card-magic-note').innerText = 
                    'โ๏ธ ุดูุง ูพุดุงูพุดู ุณูพุงู ูุณุชุฏ ู ุฏุฑูุด ฺฉุงูุงู ุฑุง ุฏุงุฑุฏ ู ููโุชูุงูุฏ ูุฑูฺฏ ฺฉูุฏ ูฺฏุฑ ุงูฺฉู ุถุญุงฺฉ ูุงุฑุฏูุด ุจุงุดุฏ.';
            } else {
                document.getElementById('quest-card-magic-note').innerText = '';
            }
            
            // Create and randomize card buttons
            var container = document.getElementById('quest-card-buttons-container');
            container.innerHTML = '';
            
            // Create both card buttons
            var successBtn = document.createElement('button');
            successBtn.className = 'quest-card-display quest-card-success';
            successBtn.onclick = function() { selectQuestCard('success'); return false; };
            successBtn.style.cssText = 'cursor: pointer; transform: scale(1); border: none; outline: none; -webkit-tap-highlight-color: transparent; position: relative;';
            successBtn.innerHTML = '<div style="font-size: 3rem; margin-bottom: 10px; pointer-events: none;">โ</div><div style="font-size: 1.2rem; font-weight: bold; pointer-events: none;">ููุฑุงู</div>';
            successBtn.id = 'success-card-btn';
            
            var failBtn = document.createElement('button');
            failBtn.className = 'quest-card-display quest-card-fail';
            failBtn.onclick = function() { selectQuestCard('fail'); return false; };
            failBtn.style.cssText = 'cursor: pointer; transform: scale(1); border: none; outline: none; -webkit-tap-highlight-color: transparent; position: relative;';
            failBtn.innerHTML = '<div style="font-size: 3rem; margin-bottom: 10px; pointer-events: none;">โ</div><div style="font-size: 1.2rem; font-weight: bold; pointer-events: none;">ูุฑูฺฏ</div>';
            failBtn.id = 'fail-card-btn';
            
            // Randomize order: randomly decide which card appears first
            var cardOrder = Math.random() < 0.5 ? [successBtn, failBtn] : [failBtn, successBtn];
            
            // Add cards to container in random order
            cardOrder.forEach(function(btn) {
                container.appendChild(btn);
            });
            
            // Add magic token warning to fail button if needed
            if (hasMagic) {
                // Check if Youth is in the game
                var hasYouth = players.some(function(p) { return p.roleKey === 'Youth'; }) || 
                              (selectedRoles && selectedRoles.indexOf('Youth') !== -1) ||
                              (rolesOnGround && rolesOnGround.indexOf('Youth') !== -1);
                
                // Add large danger sign on Fail card
                var warningText = hasYouth ? 
                    '<div style="font-size: 4rem; margin-bottom: 10px;">โ๏ธ</div><div style="font-size: 1.1rem; font-weight: 900; text-align: center; color: white; text-shadow: 2px 2px 4px rgba(0,0,0,0.8);">ููุท<br>ุถุญุงฺฉ ูุงุฑุฏูุด<br>ุง ุฌูุงู ุฎุงู</div>' :
                    '<div style="font-size: 4rem; margin-bottom: 10px;">โ๏ธ</div><div style="font-size: 1.1rem; font-weight: 900; text-align: center; color: white; text-shadow: 2px 2px 4px rgba(0,0,0,0.8);">ููุท<br>ุถุญุงฺฉ ูุงุฑุฏูุด</div>';
                
                var warning = document.createElement('div');
                warning.className = 'magic-token-warning';
                warning.style.position = 'absolute';
                warning.style.top = '0';
                warning.style.left = '0';
                warning.style.right = '0';
                warning.style.bottom = '0';
                warning.style.background = 'rgba(244, 67, 54, 0.95)';
                warning.style.border = '4px solid #ff0000';
                warning.style.borderRadius = '12px';
                warning.style.display = 'flex';
                warning.style.flexDirection = 'column';
                warning.style.alignItems = 'center';
                warning.style.justifyContent = 'center';
                warning.style.zIndex = '10';
                warning.style.padding = '10px';
                warning.innerHTML = warningText;
                failBtn.appendChild(warning);
            }
            
            document.getElementById('quest-card-progress').innerText = 
                'ูุดุงูโูุง ุจุฑฺฏุฒุฏู ุดุฏู: ' + toFarsiNum(questCards.length) + ' / ' + toFarsiNum(teamSize);
        }

        function selectQuestCard(cardType) {
            console.log('selectQuestCard called with:', cardType);
            var config = QUEST_CONFIG[playerCount];
            var teamSize = config.quests[currentQuest - 1];
            
            if (questCards.length >= teamSize) {
                console.log('All cards already selected');
                return;
            }
            
            // Check magic token restriction
            // Only restrict if this is the team member with magic token
            var hasMagic = (magicTokenTeamMemberIndex !== null && questCards.length === magicTokenTeamMemberIndex);
            if (hasMagic && cardType === 'fail') {
                // Show warning but allow selection (don't block to avoid revealing choice)
                // Player should know the rule: only ุถุญุงฺฉ ูุงุฑุฏูุด can play Fail with magic token
                // No confirmation needed - just let them choose
            }
            
            questCards.push({
                player: 'Team Member ' + (questCards.length + 1),
                card: cardType
            });
            
            addLog('ุนุถู ฺฏุฑูู ' + toFarsiNum(questCards.length) + ' ูุดุงู ' + (cardType === 'success' ? 'ููุฑุงู' : 'ูุฑูฺฏ') + ' ุฑุง ุจุฑฺฏุฒุฏ');
            
            // Animate the selected card
            var cardBtn = cardType === 'success' ? 
                document.getElementById('success-card-btn') : 
                document.getElementById('fail-card-btn');
            if (cardBtn) {
                cardBtn.classList.add('quest-card-animate');
                cardBtn.style.pointerEvents = 'none'; // Disable during animation
                setTimeout(function() {
                    cardBtn.classList.remove('quest-card-animate');
                    cardBtn.style.pointerEvents = 'auto';
                }, 600);
            }
            
            // Check if all cards are selected BEFORE updating UI
            var allSelected = questCards.length >= teamSize;
            
            if (allSelected) {
                // Hide the card selection modal immediately
                document.getElementById('quest-card-modal').classList.add('hidden');
                // Show reveal animation after a brief delay
                setTimeout(function() {
                    revealQuestCards();
                }, 500);
            } else {
                // Reset to confirmation mode for next player
                questCardSelectionMode = 'confirmation';
                document.getElementById('quest-card-confirmation-screen').classList.remove('hidden');
                document.getElementById('quest-card-selection-screen').classList.add('hidden');
                showQuestCardConfirmation();
            }
        }

        function revealQuestCards() {
            // Leader collects and shuffles cards, then reveals
            // IMPORTANT: Shuffle cards to randomize order so players cannot identify who played which card
            shuffleArray(questCards);
            
            var successes = questCards.filter(c => c.card === 'success').length;
            var failures = questCards.filter(c => c.card === 'fail').length;
            
            document.getElementById('quest-card-modal').classList.add('hidden');
            
            // Show animated card reveal
            var container = document.getElementById('revealed-cards-container');
            container.innerHTML = '';
            
            questCards.forEach(function(card, index) {
                var cardDiv = document.createElement('div');
                cardDiv.className = 'quest-card-display ' + 
                    (card.card === 'success' ? 'quest-card-success' : 'quest-card-fail');
                cardDiv.style.animationDelay = (index * 0.15) + 's';
                cardDiv.style.width = '100px';
                cardDiv.style.height = '130px';
                cardDiv.style.margin = '5px';
                cardDiv.style.fontSize = '1.5rem';
                
                var icon = document.createElement('div');
                icon.style.fontSize = '2rem';
                icon.style.marginBottom = '5px';
                icon.innerText = card.card === 'success' ? 'โ' : 'โ';
                cardDiv.appendChild(icon);
                
                var label = document.createElement('div');
                label.style.fontSize = '0.9rem';
                label.style.fontWeight = 'bold';
                label.innerText = card.card === 'success' ? 'ููุฑุงู' : 'ูุฑูฺฏ';
                cardDiv.appendChild(label);
                
                container.appendChild(cardDiv);
            });
            
            // Show results
            var config = QUEST_CONFIG[playerCount];
            var requiredFails = config.fails[currentQuest - 1];
            var success = failures < requiredFails;
            
            var summary = document.getElementById('quest-result-summary');
            if (success) {
                summary.style.background = 'linear-gradient(135deg, rgba(76, 175, 80, 0.3) 0%, rgba(76, 175, 80, 0.1) 100%)';
                summary.style.border = '2px solid var(--good-color)';
                summary.style.color = 'var(--good-color)';
                summary.innerHTML = '<div style="font-size: 1.5rem; margin-bottom: 5px;">โ</div><div style="font-size: 0.95rem;">ูพฺฉุงุฑ ' + toFarsiNum(currentQuest) + ' ูพุฑูุฒ ุดุฏ!</div><div style="font-size: 1rem; margin-top: 8px; opacity: 0.9; font-weight: bold;">' + toFarsiNum(successes) + ' ููุฑุงูุ ' + toFarsiNum(failures) + ' ูุฑูฺฏ</div>';
                playQuestSuccess();
            } else {
                summary.style.background = 'linear-gradient(135deg, rgba(244, 67, 54, 0.3) 0%, rgba(244, 67, 54, 0.1) 100%)';
                summary.style.border = '2px solid var(--evil-color)';
                summary.style.color = 'var(--evil-color)';
                summary.innerHTML = '<div style="font-size: 1.5rem; margin-bottom: 5px;">โ</div><div style="font-size: 0.95rem;">ูพฺฉุงุฑ ' + toFarsiNum(currentQuest) + ' ุดฺฉุณุช ุฎูุฑุฏ!</div><div style="font-size: 1rem; margin-top: 8px; opacity: 0.9; font-weight: bold;">' + toFarsiNum(successes) + ' ููุฑุงูุ ' + toFarsiNum(failures) + ' ูุฑูฺฏ</div>';
                playQuestFailure();
            }
            
            document.getElementById('quest-cards-reveal-modal').classList.remove('hidden');
        }

        function closeQuestReveal() {
            document.getElementById('quest-cards-reveal-modal').classList.add('hidden');
            completeQuest();
        }


        function completeQuest() {
            var config = QUEST_CONFIG[playerCount];
            var requiredFails = config.fails[currentQuest - 1];
            var failures = questCards.filter(c => c.card === 'fail').length;
            var success = failures < requiredFails;
            
            questHistory.push({
                quest: currentQuest,
                team: config.quests[currentQuest - 1],
                success: success,
                failures: failures
            });
            
            if (success) {
                goodWins++;
                addLog('ูพฺฉุงุฑ ' + toFarsiNum(currentQuest) + ' ูพุฑูุฒ ุดุฏ!');
            } else {
                evilWins++;
                addLog('ูพฺฉุงุฑ ' + toFarsiNum(currentQuest) + ' ุดฺฉุณุช ุฎูุฑุฏ! (' + toFarsiNum(failures) + ' ูุฑูฺฏ)');
            }
            
            // Check for amulet availability
            var amuletAvailable = amulets.find(a => a.quest === currentQuest && !a.available);
            if (amuletAvailable) {
                amuletAvailable.available = true;
            }
            
            // Reset magic token
            magicTokenHolder = null;
            magicTokenTeamMemberIndex = null;
            
            updateGameDisplay();
            
            // Check win conditions
            var failThreshold = (playerCount === 4) ? 2 : 3;
            if (goodWins >= 3) {
                endGame('good', 'ุณูพุงู ูุฑุฏูู ุจุฑูุฏู ุดุฏ! ' + toFarsiNum(3) + ' ูพฺฉุงุฑ ุจุง ูพุฑูุฒ ุชฺฉูู ุดุฏ.');
                return;
            }
            if (evilWins >= failThreshold) {
                startFinalQuest();
                return;
            }
            
            // Transition phase: Select next leader and handle amulets
            startTransitionPhase();
        }

        function startTransitionPhase() {
            document.getElementById('phase-title').innerText = 'ูุงุฒ ุงูุชูุงู';
            document.getElementById('phase-content').innerHTML = 
                '<p><strong>ูุฑุญูู ' + toFarsiNum(3) + ':</strong> ุณุฑุฏุงุฑ ูุนู ุณุฑุฏุงุฑ ุจุนุฏ ุฑุง ุจุฑูโฺฏุฒูุฏ.</p>' +
                '<p style="font-size: 0.9rem; color: var(--text-secondary);">ุณุฑุฏุงุฑ ุจุนุฏ ููโุชูุงูุฏ ฺฉุณ ุจุงุดุฏ ฺฉู ูุจูุงู ุณุฑุฏุงุฑ ุจูุฏู (ฺฉูููโุณุฑุจุงุฒ) ุง ุฌุงู ุฌูุงูโุจู ุฏุงุฑุฏ.</p>';
            
            var actions = document.getElementById('action-buttons');
            actions.innerHTML = '<button class="action-btn" onclick="openLeaderSelection()">ฺฏุฒูุด ุณุฑุฏุงุฑ ุจุนุฏ</button>';
        }

        function openLeaderSelection() {
            document.getElementById('current-leader-select-name').innerText = players[currentLeader].name;
            var list = document.getElementById('leader-select-list');
            list.innerHTML = '';
            
            players.forEach(function(player, index) {
                // Cannot select: current leader, veterans, amulet holders
                if (index === currentLeader || veterans.indexOf(index) !== -1 || amuletHolders.indexOf(index) !== -1) {
                    return;
                }
                
                var btn = document.createElement('button');
                btn.className = 'player-select-btn';
                btn.innerText = player.name;
                btn.onclick = function() { selectNextLeader(index); };
                list.appendChild(btn);
            });
            
            document.getElementById('leader-select-modal').classList.remove('hidden');
        }

        function selectNextLeader(playerIndex) {
            veterans.push(currentLeader); // Current leader becomes veteran
            currentLeader = playerIndex;
            veterans.push(currentLeader); // New leader gets veteran token
            addLog('ุณุฑุฏุงุฑ ุฌุฏุฏ: ' + players[currentLeader].name);
            
            document.getElementById('leader-select-modal').classList.add('hidden');
            
            // Check for amulet
            var amuletAvailable = amulets.find(a => a.quest === currentQuest && a.available && a.holder === null);
            if (amuletAvailable) {
                openAmuletSelection(amuletAvailable);
            } else {
                nextQuest();
            }
        }

        function openAmuletSelection(amulet) {
            document.getElementById('amulet-quest-num').innerText = amulet.quest;
            var list = document.getElementById('amulet-select-list');
            list.innerHTML = '';
            
            players.forEach(function(player, index) {
                // Cannot select: new leader, veterans, amulet holders, already checked
                if (index === currentLeader || veterans.indexOf(index) !== -1 || 
                    amuletHolders.indexOf(index) !== -1 || checkedByAmulet.indexOf(index) !== -1) {
                    return;
                }
                
                var btn = document.createElement('button');
                btn.className = 'player-select-btn';
                btn.innerText = player.name;
                btn.onclick = function() { selectAmuletHolder(amulet, index); };
                list.appendChild(btn);
            });
            
            document.getElementById('amulet-select-modal').classList.remove('hidden');
        }

        function selectAmuletHolder(amulet, playerIndex) {
            amulet.holder = playerIndex;
            amuletHolders.push(playerIndex);
            addLog(players[playerIndex].name + ' ุจุนุฏ ุงุฒ ูพฺฉุงุฑ ' + toFarsiNum(amulet.quest) + ' ุฌุงู ุฌูุงูโุจู ุฏุฑุงูุช ฺฉุฑุฏ');
            
            document.getElementById('amulet-select-modal').classList.add('hidden');
            openAmuletCheck(amulet, playerIndex);
        }

        function skipAmulet() {
            document.getElementById('amulet-select-modal').classList.add('hidden');
            nextQuest();
        }

        function openAmuletCheck(amulet, holderIndex) {
            document.getElementById('amulet-holder-name').innerText = players[holderIndex].name + ' ุงุฒ ุฌุงู ุฌูุงูโุจู ุงุณุชูุงุฏู ูโฺฉูุฏ';
            var list = document.getElementById('amulet-check-list');
            list.innerHTML = '';
            
            players.forEach(function(player, index) {
                // Cannot check: amulet holder, already checked, amulet holders
                if (index === holderIndex || checkedByAmulet.indexOf(index) !== -1 || 
                    amuletHolders.indexOf(index) !== -1) {
                    return;
                }
                
                var btn = document.createElement('button');
                btn.className = 'player-select-btn';
                btn.innerText = player.name;
                btn.onclick = function() { performAmuletCheck(amulet, index); };
                list.appendChild(btn);
            });
            
            document.getElementById('amulet-check-modal').classList.remove('hidden');
        }

        function performAmuletCheck(amulet, checkedIndex) {
            checkedByAmulet.push(checkedIndex);
            amulet.used = true;
            
            var checkedPlayer = players[checkedIndex];
            // Troublemaker always shows as Evil when checked
            var isTroublemaker = checkedPlayer.roleKey === 'Troublemaker';
            var actualAlignment = checkedPlayer.alignment;
            var displayedAlignment = isTroublemaker ? 'evil' : actualAlignment;
            
            addLog(players[amulet.holder].name + ' ุจุง ุฌุงู ุฌูุงูโุจู ' + checkedPlayer.name + ' ุฑุง ุจุฑุฑุณ ฺฉุฑุฏ');
            
            // Show result to amulet holder
            document.getElementById('amulet-check-modal').classList.add('hidden');
            
            var resultModal = document.getElementById('amulet-result-modal');
            var resultText = document.getElementById('amulet-result-text');
            var checkedName = document.getElementById('amulet-checked-name');
            
            checkedName.innerText = checkedPlayer.name;
            if (displayedAlignment === 'good') {
                resultText.innerHTML = '<div style="font-size: 2rem; margin-bottom: 10px;">๐ก๏ธ</div><div style="font-size: 1.3rem; font-weight: bold; color: var(--good-color);">ุฎูุจ</div>';
                resultText.style.color = 'var(--good-color)';
            } else {
                resultText.innerHTML = '<div style="font-size: 2rem; margin-bottom: 10px;">โ๏ธ</div><div style="font-size: 1.3rem; font-weight: bold; color: var(--evil-color);">ุจุฏ</div>';
                resultText.style.color = 'var(--evil-color)';
            }
            
            resultModal.classList.remove('hidden');
        }
        
        function closeAmuletResult() {
            document.getElementById('amulet-result-modal').classList.add('hidden');
            nextQuest();
        }

        function nextQuest() {
            currentQuest++;
            var config = QUEST_CONFIG[playerCount];
            
            if (currentQuest > config.quests.length) {
                // All quests completed
                if (goodWins > evilWins) {
                    endGame('good', 'ุณูพุงู ูุฑุฏูู ุจุฑูุฏู ุดุฏ! ูพฺฉุงุฑโูุง ูพุฑูุฒ ุจุดุชุฑ ุชฺฉูู ุดุฏ.');
                } else {
                    endGame('evil', 'ุจุฏ ุจุฑูุฏู ุดุฏ! ูพฺฉุงุฑโูุง ุจุดุชุฑ ุดฺฉุณุช ุฎูุฑุฏ.');
                }
                return;
            }
            
            updateGameDisplay();
            startTeamSelection();
        }

        function startFinalQuest() {
            var failThreshold = (playerCount === 4) ? 2 : 3;
            
            // Step 1: Show Discussion Phase
            showDiscussionPhase();
        }
        
        var discussionTimer = null;
        var discussionTimeLeft = 300; // 5 minutes in seconds
        var discussionTimerInterval = null;
        
        function showDiscussionPhase() {
            var failThreshold = (playerCount === 4) ? 2 : 3;
            
            // Hide UI elements for cleaner discussion view
            var gameStatus = document.querySelector('.game-status');
            if (gameStatus) gameStatus.style.display = 'none';
            var questBoard = document.getElementById('quest-board-visual');
            if (questBoard) questBoard.style.display = 'none';
            var leaderDisplays = document.querySelectorAll('.leader-display');
            for (var i = 0; i < leaderDisplays.length; i++) {
                leaderDisplays[i].style.display = 'none';
            }
            var amuletSection = document.getElementById('amulet-section');
            if (amuletSection) amuletSection.style.display = 'none';
            var logBtn = document.querySelector('button[onclick="toggleLog()"]');
            if (logBtn) logBtn.style.display = 'none';
            var gameLog = document.getElementById('game-log');
            if (gameLog) gameLog.classList.add('hidden');
            
            // Show phase display
            var phaseDisplay = document.getElementById('phase-display');
            if (phaseDisplay) phaseDisplay.style.display = 'block';
            
            // Reset timer to 5 minutes
            discussionTimeLeft = 300;
            
            // Check if Blind Hunter is in the game
            var hasBlindHunter = players.some(function(p) { return p.roleKey === 'Blind Hunter'; });
            
            // Check if there are special good roles (Cleric, Troublemaker, Duke, Archduke, Youth)
            var specialGoodRoles = ['Cleric', 'Troublemaker', 'Duke', 'Archduke', 'Youth'];
            var hasSpecialGoodRoles = players.some(function(p) {
                return p.alignment === 'good' && specialGoodRoles.indexOf(p.roleKey) !== -1;
            });
            
            var warningHtml = '';
            if (hasBlindHunter && hasSpecialGoodRoles) {
                warningHtml = '<div style="background: rgba(255, 87, 34, 0.3); border: 3px solid #FF5722; border-radius: 8px; padding: 15px; margin: 15px 0;">' +
                    '<p style="font-size: 1.2rem; font-weight: 900; color: #FF5722; margin-bottom: 10px; text-align: center;">โ๏ธ ูุดุฏุงุฑ ููู โ๏ธ</p>' +
                    '<p style="font-size: 1.1rem; font-weight: bold; color: #FF5722; margin: 10px 0; text-align: center;">ููุดโูุง ุฎูุฏ ุฑุง ูุงุด ูฺฉูุฏ!</p>' +
                    '<p style="margin: 10px 0; font-weight: bold;">ููุงุจโุฏุงุฑ ุฏุฑ ุจุงุฒ ุงุณุช ู ูโุชูุงูุฏ ุฏุฑ ุดฺฉุงุฑ ููุดโูุง ุฎุงุต ุฎูุจ ุฑุง ุดูุงุณุง ฺฉูุฏ.</p>' +
                    '<p style="margin: 10px 0;">ุงฺฏุฑ ููุดโูุง ุฎูุฏ ุฑุง (ููุจุฏุ ุณุงูุดุ ฺฉุงููุ ุฑุณุชูุ ุฌูุงู ุฎุงู) ูุงุด ฺฉูุฏุ ููุงุจโุฏุงุฑ ูโุชูุงูุฏ ุดูุง ุฑุง ุดูุงุณุง ฺฉูุฏ ู ุจุฏ ุจุฑูุฏู ูโุดูุฏ!</p>' +
                    '</div>';
            }
            
            var timerHtml = '<div style="background: rgba(33, 150, 243, 0.2); border: 2px solid var(--accent-color); border-radius: 8px; padding: 20px; margin: 20px 0; text-align: center;">' +
                '<p style="font-size: 1.1rem; font-weight: bold; margin-bottom: 15px;">โฑ๏ธ ุชุงูุฑ ุจุญุซ</p>' +
                '<div style="font-size: 3rem; font-weight: bold; color: var(--accent-color); margin: 15px 0; font-family: monospace;" id="discussion-timer-display">' + formatTime(discussionTimeLeft) + '</div>' +
                '<div style="display: flex; gap: 10px; justify-content: center; align-items: center; margin: 15px 0; flex-wrap: wrap;">' +
                '<button onclick="adjustDiscussionTime(-60)" style="padding: 8px 15px; font-size: 1rem; background: rgba(255,255,255,0.1); border: 1px solid var(--accent-color); border-radius: 5px; color: white; cursor: pointer;">-1 ุฏููู</button>' +
                '<button onclick="adjustDiscussionTime(-30)" style="padding: 8px 15px; font-size: 1rem; background: rgba(255,255,255,0.1); border: 1px solid var(--accent-color); border-radius: 5px; color: white; cursor: pointer;">-30 ุซุงูู</button>' +
                '<button onclick="toggleDiscussionTimer()" id="discussion-timer-btn" style="padding: 10px 20px; font-size: 1.1rem; font-weight: bold; background: var(--accent-color); border: none; border-radius: 5px; color: white; cursor: pointer;">ุดุฑูุน</button>' +
                '<button onclick="adjustDiscussionTime(30)" style="padding: 8px 15px; font-size: 1rem; background: rgba(255,255,255,0.1); border: 1px solid var(--accent-color); border-radius: 5px; color: white; cursor: pointer;">+30 ุซุงูู</button>' +
                '<button onclick="adjustDiscussionTime(60)" style="padding: 8px 15px; font-size: 1rem; background: rgba(255,255,255,0.1); border: 1px solid var(--accent-color); border-radius: 5px; color: white; cursor: pointer;">+1 ุฏููู</button>' +
                '</div>' +
                '<button onclick="resetDiscussionTimer()" style="padding: 8px 15px; font-size: 0.9rem; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.3); border-radius: 5px; color: var(--text-secondary); cursor: pointer; margin-top: 10px;">ุจุงุฒูุดุงู ุจู 5 ุฏููู</button>' +
                '</div>';
            
            var phaseTitle = document.getElementById('phase-title');
            var phaseContent = document.getElementById('phase-content');
            var actions = document.getElementById('action-buttons');
            
            if (!phaseTitle || !phaseContent || !actions) {
                console.error('Required elements not found for discussion phase');
                return;
            }
            
            phaseTitle.innerText = 'ูุงุฒ ุจุญุซ - ูุงูพุณู ูพฺฉุงุฑ';
            phaseContent.innerHTML = 
                '<div style="background: rgba(244, 67, 54, 0.2); border: 2px solid var(--evil-color); border-radius: 8px; padding: 15px; margin: 15px 0;">' +
                '<p style="font-size: 1.2rem; font-weight: bold; color: var(--evil-color); margin-bottom: 10px;">' + toFarsiNum(failThreshold) + ' ูพฺฉุงุฑ ุดฺฉุณุช ุฎูุฑุฏ!</p>' +
                '<div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 6px; margin: 15px 0; border-right: 4px solid var(--evil-color);">' +
                '<p style="font-weight: bold; color: var(--evil-color); margin-bottom: 10px;">๐ ุฑูุงุช ูุงูพุณู ูพฺฉุงุฑ:</p>' +
                '<p style="text-align: right; line-height: 1.8; font-size: 0.95rem; margin: 8px 0;">ุณู ูพฺฉุงุฑ ุจู ูุงฺฉุงู ุงูุฌุงูุฏ. ุชุงุฑฺฉ ุจุฑ ูุฏุงู ูุจุฑุฏ ฺุฑู ุดุฏู ู ูุดฺฉุฑ ุถุญูุงฺฉ ูุงุฑุฏูุด ุฏุฑ ุขุณุชุงููู ูพุฑูุฒ ุงุณุช. ุงูุง ูููุฒ ุงูุฏ ูุณุช!</p>' +
                '</div>' +
                warningHtml +
                '<p style="margin: 15px 0; font-size: 1.1rem; font-weight: bold;">ูุงุฒ ุจุญุซ:</p>' +
                '<p style="margin: 10px 0; font-size: 0.95rem; color: var(--text-secondary);">ุฒูุงู ุจุฑุง ุจุญุซ ุฏุฑุจุงุฑู ุงูฺฉู ฺู ฺฉุณุงู ูุดฺฉุฑ ุถุญุงฺฉ ูุณุชูุฏ. ููุช ุชุงูุฑ ุชูุงู ุดุฏุ ููู ฺฏูุชฺฏู ุจุงุฏ ูุชููู ุดูุฏ.</p>' +
                '</div>' +
                timerHtml;
            
            actions.innerHTML = '<button class="action-btn" onclick="stopDiscussionTimer(); showBlindHunterDecision()">ุจุญุซ ุชูุงู ุดุฏ - ุงุฏุงูู</button>';
            
            // Auto-start the timer
            setTimeout(function() {
                if (!discussionTimerInterval && discussionTimeLeft > 0) {
                    toggleDiscussionTimer();
                }
            }, 100);
        }
        
        function formatTime(seconds) {
            var mins = Math.floor(seconds / 60);
            var secs = seconds % 60;
            return (mins < 10 ? '0' : '') + mins + ':' + (secs < 10 ? '0' : '') + secs;
        }
        
        function adjustDiscussionTime(change) {
            discussionTimeLeft = Math.max(0, Math.min(3600, discussionTimeLeft + change)); // Clamp between 0 and 60 minutes
            var display = document.getElementById('discussion-timer-display');
            if (display) {
                display.textContent = formatTime(discussionTimeLeft);
                // Update color based on remaining time
                if (discussionTimeLeft > 30) {
                    display.style.color = 'var(--accent-color)';
                } else if (discussionTimeLeft > 0) {
                    display.style.color = 'var(--evil-color)';
                }
            }
        }
        
        function resetDiscussionTimer() {
            stopDiscussionTimer();
            discussionTimeLeft = 300;
            var display = document.getElementById('discussion-timer-display');
            display.textContent = formatTime(discussionTimeLeft);
            display.style.color = 'var(--accent-color)';
            document.getElementById('discussion-timer-btn').textContent = 'ุดุฑูุน';
        }
        
        function toggleDiscussionTimer() {
            if (discussionTimerInterval) {
                // Pause
                clearInterval(discussionTimerInterval);
                discussionTimerInterval = null;
                document.getElementById('discussion-timer-btn').textContent = 'ุดุฑูุน';
            } else {
                // Start
                if (discussionTimeLeft <= 0) {
                    discussionTimeLeft = 300;
                }
                document.getElementById('discussion-timer-btn').textContent = 'ุชููู';
                discussionTimerInterval = setInterval(function() {
                    discussionTimeLeft--;
                    document.getElementById('discussion-timer-display').textContent = formatTime(discussionTimeLeft);
                    
                    if (discussionTimeLeft <= 0) {
                        stopDiscussionTimer();
                        alert('โฐ ุฒูุงู ุจุญุซ ุชูุงู ุดุฏ! ููู ฺฏูุชฺฏู ุจุงุฏ ูุชููู ุดูุฏ.');
                    } else if (discussionTimeLeft <= 30) {
                        // Change color to red when less than 30 seconds
                        document.getElementById('discussion-timer-display').style.color = 'var(--evil-color)';
                    }
                }, 1000);
            }
        }
        
        function stopDiscussionTimer() {
            if (discussionTimerInterval) {
                clearInterval(discussionTimerInterval);
                discussionTimerInterval = null;
            }
            var btn = document.getElementById('discussion-timer-btn');
            if (btn) btn.textContent = 'ุดุฑูุน';
        }
        
        function showBlindHunterDecision() {
            // Check if Blind Hunter is in the game
            var hasBlindHunter = players.some(function(p) { return p.roleKey === 'Blind Hunter'; });
            
            // Check if there are special good roles (Cleric, Troublemaker, Duke, Archduke, Youth)
            var specialGoodRoles = ['Cleric', 'Troublemaker', 'Duke', 'Archduke', 'Youth'];
            var hasSpecialGoodRoles = players.some(function(p) {
                return p.alignment === 'good' && specialGoodRoles.indexOf(p.roleKey) !== -1;
            });
            
            // Skip Blind Hunter decision if Blind Hunter is not in game or no special good roles
            if (!hasBlindHunter || !hasSpecialGoodRoles) {
                showGoodsLastChance();
                return;
            }
            
            // Keep UI elements hidden for cleaner view
            document.getElementById('phase-title').innerText = 'ุชุตูู ููุงุจโุฏุงุฑ';
            document.getElementById('phase-content').innerHTML = 
                '<div style="background: rgba(255, 152, 0, 0.2); border: 2px solid var(--quest-color); border-radius: 8px; padding: 15px; margin: 15px 0;">' +
                '<p style="margin: 10px 0; font-size: 1.1rem; font-weight: bold;">ุณุฑุฏุงุฑ ููุง ูโูพุฑุณุฏ:</p>' +
                '<p style="margin: 15px 0; padding: 15px; background: rgba(0,0,0,0.3); border-radius: 6px; font-size: 1.1rem; font-weight: bold; color: var(--accent-color);">"ููุงุจโุฏุงุฑุ ุงฺฏุฑ ูโุฎูุงูุฏ ุณูพุงู ูุฑุฏูู ุฑุง ุงุฒ ูุงูพุณู ูุฑุตุชุดุงู ุจุงุฒุฏุงุฑุฏุ ูโุชูุงูุฏ ูุงุฑุฏ ุดฺฉุงุฑ ุดูุฏ. ุงูุง ุจุงุฏ ุฏุฑุณุช ุดูุงุณุง ฺฉูุฏุ ูฺฏุฑูู ุขูโูุง ุจุฑูุฏู ูโุดููุฏ."</p>' +
                '<p style="margin: 10px 0; color: var(--text-secondary);">ุงฺฏุฑ ููุงุจโุฏุงุฑ ุณุงฺฉุช ุจูุงูุฏุ ุจู ูุงูพุณู ูพฺฉุงุฑ (ูุงูพุณู ูุฑุตุช ุฎูุจ) ูโุฑูู.</p>' +
                '</div>';
            
            var actions = document.getElementById('action-buttons');
            actions.innerHTML = 
                '<button class="action-btn" onclick="showBlindHunterHuntInstructions()" style="background: var(--evil-color);">ููุงุจโุฏุงุฑ ุดฺฉุงุฑ ูโฺฉูุฏ</button>' +
                '<button class="secondary-btn" onclick="showGoodsLastChance()" style="margin-top: 10px;">ููุงุจโุฏุงุฑ ุณุงฺฉุช ูุงูุฏ - ูุงูพุณู ูพฺฉุงุฑ</button>';
        }
        
        function showGoodsLastChance() {
            // Update main screen with Good's Last Chance instructions
            document.getElementById('phase-title').innerText = 'ูุงูพุณู ูพฺฉุงุฑ';
            document.getElementById('phase-content').innerHTML = 
                '<div style="background: rgba(76, 175, 80, 0.2); border: 2px solid var(--good-color); border-radius: 8px; padding: 15px; margin: 15px 0;">' +
                '<div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 6px; margin: 15px 0; border-right: 4px solid var(--good-color);">' +
                '<p style="font-weight: bold; color: var(--good-color); margin-bottom: 10px;">๐ ุฑูุงุช ูุงูพุณู ูพฺฉุงุฑ:</p>' +
                '<p style="text-align: right; line-height: 1.8; font-size: 0.95rem; margin: 8px 0;">ุงฺฉููู ุฒูุงูู ูุงูพุณู ูุจุฑุฏ ูุฑุง ุฑุณุฏู ุงุณุช. ุงุฑุงู ุณูพุงู ูุฑุฏูู ุจุงุฏ ฺฉโุจุงุฑ ู ุจุฑุง ููุดู ุฎุงุฆูุงู ุฑุง ุดูุงุณุง ฺฉููุฏ. ุงู ุขุฎุฑู ูุฑุตุช ุงุณุช โ ุงฺฏุฑ ุฏุฑ ุงู ูพฺฉุงุฑ ูุฒ ุดฺฉุณุช ุจุฎูุฑูุฏุ ุชุงุฑฺฉ ุจุฑ ุณุฑุฒูู ฺุฑู ุฎูุงูุฏ ุดุฏ ู ุถุญูุงฺฉ ูุงุฑุฏูุด ุจุฑุง ููุดู ุจุฑ ุชุฎุช ุฎูุงูุฏ ูุดุณุช.</p>' +
                '<p style="text-align: right; line-height: 1.8; font-size: 0.95rem; margin: 8px 0;">ููู ุงุฑุงู ุจุงุฏ ุขูุงุฏู ุดููุฏ. ุฏุฑ ุงู ูุญุธูู ุณุฑููุดุชโุณุงุฒุ ุญููุช ุจุงุฏ ุขุดฺฉุงุฑ ุดูุฏ.</p>' +
                '</div>' +
                '<p style="font-size: 1.1rem; font-weight: bold; color: var(--good-color); margin-bottom: 15px;">ุฏุณุชูุฑุงูุนูู ูุงูพุณู ูพฺฉุงุฑ:</p>' +
                '<ol style="text-align: right; margin: 10px 0; padding-right: 20px; direction: rtl;">' +
                '<li style="margin: 8px 0;">ูุฑ ุงุฑ ุขูุงุฏู ุงุชูุงู ูโุดูุฏุ ุงูุง <strong>ุฏฺฏุฑ ุจุญุซ ุงูุฌุงู ููโุดูุฏ</strong>.</li>' +
                '<li style="margin: 8px 0;">ุฏุฑ ุดูุงุฑุด ' + toFarsiNum(3) + 'ุ ูุฑ ุงุฑ ุจู <strong>' + toFarsiNum(2) + ' ุงุฑ ุงุดุงุฑู ูโฺฉูุฏ</strong>.</li>' +
                '<li style="margin: 8px 0;">ุฏุณุชโูุง ุฎูุฏ ุฑุง ุฏุฑ ููุง ูฺฏู ุฏุงุฑุฏุ ุณูพุณ ุงุนูุงู ฺฉูุฏ: <strong>"ูุดฺฉุฑ ุถุญุงฺฉุ ุฏุณุชโูุง ุฎูุฏ ุฑุง ูพุงู ุจุงูุฑุฏ."</strong></li>' +
                '<li style="margin: 8px 0;">ุฏุฑ ุงู ูุฑุญููุ <strong>ููุท ุงุฑุงู ุณูพุงู ูุฑุฏูู ุจุงุฏ ุงุดุงุฑู ฺฉููุฏ</strong>.</li>' +
                '</ol>' +
                '<p style="margin-top: 15px; padding: 10px; background: rgba(76, 175, 80, 0.3); border-radius: 6px;"><strong>ุดุฑุท ุจุฑุฏ:</strong> ุงฺฏุฑ ุงุฑุงู ุณูพุงู ูุฑุฏูู ุจู <strong>ููู ุงุฑุงู ูุดฺฉุฑ ุถุญุงฺฉ</strong> ู <strong>ููุท ุงุฑุงู ูุดฺฉุฑ ุถุญุงฺฉ</strong> ุงุดุงุฑู ฺฉููุฏุ ุณูพุงู ูุฑุฏูู ุจุฑูุฏู ูโุดูุฏ!</p>' +
                '<p style="margin-top: 10px; padding: 10px; background: rgba(255, 152, 0, 0.3); border-radius: 6px; font-size: 0.9rem;"><strong>ูุงููู ูฺู:</strong> ุงฺฏุฑ ููู ุณุฑุฏุงุฑุงู ูุดฺฉุฑ ุถุญุงฺฉ ุจูุฏูุฏุ ุณูพุงู ูุฑุฏูู ุจู ุทูุฑ ุฎูุฏฺฉุงุฑ ุจุฑูุฏู ูโุดูุฏ.</p>' +
                '</div>';
            
            var actions = document.getElementById('action-buttons');
            actions.innerHTML = 
                '<button class="action-btn" onclick="resolveGoodsLastChance()">ุญู ูุงูพุณู ูพฺฉุงุฑ</button>';
        }
        
        function resolveGoodsLastChance() {
            // Check special rule: all leaders were evil
            var allLeadersEvil = veterans.every(function(idx) {
                return players[idx].alignment === 'evil';
            });
            
            if (allLeadersEvil) {
                endGame('good', 'ุณูพุงู ูุฑุฏูู ุจุฑูุฏู ุดุฏ! ููู ุณุฑุฏุงุฑุงู ูุดฺฉุฑ ุถุญุงฺฉ ุจูุฏูุฏ (ูุงููู ูฺู).');
                return;
            }
            
            // Show resolution screen
            document.getElementById('phase-title').innerText = 'ุญู ูุงูพุณู ูพฺฉุงุฑ';
            document.getElementById('phase-content').innerHTML = 
                '<p style="margin: 15px 0;">ุจุนุฏ ุงุฒ ุงูฺฉู ุงุฑุงู ุงุดุงุฑู ฺฉุฑุฏูุฏ ู ูุดฺฉุฑ ุถุญุงฺฉ ุฏุณุชโูุง ุฎูุฏ ุฑุง ูพุงู ุขูุฑุฏูุฏ:</p>' +
                '<p style="color: var(--text-secondary); margin: 15px 0;">ุขุง ุงุฑุงู ุณูพุงู ูุฑุฏูู ุจู ููู ุงุฑุงู ูุดฺฉุฑ ุถุญุงฺฉ ู ููุท ุงุฑุงู ูุดฺฉุฑ ุถุญุงฺฉ ุงุดุงุฑู ฺฉุฑุฏูุฏุ</p>';
            
            var actions = document.getElementById('action-buttons');
            actions.innerHTML = 
                '<button class="action-btn" onclick="endGame(\'good\', \'ุณูพุงู ูุฑุฏูู ุจุฑูุฏู ุดุฏ! ูุงูพุณู ูพฺฉุงุฑ ูพุฑูุฒ ุดุฏ - ููู ุงุฑุงู ูุดฺฉุฑ ุถุญุงฺฉ ุจู ุฏุฑุณุช ุดูุงุณุง ุดุฏูุฏ.\')" style="background: var(--good-color);">ุณูพุงู ูุฑุฏูู ุจุฑูุฏู ุดุฏ</button>' +
                '<button class="action-btn" onclick="endGame(\'evil\', \'ูุดฺฉุฑ ุถุญุงฺฉ ุจุฑูุฏู ุดุฏ! ูุงูพุณู ูพฺฉุงุฑ ุดฺฉุณุช ุฎูุฑุฏ - ููู ุงุฑุงู ูุดฺฉุฑ ุถุญุงฺฉ ุจู ุฏุฑุณุช ุดูุงุณุง ูุดุฏูุฏ.\')" style="background: var(--evil-color); margin-top: 10px;">ูุดฺฉุฑ ุถุญุงฺฉ ุจุฑูุฏู ุดุฏ</button>';
        }

        function showBlindHunterHuntInstructions() {
            // Update main screen with detailed Blind Hunter hunt instructions
            document.getElementById('phase-title').innerText = 'ุดฺฉุงุฑ ููุงุจโุฏุงุฑ';
            document.getElementById('phase-content').innerHTML = 
                '<div style="background: rgba(244, 67, 54, 0.2); border: 2px solid var(--evil-color); border-radius: 8px; padding: 15px; margin: 15px 0;">' +
                '<div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 6px; margin: 15px 0; border-right: 4px solid var(--evil-color);">' +
                '<p style="font-weight: bold; color: var(--evil-color); margin-bottom: 10px;">๐ ุฑูุงุช ุดฺฉุงุฑ:</p>' +
                '<p style="text-align: right; line-height: 1.8; font-size: 0.95rem; margin: 8px 0;">ููุงุจโุฏุงุฑุ ุดฺฉุงุฑฺ ุชุงุฑฺฉุ ุฎูุฏ ุฑุง ุขุดฺฉุงุฑ ฺฉุฑุฏู ุงุณุช. ุงฺฉููู ุฒูุงูู ุดฺฉุงุฑ ูุฑุง ุฑุณุฏู. ุงฺฏุฑ ุจุชูุงูุฏ ุฏู ูุฏู ุฎูุจ ุฑุง ุดูุงุณุง ฺฉูุฏ โ ุงุฒ ุฌููู ููุจุฏุ ูฺฏูุจุงูู ููุฑ โ ุชุงุฑฺฉ ุจุฑ ุฑูุดูุง ฺุฑู ุฎูุงูุฏ ุดุฏ ู ุถุญูุงฺฉ ูุงุฑุฏูุด ูพุฑูุฒ ุฎูุงูุฏ ฺฏุดุช.</p>' +
                '<p style="text-align: right; line-height: 1.8; font-size: 0.95rem; margin: 8px 0;">ุงูุง ุงฺฏุฑ ุฏุฑ ุดูุงุณุง ุงุดุชุจุงู ฺฉูุฏุ ููุฑ ุจุฑ ุชุงุฑฺฉ ูพุฑูุฒ ุฎูุงูุฏ ุดุฏ ู ูุฑุฏูู ุชุงุฌ ุดุงู ุฑุง ุจุฑ ุณุฑ ุฎูุงูุฏ ููุงุฏ.</p>' +
                '</div>' +
                '<p style="font-size: 1.1rem; font-weight: bold; color: var(--evil-color); margin-bottom: 15px;">ุฏุณุชูุฑุงูุนูู ุดฺฉุงุฑ ููุงุจโุฏุงุฑ:</p>' +
                '<ol style="text-align: right; margin: 10px 0; padding-right: 20px; direction: rtl;">' +
                '<li style="margin: 8px 0;">ููุงุจโุฏุงุฑ ุฎูุฏ ุฑุง ูุดุงู ูโุฏูุฏ ู ูโฺฏูุฏ ฺฉู ููุงุจโุฏุงุฑ ุงุณุช.</li>' +
                '<li style="margin: 8px 0;">ููุงุจโุฏุงุฑ ุจุงุฏ <strong>' + toFarsiNum(2) + ' ูุฏู ุฎูุจ</strong> ุฑุง ุจุง <strong>ููุด</strong> ุดูุงุณุง ฺฉูุฏ.</li>' +
                '<li style="margin: 8px 0;"><strong>ุจุงุฏ ููุจุฏ ุฑุง ุจู ุนููุงู ฺฉ ุงุฒ ุงูุฏุงู ุดูุงุณุง ฺฉูุฏ</strong> (ุงูุฒุงู ุงุณุช).</li>' +
                '<li style="margin: 8px 0;">ุงูุฏุงู ูโุชูุงููุฏ ูุฑ ุงุฑ ุจุงุดูุฏ (ุง ูุดุงู ุฑู ุจู ูพุงู ุฏุฑ ุจุงุฒ ' + toFarsiNum(4) + '-' + toFarsiNum(5) + ' ููุฑู).</li>' +
                '<li style="margin: 8px 0;">ุจุฑุง ุงูุฏุงูุ ฺฉุงูู ุขููฺฏุฑ ู ุฑุณุชู ุฏุณุชุงู ูโุชูุงููุฏ ุจู ุนููุงู "ุณุฑุจุงุฒ" ุดูุงุณุง ุดููุฏ.</li>' +
                '<li style="margin: 8px 0;">ูฺ ุงุฑ (ุจู ุฌุฒ ููุงุจโุฏุงุฑ) ููโุชูุงูุฏ ุฏุฑ ุทูู ุดฺฉุงุฑ ุตุญุจุช ฺฉูุฏ.</li>' +
                '</ol>' +
                '<p style="margin-top: 15px; padding: 10px; background: rgba(244, 67, 54, 0.3); border-radius: 6px;"><strong>ุดุฑุท ุจุฑุฏ:</strong> ุงฺฏุฑ ููุงุจโุฏุงุฑ ูุฑ ุฏู ูุฏู ุฑุง ุจู ุฏุฑุณุช ุดูุงุณุง ฺฉูุฏ (ุดุงูู ููุจุฏ)ุ <strong>ุจุฏ ุจุฑูุฏู ูโุดูุฏ</strong>!</p>' +
                '<p style="margin-top: 10px; padding: 10px; background: rgba(76, 175, 80, 0.3); border-radius: 6px;"><strong>ุฏุฑ ุบุฑ ุงู ุตูุฑุช:</strong> ุงฺฏุฑ ููุงุจโุฏุงุฑ ุงุดุชุจุงู ฺฉูุฏุ <strong>ุฎูุจ ุจุฑูุฏู ูโุดูุฏ</strong>!</p>' +
                '</div>' +
                '<p style="margin: 15px 0; color: var(--text-secondary);">ุจุนุฏ ุงุฒ ุงูฺฉู ููุงุจโุฏุงุฑ ุงูุฏุงู ุฎูุฏ ุฑุง ุดูุงุณุง ฺฉุฑุฏ:</p>';
            
            var actions = document.getElementById('action-buttons');
            actions.innerHTML = 
                '<button class="action-btn" onclick="blindHunterHunt()">ููุงุจโุฏุงุฑ ุงูุฏุงู ุฑุง ุดูุงุณุง ฺฉุฑุฏ</button>';
        }
        
        function blindHunterHunt() {
            // Show resolution screen
            document.getElementById('phase-title').innerText = 'ูุชุฌู ุดฺฉุงุฑ ููุงุจโุฏุงุฑ';
            document.getElementById('phase-content').innerHTML = 
                '<p style="margin: 15px 0;">ุขุง ููุงุจโุฏุงุฑ ูุฑ ุฏู ูุฏู ุฎูุจ ุฑุง ุจู ุฏุฑุณุช ุดูุงุณุง ฺฉุฑุฏ (ุดุงูู ููุจุฏ)ุ</p>';
            
            var actions = document.getElementById('action-buttons');
            actions.innerHTML = 
                '<button class="action-btn" onclick="endGame(\'evil\', \'ููุงุจโุฏุงุฑ ุงูุฏุงู ุฎูุจ ุฑุง ุจู ุฏุฑุณุช ุดูุงุณุง ฺฉุฑุฏ. ูุดฺฉุฑ ุถุญุงฺฉ ุจุฑูุฏู ุดุฏ!\')" style="background: var(--evil-color);">ููุงุจโุฏุงุฑ ูพุฑูุฒ ุดุฏ</button>' +
                '<button class="action-btn" onclick="endGame(\'good\', \'ููุงุจโุฏุงุฑ ุฏุฑ ุดูุงุณุง ุงูุฏุงู ุดฺฉุณุช ุฎูุฑุฏ. ุฎูุจ ุจุฑูุฏู ุดุฏ!\')" style="background: var(--good-color); margin-top: 10px;">ููุงุจโุฏุงุฑ ุดฺฉุณุช ุฎูุฑุฏ</button>';
        }


        function endGame(winner, message) {
            isGameEnded = true;
            isGameInProgress = false;
            var titleEl = document.getElementById('end-game-title');
            titleEl.innerText = (winner === 'good' ? 'ุฎูุจ' : 'ุจุฏ') + ' ุจุฑูุฏู ุดุฏ!';
            titleEl.style.color = winner === 'good' ? '#4CAF50' : '#F44336';
            document.getElementById('end-game-message').innerText = message;
            document.getElementById('end-game-modal').classList.remove('hidden');
            addLog('ูพุงุงู ุจุงุฒ: ' + message);
            
            // Play victory sound
            if (winner === 'good') {
                playGoodWins();
            } else {
                playEvilWins();
            }
        }

        function toggleLog() {
            var log = document.getElementById('game-log');
            log.classList.toggle('hidden');
        }

        function addLog(message) {
            var timestamp = new Date().toLocaleTimeString();
            gameLog.push('[' + timestamp + '] ' + message);
            
            var content = document.getElementById('log-content');
            content.innerHTML = '';
            gameLog.slice().reverse().forEach(function(entry) {
                var div = document.createElement('div');
                div.className = 'log-entry';
                div.innerText = entry;
                content.appendChild(div);
            });
        }

        function showScreen(id) {
            var screens = ['setup-screen', 'role-selection-screen', 'distribution-screen', 'leader-announce-screen', 'game-screen'];
            screens.forEach(s => {
                var el = document.getElementById(s);
                if (el) el.classList.add('hidden');
            });
            var target = document.getElementById(id);
            if (target) target.classList.remove('hidden');
        }

        function shuffleArray(array) {
            for (var i = array.length - 1; i > 0; i--) {
                var j = Math.floor(Math.random() * (i + 1));
                var temp = array[i];
                array[i] = array[j];
                array[j] = temp;
            }
        }

        // Convert English numbers to Farsi numerals
        function toFarsiNum(num) {
            var farsiDigits = ['ฐ', 'ฑ', 'ฒ', 'ณ', 'ด', 'ต', 'ถ', 'ท', 'ธ', 'น'];
            var numStr = num.toString();
            var result = '';
            for (var i = 0; i < numStr.length; i++) {
                var char = numStr[i];
                if (char >= '0' && char <= '9') {
                    result += farsiDigits[parseInt(char)];
                } else {
                    result += char;
                }
            }
            return result;
        }

        // Sound Effects
        function playSound(frequency, duration, type) {
            try {
                var ctx = getAudioContext();
                if (!ctx) return;
                
                var oscillator = ctx.createOscillator();
                var gainNode = ctx.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(ctx.destination);
                
                oscillator.frequency.value = frequency;
                oscillator.type = type || 'sine';
                
                gainNode.gain.setValueAtTime(0.3, ctx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + duration);
                
                oscillator.start(ctx.currentTime);
                oscillator.stop(ctx.currentTime + duration);
            } catch (e) {
                // Silently fail if audio context not available
            }
        }

        function playQuestSuccess() {
            // Heroic victory fanfare - ascending triumphant call
            playSound(330.00, 0.12, 'sine'); // E4 - heroic base
            setTimeout(() => playSound(440.00, 0.12, 'sine'), 120); // A4
            setTimeout(() => playSound(554.37, 0.12, 'sine'), 240); // C#5
            setTimeout(() => playSound(659.25, 0.15, 'sine'), 360); // E5 - triumphant peak
            setTimeout(() => playSound(783.99, 0.2, 'sine'), 510); // G5 - victory resolution
        }

        function playQuestFailure() {
            // Dark, ominous warning - descending menacing tone
            playSound(277.18, 0.2, 'sawtooth'); // C#4 - dark warning
            setTimeout(() => playSound(220.00, 0.25, 'sawtooth'), 200); // A3 - deeper threat
            setTimeout(() => playSound(174.61, 0.3, 'sawtooth'), 450); // F3 - ominous low
            setTimeout(() => playSound(146.83, 0.25, 'sawtooth'), 750); // D3 - final dark note
        }

        function playGoodWins() {
            // Triumphant fanfare
            playSound(523.25, 0.15, 'sine'); // C5
            setTimeout(() => playSound(659.25, 0.15, 'sine'), 150); // E5
            setTimeout(() => playSound(783.99, 0.15, 'sine'), 300); // G5
            setTimeout(() => playSound(1046.50, 0.3, 'sine'), 450); // C6
        }

        function playEvilWins() {
            // Darker, ominous sound
            playSound(220.00, 0.2, 'sawtooth'); // A3
            setTimeout(() => playSound(196.00, 0.2, 'sawtooth'), 200); // G3
            setTimeout(() => playSound(174.61, 0.3, 'sawtooth'), 400); // F3
        }
    </script>
</body>
</html>