<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø³Ø§Ø²Ù†Ø¯Ù‡ Ø³Ù†Ø§Ø±ÛŒÙˆ Ù…Ø§ÙÛŒØ§</title>
    <style>
        :root {
            --bg-color: #121212;
            --card-bg: #1E1E1E;
            --text-primary: #FFFFFF;
            --text-secondary: #B0B0B0;
            --accent-color: #FF5722;
            --mafia-color: #F44336;
            --citizen-color: #4CAF50;
            --indep-color: #FFEB3B;
            --btn-color: #2196F3;
            --border-radius: 16px;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Tahoma', 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            overflow-x: hidden;
            user-select: none;
        }

        .container {
            width: 95%;
            max-width: 500px;
            padding: 20px;
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            margin-top: 20px;
            margin-bottom: 20px;
        }

        h1 { font-size: 1.5rem; margin: 0 0 1rem 0; font-weight: 900; }
        h2 { font-size: 1.2rem; margin: 10px 0; color: var(--text-secondary); }
        
        /* Selection Grid */
        .role-category {
            width: 100%;
            margin-bottom: 20px;
            text-align: right;
        }
        
        .cat-title {
            font-size: 1rem;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #333;
            color: var(--text-secondary);
        }

        .role-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255,255,255,0.05);
            margin-bottom: 8px;
            padding: 10px;
            border-radius: 10px;
        }

        .role-name {
            font-size: 0.95rem;
            font-weight: bold;
        }
        
        .role-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .ctrl-btn {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            border: none;
            color: white;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-minus { background-color: #444; }
        .btn-plus { background-color: var(--btn-color); }

        .count-badge {
            font-size: 1.1rem;
            width: 25px;
            text-align: center;
        }

        /* Bottom Bar */
        .bottom-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: #252525;
            padding: 15px;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.5);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
        }

        .total-info {
            text-align: right;
            font-size: 0.9rem;
        }

        button.action-btn {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 12px 25px;
            font-size: 1rem;
            font-family: inherit;
            font-weight: 700;
            border-radius: 12px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(255, 87, 34, 0.3);
        }

        button.action-btn:disabled {
            background-color: #555;
            color: #888;
            box-shadow: none;
        }

        /* Game Screens */
        .hidden { display: none !important; }
        
        .role-reveal {
            font-size: 2.2rem;
            font-weight: 900;
            margin: 20px 0;
            color: white;
            animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .team-reveal { font-size: 1.2rem; margin-bottom: 20px; font-weight: bold; }

        @keyframes popIn {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }

        /* Color Utils */
        .mafia-text { color: var(--mafia-color); }
        .citizen-text { color: var(--citizen-color); }
        .indep-text { color: var(--indep-color); }

        /* Inputs */
        .player-input {
            width: 100%;
            padding: 12px;
            margin-bottom: 10px;
            background-color: #333;
            border: 1px solid #444;
            border-radius: 8px;
            color: white;
            font-family: inherit;
            font-size: 1rem;
            text-align: center;
        }
        .player-input:focus { outline: 2px solid var(--btn-color); border-color: transparent; }

        /* Saved Players Chips */
        .player-chip {
            background: rgba(255,255,255,0.1);
            border: 1px solid #555;
            border-radius: 20px;
            padding: 6px 14px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
            margin: 3px;
            display: inline-block;
        }
        .player-chip:active {
            background: var(--btn-color);
            border-color: var(--btn-color);
            transform: scale(0.95);
        }
    </style>
</head>
<body>

    <!-- 1. Builder Screen -->
    <div id="builder-screen" class="container" style="padding-bottom: 80px;">
        <h1>Ø³Ø§Ø®Øª Ø³Ù†Ø§Ø±ÛŒÙˆ</h1>
        
        <!-- Mafia Roles -->
        <div class="role-category">
            <div class="cat-title mafia-text">ØªÛŒÙ… Ù…Ø§ÙÛŒØ§</div>
            <div id="mafia-list"></div>
        </div>

        <!-- Citizen Roles -->
        <div class="role-category">
            <div class="cat-title citizen-text">ØªÛŒÙ… Ø´Ù‡Ø±ÙˆÙ†Ø¯</div>
            <div id="citizen-list"></div>
        </div>

        <!-- Independent/Other -->
        <div class="role-category">
            <div class="cat-title indep-text">Ù…Ø³ØªÙ‚Ù„ / Ø³Ø§ÛŒØ±</div>
            <div id="other-list"></div>
        </div>

        <!-- Player Names Section -->
        <div id="names-section" class="role-category hidden" style="margin-top: 30px; border-top: 1px solid #333; padding-top: 20px;">
            <div class="cat-title" style="color: white; display:flex; justify-content:space-between;">
                <span>Ø§Ø³Ø§Ù…ÛŒ Ø¨Ø§Ø²ÛŒÚ©Ù†Ø§Ù† (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</span>
                <button onclick="clearInputs()" style="background:none; border:none; color:#aaa; cursor:pointer; font-size:0.8rem;">Ù¾Ø§Ú© Ú©Ø±Ø¯Ù†</button>
            </div>
            <div id="player-inputs-container"></div>
            
            <!-- Saved Players Chips -->
            <div id="saved-players-section" style="margin-top: 15px; text-align: right;">
                <div style="font-size: 0.8rem; color: #888; margin-bottom: 5px;">ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø§Ø³Ø§Ù…ÛŒ:</div>
                <div id="saved-list" style="display: flex; flex-wrap: wrap; gap: 5px; justify-content: flex-end;"></div>
                <button onclick="clearSavedPlayers()" style="background:none; border:none; color:#F44336; font-size:0.8rem; margin-top:10px; cursor:pointer; opacity: 0.7;">Ø­Ø°Ù ØªØ§Ø±ÛŒØ®Ú†Ù‡</button>
            </div>
        </div>
    </div>

    <!-- Bottom Bar for Builder -->
    <div id="builder-bar" class="bottom-bar">
        <div class="total-info">
            <div>ØªØ¹Ø¯Ø§Ø¯ Ø¨Ø§Ø²ÛŒÚ©Ù†: <span id="total-players" style="color: white; font-weight: bold;">0</span></div>
            <div style="font-size: 0.8rem; color: #888;">ØªØ±Ú©ÛŒØ¨ Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ø³Ø§Ø²ÛŒØ¯</div>
        </div>
        <button class="action-btn" id="start-btn" onclick="startGame()" disabled>Ø´Ø±ÙˆØ¹ ØªÙˆØ²ÛŒØ¹</button>
    </div>

    <!-- 2. Pass Phone Screen -->
    <div id="pass-screen" class="container hidden">
        <div style="font-size: 0.9rem; color: #888; margin-bottom: 20px;">
            Ø¨Ø§Ø²ÛŒÚ©Ù† <span id="player-num-pass"></span> Ø§Ø² <span id="total-players-game"></span>
        </div>
        <div style="font-size: 4rem; margin: 20px;">ğŸ“±</div>
        <h2>Ù†ÙˆØ¨Øª Ø¨Ø§Ø²ÛŒÚ©Ù† <span id="player-idx" style="color: var(--btn-color);">1</span></h2>
        <p>Ú¯ÙˆØ´ÛŒ Ø±Ø§ Ø¨Ù‡ Ø§ÛŒÙ† Ø¨Ø§Ø²ÛŒÚ©Ù† Ø¨Ø¯Ù‡ÛŒØ¯.</p>
        <button class="action-btn" style="width: 100%; background-color: var(--btn-color);" onclick="confirmIdentity()">Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù†Ù‚Ø´</button>
    </div>

    <!-- 3. Reveal Role Screen -->
    <div id="reveal-screen" class="container hidden">
        <div style="font-size: 0.9rem; color: #888; margin-bottom: 20px;">
            Ø¨Ø§Ø²ÛŒÚ©Ù† <span id="player-num-reveal"></span> Ø§Ø² <span id="total-players-reveal"></span>
        </div>
        <p>Ù†Ù‚Ø´ Ø´Ù…Ø§:</p>
        <div id="role-display" class="role-reveal">...</div>
        <div id="role-eng" style="font-size: 1rem; color: #888; margin-top: -15px; margin-bottom: 20px;">...</div>
        <div id="team-display" class="team-reveal">...</div>
        <p style="font-size: 0.9rem; opacity: 0.6;">Ø¨Ù‡ Ø®Ø§Ø·Ø± Ø¨Ø³Ù¾Ø§Ø±ÛŒØ¯ Ùˆ Ù¾Ù†Ù‡Ø§Ù† Ú©Ù†ÛŒØ¯.</p>
        <button id="next-btn" class="action-btn" style="width: 100%; background-color: var(--citizen-color);" onclick="nextPlayer()">Ù¾Ù†Ù‡Ø§Ù† Ú©Ø±Ø¯Ù† Ùˆ Ù†ÙØ± Ø¨Ø¹Ø¯ÛŒ</button>
    </div>

    <!-- 4. End Screen -->
    <div id="end-screen" class="container hidden">
        <div style="font-size: 4rem; margin-bottom: 10px;">âœ…</div>
        <h1>Ù¾Ø§ÛŒØ§Ù† ØªÙˆØ²ÛŒØ¹</h1>
        <p>ØªÙ…Ø§Ù… Ù†Ù‚Ø´â€ŒÙ‡Ø§ ØªÙˆØ²ÛŒØ¹ Ø´Ø¯Ù†Ø¯.<br>Ú¯ÙˆØ´ÛŒ Ø±Ø§ Ø¨Ù‡ Ø±Ø§ÙˆÛŒ (Ú¯Ø§Ø¯) Ø¨Ø±Ú¯Ø±Ø¯Ø§Ù†ÛŒØ¯.</p>
        <button class="action-btn" style="background-color: #F44336;" onclick="restartGame()">Ø´Ø±ÙˆØ¹ Ø¨Ø§Ø²ÛŒ Ù…Ø¬Ø¯Ø¯ (Restart)</button>
        <button class="action-btn" style="background-color: #2196F3; margin-top: 10px;" onclick="resetGame()">ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¬Ø¯ÛŒØ¯</button>
    </div>

    <script>
        // --- Role Definitions ---
        var AVAILABLE_ROLES = {
            mafia: [
                { id: 'godfather', name: 'Ø±Ø¦ÛŒØ³ Ù…Ø§ÙÛŒØ§', eng: 'Boss / Godfather' },
                { id: 'simple_mafia', name: 'Ù…Ø§ÙÛŒØ§ Ø³Ø§Ø¯Ù‡', eng: 'Simple Mafia' },
                { id: 'nato', name: 'Ù†Ø§ØªÙˆ', eng: 'Nato' },
                { id: 'hostage_taker', name: 'Ú¯Ø±ÙˆÚ¯Ø§Ù†â€ŒÚ¯ÛŒØ±', eng: 'Hostage Taker' },
                { id: 'witch', name: 'Ø¬Ø§Ø¯ÙˆÚ¯Ø±', eng: 'Witch' },
                { id: 'executioner', name: 'Ø¬Ù„Ø§Ø¯', eng: 'Executioner' },
                { id: 'informant', name: 'Ø®Ø¨Ø±Ú†ÛŒÙ†', eng: 'Informant' }
            ],
            citizen: [
                { id: 'citizen', name: 'Ø´Ù‡Ø±ÙˆÙ†Ø¯ Ø³Ø§Ø¯Ù‡', eng: 'Simple Citizen' },
                { id: 'doctor', name: 'Ù¾Ø²Ø´Ú©', eng: 'Doctor' },
                { id: 'detective', name: 'Ú©Ø§Ø±Ø¢Ú¯Ø§Ù‡', eng: 'Detective' },
                { id: 'sniper', name: 'Ø§Ø³Ù†Ø§ÛŒÙ¾Ø± / ØªÚ©â€ŒØªÛŒØ±Ø§Ù†Ø¯Ø§Ø²', eng: 'Sniper' },
                { id: 'takavar', name: 'ØªÚ©Ø§ÙˆØ±', eng: 'Commando' },
                { id: 'guard', name: 'Ù†Ú¯Ù‡Ø¨Ø§Ù†', eng: 'Guard' },
                { id: 'rifleman', name: 'ØªÙÙ†Ú¯Ø¯Ø§Ø±', eng: 'Rifleman' },
                { id: 'armored', name: 'Ø²Ø±Ù‡â€ŒÙ¾ÙˆØ´', eng: 'Armored' },
                { id: 'heir', name: 'ÙˆØ§Ø±Ø«', eng: 'Heir' },
                { id: 'armorsmith', name: 'Ø²Ø±Ù‡â€ŒØ³Ø§Ø²', eng: 'Armorsmith' },
                { id: 'herbalist', name: 'Ø¹Ø·Ø§Ø±', eng: 'Herbalist' },
                { id: 'suspect', name: 'Ù…Ø¸Ù†ÙˆÙ†', eng: 'Suspect' },
                { id: 'village_head', name: 'Ú©Ø¯Ø®Ø¯Ø§', eng: 'Village Head' }
            ],
            other: [
                { id: 'joker', name: 'Ø¬ÙˆÚ©Ø±', eng: 'Joker', team: 'INDEP' }
            ]
        };

        // --- State ---
        var selectedRoles = {}; // Map id -> count
        var gameRoleList = [];
        var playerNames = [];
        var currentPlayerIndex = 0;
        var savedPlayers = [];
        var isGameInProgress = false;
        
        // Completely prevent accidental refresh/back navigation
        // Set up event listeners once (always active, check flag when firing)
        window.addEventListener('beforeunload', function(e) {
            if (isGameInProgress) {
                e.preventDefault();
                e.returnValue = 'Ø¨Ø§Ø²ÛŒ Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù… Ø§Ø³Øª! Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…Ø¬Ø¯Ø¯ Ø¨Ø§Ø¹Ø« Ø§Ø² Ø¯Ø³Øª Ø±ÙØªÙ† Ù¾ÛŒØ´Ø±ÙØª Ù…ÛŒâ€ŒØ´ÙˆØ¯.';
                return e.returnValue;
            }
        });
        
        // Disable keyboard shortcuts for refresh (F5, Ctrl+R, Ctrl+Shift+R)
        document.addEventListener('keydown', function(e) {
            if (isGameInProgress) {
                // F5
                if (e.key === 'F5' || e.keyCode === 116) {
                    e.preventDefault();
                    alert('Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…Ø¬Ø¯Ø¯ Ø¯Ø± Ø·ÙˆÙ„ Ø¨Ø§Ø²ÛŒ ØºÛŒØ±ÙØ¹Ø§Ù„ Ø§Ø³Øª. Ø§Ø² Ú©Ù†ØªØ±Ù„â€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ø²ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ø§ÙˆØ¨Ø±ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.');
                    return false;
                }
                // Ctrl+R or Ctrl+Shift+R
                if ((e.ctrlKey || e.metaKey) && (e.key === 'r' || e.key === 'R')) {
                    e.preventDefault();
                    alert('Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…Ø¬Ø¯Ø¯ Ø¯Ø± Ø·ÙˆÙ„ Ø¨Ø§Ø²ÛŒ ØºÛŒØ±ÙØ¹Ø§Ù„ Ø§Ø³Øª. Ø§Ø² Ú©Ù†ØªØ±Ù„â€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ø²ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ø§ÙˆØ¨Ø±ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.');
                    return false;
                }
            }
        });
        
        // Disable right-click context menu during game
        document.addEventListener('contextmenu', function(e) {
            if (isGameInProgress) {
                e.preventDefault();
                return false;
            }
        }, false);
        
        // Handle back button
        window.onpopstate = function(event) {
            if (isGameInProgress) {
                // Immediately push state back to prevent navigation
                history.pushState({page: 'game'}, '', location.href);
                // Show warning
                alert('Ø¯Ú©Ù…Ù‡ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¯Ø± Ø·ÙˆÙ„ Ø¨Ø§Ø²ÛŒ ØºÛŒØ±ÙØ¹Ø§Ù„ Ø§Ø³Øª. Ø§Ø² Ú©Ù†ØªØ±Ù„â€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ø²ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ø§ÙˆØ¨Ø±ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.');
            }
        };
        
        function preventAccidentalNavigation() {
            if (isGameInProgress) {
                // Completely prevent back button - push state and immediately replace
                history.pushState({page: 'game'}, '', location.href);
                history.pushState({page: 'game'}, '', location.href);
            }
        }
        
        // Initialize navigation prevention
        preventAccidentalNavigation();

        // --- Init ---
        window.onload = function() {
            loadSavedPlayers();
            renderBuilder();
        };

        function loadSavedPlayers() {
            var stored = localStorage.getItem('mafia_flexible_players');
            if (stored) {
                savedPlayers = JSON.parse(stored);
            }
            renderSavedList();
        }

        function renderSavedList() {
            var container = document.getElementById('saved-list');
            container.innerHTML = '';
            
            if (savedPlayers.length === 0) {
                container.innerHTML = '<span style="color:#555; font-size:0.8rem;">Ù†Ø§Ù…ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ù†Ø´Ø¯Ù‡</span>';
                return;
            }

            for (var i = 0; i < savedPlayers.length; i++) {
                (function(name) {
                    var chip = document.createElement('div');
                    chip.className = 'player-chip';
                    chip.innerText = name;
                    chip.onclick = function() { fillInput(name); };
                    container.appendChild(chip);
                })(savedPlayers[i]);
            }
        }

        function fillInput(name) {
            var inputs = document.querySelectorAll('.player-input');
            for (var i = 0; i < inputs.length; i++) {
                if (inputs[i].value === '') {
                    inputs[i].value = name;
                    return;
                }
            }
        }

        function clearInputs() {
            var inputs = document.querySelectorAll('.player-input');
            for (var i = 0; i < inputs.length; i++) {
                inputs[i].value = '';
            }
        }

        function clearSavedPlayers() {
            if (confirm('Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ')) {
                savedPlayers = [];
                localStorage.removeItem('mafia_flexible_players');
                renderSavedList();
            }
        }

        function renderBuilder() {
            renderCategory('mafia-list', AVAILABLE_ROLES.mafia, 'MAFIA');
            renderCategory('citizen-list', AVAILABLE_ROLES.citizen, 'CITIZEN');
            renderCategory('other-list', AVAILABLE_ROLES.other, 'INDEP');
        }

        function renderCategory(elementId, roles, team) {
            var container = document.getElementById(elementId);
            var html = '';
            for (var i = 0; i < roles.length; i++) {
                var r = roles[i];
                var count = selectedRoles[r.id] || 0;
                
                html += '<div class="role-item">';
                html += '<div class="role-name">' + r.name + '</div>';
                html += '<div class="role-controls">';
                html += '<button class="ctrl-btn btn-minus" onclick="updateCount(\'' + r.id + '\', -1)">-</button>';
                html += '<div class="count-badge" id="count-' + r.id + '">' + count + '</div>';
                html += '<button class="ctrl-btn btn-plus" onclick="updateCount(\'' + r.id + '\', 1)">+</button>';
                html += '</div></div>';
            }
            container.innerHTML = html;
        }

        function updateCount(roleId, delta) {
            var current = selectedRoles[roleId] || 0;
            var newCount = current + delta;
            if (newCount < 0) newCount = 0;
            
            selectedRoles[roleId] = newCount;
            document.getElementById('count-' + roleId).innerText = newCount;
            
            updateTotal();
        }

        function updateTotal() {
            var total = 0;
            for (var key in selectedRoles) {
                if (selectedRoles.hasOwnProperty(key)) {
                    total += selectedRoles[key];
                }
            }
            document.getElementById('total-players').innerText = total;
            document.getElementById('start-btn').disabled = (total === 0);
            
            updateNameInputs(total);
        }

        function updateNameInputs(total) {
            var section = document.getElementById('names-section');
            var container = document.getElementById('player-inputs-container');
            
            if (total > 0) {
                section.classList.remove('hidden');
            } else {
                section.classList.add('hidden');
                return;
            }

            // Preserve existing values
            var currentInputs = document.querySelectorAll('.player-input');
            var values = [];
            for(var i=0; i<currentInputs.length; i++) values.push(currentInputs[i].value);

            container.innerHTML = "";
            for(var i=0; i<total; i++) {
                var inp = document.createElement('input');
                inp.className = 'player-input';
                inp.placeholder = 'Ø¨Ø§Ø²ÛŒÚ©Ù† ' + (i+1);
                if(values[i]) inp.value = values[i];
                container.appendChild(inp);
            }
        }

        function getRoleObject(id) {
            // Search in all categories
            var cats = ['mafia', 'citizen', 'other'];
            for (var i = 0; i < cats.length; i++) {
                var list = AVAILABLE_ROLES[cats[i]];
                for (var j = 0; j < list.length; j++) {
                    if (list[j].id === id) {
                        // Return copy with implied team if not set
                        var obj = list[j];
                        if (!obj.team) {
                            if (cats[i] === 'mafia') obj.team = 'MAFIA';
                            if (cats[i] === 'citizen') obj.team = 'CITIZEN';
                        }
                        return obj;
                    }
                }
            }
            return null;
        }

        // --- Game Logic ---

        function shuffleArray(array) {
            for (var i = array.length - 1; i > 0; i--) {
                var j = Math.floor(Math.random() * (i + 1));
                var temp = array[i];
                array[i] = array[j];
                array[j] = temp;
            }
        }

        function startGame() {
            isGameInProgress = true;
            preventAccidentalNavigation();
            isGameInProgress = true;
            // 1. Get Names & Save
            var inputEls = document.querySelectorAll('.player-input');
            playerNames = [];
            for(var i=0; i<inputEls.length; i++) {
                var val = inputEls[i].value.trim();
                if(val) {
                    playerNames.push(val);
                    if(savedPlayers.indexOf(val) === -1) savedPlayers.push(val);
                } else {
                    playerNames.push(inputEls[i].placeholder);
                }
            }
            localStorage.setItem('mafia_flexible_players', JSON.stringify(savedPlayers));

            // 2. Build list
            gameRoleList = [];
            for (var id in selectedRoles) {
                if (selectedRoles.hasOwnProperty(id)) {
                    var count = selectedRoles[id];
                    var roleDef = getRoleObject(id);
                    if (roleDef) {
                        for (var k = 0; k < count; k++) {
                            gameRoleList.push(roleDef);
                        }
                    }
                }
            }

            if (gameRoleList.length === 0) return;

            shuffleArray(gameRoleList);
            currentPlayerIndex = 0;

            // Hide builder, show pass screen
            document.getElementById('builder-screen').classList.add('hidden');
            document.getElementById('builder-bar').classList.add('hidden'); // Hide bottom bar
            
            showScreen('pass-screen');
            updatePassScreen();
        }

        function updatePassScreen() {
            var total = gameRoleList.length;
            var num = currentPlayerIndex + 1;
            document.getElementById('player-num-pass').innerText = num;
            document.getElementById('total-players-game').innerText = total;
            document.getElementById('player-idx').innerText = playerNames[currentPlayerIndex]; // Use Name
        }

        function confirmIdentity() {
            var roleObj = gameRoleList[currentPlayerIndex];
            var playerName = playerNames[currentPlayerIndex];
            
            var roleEl = document.getElementById('role-display');
            var engEl = document.getElementById('role-eng');
            var teamEl = document.getElementById('team-display');
            
            roleEl.innerText = roleObj.name;
            
            // Show teammates for Mafia
            var teammatesText = "";
            if (roleObj.team === 'MAFIA') {
                // Find other mafia
                var teammates = [];
                for(var i=0; i<gameRoleList.length; i++) {
                    if(gameRoleList[i].team === 'MAFIA' && i !== currentPlayerIndex) {
                        teammates.push(playerNames[i] + " (" + gameRoleList[i].name + ")");
                    }
                }
                
                if(teammates.length > 0) {
                    teammatesText = "<br><span style='font-size:0.9rem; color:#FF5252; display:block; margin-top:10px;'>ÛŒØ§Ø±Ø§Ù† Ø´Ù…Ø§:<br>" + teammates.join('<br>') + "</span>";
                } else {
                    teammatesText = "<br><span style='font-size:0.9rem; color:#FF5252; display:block; margin-top:10px;'>(Ø´Ù…Ø§ ØªÙ†Ù‡Ø§ Ù…Ø§ÙÛŒØ§ Ù‡Ø³ØªÛŒØ¯)</span>";
                }
            }
            
            engEl.innerHTML = roleObj.eng + teammatesText;
            
            if (roleObj.team === 'MAFIA') {
                roleEl.style.color = '#FF5252';
                teamEl.innerText = "ØªÛŒÙ… Ù…Ø§ÙÛŒØ§";
                teamEl.style.color = '#FF5252';
            } else if (roleObj.team === 'CITIZEN') {
                roleEl.style.color = '#69F0AE';
                teamEl.innerText = "ØªÛŒÙ… Ø´Ù‡Ø±ÙˆÙ†Ø¯";
                teamEl.style.color = '#69F0AE';
            } else {
                // Independent/Joker
                roleEl.style.color = '#FFEB3B';
                teamEl.innerText = "Ù…Ø³ØªÙ‚Ù„ / Ø³Ø§ÛŒØ¯ Ø³ÙˆÙ…";
                teamEl.style.color = '#FFEB3B';
            }

            // document.getElementById('player-num-reveal').innerText = currentPlayerIndex + 1; // Removed number
            document.getElementById('player-num-reveal').innerText = playerName; // Show Name instead of Num
            
            document.getElementById('total-players-reveal').innerText = gameRoleList.length;
            
            var nextBtn = document.getElementById('next-btn');
            if (currentPlayerIndex === gameRoleList.length - 1) {
                nextBtn.innerText = "Ù¾Ø§ÛŒØ§Ù† ØªÙˆØ²ÛŒØ¹";
                nextBtn.style.backgroundColor = "#F44336";
            } else {
                nextBtn.innerText = "Ù¾Ù†Ù‡Ø§Ù† Ú©Ø±Ø¯Ù† Ùˆ Ù†ÙØ± Ø¨Ø¹Ø¯ÛŒ";
                nextBtn.style.backgroundColor = "#2196F3";
            }

            showScreen('reveal-screen');
        }

        function nextPlayer() {
            currentPlayerIndex++;
            if (currentPlayerIndex >= gameRoleList.length) {
                showScreen('end-screen');
            } else {
                updatePassScreen();
                showScreen('pass-screen');
            }
        }

        function resetGame() {
            // Go back to builder
            document.getElementById('builder-screen').classList.remove('hidden');
            document.getElementById('builder-bar').classList.remove('hidden');
            
            // Hide others
            document.getElementById('pass-screen').classList.add('hidden');
            document.getElementById('reveal-screen').classList.add('hidden');
            document.getElementById('end-screen').classList.add('hidden');
        }

        function restartGame() {
            if (confirm("Ø¢ÛŒØ§ Ø¨Ø§Ø²ÛŒ Ø¨Ø§ Ù‡Ù…Ø§Ù† ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù…Ø¬Ø¯Ø¯Ø§Ù‹ Ø´Ø±ÙˆØ¹ Ø´ÙˆØ¯ØŸ")) {
                // Reshuffle and start again
                shuffleArray(gameRoleList);
                currentPlayerIndex = 0;
                
                // Skip builder, go straight to pass
                document.getElementById('builder-screen').classList.add('hidden');
                document.getElementById('builder-bar').classList.add('hidden');
                document.getElementById('end-screen').classList.add('hidden');
                
                showScreen('pass-screen');
                updatePassScreen();
            }
        }

        function showScreen(screenId) {
            // Helper to toggle screens, keeping builder intact in background if needed
            // But here we hid builder manually.
            var ids = ['pass-screen', 'reveal-screen', 'end-screen'];
            for (var i = 0; i < ids.length; i++) {
                document.getElementById(ids[i]).classList.add('hidden');
            }
            var target = document.getElementById(screenId);
            target.classList.remove('hidden');

             // Reset animation for reveal
             if (screenId === 'reveal-screen') {
                var roleEl = document.getElementById('role-display');
                roleEl.style.animation = 'none';
                roleEl.offsetHeight; /* trigger reflow */
                roleEl.style.animation = 'popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
            }
        }
    </script>
</body>
</html>
