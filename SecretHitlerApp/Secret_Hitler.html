<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Secret Hitler</title>
    <style>
        :root {
            --bg-color: #0a192f;
            --card-bg: #112240;
            --text-primary: #e6f1ff;
            --text-secondary: #8892b0;
            --accent-color: #64ffda;
            --liberal-color: #2196F3;
            --fascist-color: #F44336;
            --hitler-color: #9C27B0;
            --btn-color: #64ffda;
            --btn-text: #0a192f;
            --border-radius: 8px;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            overflow-x: hidden;
            user-select: none;
        }

        .container {
            width: 95%;
            max-width: 600px;
            padding: 20px;
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            margin: 20px 0;
            text-align: center;
            transition: transform 0.3s ease;
        }

        h1 { font-size: 1.8rem; margin-bottom: 0.5rem; color: var(--accent-color); font-weight: 900; }
        h2 { font-size: 1.2rem; margin: 10px 0; color: var(--text-secondary); }
        p { font-size: 1rem; color: var(--text-secondary); margin-bottom: 1rem; line-height: 1.5; }

        .setup-info {
            background: rgba(255,255,255,0.05);
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: left;
            font-size: 0.9rem;
            line-height: 1.6;
        }

        .input-group { margin-bottom: 10px; text-align: left; }
        .input-group label { display: block; margin-bottom: 5px; color: var(--text-secondary); font-size: 0.9rem; }
        
        .player-input {
            width: 100%;
            padding: 12px;
            background-color: #233554;
            border: 1px solid #303C55;
            border-radius: 4px;
            color: var(--text-primary);
            font-size: 1rem;
            text-align: center;
        }
        .player-input:focus { outline: 1px solid var(--accent-color); }

        .action-btn {
            background-color: var(--btn-color);
            color: var(--btn-text);
            border: none;
            padding: 14px 20px;
            font-size: 1rem;
            font-weight: bold;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            margin-top: 15px;
            transition: transform 0.1s;
        }
        .action-btn:active { transform: scale(0.98); }
        
        .secondary-btn {
            background-color: transparent;
            color: var(--accent-color);
            border: 1px solid var(--accent-color);
            padding: 10px 15px;
            font-size: 0.9rem;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
            width: 100%;
        }

        .player-select-btn {
            background: linear-gradient(135deg, rgba(100, 255, 218, 0.2) 0%, rgba(100, 255, 218, 0.1) 100%);
            color: var(--accent-color);
            border: 3px solid var(--accent-color);
            padding: 18px 24px;
            font-size: 1.2rem;
            font-weight: bold;
            border-radius: 12px;
            cursor: pointer;
            width: 100%;
            margin: 12px 0;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(100, 255, 218, 0.2);
            text-align: center;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .player-select-btn:hover {
            background: linear-gradient(135deg, rgba(100, 255, 218, 0.3) 0%, rgba(100, 255, 218, 0.2) 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(100, 255, 218, 0.4);
        }
        .player-select-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 10px rgba(100, 255, 218, 0.3);
        }

        .hidden { display: none !important; }

        /* Role Card */
        .role-card {
            background: rgba(0,0,0,0.2);
            padding: 20px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.1);
            margin: 20px 0;
        }
        .role-title { 
            font-size: 2rem; 
            font-weight: 900; 
            margin-bottom: 10px; 
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .role-liberal { 
            color: var(--liberal-color); 
            text-shadow: 0 0 10px rgba(33, 150, 243, 0.5);
        }
        .role-fascist { 
            color: var(--fascist-color); 
            text-shadow: 0 0 10px rgba(244, 67, 54, 0.5);
        }
        .role-hitler { 
            color: var(--hitler-color); 
            text-shadow: 0 0 10px rgba(156, 39, 176, 0.5);
        }

        @keyframes popIn {
            from { opacity: 0; transform: scale(0.5); }
            to { opacity: 1; transform: scale(1); }
        }

        /* Policy Track */
        .policy-track {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 8px;
            margin: 15px 0;
            padding: 15px;
            background: rgba(0,0,0,0.2);
            border-radius: 12px;
            border: 2px solid rgba(255,255,255,0.1);
            position: relative;
        }
        .policy-slot {
            width: 45px;
            height: 60px;
            border-radius: 6px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 2px solid #555;
            background: rgba(0,0,0,0.4);
            position: relative;
            transition: all 0.3s;
        }
        .policy-slot.liberal {
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
            border-color: #64B5F6;
            box-shadow: 0 0 12px rgba(33, 150, 243, 0.6);
        }
        .policy-slot.fascist {
            background: linear-gradient(135deg, #F44336 0%, #D32F2F 100%);
            border-color: #EF5350;
            box-shadow: 0 0 12px rgba(244, 67, 54, 0.6);
        }
        .policy-slot.hitler-zone-slot {
            border-color: #9C27B0;
            border-width: 3px;
            box-shadow: 0 0 15px rgba(156, 39, 176, 0.8);
            animation: hitlerZoneGlow 2s ease-in-out infinite;
        }
        @keyframes hitlerZoneGlow {
            0%, 100% { box-shadow: 0 0 15px rgba(156, 39, 176, 0.8); }
            50% { box-shadow: 0 0 25px rgba(156, 39, 176, 1); }
        }
        .policy-slot.power {
            border-width: 3px;
            border-color: var(--accent-color);
        }
        .policy-icon {
            font-size: 1.4rem;
            font-weight: bold;
            color: white;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }
        .power-badge {
            position: absolute;
            top: -6px;
            right: -6px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--accent-color);
            color: var(--btn-text);
            font-size: 0.65rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            border: 2px solid var(--bg-color);
            box-shadow: 0 2px 6px rgba(100, 255, 218, 0.6);
        }
        .track-separator {
            width: 4px;
            height: 60px;
            background: linear-gradient(180deg, transparent, rgba(255,255,255,0.5), transparent);
            border-radius: 2px;
            margin: 0 8px;
            flex-shrink: 0;
            position: relative;
        }
        .track-separator.hitler-zone-separator {
            width: 5px;
            background: linear-gradient(180deg, transparent, #9C27B0, rgba(156, 39, 176, 0.8), transparent);
            box-shadow: 0 0 10px rgba(156, 39, 176, 0.8);
        }
        .track-separator::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 2px;
            height: 40px;
            background: rgba(255,255,255,0.3);
        }
        .track-separator.hitler-zone-separator::before {
            background: #9C27B0;
            width: 3px;
            box-shadow: 0 0 6px rgba(156, 39, 176, 0.8);
        }
        .track-label {
            position: absolute;
            top: -22px;
            font-size: 0.65rem;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
            pointer-events: none;
        }
        .track-label.liberal-label {
            left: 15px;
            color: #64B5F6;
        }
        .track-label.fascist-label {
            right: 15px;
            color: #EF5350;
        }
        .hitler-zone-marker {
            position: absolute;
            top: -22px;
            font-size: 0.7rem;
            color: #9C27B0;
            text-shadow: 0 0 10px rgba(156, 39, 176, 0.8);
            font-weight: bold;
            pointer-events: none;
            white-space: nowrap;
        }

        /* Game Status */
        .game-status {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
            padding: 15px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
        }
        .status-item {
            text-align: center;
        }
        .status-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }
        .status-value {
            font-size: 1.5rem;
            font-weight: bold;
        }

        /* Tracker */
        .tracker-display {
            padding: 15px;
            background: rgba(255, 152, 0, 0.1);
            border: 2px solid #FF9800;
            border-radius: 8px;
            margin: 15px 0;
        }
        .tracker-slots {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }
        .tracker-slot {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid #FF9800;
            background: rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        .tracker-slot.filled {
            background: #FF9800;
            color: var(--bg-color);
        }

        /* Government Display */
        .government-display {
            padding: 15px;
            background: rgba(100, 255, 218, 0.1);
            border: 2px solid var(--accent-color);
            border-radius: 8px;
            margin: 15px 0;
        }
        .gov-member {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--accent-color);
            margin: 10px 0;
        }

        /* Policy Cards */
        .policy-card {
            width: 100px;
            height: 140px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
            cursor: pointer;
            border: 3px solid white;
            transition: all 0.3s;
            position: relative;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        .policy-card:active { transform: scale(0.95); }
        .policy-card-liberal {
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
            color: white;
        }
        .policy-card-fascist {
            background: linear-gradient(135deg, #F44336 0%, #D32F2F 100%);
            color: white;
        }
        .policy-card-hidden {
            background: linear-gradient(135deg, #424242 0%, #212121 100%);
            color: white;
        }
        .card-container {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin: 20px 0;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 25, 47, 0.98);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            pointer-events: auto;
        }
        .modal-overlay.hidden {
            display: none;
        }

        /* Saved Players */
        .saved-list-container {
            margin-top: 15px;
            padding: 10px;
            background: rgba(255,255,255,0.03);
            border-radius: 8px;
            min-height: 40px;
        }
        .saved-list-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }
        .player-chip {
            background: rgba(255,255,255,0.1);
            border: 1px solid #555;
            border-radius: 20px;
            padding: 6px 14px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
            margin: 3px;
            display: inline-block;
        }
        .player-chip:active {
            background: var(--accent-color);
            border-color: var(--accent-color);
            transform: scale(0.95);
        }

        /* Log */
        .log-entry {
            font-size: 0.85rem;
            text-align: left;
            border-bottom: 1px solid #233554;
            padding: 5px 0;
            color: #8892b0;
        }

        /* Animations */
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        .container, .modal-overlay > .container { 
            animation: fadeIn 0.3s ease-out; 
        }

        /* Dead Player */
        .dead-player {
            opacity: 0.5;
            text-decoration: line-through;
        }
    </style>
</head>
<body>

    <!-- 1. Setup Screen -->
    <div id="setup-screen" class="container">
        <h1>Secret Hitler</h1>
        <p>Social Deduction Game</p>

        <div class="setup-info">
            <strong>Game Overview:</strong><br>
            ‚Ä¢ Players are secretly assigned Liberal or Fascist roles (one Hitler)<br>
            ‚Ä¢ Liberals win by passing 5 Liberal policies OR killing Hitler<br>
            ‚Ä¢ Fascists win by passing 6 Fascist policies OR having Hitler elected Chancellor after 3 Fascist policies<br>
            ‚Ä¢ Supports 5-10 players
        </div>

        <div class="input-group">
            <label>Number of Players:</label>
            <div style="display:flex; align-items:center; justify-content:center; gap:15px;">
                <button class="secondary-btn" style="width:40px;" onclick="updatePlayerCount(-1)">-</button>
                <span id="player-count-display" style="font-size:1.5rem; font-weight:bold;">7</span>
                <button class="secondary-btn" style="width:40px;" onclick="updatePlayerCount(1)">+</button>
            </div>
        </div>

        <div id="player-inputs-container" style="margin-top:20px;"></div>
        
        <!-- Saved Players List -->
        <div class="saved-list-container">
            <div class="saved-list-label">Saved Names (tap to fill):</div>
            <div id="saved-list" style="text-align: center;"></div>
        </div>

        <button class="action-btn" onclick="startRoleDistribution()">Start Game</button>
    </div>

    <!-- 2. Role Distribution Phase -->
    <div id="distribution-screen" class="container hidden">
        <div id="dist-pass-view">
            <p>Pass device to:</p>
            <h2 id="dist-player-name" style="font-size:2rem; color:var(--accent-color);">Player Name</h2>
            <div style="font-size:4rem; margin:20px;">üì±</div>
            <p>Player <span id="dist-player-num">1</span> of <span id="dist-total-players">7</span></p>
            <button class="action-btn" onclick="revealRole()">Reveal Role</button>
        </div>

        <div id="dist-reveal-view" class="hidden">
            <h2 id="reveal-name-header">Player Name</h2>
            <div class="role-card">
                <div id="role-title" class="role-title">Role</div>
                <div id="role-desc" style="font-size:0.95rem; margin-bottom:10px; color:#ddd;"></div>
                <div id="role-extra" style="font-size:0.9rem; color:#ffd700;"></div>
            </div>
            <p style="font-size:0.8rem; color:#666;">Memorize your role and hide it.</p>
            <button id="next-dist-btn" class="action-btn" onclick="nextDistribute()">Hide & Next</button>
        </div>
    </div>

    <!-- 3. Main Game Screen -->
    <div id="game-screen" class="container hidden">
        <h1>Secret Hitler</h1>
        
        <!-- Game Status -->
        <div class="game-status">
            <div class="status-item">
                <div class="status-label">Liberal Policies</div>
                <div class="status-value" style="color:var(--liberal-color);" id="liberal-policies">0</div>
            </div>
            <div class="status-item">
                <div class="status-label">Fascist Policies</div>
                <div class="status-value" style="color:var(--fascist-color);" id="fascist-policies">0</div>
            </div>
        </div>

        <!-- Policy Track -->
        <div class="policy-track" id="policy-track">
            <!-- Policy slots will be generated here -->
        </div>

        <!-- Tracker -->
        <div class="tracker-display">
            <div style="font-weight: bold; color: #FF9800; margin-bottom: 10px;">Election Tracker</div>
            <div class="tracker-slots" id="tracker-slots">
                <div class="tracker-slot">1</div>
                <div class="tracker-slot">2</div>
                <div class="tracker-slot">3</div>
            </div>
            <p style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 10px;">
                3 failed elections = Topdeck (enact top policy card)
            </p>
        </div>

        <!-- Current Government -->
        <div class="government-display" id="government-display">
            <div class="status-label">Current Government</div>
            <div class="gov-member" id="president-name">-</div>
            <div style="font-size: 0.9rem; color: var(--text-secondary);">President</div>
            <div class="gov-member" id="chancellor-name">-</div>
            <div style="font-size: 0.9rem; color: var(--text-secondary);">Chancellor</div>
        </div>

        <!-- Action Buttons -->
        <div id="action-buttons" style="margin-top: 20px;"></div>

        <!-- Current Phase Display -->
        <div id="phase-display" style="margin: 20px 0; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px;">
            <div id="phase-title" style="font-size: 1.2rem; font-weight: bold; color: var(--accent-color); margin-bottom: 10px;"></div>
            <div id="phase-content"></div>
        </div>

        <!-- Game Log -->
        <button class="secondary-btn" onclick="toggleLog()">Toggle Game Log</button>
        <div id="game-log" class="hidden" style="margin-top: 15px; max-height: 200px; overflow-y: auto; text-align: left; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px;">
            <div id="log-content"></div>
        </div>

        <!-- End Game Modal -->
        <div id="end-game-modal" class="modal-overlay hidden">
            <div class="container" style="max-width:500px; border: 2px solid var(--accent-color);">
                <h1 id="end-game-title" style="margin-bottom: 20px;">GAME OVER</h1>
                <p id="end-game-message" style="font-size: 1.2rem; margin-bottom: 30px;"></p>
                <button class="action-btn" onclick="location.reload()">New Game</button>
            </div>
        </div>
    </div>

    <!-- Policy Selection Modal -->
    <div id="policy-selection-modal" class="modal-overlay hidden">
        <div class="container" style="max-width:500px;">
            <h2 id="policy-selection-title">Select Policy</h2>
            <p id="policy-selection-instruction" style="margin: 15px 0;"></p>
            <div class="card-container" id="policy-selection-cards"></div>
            <p id="policy-selection-progress" style="margin-top: 15px; color: var(--text-secondary); font-size: 0.9rem;"></p>
        </div>
    </div>

    <!-- Chancellor Discard Modal -->
    <div id="chancellor-discard-modal" class="modal-overlay hidden">
        <div class="container" style="max-width:500px;">
            <h2>Chancellor Discards</h2>
            <p id="chancellor-discard-instruction" style="margin: 15px 0;"></p>
            <div class="card-container" id="chancellor-discard-cards"></div>
        </div>
    </div>

    <!-- Policy Reveal Modal -->
    <div id="policy-reveal-modal" class="modal-overlay hidden">
        <div class="container" style="max-width:400px;">
            <h2 style="color: var(--accent-color); margin-bottom: 15px;">Policy Enacted</h2>
            <div id="policy-reveal-card" class="policy-card" style="margin: 20px auto; cursor: default;"></div>
            <div id="policy-reveal-message" style="font-size: 1.1rem; font-weight: bold; margin: 20px 0;"></div>
            <button class="action-btn" onclick="closePolicyReveal()">Continue</button>
        </div>
    </div>

    <!-- Special Power Modals -->
    <div id="investigate-modal" class="modal-overlay hidden">
        <div class="container" style="max-width:500px;">
            <h2>Investigate Loyalty</h2>
            <p style="margin: 15px 0;">President: Select a player to investigate.</p>
            <div id="investigate-list"></div>
        </div>
    </div>

    <div id="investigate-result-modal" class="modal-overlay hidden">
        <div class="container" style="max-width:400px;">
            <h2>Investigation Result</h2>
            <p style="margin: 15px 0;">You investigated:</p>
            <p id="investigated-player" style="font-size: 1.3rem; font-weight: bold; color: var(--accent-color); margin: 10px 0;"></p>
            <div id="investigation-result" style="margin: 20px 0; padding: 20px; border-radius: 12px; text-align: center; background: rgba(0,0,0,0.3); border: 3px solid;"></div>
            <button class="action-btn" onclick="closeInvestigationResult()">Continue</button>
        </div>
    </div>

    <div id="special-election-modal" class="modal-overlay hidden">
        <div class="container" style="max-width:500px;">
            <h2>Special Election</h2>
            <p style="margin: 15px 0;">President: Select the next President.</p>
            <div id="special-election-list"></div>
        </div>
    </div>

    <div id="policy-peek-modal" class="modal-overlay hidden">
        <div class="container" style="max-width:500px;">
            <h2>Policy Peek</h2>
            <p style="margin: 15px 0;">President: Look at the top 3 cards of the policy deck.</p>
            <div class="card-container" id="policy-peek-cards"></div>
            <button class="action-btn" onclick="closePolicyPeek()">I've Seen Them</button>
        </div>
    </div>

    <div id="execution-modal" class="modal-overlay hidden">
        <div class="container" style="max-width:500px;">
            <h2>Execution</h2>
            <p style="margin: 15px 0;">President: Select a player to execute.</p>
            <div id="execution-list"></div>
        </div>
    </div>

    <div id="nominate-chancellor-modal" class="modal-overlay hidden">
        <div class="container" style="max-width:500px;">
            <h2>Nominate Chancellor</h2>
            <p style="margin: 15px 0;">President <span id="nominate-pres-name" style="color: var(--accent-color); font-weight: bold;"></span>: Select a Chancellor.</p>
            <p style="font-size: 0.9rem; color: var(--text-secondary); margin: 10px 0;">
                Cannot select: Previous President, Previous Chancellor (Term Limit)
            </p>
            <div id="nominate-chancellor-list"></div>
        </div>
    </div>

    <script>
        // --- Game Configuration ---
        var ROLE_CONFIG = {
            5: { liberals: 3, fascists: 1, hitler: 1 },
            6: { liberals: 4, fascists: 1, hitler: 1 },
            7: { liberals: 4, fascists: 2, hitler: 1 },
            8: { liberals: 5, fascists: 2, hitler: 1 },
            9: { liberals: 5, fascists: 3, hitler: 1 },
            10: { liberals: 6, fascists: 3, hitler: 1 }
        };

        var FASCIST_POWERS = {
            1: { name: 'Investigate Loyalty', description: 'President investigates a player\'s loyalty card' },
            2: { name: 'Investigate OR Special Election', description: 'President chooses: Investigate OR Special Election' },
            3: { name: 'Policy Peek', description: 'President looks at top 3 policy cards' },
            4: { name: 'Execution', description: 'President executes a player' },
            5: { name: 'Execution', description: 'President executes a player' }
        };

        // --- Global State ---
        var playerCount = 7;
        var players = [];
        var savedPlayers = [];
        var currentDistIndex = 0;
        
        // Game State
        var policyDeck = [];
        var discardPile = [];
        var liberalPolicies = 0;
        var fascistPolicies = 0;
        var currentPresident = 0;
        var currentChancellor = null;
        var previousPresident = null;
        var previousChancellor = null;
        var electionTracker = 0;
        var isGameEnded = false;
        var gameLog = [];
        var hitlerZone = false; // After 3 fascist policies
        var currentHand = []; // Cards drawn by President
        var chancellorHand = []; // Cards passed to Chancellor
        
        // Special Powers
        var pendingInvestigation = false;
        var pendingSpecialElection = false;
        var pendingPolicyPeek = false;
        var pendingExecution = false;
        var investigationTarget = null;
        var specialElectionTarget = null;
        var executionTarget = null;

        // --- Initialization ---
        window.onload = function() {
            loadSavedPlayers();
            renderPlayerInputs();
        };

        function loadSavedPlayers() {
            var stored = localStorage.getItem('hitler_players');
            if (stored) {
                savedPlayers = JSON.parse(stored);
            }
            renderSavedList();
        }

        function renderSavedList() {
            var container = document.getElementById('saved-list');
            container.innerHTML = '';
            
            if (savedPlayers.length === 0) {
                container.innerHTML = '<span style="color:#555; font-size:0.8rem;">No saved names</span>';
                return;
            }

            savedPlayers.forEach(function(name) {
                var chip = document.createElement('div');
                chip.className = 'player-chip';
                chip.innerText = name;
                chip.onclick = function() { fillInput(name); };
                container.appendChild(chip);
            });
        }

        function fillInput(name) {
            var inputs = document.querySelectorAll('.player-input');
            for (var i = 0; i < inputs.length; i++) {
                var val = inputs[i].value;
                if (val === '') {
                    inputs[i].value = name;
                    return;
                }
            }
        }

        function updatePlayerCount(delta) {
            var newCount = playerCount + delta;
            if (newCount >= 5 && newCount <= 10) {
                playerCount = newCount;
                document.getElementById('player-count-display').innerText = playerCount;
                renderPlayerInputs();
            }
        }

        function renderPlayerInputs() {
            var container = document.getElementById('player-inputs-container');
            var currentValues = [];
            var inputs = container.querySelectorAll('.player-input');
            for(var i=0; i<inputs.length; i++) currentValues.push(inputs[i].value);

            container.innerHTML = '';
            for (var i = 0; i < playerCount; i++) {
                var val = currentValues[i] || '';
                var placeholder = "Player " + (i + 1);
                var input = document.createElement('input');
                input.type = 'text';
                input.className = 'player-input';
                input.placeholder = placeholder;
                input.value = val;
                container.appendChild(input);
            }
        }

        // --- Role Distribution ---
        function startRoleDistribution() {
            var inputs = document.querySelectorAll('.player-input');
            var names = [];
            for (var i = 0; i < inputs.length; i++) {
                var val = inputs[i].value.trim() || inputs[i].placeholder;
                names.push(val);
                
                if (inputs[i].value.trim() !== '' && savedPlayers.indexOf(val) === -1) {
                    savedPlayers.push(val);
                }
            }
            localStorage.setItem('hitler_players', JSON.stringify(savedPlayers));
            renderSavedList();

            var config = ROLE_CONFIG[playerCount];
            var roles = [];
            
            // Add Liberals
            for (var i = 0; i < config.liberals; i++) {
                roles.push('Liberal');
            }
            // Add Fascists
            for (var i = 0; i < config.fascists; i++) {
                roles.push('Fascist');
            }
            // Add Hitler
            roles.push('Hitler');
            
            // Shuffle roles
            shuffleArray(roles);
            
            players = [];
            for (var i = 0; i < playerCount; i++) {
                players.push({
                    name: names[i],
                    role: roles[i],
                    dead: false
                });
            }
            
            currentDistIndex = 0;
            document.getElementById('dist-total-players').innerText = playerCount;
            showScreen('distribution-screen');
            updateDistScreen();
        }

        function updateDistScreen() {
            document.getElementById('dist-player-num').innerText = currentDistIndex + 1;
            document.getElementById('dist-player-name').innerText = players[currentDistIndex].name;
        }

        function revealRole() {
            var player = players[currentDistIndex];
            document.getElementById('reveal-name-header').innerText = player.name;
            
            var title = document.getElementById('role-title');
            var desc = document.getElementById('role-desc');
            var extra = document.getElementById('role-extra');
            
            title.innerText = player.role;
            if (player.role === 'Liberal') {
                title.className = 'role-title role-liberal';
                desc.innerText = 'You are a Liberal. Your goal is to pass 5 Liberal policies or kill Hitler.';
                extra.innerHTML = '';
            } else if (player.role === 'Fascist') {
                title.className = 'role-title role-fascist';
                desc.innerText = 'You are a Fascist. Your goal is to pass 6 Fascist policies or have Hitler elected Chancellor after 3 Fascist policies.';
                // Show other fascists
                var fascists = players.filter(p => p.role === 'Fascist' && p.name !== player.name);
                var hitler = players.find(p => p.role === 'Hitler');
                if (hitler) {
                    extra.innerHTML = '<div style="margin-top: 15px; padding: 10px; background: rgba(244, 67, 54, 0.2); border: 1px solid var(--fascist-color); border-radius: 8px; color: #FFCDD2;"><strong>Your teammates:</strong><br>Hitler: ' + hitler.name + '<br>' + 
                        (fascists.length > 0 ? 'Other Fascists: ' + fascists.map(p => p.name).join(', ') : 'No other Fascists') + '</div>';
                }
            } else if (player.role === 'Hitler') {
                title.className = 'role-title role-hitler';
                desc.innerText = 'You are Hitler. Your goal is to pass 6 Fascist policies or be elected Chancellor after 3 Fascist policies.';
                // Show fascists
                var fascists = players.filter(p => p.role === 'Fascist');
                if (fascists.length > 0) {
                    extra.innerHTML = '<div style="margin-top: 15px; padding: 10px; background: rgba(156, 39, 176, 0.2); border: 1px solid var(--hitler-color); border-radius: 8px; color: #E1BEE7;"><strong>Your Fascist teammates:</strong><br>' + fascists.map(p => p.name).join(', ') + '</div>';
                } else {
                    extra.innerHTML = '<div style="margin-top: 15px; padding: 10px; background: rgba(156, 39, 176, 0.2); border: 1px solid var(--hitler-color); border-radius: 8px; color: #E1BEE7;">You have no Fascist teammates.</div>';
                }
            }
            
            var nextBtn = document.getElementById('next-dist-btn');
            if (currentDistIndex === playerCount - 1) {
                nextBtn.innerText = "Finish Distribution";
                nextBtn.style.backgroundColor = "#4CAF50";
            } else {
                nextBtn.innerText = "Hide & Next";
                nextBtn.style.backgroundColor = "#64ffda";
            }
            
            document.getElementById('dist-pass-view').classList.add('hidden');
            document.getElementById('dist-reveal-view').classList.remove('hidden');
        }

        function nextDistribute() {
            currentDistIndex++;
            if (currentDistIndex >= playerCount) {
                startGame();
            } else {
                document.getElementById('dist-pass-view').classList.remove('hidden');
                document.getElementById('dist-reveal-view').classList.add('hidden');
                updateDistScreen();
            }
        }

        // --- Game Logic ---
        function startGame() {
            // Initialize policy deck: 6 Liberal, 11 Fascist
            policyDeck = [];
            for (var i = 0; i < 6; i++) {
                policyDeck.push('Liberal');
            }
            for (var i = 0; i < 11; i++) {
                policyDeck.push('Fascist');
            }
            shuffleArray(policyDeck);
            
            discardPile = [];
            liberalPolicies = 0;
            fascistPolicies = 0;
            currentPresident = Math.floor(Math.random() * playerCount);
            previousPresident = null;
            previousChancellor = null;
            electionTracker = 0;
            isGameEnded = false;
            gameLog = [];
            hitlerZone = false;
            currentHand = [];
            chancellorHand = [];
            
            addLog("Game started with " + playerCount + " players.");
            addLog("First President: " + players[currentPresident].name);
            
            showScreen('game-screen');
            updateGameDisplay();
            startElection();
        }

        function updateGameDisplay() {
            document.getElementById('liberal-policies').innerText = liberalPolicies;
            document.getElementById('fascist-policies').innerText = fascistPolicies;
            document.getElementById('president-name').innerText = players[currentPresident].name;
            document.getElementById('chancellor-name').innerText = currentChancellor !== null ? players[currentChancellor].name : '-';
            
            renderPolicyTrack();
            renderTracker();
        }

        function renderPolicyTrack() {
            var track = document.getElementById('policy-track');
            track.innerHTML = '';
            
            // Liberal track (5 slots)
            for (var i = 0; i < 5; i++) {
                var slot = document.createElement('div');
                slot.className = 'policy-slot';
                if (i < liberalPolicies) {
                    slot.classList.add('liberal');
                    slot.innerHTML = '<div class="policy-icon">L</div>';
                }
                track.appendChild(slot);
            }
            
            // Separator between Liberal and Fascist
            var separator1 = document.createElement('div');
            separator1.className = 'track-separator';
            track.appendChild(separator1);
            
            var hitlerZoneActive = fascistPolicies >= 3;
            
            // Fascist track - First 3 (Hitler Zone)
            for (var i = 0; i < 3; i++) {
                var slot = document.createElement('div');
                slot.className = 'policy-slot';
                if (i < fascistPolicies) {
                    slot.classList.add('fascist');
                    slot.innerHTML = '<div class="policy-icon">F</div>';
                    
                    // Add power badge
                    var power = FASCIST_POWERS[i + 1];
                    if (power) {
                        slot.classList.add('power');
                        var badge = document.createElement('div');
                        badge.className = 'power-badge';
                        badge.innerText = (i + 1);
                        badge.title = power.name;
                        slot.appendChild(badge);
                    }
                }
                // Mark as Hitler Zone slot if active
                if (hitlerZoneActive) {
                    slot.classList.add('hitler-zone-slot');
                }
                track.appendChild(slot);
            }
            
            // Separator between Hitler Zone and regular Fascist
            var separator2 = document.createElement('div');
            separator2.className = 'track-separator' + (hitlerZoneActive ? ' hitler-zone-separator' : '');
            track.appendChild(separator2);
            
            // Fascist track - Last 3 (Regular)
            for (var i = 3; i < 6; i++) {
                var slot = document.createElement('div');
                slot.className = 'policy-slot';
                if (i < fascistPolicies) {
                    slot.classList.add('fascist');
                    slot.innerHTML = '<div class="policy-icon">F</div>';
                    
                    // Add power badge
                    var power = FASCIST_POWERS[i + 1];
                    if (power) {
                        slot.classList.add('power');
                        var badge = document.createElement('div');
                        badge.className = 'power-badge';
                        badge.innerText = (i + 1);
                        badge.title = power.name;
                        slot.appendChild(badge);
                    }
                }
                track.appendChild(slot);
            }
            
            // Add labels after slots are created
            var liberalLabel = document.createElement('div');
            liberalLabel.className = 'track-label liberal-label';
            liberalLabel.innerHTML = 'üõ°Ô∏è LIB';
            track.appendChild(liberalLabel);
            
            var fascistLabel = document.createElement('div');
            fascistLabel.className = 'track-label fascist-label';
            fascistLabel.innerHTML = '‚öîÔ∏è FAS';
            track.appendChild(fascistLabel);
            
            // Add Hitler Zone marker if active (positioned above first 3 fascist slots)
            if (hitlerZoneActive) {
                var hzMarker = document.createElement('div');
                hzMarker.className = 'hitler-zone-marker';
                hzMarker.innerHTML = '‚ö° HZ';
                // Position after 5 liberal slots + separator (approximately)
                var leftPos = 5 * 53 + 20 + 26; // 5 slots + separator + center of first HZ slot
                hzMarker.style.left = leftPos + 'px';
                track.appendChild(hzMarker);
            }
        }

        function renderTracker() {
            var slots = document.getElementById('tracker-slots');
            slots.innerHTML = '';
            for (var i = 0; i < 3; i++) {
                var slot = document.createElement('div');
                slot.className = 'tracker-slot';
                if (i < electionTracker) {
                    slot.classList.add('filled');
                }
                slot.innerText = i + 1;
                slots.appendChild(slot);
            }
        }

        function startElection() {
            document.getElementById('phase-title').innerText = 'Election Phase';
            document.getElementById('phase-content').innerHTML = 
                '<p><strong>' + players[currentPresident].name + '</strong> is the President.</p>' +
                '<p>President must nominate a Chancellor.</p>' +
                '<p style="font-size: 0.9rem; color: var(--text-secondary);">Voting happens offline - announce your vote publicly.</p>';
            
            var actions = document.getElementById('action-buttons');
            actions.innerHTML = '<button class="action-btn" onclick="openNominateChancellor()">Nominate Chancellor</button>';
        }

        function openNominateChancellor() {
            document.getElementById('nominate-pres-name').innerText = players[currentPresident].name;
            var list = document.getElementById('nominate-chancellor-list');
            list.innerHTML = '';
            
            players.forEach(function(player, index) {
                // Cannot select: self, previous president, previous chancellor (term limit)
                if (index === currentPresident || 
                    (previousPresident !== null && index === previousPresident) ||
                    (previousChancellor !== null && index === previousChancellor)) {
                    return;
                }
                
                if (player.dead) return;
                
                var btn = document.createElement('button');
                btn.className = 'player-select-btn';
                btn.innerText = player.name;
                if (player.dead) btn.classList.add('dead-player');
                btn.onclick = function() { nominateChancellor(index); };
                list.appendChild(btn);
            });
            
            document.getElementById('nominate-chancellor-modal').classList.remove('hidden');
        }

        function nominateChancellor(chancellorIndex) {
            currentChancellor = chancellorIndex;
            document.getElementById('nominate-chancellor-modal').classList.add('hidden');
            
            addLog(players[currentPresident].name + ' nominated ' + players[currentChancellor].name + ' as Chancellor');
            
            document.getElementById('phase-title').innerText = 'Voting Phase';
            document.getElementById('phase-content').innerHTML = 
                '<p><strong>Government:</strong> ' + players[currentPresident].name + ' (President) and ' + players[currentChancellor].name + ' (Chancellor)</p>' +
                '<p>All players vote Ja (Yes) or Nein (No).</p>' +
                '<p style="font-size: 0.9rem; color: var(--text-secondary);">Voting happens offline - announce your vote publicly.</p>';
            
            var actions = document.getElementById('action-buttons');
            actions.innerHTML = 
                '<button class="action-btn" onclick="governmentPassed()" style="background: #4CAF50;">Government Passed</button>' +
                '<button class="action-btn" onclick="governmentFailed()" style="background: #F44336; margin-top: 10px;">Government Failed</button>';
        }

        function governmentPassed() {
            addLog('Government passed: ' + players[currentPresident].name + ' (P) and ' + players[currentChancellor].name + ' (C)');
            electionTracker = 0; // Reset tracker
            previousPresident = currentPresident;
            previousChancellor = currentChancellor;
            
            // Check Hitler Zone win condition
            if (checkHitlerZoneWin()) {
                return;
            }
            
            startPolicyPhase();
        }

        function governmentFailed() {
            addLog('Government failed');
            electionTracker++;
            if (electionTracker >= 3) {
                // Topdeck
                topdeckPolicy();
            } else {
                // Move to next president
                nextPresident();
                startElection();
            }
            updateGameDisplay();
        }

        function topdeckPolicy() {
            addLog('3 failed elections - Topdecking policy');
            if (policyDeck.length === 0) {
                reshuffleDeck();
            }
            var policy = policyDeck.shift();
            enactPolicy(policy, true);
        }

        function startPolicyPhase() {
            document.getElementById('phase-title').innerText = 'Policy Phase';
            document.getElementById('phase-content').innerHTML = 
                '<p><strong>Step 1:</strong> President draws 3 policy cards.</p>';
            
            var actions = document.getElementById('action-buttons');
            actions.innerHTML = '<button class="action-btn" onclick="presidentDraws()">President Draws Cards</button>';
        }

        function presidentDraws() {
            // Draw 3 cards
            if (policyDeck.length < 3) {
                reshuffleDeck();
            }
            
            currentHand = [];
            for (var i = 0; i < 3; i++) {
                if (policyDeck.length > 0) {
                    currentHand.push(policyDeck.shift());
                }
            }
            
            addLog('President drew 3 policy cards');
            
            // President discards 1
            openPolicySelection('president', 'Discard 1 policy card', currentHand, function(selectedCard, remainingCards) {
                discardPile.push(selectedCard);
                chancellorHand = remainingCards;
                addLog('President discarded 1 card, passed 2 to Chancellor');
                
                document.getElementById('phase-title').innerText = 'Policy Phase';
                document.getElementById('phase-content').innerHTML = 
                    '<p><strong>Step 2:</strong> Chancellor receives 2 policy cards.</p>';
                
                var actions = document.getElementById('action-buttons');
                actions.innerHTML = '<button class="action-btn" onclick="chancellorSelects()">Chancellor Selects Policy</button>';
            });
        }

        function chancellorSelects() {
            // Chancellor discards 1, enacts 1
            openPolicySelection('chancellor', 'Discard 1 policy card (the other will be enacted)', chancellorHand, function(selectedCard, remainingCards) {
                discardPile.push(selectedCard);
                var enactedPolicy = remainingCards[0];
                addLog('Chancellor discarded 1 card, enacted 1 policy');
                enactPolicy(enactedPolicy, false);
            });
        }

        function openPolicySelection(role, instruction, cards, callback) {
            document.getElementById('policy-selection-title').innerText = role === 'president' ? 'President Discards' : 'Chancellor Discards';
            document.getElementById('policy-selection-instruction').innerText = instruction;
            document.getElementById('policy-selection-progress').innerText = 'Select 1 card to discard';
            
            var container = document.getElementById('policy-selection-cards');
            container.innerHTML = '';
            
            cards.forEach(function(card, index) {
                var cardDiv = document.createElement('div');
                cardDiv.className = 'policy-card';
                if (card === 'Liberal') {
                    cardDiv.classList.add('policy-card-liberal');
                    cardDiv.innerHTML = '<div style="font-size: 2rem; margin-bottom: 10px;">L</div><div>LIBERAL</div>';
                } else {
                    cardDiv.classList.add('policy-card-fascist');
                    cardDiv.innerHTML = '<div style="font-size: 2rem; margin-bottom: 10px;">F</div><div>FASCIST</div>';
                }
                
                cardDiv.onclick = function() {
                    var remaining = cards.filter(function(c, i) { return i !== index; });
                    callback(card, remaining);
                    document.getElementById('policy-selection-modal').classList.add('hidden');
                };
                
                container.appendChild(cardDiv);
            });
            
            document.getElementById('policy-selection-modal').classList.remove('hidden');
        }

        function enactPolicy(policy, isTopdeck) {
            if (policy === 'Liberal') {
                liberalPolicies++;
                addLog('Liberal policy enacted! (' + liberalPolicies + '/5)');
            } else {
                fascistPolicies++;
                addLog('Fascist policy enacted! (' + fascistPolicies + '/6)');
                
                // Check for Hitler Zone
                if (fascistPolicies >= 3 && !hitlerZone) {
                    hitlerZone = true;
                    addLog('HITLER ZONE: If Hitler is elected Chancellor, Fascists win!');
                }
                
                // Check for special power
                if (fascistPolicies <= 5) {
                    var power = FASCIST_POWERS[fascistPolicies];
                    if (power) {
                        addLog('Special Power unlocked: ' + power.name);
                        if (fascistPolicies === 1) {
                            pendingInvestigation = true;
                        } else if (fascistPolicies === 2) {
                            pendingInvestigation = true;
                            pendingSpecialElection = true;
                        } else if (fascistPolicies === 3) {
                            pendingPolicyPeek = true;
                        } else if (fascistPolicies === 4 || fascistPolicies === 5) {
                            pendingExecution = true;
                        }
                    }
                }
            }
            
            // Show policy reveal
            var revealCard = document.getElementById('policy-reveal-card');
            var revealMsg = document.getElementById('policy-reveal-message');
            
            if (policy === 'Liberal') {
                revealCard.className = 'policy-card policy-card-liberal';
                revealCard.innerHTML = '<div style="font-size: 3rem; margin-bottom: 10px;">L</div><div style="font-size: 1.5rem;">LIBERAL</div>';
                revealMsg.innerText = 'Liberal Policy Enacted!';
                revealMsg.style.color = 'var(--liberal-color)';
            } else {
                revealCard.className = 'policy-card policy-card-fascist';
                revealCard.innerHTML = '<div style="font-size: 3rem; margin-bottom: 10px;">F</div><div style="font-size: 1.5rem;">FASCIST</div>';
                revealMsg.innerText = 'Fascist Policy Enacted!';
                revealMsg.style.color = 'var(--fascist-color)';
            }
            
            document.getElementById('policy-reveal-modal').classList.remove('hidden');
            
            updateGameDisplay();
            checkWinConditions();
        }

        function closePolicyReveal() {
            document.getElementById('policy-reveal-modal').classList.add('hidden');
            
            // Handle special powers
            if (pendingInvestigation && fascistPolicies === 1) {
                openInvestigation();
            } else if (pendingInvestigation && pendingSpecialElection && fascistPolicies === 2) {
                openInvestigationOrSpecialElection();
            } else if (pendingPolicyPeek) {
                openPolicyPeek();
            } else if (pendingExecution) {
                openExecution();
            } else {
                nextTurn();
            }
        }

        function openInvestigation() {
            pendingInvestigation = false;
            document.getElementById('phase-title').innerText = 'Special Power: Investigate';
            document.getElementById('phase-content').innerHTML = 
                '<p>President: Select a player to investigate their loyalty card.</p>';
            
            var list = document.getElementById('investigate-list');
            list.innerHTML = '';
            
            players.forEach(function(player, index) {
                if (index === currentPresident || player.dead) return;
                
                var btn = document.createElement('button');
                btn.className = 'player-select-btn';
                btn.innerText = player.name;
                btn.onclick = function() { performInvestigation(index); };
                list.appendChild(btn);
            });
            
            document.getElementById('investigate-modal').classList.remove('hidden');
        }

        function performInvestigation(targetIndex) {
            investigationTarget = targetIndex;
            var target = players[targetIndex];
            
            document.getElementById('investigate-modal').classList.add('hidden');
            
            // Show result to President
            document.getElementById('investigated-player').innerText = target.name;
            var result = document.getElementById('investigation-result');
            
            // Fascists and Hitler show as Fascist, Liberals show as Liberal
            var isFascist = (target.role === 'Fascist' || target.role === 'Hitler');
            if (isFascist) {
                result.innerHTML = '<div style="font-size: 2rem; margin-bottom: 10px;">‚öîÔ∏è</div><div style="font-size: 1.3rem; font-weight: bold; color: var(--fascist-color);">FASCIST</div>';
                result.style.borderColor = 'var(--fascist-color)';
            } else {
                result.innerHTML = '<div style="font-size: 2rem; margin-bottom: 10px;">üõ°Ô∏è</div><div style="font-size: 1.3rem; font-weight: bold; color: var(--liberal-color);">LIBERAL</div>';
                result.style.borderColor = 'var(--liberal-color)';
            }
            
            addLog(players[currentPresident].name + ' investigated ' + target.name + ' (result: ' + (isFascist ? 'Fascist' : 'Liberal') + ')');
            
            document.getElementById('investigate-result-modal').classList.remove('hidden');
        }

        function closeInvestigationResult() {
            document.getElementById('investigate-result-modal').classList.add('hidden');
            nextTurn();
        }

        function openInvestigationOrSpecialElection() {
            pendingInvestigation = false;
            pendingSpecialElection = false;
            
            document.getElementById('phase-title').innerText = 'Special Power: Choose';
            document.getElementById('phase-content').innerHTML = 
                '<p>President: Choose Investigation OR Special Election.</p>';
            
            var actions = document.getElementById('action-buttons');
            actions.innerHTML = 
                '<button class="action-btn" onclick="openInvestigation()">Investigate Loyalty</button>' +
                '<button class="action-btn" onclick="openSpecialElection()" style="margin-top: 10px;">Special Election</button>';
        }

        function openSpecialElection() {
            document.getElementById('phase-title').innerText = 'Special Power: Special Election';
            document.getElementById('phase-content').innerHTML = 
                '<p>President: Select the next President (bypasses normal order).</p>';
            
            var list = document.getElementById('special-election-list');
            list.innerHTML = '';
            
            players.forEach(function(player, index) {
                if (player.dead) return;
                
                var btn = document.createElement('button');
                btn.className = 'player-select-btn';
                btn.innerText = player.name;
                btn.onclick = function() { performSpecialElection(index); };
                list.appendChild(btn);
            });
            
            document.getElementById('special-election-modal').classList.remove('hidden');
        }

        function performSpecialElection(targetIndex) {
            currentPresident = targetIndex;
            addLog('Special Election: ' + players[currentPresident].name + ' is now President');
            document.getElementById('special-election-modal').classList.add('hidden');
            nextTurn();
        }

        function openPolicyPeek() {
            pendingPolicyPeek = false;
            
            // Show top 3 cards
            if (policyDeck.length < 3) {
                reshuffleDeck();
            }
            
            var peekCards = [];
            for (var i = 0; i < 3 && i < policyDeck.length; i++) {
                peekCards.push(policyDeck[i]);
            }
            
            var container = document.getElementById('policy-peek-cards');
            container.innerHTML = '';
            
            peekCards.forEach(function(card) {
                var cardDiv = document.createElement('div');
                cardDiv.className = 'policy-card';
                if (card === 'Liberal') {
                    cardDiv.classList.add('policy-card-liberal');
                    cardDiv.innerHTML = '<div style="font-size: 2rem; margin-bottom: 10px;">L</div><div>LIBERAL</div>';
                } else {
                    cardDiv.classList.add('policy-card-fascist');
                    cardDiv.innerHTML = '<div style="font-size: 2rem; margin-bottom: 10px;">F</div><div>FASCIST</div>';
                }
                container.appendChild(cardDiv);
            });
            
            addLog(players[currentPresident].name + ' used Policy Peek');
            document.getElementById('policy-peek-modal').classList.remove('hidden');
        }

        function closePolicyPeek() {
            document.getElementById('policy-peek-modal').classList.add('hidden');
            nextTurn();
        }

        function openExecution() {
            pendingExecution = false;
            document.getElementById('phase-title').innerText = 'Special Power: Execution';
            document.getElementById('phase-content').innerHTML = 
                '<p>President: Select a player to execute.</p>';
            
            var list = document.getElementById('execution-list');
            list.innerHTML = '';
            
            players.forEach(function(player, index) {
                if (index === currentPresident || player.dead) return;
                
                var btn = document.createElement('button');
                btn.className = 'player-select-btn';
                btn.innerText = player.name;
                btn.onclick = function() { performExecution(index); };
                list.appendChild(btn);
            });
            
            document.getElementById('execution-modal').classList.remove('hidden');
        }

        function performExecution(targetIndex) {
            var target = players[targetIndex];
            target.dead = true;
            addLog(players[currentPresident].name + ' executed ' + target.name);
            
            document.getElementById('execution-modal').classList.add('hidden');
            
            // Check if Hitler was killed
            if (target.role === 'Hitler') {
                endGame('liberal', 'Liberals win! Hitler was executed.');
                return;
            }
            
            // Check if game can continue (need at least 3 players alive)
            var aliveCount = players.filter(p => !p.dead).length;
            if (aliveCount < 3) {
                endGame('fascist', 'Fascists win! Not enough players to continue.');
                return;
            }
            
            nextTurn();
        }

        function nextTurn() {
            currentChancellor = null;
            nextPresident();
            startElection();
        }

        function nextPresident() {
            do {
                currentPresident = (currentPresident + 1) % playerCount;
            } while (players[currentPresident].dead);
        }

        function reshuffleDeck() {
            if (discardPile.length === 0) {
                // Should not happen, but handle it
                addLog('Warning: Deck empty and no discard pile!');
                return;
            }
            
            policyDeck = discardPile.slice();
            discardPile = [];
            shuffleArray(policyDeck);
            addLog('Policy deck reshuffled');
        }

        function checkWinConditions() {
            if (isGameEnded) return;
            
            // Liberal win: 5 Liberal policies
            if (liberalPolicies >= 5) {
                endGame('liberal', 'Liberals win! 5 Liberal policies enacted.');
                return;
            }
            
            // Fascist win: 6 Fascist policies
            if (fascistPolicies >= 6) {
                endGame('fascist', 'Fascists win! 6 Fascist policies enacted.');
                return;
            }
            
            // Hitler Zone check happens during election
        }

        function checkHitlerZoneWin() {
            if (hitlerZone && currentChancellor !== null) {
                var chancellor = players[currentChancellor];
                if (chancellor.role === 'Hitler') {
                    endGame('fascist', 'Fascists win! Hitler was elected Chancellor in Hitler Zone.');
                    return true;
                }
            }
            return false;
        }

        function endGame(winner, message) {
            isGameEnded = true;
            var titleEl = document.getElementById('end-game-title');
            titleEl.innerText = winner.toUpperCase() + ' WINS!';
            titleEl.style.color = winner === 'liberal' ? 'var(--liberal-color)' : 'var(--fascist-color)';
            document.getElementById('end-game-message').innerText = message;
            document.getElementById('end-game-modal').classList.remove('hidden');
            addLog('GAME OVER: ' + message);
        }

        function toggleLog() {
            var log = document.getElementById('game-log');
            log.classList.toggle('hidden');
        }

        function addLog(message) {
            var timestamp = new Date().toLocaleTimeString();
            gameLog.push('[' + timestamp + '] ' + message);
            
            var content = document.getElementById('log-content');
            content.innerHTML = '';
            gameLog.slice().reverse().forEach(function(entry) {
                var div = document.createElement('div');
                div.className = 'log-entry';
                div.innerText = entry;
                content.appendChild(div);
            });
        }

        function showScreen(id) {
            var screens = ['setup-screen', 'distribution-screen', 'game-screen'];
            screens.forEach(s => {
                var el = document.getElementById(s);
                if (el) el.classList.add('hidden');
            });
            var target = document.getElementById(id);
            if (target) target.classList.remove('hidden');
        }

        function shuffleArray(array) {
            for (var i = array.length - 1; i > 0; i--) {
                var j = Math.floor(Math.random() * (i + 1));
                var temp = array[i];
                array[i] = array[j];
                array[j] = temp;
            }
        }
    </script>
</body>
</html>

